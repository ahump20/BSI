# Blaze Sports Intel - Regression Models Infrastructure
# Cloudflare Workers + D1 + KV + R2 configuration

name = "blazesportsintel-models"
compatibility_date = "2025-01-01"
pages_build_output_dir = "public"

[site]
bucket = "./public"

# ============================================================================
# D1 DATABASE (SQLite at the Edge)
# ============================================================================

[[d1_databases]]
binding = "DB"
database_name = "bsi-models-db"
database_id = "57601862-355e-4f41-8b81-bcb28de08425"

# Apply schema with:
# wrangler d1 execute blazesports-db --file=functions/api/db/schema.sql

# ============================================================================
# KV NAMESPACES (Key-Value Store for Caching & Aliases)
# ============================================================================

[[kv_namespaces]]
binding = "KV"
id = "6e3a09ea1e134a4e86036b469bfc6f4f"  # BLAZE_CACHE

# KV Usage:
# - alias:model_key → r2://path/to/artifact.json
# - cache:mlb:standings:2025 → {...}
# - drift:model_key:psi → 0.023
# - health:model:model_key → {auc_7d, ece_7d}

# ============================================================================
# R2 STORAGE (Object Storage for Models & Data)
# ============================================================================

[[r2_buckets]]
binding = "R2"
bucket_name = "bsi-models"

# Create with: wrangler r2 bucket create bsi-models

# R2 Layout:
# r2://bsi-models/
#   baseball/ncaa/is_home_run_v1/artifact.json
#   baseball/ncaa/xwoba_batball_v1/artifact.json
#   football/ncaa/epa_v1/artifact.json

[[r2_buckets]]
binding = "R2_RAW"
bucket_name = "bsi-raw-data"

# R2 Raw Data Layout:
# r2://bsi-raw-data/
#   baseball/ncaa/2025/games/
#   baseball/ncaa/2025/plays/
#   baseball/ncaa/2025/features/

# ============================================================================
# ANALYTICS ENGINE (Performance Monitoring)
# ============================================================================

[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "blazesports_analytics"

# Tracks:
# - Prediction requests
# - Model performance (AUC, ECE drift)
# - API latency
# - Error rates

# ============================================================================
# ENVIRONMENT VARIABLES (Secrets)
# ============================================================================

[vars]
ENVIRONMENT = "production"
TIMEZONE = "America/Chicago"

# Set secrets with:
# wrangler pages secret put SPORTSDATAIO_API_KEY
# wrangler pages secret put SPORTSDATA_API_KEY

# ============================================================================
# CRON TRIGGERS (Scheduled Jobs)
# ============================================================================

[[triggers.crons]]
crons = ["0 */6 * * *"]  # Every 6 hours

# Jobs:
# - Refresh NCAA baseball standings/scores
# - Calculate drift metrics (PSI)
# - Update conference strength (Elo)

[[triggers.crons]]
crons = ["0 3 * * *"]  # Daily at 3 AM CDT

# Jobs:
# - Retrain models with new data
# - Export updated artifacts to R2
# - Update champion aliases in KV

# ============================================================================
# ROUTES & DEPLOYMENT
# ============================================================================

[env.production]
name = "blazesportsintel-models"
route = "blazesportsintel.com/api/*"

[env.staging]
name = "blazesportsintel-models-staging"
route = "staging.blazesportsintel.com/api/*"

# ============================================================================
# BUILD CONFIGURATION
# ============================================================================

[build]
command = "npm run build"

[build.upload]
format = "service-worker"

# ============================================================================
# OBSERVABILITY
# ============================================================================

[observability]
enabled = true
head_sampling_rate = 0.01  # 1% of requests

# ============================================================================
# EXAMPLE DEPLOYMENT COMMANDS
# ============================================================================

# 1. Create D1 database:
#    wrangler d1 create blazesports-db
#
# 2. Apply schema:
#    wrangler d1 execute blazesports-db --file=functions/api/db/schema.sql
#
# 3. Create KV namespace:
#    wrangler kv:namespace create "BLAZE_CACHE"
#
# 4. Create R2 buckets:
#    wrangler r2 bucket create bsi-models
#    wrangler r2 bucket create bsi-raw-data
#
# 5. Deploy:
#    wrangler pages deploy public --project-name blazesportsintel
#
# 6. Set secrets:
#    wrangler pages secret put SPORTSDATAIO_API_KEY --project-name blazesportsintel
#
# 7. Upload model artifact to R2:
#    wrangler r2 object put bsi-models/baseball/ncaa/is_home_run_v1/artifact.json --file=models/is_home_run_ncaa_v1.json
#
# 8. Set alias in KV:
#    wrangler kv:key put --namespace-id=6e3a09ea1e134a4e86036b469bfc6f4f "alias:is_home_run_ncaa_v1" "baseball/ncaa/is_home_run_v1/artifact.json"
