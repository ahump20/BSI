# =============================================================================
# Blaze Sports Intel — Workers Configuration (Hybrid Router)
# =============================================================================
# This Worker is the apex entry-point for blazesportsintel.com.
# It handles dynamic routes (API, WebSocket, auth) and proxies static
# requests to the Cloudflare Pages project.
# =============================================================================

name = "blazesportsintel-worker"
main = "index.ts"
compatibility_date = "2025-12-01"

# ---------------------------------------------------------------------------
# Development (default environment — `wrangler dev`)
# ---------------------------------------------------------------------------
# Top-level bindings are used for local development only.

[[kv_namespaces]]
binding = "KV"
id = "e6cb68e815cd45babeee0e10460dbfee"
preview_id = "abf84a80fa024f43bc62daf786955e2b"  # BSI_DEV_CACHE — isolated from production

[[d1_databases]]
binding = "DB"
database_name = "bsi-prod-db"
database_id = "6921617f-5351-4df3-aeab-07425e72ec6b"

[[kv_namespaces]]
binding = "ERROR_LOG"
id = "7edf894ff9ba4dd08b5433ed76ebc9c6"

[[r2_buckets]]
binding = "ASSETS_BUCKET"
bucket_name = "bsi-game-assets"

[[durable_objects.bindings]]
name = "CACHE"
class_name = "CacheObject"

[[durable_objects.bindings]]
name = "PORTAL_POLLER"
class_name = "PortalPoller"

[[migrations]]
tag = "v1"
new_classes = ["CacheObject"]

[[migrations]]
tag = "v2"
new_classes = ["PortalPoller"]

[[analytics_engine_datasets]]
binding = "OPS_EVENTS"
dataset = "bsi_ops_events"

[vars]
ENVIRONMENT = "development"
API_VERSION = "1.0.0"
PAGES_ORIGIN = "https://blazesportsintel.pages.dev"

# Cron trigger — warm KV cache for scores + rankings
[triggers]
crons = ["*/1 * * * *"]  # Every minute (scores adjust TTL internally based on season)

[dev]
port = 8787
local_protocol = "http"

# =============================================================================
# Production environment — `wrangler deploy --env production`
# =============================================================================
# IMPORTANT: Wrangler does NOT inherit top-level bindings into named envs.
# Every binding must be explicitly declared here.
# =============================================================================

[env.production]
name = "blazesportsintel-worker-prod"
routes = [
  { pattern = "blazesportsintel.com/*", zone_name = "blazesportsintel.com" },
  { pattern = "www.blazesportsintel.com/*", zone_name = "blazesportsintel.com" }
]

[env.production.vars]
ENVIRONMENT = "production"
API_VERSION = "1.0.0"
PAGES_ORIGIN = "https://blazesportsintel.pages.dev"

[[env.production.kv_namespaces]]
binding = "KV"
id = "e6cb68e815cd45babeee0e10460dbfee"

[[env.production.d1_databases]]
binding = "DB"
database_name = "bsi-prod-db"
database_id = "6921617f-5351-4df3-aeab-07425e72ec6b"

[[env.production.kv_namespaces]]
binding = "ERROR_LOG"
id = "7edf894ff9ba4dd08b5433ed76ebc9c6"

[[env.production.r2_buckets]]
binding = "ASSETS_BUCKET"
bucket_name = "bsi-game-assets"

[[env.production.durable_objects.bindings]]
name = "CACHE"
class_name = "CacheObject"

[[env.production.durable_objects.bindings]]
name = "PORTAL_POLLER"
class_name = "PortalPoller"

[[env.production.analytics_engine_datasets]]
binding = "OPS_EVENTS"
dataset = "bsi_ops_events"

# Cron trigger — warm KV cache for scores + rankings
[env.production.triggers]
crons = ["*/1 * * * *"]

[[env.production.tail_consumers]]
service = "bsi-error-tracker"

# Secrets (set via `wrangler secret put --env production`):
# SPORTS_DATA_IO_API_KEY (required for canonical SportsDataIO routes)
# RAPIDAPI_KEY
# NOTION_TOKEN
# STRIPE_SECRET_KEY
# AMPLITUDE_API_KEY
# TURNSTILE_SECRET_KEY (for Cloudflare Turnstile bot protection)
