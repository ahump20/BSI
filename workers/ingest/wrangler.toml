# BSI Data Ingest Worker
# Purpose: Scheduled data ingestion with provider failover
# Deployment: wrangler deploy --config workers/ingest/wrangler.toml

name = "bsi-ingest"
main = "index.ts"
compatibility_date = "2025-01-01"
compatibility_flags = ["nodejs_compat"]
account_id = "a12cb329d84130460eed99b816e4d0d3"

# Environment Variables
[vars]
ENVIRONMENT = "production"
CATALOG_PREFIX = "archives/"
ENABLE_REENQUEUE = "false"
GITHUB_REPO = "ahump20/BSI"

# Cron Triggers
[triggers]
crons = [
  "*/5 * * * *",   # Live games - every 5 minutes
  "0 * * * *",     # Team stats refresh - hourly
  "0 2 * * *",     # Historical aggregations - daily at 2am CST
  "0 3 * * *"      # Asset catalog - daily at 3am CST
]

# Smart Placement for consistent cross-edge behavior
[placement]
mode = "smart"

# KV Namespace (Cache)
[[kv_namespaces]]
binding = "BSI_INGEST_CACHE"
id = "a53c3726fc3044be82e79d2d1e371d26"

# R2 Bucket (Archives)
[[r2_buckets]]
binding = "BSI_INGEST_ASSETS"
bucket_name = "blazesports-archives"

# Analytics Engine
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "bsi_ingest_analytics"

# Observability
[observability.logs]
enabled = true

# Development settings
[dev]
port = 8789
local_protocol = "http"

# Staging environment
[env.staging]
name = "bsi-ingest-staging"
[env.staging.vars]
ENVIRONMENT = "staging"

# D1 Database (NCAA Baseball Games)
[[d1_databases]]
binding = "BSI_GAME_DB"
database_name = "bsi-game-db"
database_id = "88eb676f-af0f-470c-a46a-b9429f5b51f3"
