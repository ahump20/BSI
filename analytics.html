<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”¥ Blaze Sports Analytics - Multi-Sport Intelligence Platform</title>

    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Three.js for 3D Particle Systems -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <!-- Babylon.js for Advanced 3D Models -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Phase 6: Enhanced Visualization Libraries (Feature Flag Gated) -->
    <!-- Plotly.js with WebGPU support for million-point datasets -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>

    <!-- deck.gl for GPU-accelerated geospatial visualizations -->
    <script src="https://unpkg.com/deck.gl@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/core@^8.9.0/dist.min.js"></script>
    <script src="https://unpkg.com/@deck.gl/layers@^8.9.0/dist.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Blaze Analytics Styles (External) -->
    <link rel="stylesheet" href="/public/css/analytics.css">
</head>
<body>
    <!-- Three.js Background Canvas -->
    <canvas id="three-background"></canvas>

    <!-- Navigation -->
    <nav class="back-nav">
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i> Back to Home
        </a>
    </nav>

    <!-- React App Root -->
    <div id="root"></div>

    <script type="text/babel" src="/public/js/analytics.js"></script>

    <!-- Data Freshness Indicator Component -->
    <script src="/public/js/data-freshness-component.js"></script>

    <!-- Error Handler Component -->
    <script src="/public/js/error-handler.js"></script>

    <!-- Loading Skeleton Components -->
    <script src="/public/js/loading-skeletons.js"></script>

    <!-- User Feedback Widget -->
    <script src="/public/js/feedback-widget.js"></script>

    <!-- Babylon.js 3D Hero (Rotating Trophy) -->
    <script>
        (function() {
            const canvas = document.getElementById('babylon-hero');
            if (!canvas || typeof BABYLON === 'undefined') return;

            const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
            const scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color4(0, 0, 0, 0);

            const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 3, 8, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, false);

            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 0.7;

            // Create a trophy-like shape
            const trophy = BABYLON.MeshBuilder.CreateCylinder("trophy", { height: 2, diameterTop: 0.5, diameterBottom: 1 }, scene);

            const trophyMaterial = new BABYLON.StandardMaterial("trophyMat", scene);
            trophyMaterial.diffuseColor = new BABYLON.Color3(0.75, 0.34, 0);
            trophyMaterial.specularColor = new BABYLON.Color3(1, 0.6, 0);
            trophyMaterial.emissiveColor = new BABYLON.Color3(0.3, 0.1, 0);
            trophy.material = trophyMaterial;

            // Add glow
            const gl = new BABYLON.GlowLayer("glow", scene);
            gl.intensity = 0.5;

            // Rotate trophy
            scene.registerBeforeRender(() => {
                trophy.rotation.y += 0.01;
            });

            engine.runRenderLoop(() => {
                scene.render();
            });

            window.addEventListener('resize', () => {
                engine.resize();
            });
        })();
    </script>

    <!-- Babylon.js 3D Baseball Diamond -->
    <script>
        let baseballDiamondEngine = null;
        let baseballDiamondScene = null;
        let playerMeshes = [];

        function createBaseballDiamond() {
            const canvas = document.getElementById('baseball-diamond-3d');
            if (!canvas || typeof BABYLON === 'undefined') return;

            // Clean up existing scene if it exists
            if (baseballDiamondEngine) {
                baseballDiamondEngine.dispose();
            }

            baseballDiamondEngine = new BABYLON.Engine(canvas, true, {
                preserveDrawingBuffer: true,
                stencil: true,
                antialias: true
            });

            baseballDiamondScene = new BABYLON.Scene(baseballDiamondEngine);
            baseballDiamondScene.clearColor = new BABYLON.Color4(0.05, 0.1, 0.05, 1);

            // Camera positioned to view from above/behind home plate
            const camera = new BABYLON.ArcRotateCamera(
                "camera",
                -Math.PI / 2,
                Math.PI / 3.5,
                50,
                new BABYLON.Vector3(0, 0, 10),
                baseballDiamondScene
            );
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 30;
            camera.upperRadiusLimit = 100;
            camera.lowerBetaLimit = 0.1;
            camera.upperBetaLimit = Math.PI / 2;

            // Lighting
            const hemisphericLight = new BABYLON.HemisphericLight(
                "hemiLight",
                new BABYLON.Vector3(0, 1, 0),
                baseballDiamondScene
            );
            hemisphericLight.intensity = 0.7;

            const directionalLight = new BABYLON.DirectionalLight(
                "dirLight",
                new BABYLON.Vector3(-1, -2, -1),
                baseballDiamondScene
            );
            directionalLight.intensity = 0.5;

            // Stadium lights effect
            const stadiumLight1 = new BABYLON.PointLight(
                "stadiumLight1",
                new BABYLON.Vector3(-30, 40, 30),
                baseballDiamondScene
            );
            stadiumLight1.intensity = 0.3;

            const stadiumLight2 = new BABYLON.PointLight(
                "stadiumLight2",
                new BABYLON.Vector3(30, 40, 30),
                baseballDiamondScene
            );
            stadiumLight2.intensity = 0.3;

            // Create baseball diamond
            createField();
            createBases();
            createPitchersMound();
            createFoulLines();
            createOutfield();

            // Create default player positions (standard defensive alignment)
            const defaultPositions = [
                { name: "Pitcher", abbr: "P", position: new BABYLON.Vector3(0, 0.5, 10), jersey: "1" },
                { name: "Catcher", abbr: "C", position: new BABYLON.Vector3(0, 0.5, 0), jersey: "2" },
                { name: "First Base", abbr: "1B", position: new BABYLON.Vector3(18, 0.5, 18), jersey: "3" },
                { name: "Second Base", abbr: "2B", position: new BABYLON.Vector3(6, 0.5, 24), jersey: "4" },
                { name: "Third Base", abbr: "3B", position: new BABYLON.Vector3(-18, 0.5, 18), jersey: "5" },
                { name: "Shortstop", abbr: "SS", position: new BABYLON.Vector3(-8, 0.5, 22), jersey: "6" },
                { name: "Left Field", abbr: "LF", position: new BABYLON.Vector3(-28, 0.5, 50), jersey: "7" },
                { name: "Center Field", abbr: "CF", position: new BABYLON.Vector3(0, 0.5, 60), jersey: "8" },
                { name: "Right Field", abbr: "RF", position: new BABYLON.Vector3(28, 0.5, 50), jersey: "9" }
            ];

            createPlayers(defaultPositions);

            // Render loop
            baseballDiamondEngine.runRenderLoop(() => {
                baseballDiamondScene.render();
            });

            // Resize handling
            window.addEventListener('resize', () => {
                baseballDiamondEngine.resize();
            });
        }

        function createField() {
            // Infield dirt (diamond shape)
            const infieldPoints = [
                new BABYLON.Vector3(0, 0, 0),      // Home plate
                new BABYLON.Vector3(21, 0, 21),    // First base extended
                new BABYLON.Vector3(0, 0, 30),     // Behind second base
                new BABYLON.Vector3(-21, 0, 21),   // Third base extended
            ];

            const infield = BABYLON.MeshBuilder.CreatePolygon(
                "infield",
                { shape: infieldPoints, sideOrientation: BABYLON.Mesh.DOUBLESIDE },
                baseballDiamondScene
            );
            infield.position.y = 0.1;

            const infieldMaterial = new BABYLON.StandardMaterial("infieldMat", baseballDiamondScene);
            infieldMaterial.diffuseColor = new BABYLON.Color3(0.76, 0.6, 0.42); // Dirt brown
            infieldMaterial.specularColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            infield.material = infieldMaterial;

            // Grass outfield (large circle)
            const outfield = BABYLON.MeshBuilder.CreateDisc(
                "outfield",
                { radius: 80, tessellation: 64 },
                baseballDiamondScene
            );
            outfield.rotation.x = Math.PI / 2;

            const outfieldMaterial = new BABYLON.StandardMaterial("outfieldMat", baseballDiamondScene);
            outfieldMaterial.diffuseColor = new BABYLON.Color3(0.13, 0.55, 0.13); // Grass green
            outfieldMaterial.specularColor = new BABYLON.Color3(0.05, 0.05, 0.05);
            outfield.material = outfieldMaterial;
        }

        function createBases() {
            const baseSize = 1.2;
            const baseMaterial = new BABYLON.StandardMaterial("baseMat", baseballDiamondScene);
            baseMaterial.diffuseColor = new BABYLON.Color3(0.95, 0.95, 0.95); // White
            baseMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.2, 0.2);

            // Home plate (pentagon shape)
            const homePlate = BABYLON.MeshBuilder.CreateBox(
                "homePlate",
                { size: baseSize },
                baseballDiamondScene
            );
            homePlate.position = new BABYLON.Vector3(0, 0.2, 0);
            homePlate.material = baseMaterial;

            // First base
            const firstBase = BABYLON.MeshBuilder.CreateBox(
                "firstBase",
                { size: baseSize },
                baseballDiamondScene
            );
            firstBase.position = new BABYLON.Vector3(18.29, 0.2, 18.29); // 90 feet from home
            firstBase.material = baseMaterial;

            // Second base
            const secondBase = BABYLON.MeshBuilder.CreateBox(
                "secondBase",
                { size: baseSize },
                baseballDiamondScene
            );
            secondBase.position = new BABYLON.Vector3(0, 0.2, 25.87);
            secondBase.material = baseMaterial;

            // Third base
            const thirdBase = BABYLON.MeshBuilder.CreateBox(
                "thirdBase",
                { size: baseSize },
                baseballDiamondScene
            );
            thirdBase.position = new BABYLON.Vector3(-18.29, 0.2, 18.29);
            thirdBase.material = baseMaterial;
        }

        function createPitchersMound() {
            const mound = BABYLON.MeshBuilder.CreateCylinder(
                "pitchersMound",
                { height: 0.4, diameter: 4 },
                baseballDiamondScene
            );
            mound.position = new BABYLON.Vector3(0, 0.2, 10.17); // 60.5 feet from home

            const moundMaterial = new BABYLON.StandardMaterial("moundMat", baseballDiamondScene);
            moundMaterial.diffuseColor = new BABYLON.Color3(0.65, 0.5, 0.35);
            mound.material = moundMaterial;

            // Pitching rubber
            const rubber = BABYLON.MeshBuilder.CreateBox(
                "rubber",
                { width: 1.5, height: 0.1, depth: 0.5 },
                baseballDiamondScene
            );
            rubber.position = new BABYLON.Vector3(0, 0.45, 10.17);

            const rubberMaterial = new BABYLON.StandardMaterial("rubberMat", baseballDiamondScene);
            rubberMaterial.diffuseColor = new BABYLON.Color3(0.9, 0.9, 0.9);
            rubber.material = rubberMaterial;
        }

        function createFoulLines() {
            const lineMaterial = new BABYLON.StandardMaterial("lineMat", baseballDiamondScene);
            lineMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
            lineMaterial.emissiveColor = new BABYLON.Color3(0.3, 0.3, 0.3);

            // First base foul line
            const firstBaseLine = BABYLON.MeshBuilder.CreateBox(
                "firstBaseLine",
                { width: 0.3, height: 0.1, depth: 80 },
                baseballDiamondScene
            );
            firstBaseLine.position = new BABYLON.Vector3(20, 0.15, 40);
            firstBaseLine.rotation.y = -Math.PI / 4;
            firstBaseLine.material = lineMaterial;

            // Third base foul line
            const thirdBaseLine = BABYLON.MeshBuilder.CreateBox(
                "thirdBaseLine",
                { width: 0.3, height: 0.1, depth: 80 },
                baseballDiamondScene
            );
            thirdBaseLine.position = new BABYLON.Vector3(-20, 0.15, 40);
            thirdBaseLine.rotation.y = Math.PI / 4;
            thirdBaseLine.material = lineMaterial;
        }

        function createOutfield() {
            // Outfield wall (arc)
            const wallMaterial = new BABYLON.StandardMaterial("wallMat", baseballDiamondScene);
            wallMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.3, 0.2); // Dark green
            wallMaterial.emissiveColor = new BABYLON.Color3(0.05, 0.1, 0.05);

            const wall = BABYLON.MeshBuilder.CreateTorus(
                "outfieldWall",
                { diameter: 150, thickness: 2, tessellation: 64 },
                baseballDiamondScene
            );
            wall.rotation.x = Math.PI / 2;
            wall.position.z = 15;
            wall.material = wallMaterial;
        }

        function createPlayers(positions) {
            // Clear existing player meshes
            playerMeshes.forEach(mesh => mesh.dispose());
            playerMeshes = [];

            positions.forEach(player => {
                // Player marker (sphere)
                const playerMesh = BABYLON.MeshBuilder.CreateSphere(
                    `player_${player.abbr}`,
                    { diameter: 2 },
                    baseballDiamondScene
                );
                playerMesh.position = player.position;

                const playerMaterial = new BABYLON.StandardMaterial(`playerMat_${player.abbr}`, baseballDiamondScene);
                playerMaterial.diffuseColor = new BABYLON.Color3(0.75, 0.34, 0); // Blaze orange
                playerMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.1, 0);
                playerMaterial.specularColor = new BABYLON.Color3(1, 0.5, 0);
                playerMesh.material = playerMaterial;

                // Add glow effect
                const glow = new BABYLON.GlowLayer("glow", baseballDiamondScene);
                glow.intensity = 0.4;

                // Player label (text plane)
                const labelPlane = BABYLON.MeshBuilder.CreatePlane(
                    `label_${player.abbr}`,
                    { width: 6, height: 2 },
                    baseballDiamondScene
                );
                labelPlane.position = new BABYLON.Vector3(
                    player.position.x,
                    player.position.y + 2,
                    player.position.z
                );
                labelPlane.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;

                // Create dynamic texture for label
                const labelTexture = new BABYLON.DynamicTexture(
                    `labelTexture_${player.abbr}`,
                    { width: 512, height: 256 },
                    baseballDiamondScene
                );

                const ctx = labelTexture.getContext();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, 512, 256);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 60px Inter, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(player.abbr, 256, 100);
                ctx.font = '40px Inter, sans-serif';
                ctx.fillText(`#${player.jersey}`, 256, 180);
                labelTexture.update();

                const labelMaterial = new BABYLON.StandardMaterial(`labelMat_${player.abbr}`, baseballDiamondScene);
                labelMaterial.diffuseTexture = labelTexture;
                labelMaterial.emissiveTexture = labelTexture;
                labelMaterial.opacityTexture = labelTexture;
                labelPlane.material = labelMaterial;

                // Store mesh references
                playerMeshes.push(playerMesh, labelPlane);

                // Interactive hover effect
                playerMesh.actionManager = new BABYLON.ActionManager(baseballDiamondScene);
                playerMesh.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPointerOverTrigger,
                        () => {
                            playerMesh.scaling = new BABYLON.Vector3(1.3, 1.3, 1.3);
                            playerMaterial.emissiveColor = new BABYLON.Color3(0.5, 0.2, 0);
                        }
                    )
                );
                playerMesh.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPointerOutTrigger,
                        () => {
                            playerMesh.scaling = new BABYLON.Vector3(1, 1, 1);
                            playerMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.1, 0);
                        }
                    )
                );
            });
        }

        // Initialize on page load (but don't render until user shows the diamond)
        document.addEventListener('DOMContentLoaded', () => {
            // Watch for the show3DDiamond state change
            const observer = new MutationObserver(() => {
                const canvas = document.getElementById('baseball-diamond-3d');
                if (canvas && canvas.offsetParent !== null && !baseballDiamondEngine) {
                    createBaseballDiamond();
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true
            });
        });
    </script>

    <!-- Babylon.js 3D Football Field -->
    <script>
        let footballFieldEngine = null;
        let footballFieldScene = null;
        let footballPlayerMeshes = [];
        let currentFormation = 'offense-shotgun';

        // Formation definitions (positions in yards from line of scrimmage at 50-yard line)
        const formations = {
            'offense-shotgun': [
                { name: "QB", position: new BABYLON.Vector3(0, 0.5, -5), color: 'red' },
                { name: "C", position: new BABYLON.Vector3(0, 0.5, 0), color: 'red' },
                { name: "LG", position: new BABYLON.Vector3(-1.5, 0.5, 0), color: 'red' },
                { name: "RG", position: new BABYLON.Vector3(1.5, 0.5, 0), color: 'red' },
                { name: "LT", position: new BABYLON.Vector3(-3, 0.5, 0), color: 'red' },
                { name: "RT", position: new BABYLON.Vector3(3, 0.5, 0), color: 'red' },
                { name: "WR1", position: new BABYLON.Vector3(-8, 0.5, 0), color: 'red' },
                { name: "WR2", position: new BABYLON.Vector3(8, 0.5, 0), color: 'red' },
                { name: "RB", position: new BABYLON.Vector3(-2, 0.5, -5), color: 'red' },
                { name: "TE", position: new BABYLON.Vector3(4, 0.5, 0), color: 'red' },
                { name: "SLOT", position: new BABYLON.Vector3(-5, 0.5, -1), color: 'red' }
            ],
            'offense-i-formation': [
                { name: "QB", position: new BABYLON.Vector3(0, 0.5, -2), color: 'red' },
                { name: "C", position: new BABYLON.Vector3(0, 0.5, 0), color: 'red' },
                { name: "LG", position: new BABYLON.Vector3(-1.5, 0.5, 0), color: 'red' },
                { name: "RG", position: new BABYLON.Vector3(1.5, 0.5, 0), color: 'red' },
                { name: "LT", position: new BABYLON.Vector3(-3, 0.5, 0), color: 'red' },
                { name: "RT", position: new BABYLON.Vector3(3, 0.5, 0), color: 'red' },
                { name: "FB", position: new BABYLON.Vector3(0, 0.5, -5), color: 'red' },
                { name: "RB", position: new BABYLON.Vector3(0, 0.5, -7), color: 'red' },
                { name: "WR1", position: new BABYLON.Vector3(-8, 0.5, 0), color: 'red' },
                { name: "WR2", position: new BABYLON.Vector3(8, 0.5, 0), color: 'red' },
                { name: "TE", position: new BABYLON.Vector3(4, 0.5, 0), color: 'red' }
            ],
            'offense-singleback': [
                { name: "QB", position: new BABYLON.Vector3(0, 0.5, -2), color: 'red' },
                { name: "C", position: new BABYLON.Vector3(0, 0.5, 0), color: 'red' },
                { name: "LG", position: new BABYLON.Vector3(-1.5, 0.5, 0), color: 'red' },
                { name: "RG", position: new BABYLON.Vector3(1.5, 0.5, 0), color: 'red' },
                { name: "LT", position: new BABYLON.Vector3(-3, 0.5, 0), color: 'red' },
                { name: "RT", position: new BABYLON.Vector3(3, 0.5, 0), color: 'red' },
                { name: "RB", position: new BABYLON.Vector3(0, 0.5, -6), color: 'red' },
                { name: "WR1", position: new BABYLON.Vector3(-10, 0.5, 0), color: 'red' },
                { name: "WR2", position: new BABYLON.Vector3(10, 0.5, 0), color: 'red' },
                { name: "TE1", position: new BABYLON.Vector3(4, 0.5, 0), color: 'red' },
                { name: "TE2", position: new BABYLON.Vector3(-4, 0.5, 0), color: 'red' }
            ],
            'offense-pistol': [
                { name: "QB", position: new BABYLON.Vector3(0, 0.5, -3), color: 'red' },
                { name: "C", position: new BABYLON.Vector3(0, 0.5, 0), color: 'red' },
                { name: "LG", position: new BABYLON.Vector3(-1.5, 0.5, 0), color: 'red' },
                { name: "RG", position: new BABYLON.Vector3(1.5, 0.5, 0), color: 'red' },
                { name: "LT", position: new BABYLON.Vector3(-3, 0.5, 0), color: 'red' },
                { name: "RT", position: new BABYLON.Vector3(3, 0.5, 0), color: 'red' },
                { name: "RB", position: new BABYLON.Vector3(0, 0.5, -6), color: 'red' },
                { name: "WR1", position: new BABYLON.Vector3(-9, 0.5, 0), color: 'red' },
                { name: "WR2", position: new BABYLON.Vector3(9, 0.5, 0), color: 'red' },
                { name: "WR3", position: new BABYLON.Vector3(6, 0.5, -1), color: 'red' },
                { name: "TE", position: new BABYLON.Vector3(4, 0.5, 0), color: 'red' }
            ],
            'defense-4-3': [
                { name: "DT1", position: new BABYLON.Vector3(-1, 0.5, 1), color: 'blue' },
                { name: "DT2", position: new BABYLON.Vector3(1, 0.5, 1), color: 'blue' },
                { name: "DE1", position: new BABYLON.Vector3(-3.5, 0.5, 1), color: 'blue' },
                { name: "DE2", position: new BABYLON.Vector3(3.5, 0.5, 1), color: 'blue' },
                { name: "MLB", position: new BABYLON.Vector3(0, 0.5, 4), color: 'blue' },
                { name: "OLB1", position: new BABYLON.Vector3(-4, 0.5, 3), color: 'blue' },
                { name: "OLB2", position: new BABYLON.Vector3(4, 0.5, 3), color: 'blue' },
                { name: "CB1", position: new BABYLON.Vector3(-10, 0.5, 6), color: 'blue' },
                { name: "CB2", position: new BABYLON.Vector3(10, 0.5, 6), color: 'blue' },
                { name: "FS", position: new BABYLON.Vector3(0, 0.5, 12), color: 'blue' },
                { name: "SS", position: new BABYLON.Vector3(2, 0.5, 10), color: 'blue' }
            ],
            'defense-3-4': [
                { name: "NT", position: new BABYLON.Vector3(0, 0.5, 1), color: 'blue' },
                { name: "DE1", position: new BABYLON.Vector3(-2.5, 0.5, 1), color: 'blue' },
                { name: "DE2", position: new BABYLON.Vector3(2.5, 0.5, 1), color: 'blue' },
                { name: "ILB1", position: new BABYLON.Vector3(-1, 0.5, 4), color: 'blue' },
                { name: "ILB2", position: new BABYLON.Vector3(1, 0.5, 4), color: 'blue' },
                { name: "OLB1", position: new BABYLON.Vector3(-5, 0.5, 2), color: 'blue' },
                { name: "OLB2", position: new BABYLON.Vector3(5, 0.5, 2), color: 'blue' },
                { name: "CB1", position: new BABYLON.Vector3(-10, 0.5, 6), color: 'blue' },
                { name: "CB2", position: new BABYLON.Vector3(10, 0.5, 6), color: 'blue' },
                { name: "FS", position: new BABYLON.Vector3(0, 0.5, 12), color: 'blue' },
                { name: "SS", position: new BABYLON.Vector3(2, 0.5, 10), color: 'blue' }
            ],
            'defense-nickel': [
                { name: "DT1", position: new BABYLON.Vector3(-1, 0.5, 1), color: 'blue' },
                { name: "DT2", position: new BABYLON.Vector3(1, 0.5, 1), color: 'blue' },
                { name: "DE1", position: new BABYLON.Vector3(-3.5, 0.5, 1), color: 'blue' },
                { name: "DE2", position: new BABYLON.Vector3(3.5, 0.5, 1), color: 'blue' },
                { name: "MLB", position: new BABYLON.Vector3(0, 0.5, 4), color: 'blue' },
                { name: "OLB", position: new BABYLON.Vector3(-4, 0.5, 3), color: 'blue' },
                { name: "CB1", position: new BABYLON.Vector3(-12, 0.5, 6), color: 'blue' },
                { name: "CB2", position: new BABYLON.Vector3(12, 0.5, 6), color: 'blue' },
                { name: "NICK", position: new BABYLON.Vector3(-6, 0.5, 4), color: 'blue' },
                { name: "FS", position: new BABYLON.Vector3(0, 0.5, 12), color: 'blue' },
                { name: "SS", position: new BABYLON.Vector3(2, 0.5, 10), color: 'blue' }
            ],
            'defense-dime': [
                { name: "DT1", position: new BABYLON.Vector3(-1, 0.5, 1), color: 'blue' },
                { name: "DT2", position: new BABYLON.Vector3(1, 0.5, 1), color: 'blue' },
                { name: "DE1", position: new BABYLON.Vector3(-3, 0.5, 1), color: 'blue' },
                { name: "DE2", position: new BABYLON.Vector3(3, 0.5, 1), color: 'blue' },
                { name: "LB", position: new BABYLON.Vector3(0, 0.5, 3), color: 'blue' },
                { name: "CB1", position: new BABYLON.Vector3(-14, 0.5, 6), color: 'blue' },
                { name: "CB2", position: new BABYLON.Vector3(14, 0.5, 6), color: 'blue' },
                { name: "CB3", position: new BABYLON.Vector3(-8, 0.5, 5), color: 'blue' },
                { name: "CB4", position: new BABYLON.Vector3(8, 0.5, 5), color: 'blue' },
                { name: "FS", position: new BABYLON.Vector3(-3, 0.5, 12), color: 'blue' },
                { name: "SS", position: new BABYLON.Vector3(3, 0.5, 12), color: 'blue' }
            ],
            'defense-prevent': [
                { name: "DL1", position: new BABYLON.Vector3(-2, 0.5, 1), color: 'blue' },
                { name: "DL2", position: new BABYLON.Vector3(0, 0.5, 1), color: 'blue' },
                { name: "DL3", position: new BABYLON.Vector3(2, 0.5, 1), color: 'blue' },
                { name: "LB", position: new BABYLON.Vector3(0, 0.5, 4), color: 'blue' },
                { name: "CB1", position: new BABYLON.Vector3(-15, 0.5, 8), color: 'blue' },
                { name: "CB2", position: new BABYLON.Vector3(15, 0.5, 8), color: 'blue' },
                { name: "CB3", position: new BABYLON.Vector3(-10, 0.5, 6), color: 'blue' },
                { name: "CB4", position: new BABYLON.Vector3(10, 0.5, 6), color: 'blue' },
                { name: "FS1", position: new BABYLON.Vector3(-5, 0.5, 15), color: 'blue' },
                { name: "FS2", position: new BABYLON.Vector3(5, 0.5, 15), color: 'blue' },
                { name: "FS3", position: new BABYLON.Vector3(0, 0.5, 18), color: 'blue' }
            ]
        };

        function createFootballField() {
            const canvas = document.getElementById('football-field-3d');
            if (!canvas || typeof BABYLON === 'undefined') return;

            if (footballFieldEngine) {
                footballFieldEngine.dispose();
            }

            footballFieldEngine = new BABYLON.Engine(canvas, true, {
                preserveDrawingBuffer: true,
                stencil: true,
                antialias: true
            });

            footballFieldScene = new BABYLON.Scene(footballFieldEngine);
            footballFieldScene.clearColor = new BABYLON.Color4(0.05, 0.15, 0.05, 1);

            // Expose scene globally for React integration
            window.footballFieldScene = footballFieldScene;

            // Camera positioned above and behind offense
            const camera = new BABYLON.ArcRotateCamera(
                "camera",
                -Math.PI / 2,
                Math.PI / 3,
                80,
                new BABYLON.Vector3(0, 0, 0),
                footballFieldScene
            );
            camera.attachControl(canvas, true);
            camera.lowerRadiusLimit = 40;
            camera.upperRadiusLimit = 150;
            camera.lowerBetaLimit = 0.1;
            camera.upperBetaLimit = Math.PI / 2;

            // Lighting
            const hemisphericLight = new BABYLON.HemisphericLight(
                "hemiLight",
                new BABYLON.Vector3(0, 1, 0),
                footballFieldScene
            );
            hemisphericLight.intensity = 0.8;

            const directionalLight = new BABYLON.DirectionalLight(
                "dirLight",
                new BABYLON.Vector3(-0.5, -1, -0.5),
                footballFieldScene
            );
            directionalLight.intensity = 0.6;

            // Stadium lights
            for (let i = 0; i < 4; i++) {
                const light = new BABYLON.PointLight(
                    `stadiumLight${i}`,
                    new BABYLON.Vector3(
                        i % 2 === 0 ? -30 : 30,
                        50,
                        i < 2 ? -40 : 40
                    ),
                    footballFieldScene
                );
                light.intensity = 0.3;
            }

            // Create field
            createFootballFieldGround();
            createYardLines();
            createHashMarks();
            createEndZones();
            createGoalPosts();

            // Create players for default formation
            updateFormation('offense-shotgun');

            // Render loop
            footballFieldEngine.runRenderLoop(() => {
                footballFieldScene.render();
            });

            window.addEventListener('resize', () => {
                footballFieldEngine.resize();
            });
        }

        function createFootballFieldGround() {
            // Main field (120 yards including end zones)
            const field = BABYLON.MeshBuilder.CreateGround(
                "field",
                { width: 35, height: 120 },
                footballFieldScene
            );
            field.rotation.x = Math.PI;

            const fieldMaterial = new BABYLON.StandardMaterial("fieldMat", footballFieldScene);
            fieldMaterial.diffuseColor = new BABYLON.Color3(0.13, 0.55, 0.13); // Grass green
            fieldMaterial.specularColor = new BABYLON.Color3(0.05, 0.05, 0.05);
            field.material = fieldMaterial;
        }

        function createYardLines() {
            const lineMaterial = new BABYLON.StandardMaterial("lineMat", footballFieldScene);
            lineMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
            lineMaterial.emissiveColor = new BABYLON.Color3(0.4, 0.4, 0.4);

            // Yard lines every 5 yards (100 yards total)
            for (let yard = -50; yard <= 50; yard += 5) {
                const line = BABYLON.MeshBuilder.CreateBox(
                    `yardline_${yard}`,
                    { width: 35, height: 0.1, depth: 0.3 },
                    footballFieldScene
                );
                line.position = new BABYLON.Vector3(0, 0.1, yard);
                line.material = lineMaterial;

                // Add yard number labels for major lines
                if (yard % 10 === 0 && yard !== -50 && yard !== 50) {
                    const yardNumber = Math.abs(yard) === 50 ? 50 : Math.abs(yard);

                    // Left side number
                    const labelLeft = createFieldLabel(yardNumber.toString(), new BABYLON.Vector3(-12, 0.2, yard), 8);
                    // Right side number
                    const labelRight = createFieldLabel(yardNumber.toString(), new BABYLON.Vector3(12, 0.2, yard), 8);
                }
            }

            // Sidelines
            const sideline1 = BABYLON.MeshBuilder.CreateBox(
                "sideline1",
                { width: 0.3, height: 0.1, depth: 120 },
                footballFieldScene
            );
            sideline1.position = new BABYLON.Vector3(-17.5, 0.1, 0);
            sideline1.material = lineMaterial;

            const sideline2 = BABYLON.MeshBuilder.CreateBox(
                "sideline2",
                { width: 0.3, height: 0.1, depth: 120 },
                footballFieldScene
            );
            sideline2.position = new BABYLON.Vector3(17.5, 0.1, 0);
            sideline2.material = lineMaterial;
        }

        function createHashMarks() {
            const hashMaterial = new BABYLON.StandardMaterial("hashMat", footballFieldScene);
            hashMaterial.diffuseColor = new BABYLON.Color3(1, 1, 1);
            hashMaterial.emissiveColor = new BABYLON.Color3(0.3, 0.3, 0.3);

            // Hash marks every yard
            for (let yard = -49; yard <= 49; yard++) {
                // Left hash
                const hashLeft = BABYLON.MeshBuilder.CreateBox(
                    `hash_left_${yard}`,
                    { width: 2, height: 0.1, depth: 0.2 },
                    footballFieldScene
                );
                hashLeft.position = new BABYLON.Vector3(-3, 0.1, yard);
                hashLeft.material = hashMaterial;

                // Right hash
                const hashRight = BABYLON.MeshBuilder.CreateBox(
                    `hash_right_${yard}`,
                    { width: 2, height: 0.1, depth: 0.2 },
                    footballFieldScene
                );
                hashRight.position = new BABYLON.Vector3(3, 0.1, yard);
                hashRight.material = hashMaterial;
            }
        }

        function createEndZones() {
            const endzoneOffenseMaterial = new BABYLON.StandardMaterial("endzoneOffenseMat", footballFieldScene);
            endzoneOffenseMaterial.diffuseColor = new BABYLON.Color3(0.75, 0.2, 0.2); // Red
            endzoneOffenseMaterial.alpha = 0.3;

            const endzoneDefenseMaterial = new BABYLON.StandardMaterial("endzoneDefenseMat", footballFieldScene);
            endzoneDefenseMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.75); // Blue
            endzoneDefenseMaterial.alpha = 0.3;

            // Offense end zone
            const endzoneOffense = BABYLON.MeshBuilder.CreateGround(
                "endzoneOffense",
                { width: 35, height: 10 },
                footballFieldScene
            );
            endzoneOffense.position = new BABYLON.Vector3(0, 0.05, -55);
            endzoneOffense.material = endzoneOffenseMaterial;

            // Defense end zone
            const endzoneDefense = BABYLON.MeshBuilder.CreateGround(
                "endzoneDefense",
                { width: 35, height: 10 },
                footballFieldScene
            );
            endzoneDefense.position = new BABYLON.Vector3(0, 0.05, 55);
            endzoneDefense.material = endzoneDefenseMaterial;
        }

        function createGoalPosts() {
            const postMaterial = new BABYLON.StandardMaterial("postMat", footballFieldScene);
            postMaterial.diffuseColor = new BABYLON.Color3(0.95, 0.77, 0.06); // Yellow/gold
            postMaterial.emissiveColor = new BABYLON.Color3(0.2, 0.15, 0.01);

            // Offense goal post
            const postOffense = BABYLON.MeshBuilder.CreateCylinder(
                "postOffense",
                { height: 15, diameter: 0.4 },
                footballFieldScene
            );
            postOffense.position = new BABYLON.Vector3(0, 7.5, -60);
            postOffense.material = postMaterial;

            // Crossbar
            const crossbarOffense = BABYLON.MeshBuilder.CreateBox(
                "crossbarOffense",
                { width: 18.5, height: 0.3, depth: 0.3 },
                footballFieldScene
            );
            crossbarOffense.position = new BABYLON.Vector3(0, 10, -60);
            crossbarOffense.material = postMaterial;

            // Uprights
            const uprightOffense1 = BABYLON.MeshBuilder.CreateCylinder(
                "uprightOffense1",
                { height: 10, diameter: 0.3 },
                footballFieldScene
            );
            uprightOffense1.position = new BABYLON.Vector3(-9.25, 15, -60);
            uprightOffense1.material = postMaterial;

            const uprightOffense2 = BABYLON.MeshBuilder.CreateCylinder(
                "uprightOffense2",
                { height: 10, diameter: 0.3 },
                footballFieldScene
            );
            uprightOffense2.position = new BABYLON.Vector3(9.25, 15, -60);
            uprightOffense2.material = postMaterial;

            // Defense goal post (mirror)
            const postDefense = postOffense.clone("postDefense");
            postDefense.position = new BABYLON.Vector3(0, 7.5, 60);

            const crossbarDefense = crossbarOffense.clone("crossbarDefense");
            crossbarDefense.position = new BABYLON.Vector3(0, 10, 60);

            const uprightDefense1 = uprightOffense1.clone("uprightDefense1");
            uprightDefense1.position = new BABYLON.Vector3(-9.25, 15, 60);

            const uprightDefense2 = uprightOffense2.clone("uprightDefense2");
            uprightDefense2.position = new BABYLON.Vector3(9.25, 15, 60);
        }

        function createFieldLabel(text, position, size) {
            const labelPlane = BABYLON.MeshBuilder.CreatePlane(
                `label_${text}_${position.x}_${position.z}`,
                { width: size, height: size * 0.5 },
                footballFieldScene
            );
            labelPlane.position = position;
            labelPlane.rotation.x = Math.PI / 2;

            const labelTexture = new BABYLON.DynamicTexture(
                `labelTexture_${text}`,
                { width: 512, height: 256 },
                footballFieldScene
            );

            const ctx = labelTexture.getContext();
            ctx.fillStyle = 'white';
            ctx.font = 'bold 140px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, 256, 180);
            labelTexture.update();

            const labelMaterial = new BABYLON.StandardMaterial(`labelMat_${text}`, footballFieldScene);
            labelMaterial.diffuseTexture = labelTexture;
            labelMaterial.emissiveTexture = labelTexture;
            labelMaterial.opacityTexture = labelTexture;
            labelPlane.material = labelMaterial;

            return labelPlane;
        }

        function updateFormation(formationKey) {
            currentFormation = formationKey;

            // Clear existing players
            footballPlayerMeshes.forEach(mesh => mesh.dispose());
            footballPlayerMeshes = [];

            const formation = formations[formationKey];
            if (!formation) return;

            formation.forEach(player => {
                // Player sphere
                const playerMesh = BABYLON.MeshBuilder.CreateSphere(
                    `player_${player.name}`,
                    { diameter: 1.8 },
                    footballFieldScene
                );
                playerMesh.position = player.position;

                const playerMaterial = new BABYLON.StandardMaterial(`playerMat_${player.name}`, footballFieldScene);
                if (player.color === 'red') {
                    playerMaterial.diffuseColor = new BABYLON.Color3(0.9, 0.2, 0.2); // Red offense
                    playerMaterial.emissiveColor = new BABYLON.Color3(0.3, 0.05, 0.05);
                } else {
                    playerMaterial.diffuseColor = new BABYLON.Color3(0.2, 0.4, 0.9); // Blue defense
                    playerMaterial.emissiveColor = new BABYLON.Color3(0.05, 0.1, 0.3);
                }
                playerMaterial.specularColor = new BABYLON.Color3(0.8, 0.8, 0.8);
                playerMesh.material = playerMaterial;

                // Player label
                const labelPlane = BABYLON.MeshBuilder.CreatePlane(
                    `label_${player.name}`,
                    { width: 4, height: 1.5 },
                    footballFieldScene
                );
                labelPlane.position = new BABYLON.Vector3(
                    player.position.x,
                    player.position.y + 1.5,
                    player.position.z
                );
                labelPlane.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;

                const labelTexture = new BABYLON.DynamicTexture(
                    `labelTexture_${player.name}`,
                    { width: 512, height: 256 },
                    footballFieldScene
                );

                const ctx = labelTexture.getContext();
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, 512, 256);
                ctx.fillStyle = 'white';
                ctx.font = 'bold 70px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, 256, 160);
                labelTexture.update();

                const labelMaterial = new BABYLON.StandardMaterial(`labelMat_${player.name}`, footballFieldScene);
                labelMaterial.diffuseTexture = labelTexture;
                labelMaterial.emissiveTexture = labelTexture;
                labelMaterial.opacityTexture = labelTexture;
                labelPlane.material = labelMaterial;

                footballPlayerMeshes.push(playerMesh, labelPlane);

                // Hover effect
                playerMesh.actionManager = new BABYLON.ActionManager(footballFieldScene);
                playerMesh.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPointerOverTrigger,
                        () => {
                            playerMesh.scaling = new BABYLON.Vector3(1.4, 1.4, 1.4);
                            if (player.color === 'red') {
                                playerMaterial.emissiveColor = new BABYLON.Color3(0.6, 0.1, 0.1);
                            } else {
                                playerMaterial.emissiveColor = new BABYLON.Color3(0.1, 0.2, 0.6);
                            }
                        }
                    )
                );
                playerMesh.actionManager.registerAction(
                    new BABYLON.ExecuteCodeAction(
                        BABYLON.ActionManager.OnPointerOutTrigger,
                        () => {
                            playerMesh.scaling = new BABYLON.Vector3(1, 1, 1);
                            if (player.color === 'red') {
                                playerMaterial.emissiveColor = new BABYLON.Color3(0.3, 0.05, 0.05);
                            } else {
                                playerMaterial.emissiveColor = new BABYLON.Color3(0.05, 0.1, 0.3);
                            }
                        }
                    )
                );
            });
        }

        // Listen for formation changes from React
        document.addEventListener('DOMContentLoaded', () => {
            const observer = new MutationObserver(() => {
                const canvas = document.getElementById('football-field-3d');
                if (canvas && canvas.offsetParent !== null && !footballFieldEngine) {
                    createFootballField();
                }
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true,
                attributes: true
            });

            // Listen for formation changes
            window.addEventListener('formationChanged', (e) => {
                if (footballFieldScene && e.detail) {
                    updateFormation(e.detail);
                }
            });
        });

        // Hook into React state changes for formation updates
        if (typeof window !== 'undefined') {
            const originalSetState = window.React?.Component?.prototype?.setState;
            if (originalSetState) {
                window.React.Component.prototype.setState = function(...args) {
                    const result = originalSetState.apply(this, args);
                    if (this.state?.selectedFormation && this.state.selectedFormation !== currentFormation) {
                        window.dispatchEvent(new CustomEvent('formationChanged', {
                            detail: this.state.selectedFormation
                        }));
                    }
                    return result;
                };
            }
        }
    </script>
</body>
</html>
