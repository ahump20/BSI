<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Photo Management | Blaze Sports Intel Admin</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --burnt-orange: #BF5700;
      --ember: #FF6B35;
      --charcoal: #1A1A1A;
      --midnight: #0D0D0D;
      --cream: #FAF8F5;
      --gold: #C9A227;
      --success: #2E7D32;
      --warning: #F9A825;
      --error: #C62828;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --border: #374151;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--midnight);
      color: var(--text-primary);
      min-height: 100vh;
    }
    .header {
      background: var(--charcoal);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--burnt-orange);
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }
    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .nav-links a:hover, .nav-links a.active { color: var(--burnt-orange); }

    .auth-screen {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 16px;
      text-align: center;
    }
    .auth-screen h1 { font-size: 24px; margin-bottom: 8px; }
    .auth-screen p { color: var(--text-secondary); margin-bottom: 24px; }
    .auth-screen input {
      width: 100%;
      padding: 12px 16px;
      background: var(--midnight);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 16px;
    }
    .auth-screen input:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: var(--burnt-orange);
      color: white;
    }
    .btn-primary:hover { background: var(--ember); }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .btn-secondary:hover {
      border-color: var(--burnt-orange);
      color: var(--burnt-orange);
    }
    .btn-danger {
      background: rgba(198, 40, 40, 0.2);
      border: 1px solid #C62828;
      color: #ef5350;
      padding: 8px 12px;
      font-size: 12px;
    }
    .btn-danger:hover {
      background: #C62828;
      color: white;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
    }

    /* Upload Form */
    .upload-section {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .upload-section h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: var(--gold);
    }
    .upload-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group label {
      font-size: 13px;
      color: var(--text-secondary);
    }
    .form-group input, .form-group select {
      padding: 10px 14px;
      background: var(--midnight);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .form-group input[type="file"] {
      padding: 8px;
    }
    .upload-btn {
      grid-column: span 2;
      justify-self: start;
    }
    .upload-status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      display: none;
    }
    .upload-status.success {
      display: block;
      background: rgba(46, 125, 50, 0.2);
      border: 1px solid var(--success);
      color: #81c784;
    }
    .upload-status.error {
      display: block;
      background: rgba(198, 40, 40, 0.2);
      border: 1px solid var(--error);
      color: #ef5350;
    }

    /* Photo Grid */
    .photos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }
    .photo-card {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .photo-card:hover {
      border-color: var(--burnt-orange);
    }
    .photo-card img {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: var(--midnight);
    }
    .photo-card .info {
      padding: 14px;
    }
    .photo-card .player-name {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 4px;
    }
    .photo-card .school-name {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }
    .photo-card .meta {
      font-size: 11px;
      color: var(--text-secondary);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .photo-card .actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .search-bar input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .search-bar input:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }

    /* Stats */
    .stats {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .stat-card {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px 20px;
      min-width: 120px;
    }
    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--burnt-orange);
    }
    .stat-card .label {
      font-size: 13px;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Blaze Sports Intel</a>
    <nav class="nav-links">
      <a href="/transfer-portal/admin">Portal Admin</a>
      <a href="/admin/photos" class="active">Photos</a>
      <a href="/admin/analytics">Analytics</a>
      <a href="/">Back to Site</a>
    </nav>
  </header>

  <!-- Auth Screen -->
  <div id="authScreen" class="auth-screen">
    <h1>Admin Access</h1>
    <p>Enter API key to manage player photos</p>
    <input type="password" id="apiKeyInput" placeholder="Enter Admin API Key" />
    <button class="btn btn-primary" onclick="authenticate()">Authenticate</button>
    <p id="authError" style="color: var(--error); margin-top: 12px; display: none;"></p>
  </div>

  <!-- Main Content -->
  <div id="mainContent" class="container" style="display: none;">
    <div class="page-header">
      <h1 class="page-title">Photo Management</h1>
    </div>

    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <div class="value" id="totalPhotos">0</div>
        <div class="label">Total Photos</div>
      </div>
      <div class="stat-card">
        <div class="value" id="recentUploads">0</div>
        <div class="label">Last 7 Days</div>
      </div>
    </div>

    <!-- Upload Section -->
    <section class="upload-section">
      <h2>Upload Player Photo</h2>
      <form id="uploadForm" class="upload-form">
        <div class="form-group">
          <label>Player Name *</label>
          <input type="text" id="playerName" required placeholder="e.g., John Smith" />
        </div>
        <div class="form-group">
          <label>School Name</label>
          <input type="text" id="schoolName" placeholder="e.g., Texas" />
        </div>
        <div class="form-group">
          <label>Player ID (from Portal)</label>
          <input type="text" id="playerId" placeholder="Optional - links to portal entry" />
        </div>
        <div class="form-group">
          <label>Photo File *</label>
          <input type="file" id="photoFile" accept="image/jpeg,image/png,image/webp" required />
        </div>
        <div class="upload-btn">
          <button type="submit" class="btn btn-primary">Upload Photo</button>
        </div>
      </form>
      <div id="uploadStatus" class="upload-status"></div>
    </section>

    <!-- Search -->
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="Search by player name..." />
      <button class="btn btn-secondary" onclick="loadPhotos()">Refresh</button>
    </div>

    <!-- Photos Grid -->
    <div id="photosGrid" class="photos-grid">
      <div class="loading">Loading photos...</div>
    </div>
  </div>

  <script>
    let API_KEY = '';

    function authenticate() {
      const key = document.getElementById('apiKeyInput').value.trim();
      if (!key) {
        showAuthError('Please enter an API key');
        return;
      }
      
      API_KEY = key;
      localStorage.setItem('bsi_admin_key', key);
      
      // Test the key by loading photos
      loadPhotos().then(success => {
        if (success) {
          document.getElementById('authScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
        } else {
          showAuthError('Invalid API key');
          localStorage.removeItem('bsi_admin_key');
        }
      });
    }

    function showAuthError(msg) {
      const el = document.getElementById('authError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    async function loadPhotos() {
      const searchTerm = document.getElementById('searchInput')?.value || '';
      let url = '/api/admin/photos?limit=100';
      if (searchTerm) {
        url += '&playerName=' + encodeURIComponent(searchTerm);
      }

      try {
        const res = await fetch(url, {
          headers: { 'Authorization': 'Bearer ' + API_KEY }
        });
        
        if (res.status === 401) {
          return false;
        }
        
        const data = await res.json();
        
        if (data.error) {
          document.getElementById('photosGrid').innerHTML = '<div class="empty-state"><h3>Error</h3><p>' + data.error + '</p></div>';
          return false;
        }

        const photos = data.photos || [];
        updateStats(photos);
        renderPhotos(photos);
        return true;
      } catch (err) {
        console.error('Error loading photos:', err);
        document.getElementById('photosGrid').innerHTML = '<div class="empty-state"><h3>Error Loading Photos</h3><p>' + err.message + '</p></div>';
        return false;
      }
    }

    function updateStats(photos) {
      document.getElementById('totalPhotos').textContent = photos.length;
      
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      const recent = photos.filter(p => new Date(p.uploaded_at) > weekAgo).length;
      document.getElementById('recentUploads').textContent = recent;
    }

    function renderPhotos(photos) {
      const grid = document.getElementById('photosGrid');
      
      if (photos.length === 0) {
        grid.innerHTML = '<div class="empty-state"><h3>No Photos Yet</h3><p>Upload player photos using the form above.</p></div>';
        return;
      }

      grid.innerHTML = photos.map(photo => `
        <div class="photo-card">
          <img src="${photo.r2_url || '/images/player-placeholder.png'}" alt="${photo.player_name}" onerror="this.src='/images/player-placeholder.png'" />
          <div class="info">
            <div class="player-name">${photo.player_name}</div>
            <div class="school-name">${photo.school_name || 'No school'}</div>
            <div class="meta">
              <span>${formatFileSize(photo.file_size)}</span>
              <span>${formatDate(photo.uploaded_at)}</span>
            </div>
            <div class="actions">
              <button class="btn btn-danger" onclick="deletePhoto(${photo.id}, '${photo.player_name}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function formatFileSize(bytes) {
      if (!bytes) return 'Unknown';
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    async function deletePhoto(id, playerName) {
      if (!confirm('Delete photo for ' + playerName + '?')) return;
      
      try {
        const res = await fetch('/api/admin/photos/' + id, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + API_KEY }
        });
        
        const data = await res.json();
        if (data.success) {
          loadPhotos();
        } else {
          alert('Failed to delete: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Error deleting photo: ' + err.message);
      }
    }

    document.getElementById('uploadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const statusEl = document.getElementById('uploadStatus');
      statusEl.className = 'upload-status';
      statusEl.style.display = 'none';
      
      const formData = new FormData();
      formData.append('playerName', document.getElementById('playerName').value);
      formData.append('schoolName', document.getElementById('schoolName').value);
      formData.append('playerId', document.getElementById('playerId').value);
      formData.append('photo', document.getElementById('photoFile').files[0]);
      formData.append('uploadedBy', 'admin');

      try {
        const res = await fetch('/api/admin/photos/upload', {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + API_KEY },
          body: formData
        });
        
        const data = await res.json();
        
        if (data.success) {
          statusEl.className = 'upload-status success';
          statusEl.textContent = 'Photo uploaded successfully!';
          statusEl.style.display = 'block';
          document.getElementById('uploadForm').reset();
          loadPhotos();
        } else {
          statusEl.className = 'upload-status error';
          statusEl.textContent = 'Upload failed: ' + (data.error || 'Unknown error');
          statusEl.style.display = 'block';
        }
      } catch (err) {
        statusEl.className = 'upload-status error';
        statusEl.textContent = 'Upload error: ' + err.message;
        statusEl.style.display = 'block';
      }
    });

    // Search on input
    document.getElementById('searchInput')?.addEventListener('input', debounce(loadPhotos, 300));

    function debounce(fn, ms) {
      let timeout;
      return function() {
        clearTimeout(timeout);
        timeout = setTimeout(fn, ms);
      };
    }

    // Check for saved key on load
    window.addEventListener('load', function() {
      const savedKey = localStorage.getItem('bsi_admin_key');
      if (savedKey) {
        API_KEY = savedKey;
        loadPhotos().then(success => {
          if (success) {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
          }
        });
      }
    });
  </script>
</body>
</html>
