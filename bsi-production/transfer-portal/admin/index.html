<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Transfer Portal Admin | Blaze Sports Intel</title>
  <link rel="icon" href="/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --burnt-orange: #BF5700;
      --ember: #FF6B35;
      --charcoal: #1A1A1A;
      --midnight: #0D0D0D;
      --cream: #FAF8F5;
      --gold: #C9A227;
      --success: #2E7D32;
      --warning: #F9A825;
      --error: #C62828;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --border: #374151;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--midnight);
      color: var(--text-primary);
      min-height: 100vh;
    }
    .header {
      background: var(--charcoal);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--burnt-orange);
      text-decoration: none;
    }
    .nav-links {
      display: flex;
      gap: 24px;
      align-items: center;
    }
    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .nav-links a:hover { color: var(--text-primary); }

    .auth-screen {
      max-width: 400px;
      margin: 100px auto;
      padding: 40px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 16px;
      text-align: center;
    }
    .auth-screen h1 {
      font-size: 24px;
      margin-bottom: 8px;
    }
    .auth-screen p {
      color: var(--text-secondary);
      margin-bottom: 24px;
    }
    .auth-screen input {
      width: 100%;
      padding: 12px 16px;
      background: var(--midnight);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 16px;
      margin-bottom: 16px;
    }
    .auth-screen input:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: var(--burnt-orange);
      color: white;
      width: 100%;
    }
    .btn-primary:hover { background: var(--ember); }
    .btn-export {
      background: transparent;
      border: 1px solid var(--gold);
      color: var(--gold);
      font-size: 12px;
      padding: 8px 14px;
    }
    .btn-export:hover {
      background: rgba(201, 162, 39, 0.15);
      border-color: var(--gold);
    }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .btn-secondary:hover {
      border-color: var(--burnt-orange);
      color: var(--burnt-orange);
    }
    .btn-danger {
      background: rgba(198, 40, 40, 0.2);
      border: 1px solid #C62828;
      color: #ef5350;
    }
    .btn-danger:hover {
      background: #C62828;
      color: white;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px;
    }
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .page-title {
      font-size: 28px;
      font-weight: 700;
    }
    .page-actions {
      display: flex;
      gap: 12px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      color: var(--ember);
    }

    .filter-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .search-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 16px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .filter-select {
      padding: 10px 16px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      min-width: 140px;
    }
    .filter-select:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }

    .table-container {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    .admin-table {
      width: 100%;
      border-collapse: collapse;
    }
    .admin-table th {
      padding: 12px 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid var(--border);
    }
    .admin-table td {
      padding: 12px 16px;
      font-size: 14px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      vertical-align: middle;
    }
    .admin-table tr:hover td {
      background: rgba(191, 87, 0, 0.05);
    }
    .admin-table tr:last-child td {
      border-bottom: none;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-badge.in-portal {
      background: rgba(249, 168, 37, 0.2);
      color: var(--warning);
    }
    .status-badge.committed {
      background: rgba(46, 125, 50, 0.2);
      color: var(--success);
    }
    .status-badge.withdrawn {
      background: rgba(198, 40, 40, 0.2);
      color: #ef5350;
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .position-badge {
      display: inline-block;
      padding: 3px 8px;
      background: rgba(191, 87, 0, 0.2);
      border-radius: 4px;
      font-size: 11px;
      font-family: monospace;
      color: var(--ember);
    }

    .actions-cell {
      display: flex;
      gap: 8px;
    }
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 16px;
      width: 90%;
      max-width: 700px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    .modal-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
    }
    .modal-close:hover { color: var(--text-primary); }
    .modal-body {
      padding: 24px;
    }
    .modal-footer {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .form-input, .form-select, .form-textarea {
      padding: 10px 14px;
      background: var(--midnight);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .form-textarea {
      resize: vertical;
      min-height: 80px;
    }
    .form-help {
      font-size: 11px;
      color: var(--text-secondary);
    }

    .form-section {
      grid-column: 1 / -1;
      font-size: 14px;
      font-weight: 600;
      color: var(--burnt-orange);
      margin-top: 8px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      padding: 14px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }
    .toast.success {
      background: var(--success);
      color: white;
    }
    .toast.error {
      background: var(--error);
      color: white;
    }
    .toast.hidden { display: none; }
    @keyframes slideIn {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .loading {
      text-align: center;
      padding: 60px 24px;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--burnt-orange);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .hidden { display: none; }

    .pagination {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
    }
    .pagination-info {
      font-size: 14px;
      color: var(--text-secondary);
    }
    .pagination-buttons {
      display: flex;
      gap: 8px;
    }

    .player-name-strong {
      font-weight: 600;
    }
    .player-year {
      font-size: 12px;
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
    }
    .school-conference {
      font-size: 12px;
      color: var(--text-secondary);
      display: block;
      margin-top: 2px;
    }
    .empty-text {
      color: var(--text-secondary);
    }
    .date-cell {
      font-family: monospace;
      font-size: 13px;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      .page-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }
      .filter-bar {
        flex-direction: column;
      }
      .admin-table {
        font-size: 12px;
      }
      .admin-table th, .admin-table td {
        padding: 8px 12px;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Blaze Sports Intel</a>
    <nav class="nav-links">
      <a href="/transfer-portal">Public View</a>
      <a href="/college-baseball">College Baseball</a>
      <a href="#" id="logout-link">Sign Out</a>
    </nav>
  </header>

  <div id="auth-screen" class="auth-screen">
    <h1>Transfer Portal Admin</h1>
    <p>Enter your admin API key to access the portal management system.</p>
    <input type="password" id="api-key-input" placeholder="API Key">
    <button class="btn btn-primary" id="auth-btn">Sign In</button>
    <p id="auth-error" class="hidden" style="color: #ef5350; margin-top: 16px; font-size: 14px;"></p>
  </div>

  <main id="admin-dashboard" class="container hidden">
    <div class="page-header">
      <h1 class="page-title">Transfer Portal Admin</h1>
      <div class="page-actions">
        <button class="btn btn-export" id="export-csv-btn" title="Export to CSV">CSV</button>
        <button class="btn btn-export" id="export-json-btn" title="Export to JSON">JSON</button>
        <button class="btn btn-secondary" id="refresh-btn">Refresh</button>
        <button class="btn btn-primary" id="add-btn">+ Add Player</button>
      </div>
    </div>

    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Players</div>
        <div class="stat-value" id="stat-total">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">In Portal</div>
        <div class="stat-value" id="stat-in-portal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Committed</div>
        <div class="stat-value" id="stat-committed">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Withdrawn</div>
        <div class="stat-value" id="stat-withdrawn">0</div>
      </div>
    </div>

    <div class="filter-bar">
      <input type="text" class="search-input" id="search-input" placeholder="Search players...">
      <select class="filter-select" id="status-filter">
        <option value="all">All Status</option>
        <option value="in-portal">In Portal</option>
        <option value="committed">Committed</option>
        <option value="withdrawn">Withdrawn</option>
      </select>
      <select class="filter-select" id="position-filter">
        <option value="all">All Positions</option>
        <option value="RHP">RHP</option>
        <option value="LHP">LHP</option>
        <option value="C">Catcher</option>
        <option value="1B">1B</option>
        <option value="2B">2B</option>
        <option value="SS">SS</option>
        <option value="3B">3B</option>
        <option value="OF">OF</option>
        <option value="INF">INF</option>
        <option value="UTIL">UTIL</option>
      </select>
    </div>

    <div class="table-container">
      <div id="loading-state" class="loading">
        <div class="spinner"></div>
        <p>Loading players...</p>
      </div>
      <table class="admin-table" id="players-table">
        <thead>
          <tr>
            <th>Player</th>
            <th>Pos</th>
            <th>From School</th>
            <th>To School</th>
            <th>Status</th>
            <th>Entry Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="players-tbody"></tbody>
      </table>
      <div class="pagination" id="pagination">
        <span class="pagination-info" id="pagination-info">Showing 0 players</span>
        <div class="pagination-buttons">
          <button class="btn btn-secondary btn-sm" id="prev-btn" disabled>Previous</button>
          <button class="btn btn-secondary btn-sm" id="next-btn">Next</button>
        </div>
      </div>
    </div>
  </main>

  <div id="player-modal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2 class="modal-title" id="modal-title">Add Player</h2>
        <button class="modal-close" id="modal-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <form id="player-form" class="form-grid">
          <input type="hidden" id="player-id">

          <div class="form-section">Player Info</div>

          <div class="form-group">
            <label class="form-label">First Name *</label>
            <input type="text" class="form-input" id="first-name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Last Name *</label>
            <input type="text" class="form-input" id="last-name" required>
          </div>
          <div class="form-group">
            <label class="form-label">Position *</label>
            <select class="form-select" id="position" required>
              <option value="">Select position</option>
              <option value="RHP">RHP</option>
              <option value="LHP">LHP</option>
              <option value="C">Catcher (C)</option>
              <option value="1B">First Base (1B)</option>
              <option value="2B">Second Base (2B)</option>
              <option value="SS">Shortstop (SS)</option>
              <option value="3B">Third Base (3B)</option>
              <option value="OF">Outfield (OF)</option>
              <option value="INF">Infield (INF)</option>
              <option value="UTIL">Utility (UTIL)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Year</label>
            <select class="form-select" id="year">
              <option value="">Select year</option>
              <option value="Fr.">Freshman</option>
              <option value="So.">Sophomore</option>
              <option value="Jr.">Junior</option>
              <option value="Sr.">Senior</option>
              <option value="Grad">Graduate</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Height</label>
            <input type="text" class="form-input" id="height" placeholder="e.g., 6-2">
          </div>
          <div class="form-group">
            <label class="form-label">Weight (lbs)</label>
            <input type="number" class="form-input" id="weight" placeholder="e.g., 195">
          </div>
          <div class="form-group">
            <label class="form-label">Hometown</label>
            <input type="text" class="form-input" id="hometown" placeholder="e.g., Austin, TX">
          </div>
          <div class="form-group">
            <label class="form-label">High School</label>
            <input type="text" class="form-input" id="high-school">
          </div>

          <div class="form-section">From School</div>

          <div class="form-group">
            <label class="form-label">School Name *</label>
            <input type="text" class="form-input" id="from-school" required placeholder="e.g., Texas">
          </div>
          <div class="form-group">
            <label class="form-label">Conference *</label>
            <select class="form-select" id="from-conference" required>
              <option value="">Select conference</option>
              <option value="SEC">SEC</option>
              <option value="ACC">ACC</option>
              <option value="Big 12">Big 12</option>
              <option value="Big Ten">Big Ten</option>
              <option value="Pac-12">Pac-12</option>
              <option value="AAC">AAC</option>
              <option value="Sun Belt">Sun Belt</option>
              <option value="C-USA">C-USA</option>
              <option value="MWC">Mountain West</option>
              <option value="WCC">WCC</option>
              <option value="A-10">Atlantic 10</option>
              <option value="CAA">CAA</option>
              <option value="MAC">MAC</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">State</label>
            <input type="text" class="form-input" id="from-state" placeholder="e.g., TX">
          </div>

          <div class="form-section">To School (if committed)</div>

          <div class="form-group">
            <label class="form-label">School Name</label>
            <input type="text" class="form-input" id="to-school" placeholder="Leave blank if uncommitted">
          </div>
          <div class="form-group">
            <label class="form-label">Conference</label>
            <select class="form-select" id="to-conference">
              <option value="">Select conference</option>
              <option value="SEC">SEC</option>
              <option value="ACC">ACC</option>
              <option value="Big 12">Big 12</option>
              <option value="Big Ten">Big Ten</option>
              <option value="Pac-12">Pac-12</option>
              <option value="AAC">AAC</option>
              <option value="Sun Belt">Sun Belt</option>
              <option value="C-USA">C-USA</option>
              <option value="MWC">Mountain West</option>
              <option value="WCC">WCC</option>
              <option value="A-10">Atlantic 10</option>
              <option value="CAA">CAA</option>
              <option value="MAC">MAC</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">State</label>
            <input type="text" class="form-input" id="to-state" placeholder="e.g., TX">
          </div>

          <div class="form-section">Status & Dates</div>

          <div class="form-group">
            <label class="form-label">Status *</label>
            <select class="form-select" id="status" required>
              <option value="in-portal">In Portal</option>
              <option value="committed">Committed</option>
              <option value="withdrawn">Withdrawn</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Entry Date *</label>
            <input type="date" class="form-input" id="entry-date" required>
          </div>
          <div class="form-group" id="commit-date-group">
            <label class="form-label">Commit Date</label>
            <input type="date" class="form-input" id="commit-date">
          </div>

          <div class="form-section">Stats (2024 Season)</div>

          <div class="form-group">
            <label class="form-label">Batting Average</label>
            <input type="text" class="form-input" id="batting-avg" placeholder="e.g., .312">
          </div>
          <div class="form-group">
            <label class="form-label">Home Runs</label>
            <input type="number" class="form-input" id="home-runs" placeholder="e.g., 14">
          </div>
          <div class="form-group">
            <label class="form-label">RBIs</label>
            <input type="number" class="form-input" id="rbis" placeholder="e.g., 58">
          </div>
          <div class="form-group">
            <label class="form-label">ERA (pitchers)</label>
            <input type="text" class="form-input" id="era" placeholder="e.g., 3.45">
          </div>
          <div class="form-group">
            <label class="form-label">Wins (pitchers)</label>
            <input type="number" class="form-input" id="wins" placeholder="e.g., 8">
          </div>
          <div class="form-group">
            <label class="form-label">Strikeouts (pitchers)</label>
            <input type="number" class="form-input" id="strikeouts" placeholder="e.g., 95">
          </div>

          <div class="form-section">Additional Info</div>

          <div class="form-group full-width">
            <label class="form-label">Notes</label>
            <textarea class="form-textarea" id="notes" placeholder="Any additional information about the player..."></textarea>
          </div>
          <div class="form-group full-width">
            <label class="form-label">Source URL</label>
            <input type="url" class="form-input" id="source-url" placeholder="https://...">
            <span class="form-help">Link to article, tweet, or official announcement</span>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
        <button class="btn btn-primary" id="modal-save-btn">Save Player</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h2 class="modal-title">Confirm Delete</h2>
        <button class="modal-close" id="delete-close-btn">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete <strong id="delete-player-name"></strong> from the transfer portal database?</p>
        <p style="color: var(--text-secondary); font-size: 14px; margin-top: 12px;">This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="delete-cancel-btn">Cancel</button>
        <button class="btn btn-danger" id="delete-confirm-btn">Delete Player</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>

  <script>
    (function() {
      var API_KEY = '';
      var allPlayers = [];
      var filteredPlayers = [];
      var currentPage = 1;
      var itemsPerPage = 50;
      var deletePlayerId = null;
      var editingPlayerId = null;

      // DOM elements
      var authScreen = document.getElementById('auth-screen');
      var adminDashboard = document.getElementById('admin-dashboard');
      var apiKeyInput = document.getElementById('api-key-input');
      var authBtn = document.getElementById('auth-btn');
      var authError = document.getElementById('auth-error');
      var logoutLink = document.getElementById('logout-link');
      var refreshBtn = document.getElementById('refresh-btn');
      var addBtn = document.getElementById('add-btn');
      var exportCsvBtn = document.getElementById('export-csv-btn');
      var exportJsonBtn = document.getElementById('export-json-btn');
      var searchInput = document.getElementById('search-input');
      var statusFilter = document.getElementById('status-filter');
      var positionFilter = document.getElementById('position-filter');
      var loadingState = document.getElementById('loading-state');
      var playersTable = document.getElementById('players-table');
      var playersTbody = document.getElementById('players-tbody');
      var paginationInfo = document.getElementById('pagination-info');
      var prevBtn = document.getElementById('prev-btn');
      var nextBtn = document.getElementById('next-btn');
      var playerModal = document.getElementById('player-modal');
      var modalTitle = document.getElementById('modal-title');
      var modalCloseBtn = document.getElementById('modal-close-btn');
      var modalCancelBtn = document.getElementById('modal-cancel-btn');
      var modalSaveBtn = document.getElementById('modal-save-btn');
      var playerForm = document.getElementById('player-form');
      var deleteModal = document.getElementById('delete-modal');
      var deletePlayerName = document.getElementById('delete-player-name');
      var deleteCloseBtn = document.getElementById('delete-close-btn');
      var deleteCancelBtn = document.getElementById('delete-cancel-btn');
      var deleteConfirmBtn = document.getElementById('delete-confirm-btn');
      var statusSelect = document.getElementById('status');
      var commitDateGroup = document.getElementById('commit-date-group');
      var toast = document.getElementById('toast');

      // Event listeners
      authBtn.addEventListener('click', authenticate);
      apiKeyInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') authenticate();
      });
      logoutLink.addEventListener('click', function(e) {
        e.preventDefault();
        logout();
      });
      refreshBtn.addEventListener('click', loadPlayers);
      addBtn.addEventListener('click', openAddModal);
      exportCsvBtn.addEventListener('click', exportCSV);
      exportJsonBtn.addEventListener('click', exportJSON);
      searchInput.addEventListener('input', filterPlayersHandler);
      statusFilter.addEventListener('change', filterPlayersHandler);
      positionFilter.addEventListener('change', filterPlayersHandler);
      prevBtn.addEventListener('click', prevPage);
      nextBtn.addEventListener('click', nextPage);
      modalCloseBtn.addEventListener('click', closeModal);
      modalCancelBtn.addEventListener('click', closeModal);
      modalSaveBtn.addEventListener('click', savePlayer);
      deleteCloseBtn.addEventListener('click', closeDeleteModal);
      deleteCancelBtn.addEventListener('click', closeDeleteModal);
      deleteConfirmBtn.addEventListener('click', confirmDelete);
      statusSelect.addEventListener('change', handleStatusChange);

      function authenticate() {
        var key = apiKeyInput.value.trim();
        if (!key) {
          showAuthError('Please enter an API key');
          return;
        }

        API_KEY = key;

        fetch('/api/admin/transfer-portal', {
          headers: { 'Authorization': 'Bearer ' + key }
        })
        .then(function(response) {
          if (!response.ok) {
            throw new Error('Invalid API key');
          }
          return response.json();
        })
        .then(function(data) {
          sessionStorage.setItem('bsi_admin_key', key);
          authScreen.classList.add('hidden');
          adminDashboard.classList.remove('hidden');
          loadPlayers();
        })
        .catch(function(error) {
          API_KEY = '';
          showAuthError('Invalid API key. Please try again.');
        });
      }

      function showAuthError(msg) {
        authError.textContent = msg;
        authError.classList.remove('hidden');
      }

      function logout() {
        API_KEY = '';
        sessionStorage.removeItem('bsi_admin_key');
        adminDashboard.classList.add('hidden');
        authScreen.classList.remove('hidden');
        apiKeyInput.value = '';
        authError.classList.add('hidden');
      }

      function checkStoredAuth() {
        var storedKey = sessionStorage.getItem('bsi_admin_key');
        if (storedKey) {
          apiKeyInput.value = storedKey;
          authenticate();
        }
      }

      function loadPlayers() {
        loadingState.classList.remove('hidden');
        playersTable.classList.add('hidden');

        fetch('/api/admin/transfer-portal', {
          headers: { 'Authorization': 'Bearer ' + API_KEY }
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to load');
          return response.json();
        })
        .then(function(data) {
          allPlayers = data.players || [];
          filteredPlayers = allPlayers.slice();
          updateStats();
          renderTable();
          loadingState.classList.add('hidden');
          playersTable.classList.remove('hidden');
        })
        .catch(function(error) {
          showToast('Failed to load players', 'error');
          loadingState.classList.add('hidden');
        });
      }

      function updateStats() {
        var total = allPlayers.length;
        var inPortal = 0, committed = 0, withdrawn = 0;

        for (var i = 0; i < allPlayers.length; i++) {
          var status = allPlayers[i].status;
          if (status === 'in-portal') inPortal++;
          else if (status === 'committed') committed++;
          else if (status === 'withdrawn') withdrawn++;
        }

        document.getElementById('stat-total').textContent = total;
        document.getElementById('stat-in-portal').textContent = inPortal;
        document.getElementById('stat-committed').textContent = committed;
        document.getElementById('stat-withdrawn').textContent = withdrawn;
      }

      function filterPlayersHandler() {
        var search = searchInput.value.toLowerCase();
        var statusVal = statusFilter.value;
        var positionVal = positionFilter.value;

        filteredPlayers = allPlayers.filter(function(p) {
          var name = (p.player_name || p.first_name + ' ' + p.last_name).toLowerCase();
          var matchSearch = !search || name.indexOf(search) !== -1 ||
            (p.from_school || '').toLowerCase().indexOf(search) !== -1 ||
            (p.to_school || '').toLowerCase().indexOf(search) !== -1;

          var matchStatus = statusVal === 'all' || p.status === statusVal;
          var matchPosition = positionVal === 'all' || p.position === positionVal;

          return matchSearch && matchStatus && matchPosition;
        });

        currentPage = 1;
        renderTable();
      }

      function renderTable() {
        while (playersTbody.firstChild) {
          playersTbody.removeChild(playersTbody.firstChild);
        }

        var start = (currentPage - 1) * itemsPerPage;
        var end = Math.min(start + itemsPerPage, filteredPlayers.length);
        var pageData = filteredPlayers.slice(start, end);

        if (pageData.length === 0) {
          var row = document.createElement('tr');
          var cell = document.createElement('td');
          cell.colSpan = 7;
          cell.style.textAlign = 'center';
          cell.style.padding = '40px';
          cell.className = 'empty-text';
          cell.textContent = 'No players found';
          row.appendChild(cell);
          playersTbody.appendChild(row);
        }

        for (var i = 0; i < pageData.length; i++) {
          var p = pageData[i];
          var row = document.createElement('tr');

          // Player name cell
          var nameCell = document.createElement('td');
          var playerName = p.player_name || (p.first_name + ' ' + p.last_name);
          var nameStrong = document.createElement('span');
          nameStrong.className = 'player-name-strong';
          nameStrong.textContent = playerName;
          nameCell.appendChild(nameStrong);
          if (p.year) {
            var yearSpan = document.createElement('span');
            yearSpan.className = 'player-year';
            yearSpan.textContent = p.year;
            nameCell.appendChild(yearSpan);
          }
          row.appendChild(nameCell);

          // Position cell
          var posCell = document.createElement('td');
          var posBadge = document.createElement('span');
          posBadge.className = 'position-badge';
          posBadge.textContent = p.position || '-';
          posCell.appendChild(posBadge);
          row.appendChild(posCell);

          // From school cell
          var fromCell = document.createElement('td');
          fromCell.textContent = p.from_school || '-';
          if (p.from_conference) {
            var confSpan = document.createElement('span');
            confSpan.className = 'school-conference';
            confSpan.textContent = p.from_conference;
            fromCell.appendChild(confSpan);
          }
          row.appendChild(fromCell);

          // To school cell
          var toCell = document.createElement('td');
          if (p.to_school) {
            toCell.textContent = p.to_school;
            if (p.to_conference) {
              var toConfSpan = document.createElement('span');
              toConfSpan.className = 'school-conference';
              toConfSpan.textContent = p.to_conference;
              toCell.appendChild(toConfSpan);
            }
          } else {
            var dash = document.createElement('span');
            dash.className = 'empty-text';
            dash.textContent = '-';
            toCell.appendChild(dash);
          }
          row.appendChild(toCell);

          // Status cell
          var statusCell = document.createElement('td');
          var statusBadge = document.createElement('span');
          var statusClass = p.status === 'in-portal' ? 'in-portal' : p.status === 'committed' ? 'committed' : 'withdrawn';
          var statusLabel = p.status === 'in-portal' ? 'In Portal' : p.status === 'committed' ? 'Committed' : 'Withdrawn';
          statusBadge.className = 'status-badge ' + statusClass;
          var statusDot = document.createElement('span');
          statusDot.className = 'status-dot';
          statusBadge.appendChild(statusDot);
          statusBadge.appendChild(document.createTextNode(statusLabel));
          statusCell.appendChild(statusBadge);
          row.appendChild(statusCell);

          // Entry date cell
          var dateCell = document.createElement('td');
          dateCell.className = 'date-cell';
          dateCell.textContent = p.entry_date ? formatDate(p.entry_date) : '-';
          row.appendChild(dateCell);

          // Actions cell
          var actionsCell = document.createElement('td');
          actionsCell.className = 'actions-cell';

          var editBtn = document.createElement('button');
          editBtn.className = 'btn btn-secondary btn-sm';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', createEditHandler(p));
          actionsCell.appendChild(editBtn);

          var delBtn = document.createElement('button');
          delBtn.className = 'btn btn-danger btn-sm';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', createDeleteHandler(p));
          actionsCell.appendChild(delBtn);

          row.appendChild(actionsCell);

          playersTbody.appendChild(row);
        }

        paginationInfo.textContent = filteredPlayers.length > 0
          ? 'Showing ' + (start + 1) + '-' + end + ' of ' + filteredPlayers.length + ' players'
          : 'Showing 0 players';
        prevBtn.disabled = currentPage === 1;
        nextBtn.disabled = end >= filteredPlayers.length;
      }

      function createEditHandler(player) {
        return function() { openEditModal(player); };
      }

      function createDeleteHandler(player) {
        return function() { openDeleteModal(player); };
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage--;
          renderTable();
        }
      }

      function nextPage() {
        var maxPage = Math.ceil(filteredPlayers.length / itemsPerPage);
        if (currentPage < maxPage) {
          currentPage++;
          renderTable();
        }
      }

      function openAddModal() {
        editingPlayerId = null;
        modalTitle.textContent = 'Add Player';
        playerForm.reset();
        document.getElementById('player-id').value = '';
        document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
        playerModal.classList.remove('hidden');
      }

      function openEditModal(player) {
        editingPlayerId = player.id;
        modalTitle.textContent = 'Edit Player';
        document.getElementById('player-id').value = player.id || '';
        document.getElementById('first-name').value = player.first_name || '';
        document.getElementById('last-name').value = player.last_name || '';
        document.getElementById('position').value = player.position || '';
        document.getElementById('year').value = player.year || '';
        document.getElementById('height').value = player.height || '';
        document.getElementById('weight').value = player.weight || '';
        document.getElementById('hometown').value = player.hometown || '';
        document.getElementById('high-school').value = player.high_school || '';
        document.getElementById('from-school').value = player.from_school || '';
        document.getElementById('from-conference').value = player.from_conference || '';
        document.getElementById('from-state').value = player.from_state || '';
        document.getElementById('to-school').value = player.to_school || '';
        document.getElementById('to-conference').value = player.to_conference || '';
        document.getElementById('to-state').value = player.to_state || '';
        document.getElementById('status').value = player.status || 'in-portal';
        document.getElementById('entry-date').value = player.entry_date ? player.entry_date.split('T')[0] : '';
        document.getElementById('commit-date').value = player.commit_date ? player.commit_date.split('T')[0] : '';
        document.getElementById('batting-avg').value = player.batting_avg || '';
        document.getElementById('home-runs').value = player.home_runs || '';
        document.getElementById('rbis').value = player.rbis || '';
        document.getElementById('era').value = player.era || '';
        document.getElementById('wins').value = player.wins || '';
        document.getElementById('strikeouts').value = player.strikeouts || '';
        document.getElementById('notes').value = player.notes || '';
        document.getElementById('source-url').value = player.source_url || '';

        handleStatusChange();
        playerModal.classList.remove('hidden');
      }

      function closeModal() {
        playerModal.classList.add('hidden');
        editingPlayerId = null;
      }

      function handleStatusChange() {
        var status = document.getElementById('status').value;
        commitDateGroup.style.display = status === 'committed' ? 'flex' : 'none';
      }

      function savePlayer() {
        var firstName = document.getElementById('first-name').value.trim();
        var lastName = document.getElementById('last-name').value.trim();
        var position = document.getElementById('position').value;
        var fromSchool = document.getElementById('from-school').value.trim();
        var fromConference = document.getElementById('from-conference').value;
        var status = document.getElementById('status').value;
        var entryDate = document.getElementById('entry-date').value;

        if (!firstName || !lastName || !position || !fromSchool || !fromConference || !status || !entryDate) {
          showToast('Please fill in all required fields', 'error');
          return;
        }

        var data = {
          first_name: firstName,
          last_name: lastName,
          position: position,
          year: document.getElementById('year').value || null,
          height: document.getElementById('height').value || null,
          weight: parseInt(document.getElementById('weight').value) || null,
          hometown: document.getElementById('hometown').value || null,
          high_school: document.getElementById('high-school').value || null,
          from_school: fromSchool,
          from_conference: fromConference,
          from_state: document.getElementById('from-state').value || null,
          to_school: document.getElementById('to-school').value || null,
          to_conference: document.getElementById('to-conference').value || null,
          to_state: document.getElementById('to-state').value || null,
          status: status,
          entry_date: entryDate,
          commit_date: document.getElementById('commit-date').value || null,
          batting_avg: document.getElementById('batting-avg').value || null,
          home_runs: parseInt(document.getElementById('home-runs').value) || null,
          rbis: parseInt(document.getElementById('rbis').value) || null,
          era: document.getElementById('era').value || null,
          wins: parseInt(document.getElementById('wins').value) || null,
          strikeouts: parseInt(document.getElementById('strikeouts').value) || null,
          notes: document.getElementById('notes').value || null,
          source_url: document.getElementById('source-url').value || null
        };

        var url = '/api/admin/transfer-portal';
        var method = 'POST';

        if (editingPlayerId) {
          url = '/api/admin/transfer-portal/' + editingPlayerId;
          method = 'PUT';
        }

        fetch(url, {
          method: method,
          headers: {
            'Authorization': 'Bearer ' + API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to save');
          return response.json();
        })
        .then(function(result) {
          showToast(editingPlayerId ? 'Player updated!' : 'Player added!', 'success');
          closeModal();
          loadPlayers();
        })
        .catch(function(error) {
          showToast('Failed to save player', 'error');
        });
      }

      function openDeleteModal(player) {
        deletePlayerId = player.id;
        var name = player.player_name || (player.first_name + ' ' + player.last_name);
        deletePlayerName.textContent = name;
        deleteModal.classList.remove('hidden');
      }

      function closeDeleteModal() {
        deleteModal.classList.add('hidden');
        deletePlayerId = null;
      }

      function confirmDelete() {
        if (!deletePlayerId) return;

        fetch('/api/admin/transfer-portal/' + deletePlayerId, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + API_KEY }
        })
        .then(function(response) {
          if (!response.ok) throw new Error('Failed to delete');
          return response.json();
        })
        .then(function(result) {
          showToast('Player deleted', 'success');
          closeDeleteModal();
          loadPlayers();
        })
        .catch(function(error) {
          showToast('Failed to delete player', 'error');
        });
      }

      function showToast(message, type) {
        toast.textContent = message;
        toast.className = 'toast ' + type;
        setTimeout(function() {
          toast.classList.add('hidden');
        }, 3000);
      }

      function formatDate(dateStr) {
        if (!dateStr) return '-';
        var date = new Date(dateStr);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
      }

      function exportCSV() {
        if (filteredPlayers.length === 0) {
          showToast('No data to export', 'error');
          return;
        }

        var headers = [
          'ID', 'Player Name', 'First Name', 'Last Name', 'Position', 'Year',
          'From School', 'From Conference', 'To School', 'To Conference',
          'Status', 'Entry Date', 'Commit Date', 'Batting Avg', 'Home Runs', 'RBIs',
          'ERA', 'Wins', 'Strikeouts', 'Source', 'Notes'
        ];

        var rows = filteredPlayers.map(function(p) {
          return [
            escapeCSV(p.id || ''),
            escapeCSV(p.player_name || (p.first_name + ' ' + p.last_name)),
            escapeCSV(p.first_name || ''),
            escapeCSV(p.last_name || ''),
            escapeCSV(p.position || ''),
            escapeCSV(p.year || ''),
            escapeCSV(p.from_school || ''),
            escapeCSV(p.from_conference || ''),
            escapeCSV(p.to_school || ''),
            escapeCSV(p.to_conference || ''),
            escapeCSV(p.status || ''),
            escapeCSV(p.entry_date || ''),
            escapeCSV(p.commit_date || ''),
            escapeCSV(p.batting_avg || ''),
            escapeCSV(p.home_runs || ''),
            escapeCSV(p.rbis || ''),
            escapeCSV(p.era || ''),
            escapeCSV(p.wins || ''),
            escapeCSV(p.strikeouts || ''),
            escapeCSV(p.source || ''),
            escapeCSV(p.notes || '')
          ].join(',');
        });

        var csv = headers.join(',') + '\n' + rows.join('\n');
        downloadFile(csv, 'transfer-portal-' + getDateStamp() + '.csv', 'text/csv');
        showToast('Exported ' + filteredPlayers.length + ' players to CSV', 'success');
      }

      function exportJSON() {
        if (filteredPlayers.length === 0) {
          showToast('No data to export', 'error');
          return;
        }

        var exportData = {
          exportedAt: new Date().toISOString(),
          source: 'Blaze Sports Intel Transfer Portal',
          count: filteredPlayers.length,
          players: filteredPlayers.map(function(p) {
            return {
              id: p.id,
              name: p.player_name || (p.first_name + ' ' + p.last_name),
              firstName: p.first_name,
              lastName: p.last_name,
              position: p.position,
              year: p.year,
              fromSchool: p.from_school,
              fromConference: p.from_conference,
              toSchool: p.to_school,
              toConference: p.to_conference,
              status: p.status,
              entryDate: p.entry_date,
              commitDate: p.commit_date,
              stats: {
                battingAvg: p.batting_avg,
                homeRuns: p.home_runs,
                rbis: p.rbis,
                era: p.era,
                wins: p.wins,
                strikeouts: p.strikeouts
              },
              source: p.source,
              notes: p.notes
            };
          })
        };

        var json = JSON.stringify(exportData, null, 2);
        downloadFile(json, 'transfer-portal-' + getDateStamp() + '.json', 'application/json');
        showToast('Exported ' + filteredPlayers.length + ' players to JSON', 'success');
      }

      function escapeCSV(val) {
        if (val === null || val === undefined) return '';
        var str = String(val);
        if (str.indexOf(',') !== -1 || str.indexOf('"') !== -1 || str.indexOf('\n') !== -1) {
          return '"' + str.replace(/"/g, '""') + '"';
        }
        return str;
      }

      function getDateStamp() {
        var d = new Date();
        return d.getFullYear() + '-' +
          String(d.getMonth() + 1).padStart(2, '0') + '-' +
          String(d.getDate()).padStart(2, '0');
      }

      function downloadFile(content, filename, mimeType) {
        var blob = new Blob([content], { type: mimeType });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // Initialize
      checkStoredAuth();
    })();
  </script>
</body>
</html>
