<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Transfer Portal Analytics | Blaze Sports Intel</title>
  <meta name="description" content="College baseball transfer portal analytics - conference movements, position trends, player comparisons, and historical insights.">
  <link rel="icon" href="/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --burnt-orange: #BF5700;
      --ember: #FF6B35;
      --charcoal: #1A1A1A;
      --midnight: #0D0D0D;
      --cream: #FAF8F5;
      --gold: #C9A227;
      --text-primary: #FFFFFF;
      --text-secondary: #9CA3AF;
      --border: #374151;
      --success: #22C55E;
      --warning: #F59E0B;
      --error: #EF4444;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--midnight);
      color: var(--text-primary);
      min-height: 100vh;
    }
    .header {
      background: var(--charcoal);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .logo {
      font-size: 20px;
      font-weight: 700;
      color: var(--burnt-orange);
      text-decoration: none;
    }
    .nav-links { display: flex; gap: 24px; }
    .nav-links a {
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      transition: color 0.2s;
    }
    .nav-links a:hover { color: var(--text-primary); }
    .nav-links a.active { color: var(--burnt-orange); }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    .page-header { margin-bottom: 24px; }
    .page-title {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
    }
    .page-subtitle { color: var(--text-secondary); }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      margin-bottom: 16px;
      transition: color 0.2s;
    }
    .back-link:hover { color: var(--burnt-orange); }

    /* Export Buttons */
    .page-header-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      gap: 16px;
    }
    .export-actions {
      display: flex;
      gap: 12px;
    }
    .export-btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
    }
    .export-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border-color: var(--burnt-orange);
    }
    .export-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .export-btn svg {
      width: 16px;
      height: 16px;
    }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 24px;
      padding: 16px;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
    }
    .filter-label {
      font-size: 13px;
      color: var(--text-secondary);
      margin-right: 8px;
      align-self: center;
    }
    .filter-chip {
      padding: 8px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 13px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .filter-chip:hover {
      border-color: var(--burnt-orange);
      color: var(--text-primary);
    }
    .filter-chip.active {
      background: var(--burnt-orange);
      border-color: var(--burnt-orange);
      color: white;
    }
    .filter-clear {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--error);
      border-radius: 20px;
      font-size: 13px;
      color: var(--error);
      cursor: pointer;
      margin-left: auto;
    }
    .filter-clear:hover { background: rgba(239, 68, 68, 0.1); }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--ember);
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Tab Navigation */
    .tab-nav {
      display: flex;
      gap: 4px;
      margin-bottom: 24px;
      background: var(--charcoal);
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .tab-btn {
      flex: 1;
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: var(--text-primary); }
    .tab-btn.active {
      background: var(--burnt-orange);
      color: white;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }
    @media (max-width: 1024px) { .dashboard-grid { grid-template-columns: 1fr; } }
    .card {
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
    }
    .card.full-width { grid-column: 1 / -1; }
    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-title-icon { color: var(--burnt-orange); }

    /* Conference Chart */
    .conference-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .conference-bar:last-child { border-bottom: none; }
    .conference-name {
      width: 80px;
      font-size: 13px;
      font-weight: 500;
      flex-shrink: 0;
    }
    .conference-bars {
      flex: 1;
      display: flex;
      gap: 4px;
    }
    .bar-container {
      flex: 1;
      height: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    .bar-in, .bar-out {
      height: 100%;
      position: absolute;
      left: 0;
      transition: width 0.5s ease;
    }
    .bar-in { background: var(--success); }
    .bar-out { background: var(--error); }
    .conference-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      width: 120px;
      justify-content: flex-end;
    }
    .stat-in { color: var(--success); }
    .stat-out { color: var(--error); }
    .stat-net { font-weight: 600; }
    .stat-net.positive { color: var(--success); }
    .stat-net.negative { color: var(--error); }
    .stat-net.neutral { color: var(--text-secondary); }

    /* Position Grid */
    .position-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }
    .position-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
    }
    .position-item:hover { border-color: var(--burnt-orange); }
    .position-item.selected {
      border-color: var(--burnt-orange);
      background: rgba(191, 87, 0, 0.1);
    }
    .position-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .position-count { font-size: 24px; font-weight: 700; color: var(--ember); }
    .position-pct { font-size: 12px; color: var(--text-secondary); }

    /* Destinations */
    .destination-list { display: flex; flex-direction: column; gap: 12px; }
    .destination-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
    }
    .destination-rank {
      width: 24px;
      height: 24px;
      background: var(--burnt-orange);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      flex-shrink: 0;
    }
    .destination-logo {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: contain;
      background: rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    .destination-info { flex: 1; }
    .destination-school { font-weight: 500; margin-bottom: 2px; }
    .destination-conf { font-size: 12px; color: var(--text-secondary); }
    .destination-count { font-size: 20px; font-weight: 700; color: var(--ember); }

    /* Activity List */
    .activity-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }
    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: 14px;
    }
    .activity-date {
      font-size: 12px;
      color: var(--text-secondary);
      width: 60px;
      flex-shrink: 0;
    }
    .activity-player { font-weight: 500; flex: 1; }
    .activity-position { color: var(--burnt-orange); font-size: 12px; width: 40px; }
    .activity-flow { color: var(--text-secondary); font-size: 13px; }
    .activity-arrow { color: var(--ember); margin: 0 4px; }

    /* Player Comparison */
    .comparison-container { padding: 20px 0; }
    .comparison-search {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
    }
    .search-column { flex: 1; }
    .search-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }
    .search-input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
    }
    .search-input:focus {
      outline: none;
      border-color: var(--burnt-orange);
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--charcoal);
      border: 1px solid var(--border);
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 10;
      display: none;
    }
    .search-results.show { display: block; }
    .search-result-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: background 0.2s;
    }
    .search-result-item:hover { background: rgba(191, 87, 0, 0.1); }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-name { font-weight: 500; }
    .search-result-meta { font-size: 12px; color: var(--text-secondary); }
    .search-wrapper { position: relative; }

    .comparison-grid {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 24px;
      align-items: start;
    }
    .comparison-player {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
    }
    .comparison-empty {
      padding: 60px 24px;
      text-align: center;
      color: var(--text-secondary);
      border: 2px dashed var(--border);
      border-radius: 12px;
    }
    .comparison-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--burnt-orange), var(--ember));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: white;
      margin: 0 auto 16px;
    }
    .comparison-name { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
    .comparison-meta { font-size: 14px; color: var(--text-secondary); margin-bottom: 16px; }
    .comparison-stats-list {
      text-align: left;
      border-top: 1px solid var(--border);
      padding-top: 16px;
    }
    .comparison-stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .comparison-stat-label { color: var(--text-secondary); font-size: 13px; }
    .comparison-stat-value { font-weight: 500; font-size: 14px; }
    .comparison-vs {
      font-size: 24px;
      font-weight: 700;
      color: var(--gold);
      align-self: center;
    }
    .remove-player {
      background: rgba(239, 68, 68, 0.2);
      border: none;
      color: var(--error);
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      margin-top: 16px;
    }
    .remove-player:hover { background: rgba(239, 68, 68, 0.3); }

    /* Historical Trends */
    .trends-container { padding: 20px 0; }
    .season-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }
    .season-btn {
      padding: 10px 20px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .season-btn:hover { border-color: var(--burnt-orange); color: var(--text-primary); }
    .season-btn.active {
      background: var(--burnt-orange);
      border-color: var(--burnt-orange);
      color: white;
    }
    .trend-chart {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    .trend-title { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .trend-bars { display: flex; gap: 8px; align-items: flex-end; height: 200px; }
    .trend-bar-wrapper { flex: 1; display: flex; flex-direction: column; align-items: center; }
    .trend-bar {
      width: 100%;
      background: linear-gradient(180deg, var(--burnt-orange), var(--ember));
      border-radius: 4px 4px 0 0;
      transition: height 0.5s ease;
      min-height: 4px;
    }
    .trend-label { font-size: 11px; color: var(--text-secondary); margin-top: 8px; }
    .trend-value { font-size: 12px; font-weight: 600; margin-top: 4px; }
    .trend-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }
    .trend-stat {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 16px;
    }
    .trend-stat-label { font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; }
    .trend-stat-value { font-size: 24px; font-weight: 700; color: var(--ember); }
    .trend-stat-change { font-size: 12px; margin-top: 4px; }
    .trend-stat-change.up { color: var(--success); }
    .trend-stat-change.down { color: var(--error); }

    /* Loading */
    .loading-state { text-align: center; padding: 60px 24px; }
    .spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--border);
      border-top-color: var(--burnt-orange);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-text { color: var(--error); }

    /* Scrollbar */
    .activity-list::-webkit-scrollbar, .search-results::-webkit-scrollbar { width: 6px; }
    .activity-list::-webkit-scrollbar-track, .search-results::-webkit-scrollbar-track { background: var(--charcoal); }
    .activity-list::-webkit-scrollbar-thumb, .search-results::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    @media (max-width: 768px) {
      .comparison-grid { grid-template-columns: 1fr; }
      .comparison-vs { display: none; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .position-grid { grid-template-columns: repeat(2, 1fr); }
      .comparison-search { flex-direction: column; }
    }
  </style>
</head>
<body>
  <header class="header">
    <a href="/" class="logo">Blaze Sports Intel</a>
    <nav class="nav-links">
      <a href="/transfer-portal">Portal</a>
      <a href="/transfer-portal/analytics" class="active">Analytics</a>
      <a href="/nil-calculator">NIL Calculator</a>
    </nav>
  </header>

  <main class="container">
    <a href="/transfer-portal" class="back-link"><span>&larr;</span> Back to Transfer Portal</a>
    <div class="page-header">
      <div class="page-header-row">
        <div>
          <h1 class="page-title">Portal Analytics</h1>
          <p class="page-subtitle">Conference movements, player comparisons, and historical trends</p>
        </div>
        <div class="export-actions">
          <button class="export-btn" id="exportCsv" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10 9 9 9 8 9"/>
            </svg>
            Export CSV
          </button>
          <button class="export-btn" id="exportPdf" disabled>
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <path d="M9 15v2l2-1 2 1v-2"/>
              <path d="M9 11h.01"/>
              <path d="M15 11h.01"/>
            </svg>
            Export PDF
          </button>
        </div>
      </div>
    </div>

    <div id="loadingState" class="loading-state">
      <div class="spinner"></div>
      <p>Loading analytics data...</p>
    </div>

    <div id="content" style="display: none;">
      <!-- Position Filter Bar -->
      <div class="filter-bar" id="filterBar">
        <span class="filter-label">Filter by Position:</span>
        <button class="filter-chip active" data-position="all">All Positions</button>
      </div>

      <!-- Summary Stats -->
      <div class="stats-grid" id="statsGrid"></div>

      <!-- Tab Navigation -->
      <div class="tab-nav">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="compare">Compare Players</button>
        <button class="tab-btn" data-tab="trends">Historical Trends</button>
      </div>

      <!-- Overview Tab -->
      <div class="tab-content active" id="tab-overview">
        <div class="dashboard-grid">
          <div class="card">
            <h2 class="card-title"><span class="card-title-icon">&#8651;</span> Conference Movement</h2>
            <div id="conferenceChart"></div>
          </div>
          <div class="card">
            <h2 class="card-title"><span class="card-title-icon">&#9881;</span> Position Breakdown</h2>
            <div class="position-grid" id="positionGrid"></div>
          </div>
          <div class="card">
            <h2 class="card-title"><span class="card-title-icon">&#9733;</span> Top Destinations</h2>
            <div class="destination-list" id="destinationList"></div>
          </div>
          <div class="card">
            <h2 class="card-title"><span class="card-title-icon">&#128337;</span> Recent Activity</h2>
            <div class="activity-list" id="activityList"></div>
          </div>
        </div>
      </div>

      <!-- Compare Tab -->
      <div class="tab-content" id="tab-compare">
        <div class="card full-width">
          <h2 class="card-title"><span class="card-title-icon">&#9878;</span> Player Comparison</h2>
          <div class="comparison-container">
            <div class="comparison-search">
              <div class="search-column">
                <div class="search-label">Player 1</div>
                <div class="search-wrapper">
                  <input type="text" class="search-input" id="search1" placeholder="Search player name...">
                  <div class="search-results" id="results1"></div>
                </div>
              </div>
              <div class="search-column">
                <div class="search-label">Player 2</div>
                <div class="search-wrapper">
                  <input type="text" class="search-input" id="search2" placeholder="Search player name...">
                  <div class="search-results" id="results2"></div>
                </div>
              </div>
            </div>
            <div class="comparison-grid" id="comparisonGrid">
              <div class="comparison-empty" id="player1Slot">Search and select Player 1 above</div>
              <div class="comparison-vs">VS</div>
              <div class="comparison-empty" id="player2Slot">Search and select Player 2 above</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trends Tab -->
      <div class="tab-content" id="tab-trends">
        <div class="card full-width">
          <h2 class="card-title"><span class="card-title-icon">&#128200;</span> Historical Trends</h2>
          <div class="trends-container">
            <div class="season-selector" id="seasonSelector">
              <button class="season-btn" data-season="2023">2022-23</button>
              <button class="season-btn" data-season="2024">2023-24</button>
              <button class="season-btn active" data-season="2025">2024-25</button>
            </div>
            <div class="trend-chart">
              <div class="trend-title">Portal Entries by Month</div>
              <div class="trend-bars" id="trendBars"></div>
            </div>
            <div class="trend-summary" id="trendSummary"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Export libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKnTngueai3jCGpqSW/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKNRRhy5X5AAOnx5S09ydFYWWNSfcEqDTTHgtNA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script>
    // School logo mapping
    var schoolLogoIds = {
      'Texas': 251, 'Texas A&M': 245, 'LSU': 99, 'Florida': 57, 'Georgia': 61,
      'Tennessee': 2633, 'Alabama': 333, 'Auburn': 2, 'Ole Miss': 145, 'Mississippi State': 344,
      'Arkansas': 8, 'Missouri': 142, 'South Carolina': 2579, 'Kentucky': 96, 'Vanderbilt': 238,
      'Oklahoma': 201, 'Oregon': 2483, 'Arizona': 12, 'Arizona State': 9, 'Utah': 254,
      'Colorado': 38, 'BYU': 252, 'Cincinnati': 2132, 'UCF': 2116, 'Houston': 248,
      'Kansas': 2305, 'Kansas State': 2306, 'Iowa State': 66, 'West Virginia': 277, 'Baylor': 239,
      'TCU': 2628, 'Texas Tech': 2641, 'Ohio State': 194, 'Michigan': 130, 'Penn State': 213,
      'Wisconsin': 275, 'Iowa': 2294, 'Minnesota': 135, 'Nebraska': 158, 'Illinois': 356,
      'Northwestern': 77, 'Purdue': 2509, 'Indiana': 84, 'Maryland': 120, 'Rutgers': 164,
      'Michigan State': 127, 'USC': 30, 'UCLA': 26, 'Washington': 264, 'Oregon State': 204,
      'Cal': 25, 'Stanford': 24, 'Clemson': 228, 'Florida State': 52, 'NC State': 152,
      'Duke': 150, 'North Carolina': 153, 'Virginia': 258, 'Virginia Tech': 259, 'Miami': 2390,
      'Louisville': 97, 'Pittsburgh': 221, 'Wake Forest': 154, 'Boston College': 103,
      'Georgia Tech': 59, 'Syracuse': 183, 'Notre Dame': 87, 'SMU': 2567, 'East Carolina': 151,
      'Tulane': 2655, 'Memphis': 235, 'South Florida': 58, 'Rice': 242, 'UTSA': 2636,
      'Charlotte': 2429, 'FAU': 2226, 'UAB': 5, 'North Texas': 249, 'UNLV': 2439,
      'San Diego State': 21, 'Fresno State': 278, 'Boise State': 68, 'Air Force': 2005,
      'Colorado State': 36, 'Wyoming': 2704, 'New Mexico': 167, 'Hawaii': 62, 'San Jose State': 23,
      'Nevada': 2440, 'UTEP': 2638, 'Louisiana Tech': 2348, 'Western Kentucky': 98,
      'Old Dominion': 295, 'Marshall': 276, 'Southern Miss': 2572, 'James Madison': 256,
      'Coastal Carolina': 324, 'App State': 2026, 'Troy': 2653, 'Georgia State': 2247,
      'Georgia Southern': 290, 'Arkansas State': 2032, 'Louisiana': 309, 'Texas State': 326,
      'South Alabama': 6, 'Liberty': 2335, 'Sam Houston': 2534, 'Kennesaw State': 338
    };

    var allPlayers = [];
    var filteredPlayers = [];
    var activePosition = 'all';
    var comparedPlayers = [null, null];

    // Historical data loaded from API
    var historicalData = {};

    async function loadHistoricalData() {
      try {
        // Load last 3 years of historical data
        var years = [2023, 2024, 2025];
        for (var i = 0; i < years.length; i++) {
          var year = years[i];
          try {
            var response = await fetch('/api/transfer-portal/history?year=' + year);
            if (response.ok) {
              var data = await response.json();
              if (data.success) {
                // Build monthly totals from API response
                var byMonth = [0,0,0,0,0,0,0,0,0,0,0,0];
                if (data.monthlyTotals && data.monthlyTotals.length > 0) {
                  data.monthlyTotals.forEach(function(m) {
                    byMonth[m.month - 1] = m.total || 0;
                  });
                }
                historicalData[year] = {
                  total: data.summary ? data.summary.total : 0,
                  committed: data.summary ? data.summary.committed : 0,
                  byMonth: byMonth
                };
              }
            }
          } catch (e) {
            console.warn('No historical data for ' + year);
          }
        }
      } catch (error) {
        console.error('Failed to load historical data:', error);
      }

      // Fallback to simulated data if API returns nothing
      if (!historicalData[2023]) {
        historicalData[2023] = { total: 1847, committed: 1423, byMonth: [45, 89, 234, 456, 389, 287, 156, 98, 45, 23, 12, 13] };
      }
      if (!historicalData[2024]) {
        historicalData[2024] = { total: 2156, committed: 1678, byMonth: [52, 112, 298, 512, 423, 312, 189, 112, 67, 34, 22, 23] };
      }
      if (!historicalData[2025]) {
        historicalData[2025] = { total: 0, committed: 0, byMonth: [0,0,0,0,0,0,0,0,0,0,0,0] };
      }
    }

    function getSchoolLogoUrl(schoolName) {
      var teamId = schoolLogoIds[schoolName];
      return teamId ? 'https://a.espncdn.com/combiner/i?img=/i/teamlogos/ncaa/500/' + teamId + '.png&h=32&w=32' : null;
    }

    function createElement(tag, className, textContent) {
      var el = document.createElement(tag);
      if (className) el.className = className;
      if (textContent !== undefined) el.textContent = textContent;
      return el;
    }

    function formatDate(dateStr) {
      if (!dateStr) return 'N/A';
      var date = new Date(dateStr);
      return (date.getMonth() + 1) + '/' + date.getDate();
    }

    function getInitials(name) {
      if (!name) return '??';
      var parts = name.split(' ');
      if (parts.length >= 2) return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      return name.substring(0, 2).toUpperCase();
    }

    // Tab Navigation
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var tab = this.getAttribute('data-tab');
        document.querySelectorAll('.tab-btn').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c) { c.classList.remove('active'); });
        this.classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
      });
    });

    // Position Filter
    function setupPositionFilters() {
      var filterBar = document.getElementById('filterBar');
      var positions = {};
      allPlayers.forEach(function(p) {
        var pos = p.position || 'Unknown';
        if (!positions[pos]) positions[pos] = 0;
        positions[pos]++;
      });

      var sortedPositions = Object.keys(positions).sort(function(a, b) {
        return positions[b] - positions[a];
      }).slice(0, 8);

      sortedPositions.forEach(function(pos) {
        var chip = createElement('button', 'filter-chip', pos + ' (' + positions[pos] + ')');
        chip.setAttribute('data-position', pos);
        chip.addEventListener('click', function() {
          document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
          this.classList.add('active');
          activePosition = pos;
          applyFilter();
        });
        filterBar.appendChild(chip);
      });

      var clearBtn = createElement('button', 'filter-clear', 'Clear Filter');
      clearBtn.addEventListener('click', function() {
        document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
        document.querySelector('.filter-chip[data-position="all"]').classList.add('active');
        activePosition = 'all';
        applyFilter();
      });
      filterBar.appendChild(clearBtn);
    }

    function applyFilter() {
      if (activePosition === 'all') {
        filteredPlayers = allPlayers;
      } else {
        filteredPlayers = allPlayers.filter(function(p) {
          return p.position === activePosition;
        });
      }
      var analytics = computeAnalytics(filteredPlayers);
      renderStats(analytics);
      renderConferenceChart(analytics);
      renderPositions(analytics);
      renderDestinations(analytics);
      renderActivity(analytics);
    }

    function computeAnalytics(players) {
      var analytics = {
        total: players.length,
        available: 0,
        committed: 0,
        last24Hours: 0,
        conferences: {},
        positions: {},
        destinations: {},
        recent: []
      };

      var now = new Date();
      var oneDayAgo = new Date(now.getTime() - 24 * 60 * 60 * 1000);

      players.forEach(function(player) {
        if (player.status === 'Available') analytics.available++;
        else if (player.status === 'Committed') analytics.committed++;

        if (player.portal_entry_date) {
          var entryDate = new Date(player.portal_entry_date);
          if (entryDate >= oneDayAgo) analytics.last24Hours++;
        }

        var fromConf = player.prev_conference || 'Unknown';
        var toConf = player.destination_conference || null;
        if (!analytics.conferences[fromConf]) analytics.conferences[fromConf] = { in: 0, out: 0 };
        analytics.conferences[fromConf].out++;
        if (toConf) {
          if (!analytics.conferences[toConf]) analytics.conferences[toConf] = { in: 0, out: 0 };
          analytics.conferences[toConf].in++;
        }

        var pos = player.position || 'Unknown';
        if (!analytics.positions[pos]) analytics.positions[pos] = 0;
        analytics.positions[pos]++;

        if (player.destination && player.status === 'Committed') {
          var dest = player.destination;
          if (!analytics.destinations[dest]) analytics.destinations[dest] = { count: 0, conference: player.destination_conference || '' };
          analytics.destinations[dest].count++;
        }
      });

      analytics.recent = players.slice().sort(function(a, b) {
        return new Date(b.portal_entry_date || 0) - new Date(a.portal_entry_date || 0);
      }).slice(0, 20);

      return analytics;
    }

    function renderStats(analytics) {
      var grid = document.getElementById('statsGrid');
      grid.textContent = '';
      var stats = [
        { label: 'Total in Portal', value: analytics.total },
        { label: 'Available', value: analytics.available },
        { label: 'Committed', value: analytics.committed },
        { label: 'Last 24 Hours', value: analytics.last24Hours }
      ];
      stats.forEach(function(stat) {
        var card = createElement('div', 'stat-card');
        card.appendChild(createElement('div', 'stat-value', stat.value.toString()));
        card.appendChild(createElement('div', 'stat-label', stat.label));
        grid.appendChild(card);
      });
    }

    function renderConferenceChart(analytics) {
      var container = document.getElementById('conferenceChart');
      container.textContent = '';
      var confArray = Object.keys(analytics.conferences).map(function(conf) {
        var data = analytics.conferences[conf];
        return { name: conf, in: data.in, out: data.out, net: data.in - data.out, total: data.in + data.out };
      }).sort(function(a, b) { return b.total - a.total; }).slice(0, 8);

      var maxValue = Math.max.apply(null, confArray.map(function(c) { return Math.max(c.in, c.out); })) || 1;

      confArray.forEach(function(conf) {
        var row = createElement('div', 'conference-bar');
        row.appendChild(createElement('div', 'conference-name', conf.name));

        var bars = createElement('div', 'conference-bars');
        var inContainer = createElement('div', 'bar-container');
        var inBar = createElement('div', 'bar-in');
        inBar.style.width = ((conf.in / maxValue) * 100) + '%';
        inContainer.appendChild(inBar);
        bars.appendChild(inContainer);

        var outContainer = createElement('div', 'bar-container');
        var outBar = createElement('div', 'bar-out');
        outBar.style.width = ((conf.out / maxValue) * 100) + '%';
        outContainer.appendChild(outBar);
        bars.appendChild(outContainer);
        row.appendChild(bars);

        var stats = createElement('div', 'conference-stats');
        stats.appendChild(createElement('span', 'stat-in', '+' + conf.in));
        stats.appendChild(createElement('span', 'stat-out', '-' + conf.out));
        var netClass = 'stat-net' + (conf.net > 0 ? ' positive' : conf.net < 0 ? ' negative' : ' neutral');
        stats.appendChild(createElement('span', netClass, (conf.net > 0 ? '+' : '') + conf.net));
        row.appendChild(stats);
        container.appendChild(row);
      });
    }

    function renderPositions(analytics) {
      var grid = document.getElementById('positionGrid');
      grid.textContent = '';
      var posArray = Object.keys(analytics.positions).map(function(pos) {
        return { name: pos, count: analytics.positions[pos] };
      }).sort(function(a, b) { return b.count - a.count; }).slice(0, 9);

      posArray.forEach(function(pos) {
        var item = createElement('div', 'position-item');
        if (activePosition === pos.name) item.classList.add('selected');
        item.appendChild(createElement('div', 'position-name', pos.name));
        item.appendChild(createElement('div', 'position-count', pos.count.toString()));
        item.appendChild(createElement('div', 'position-pct', ((pos.count / analytics.total) * 100).toFixed(1) + '%'));
        item.addEventListener('click', function() {
          document.querySelectorAll('.filter-chip').forEach(function(c) { c.classList.remove('active'); });
          var chip = document.querySelector('.filter-chip[data-position="' + pos.name + '"]');
          if (chip) chip.classList.add('active');
          activePosition = pos.name;
          applyFilter();
        });
        grid.appendChild(item);
      });
    }

    function renderDestinations(analytics) {
      var list = document.getElementById('destinationList');
      list.textContent = '';
      var destArray = Object.keys(analytics.destinations).map(function(school) {
        return { school: school, count: analytics.destinations[school].count, conference: analytics.destinations[school].conference };
      }).sort(function(a, b) { return b.count - a.count; }).slice(0, 10);

      destArray.forEach(function(dest, index) {
        var item = createElement('div', 'destination-item');
        item.appendChild(createElement('div', 'destination-rank', (index + 1).toString()));
        var logoUrl = getSchoolLogoUrl(dest.school);
        if (logoUrl) {
          var logo = document.createElement('img');
          logo.className = 'destination-logo';
          logo.src = logoUrl;
          logo.alt = dest.school;
          logo.onerror = function() { this.style.display = 'none'; };
          item.appendChild(logo);
        }
        var info = createElement('div', 'destination-info');
        info.appendChild(createElement('div', 'destination-school', dest.school));
        info.appendChild(createElement('div', 'destination-conf', dest.conference));
        item.appendChild(info);
        item.appendChild(createElement('div', 'destination-count', dest.count.toString()));
        list.appendChild(item);
      });
    }

    function renderActivity(analytics) {
      var list = document.getElementById('activityList');
      list.textContent = '';
      analytics.recent.forEach(function(player) {
        var item = createElement('div', 'activity-item');
        item.appendChild(createElement('div', 'activity-date', formatDate(player.portal_entry_date)));
        item.appendChild(createElement('div', 'activity-player', player.name));
        item.appendChild(createElement('div', 'activity-position', player.position));
        var flow = createElement('div', 'activity-flow');
        flow.appendChild(document.createTextNode(player.prev_school || 'Unknown'));
        flow.appendChild(createElement('span', 'activity-arrow', ' â†’ '));
        flow.appendChild(document.createTextNode(player.destination || 'TBD'));
        item.appendChild(flow);
        list.appendChild(item);
      });
    }

    // Player Comparison
    function setupComparison() {
      ['1', '2'].forEach(function(num) {
        var input = document.getElementById('search' + num);
        var results = document.getElementById('results' + num);

        input.addEventListener('input', function() {
          var query = this.value.toLowerCase().trim();
          results.textContent = '';
          if (query.length < 2) { results.classList.remove('show'); return; }

          var matches = allPlayers.filter(function(p) {
            return p.name && p.name.toLowerCase().indexOf(query) !== -1;
          }).slice(0, 10);

          if (matches.length === 0) { results.classList.remove('show'); return; }

          matches.forEach(function(player) {
            var item = createElement('div', 'search-result-item');
            item.appendChild(createElement('div', 'search-result-name', player.name));
            item.appendChild(createElement('div', 'search-result-meta', player.position + ' | ' + (player.prev_school || 'Unknown')));
            item.addEventListener('click', function() {
              selectPlayer(parseInt(num) - 1, player);
              input.value = player.name;
              results.classList.remove('show');
            });
            results.appendChild(item);
          });
          results.classList.add('show');
        });

        input.addEventListener('blur', function() {
          setTimeout(function() { results.classList.remove('show'); }, 200);
        });
      });
    }

    function selectPlayer(slot, player) {
      comparedPlayers[slot] = player;
      renderComparison();
    }

    function removePlayer(slot) {
      comparedPlayers[slot] = null;
      document.getElementById('search' + (slot + 1)).value = '';
      renderComparison();
    }

    function renderComparison() {
      var grid = document.getElementById('comparisonGrid');
      grid.textContent = '';

      for (var i = 0; i < 2; i++) {
        var player = comparedPlayers[i];
        var container;

        if (player) {
          container = createElement('div', 'comparison-player');
          var avatar = createElement('div', 'comparison-avatar', getInitials(player.name));
          container.appendChild(avatar);
          container.appendChild(createElement('div', 'comparison-name', player.name));
          container.appendChild(createElement('div', 'comparison-meta', player.position + ' | ' + (player.prev_school || 'Unknown')));

          var statsList = createElement('div', 'comparison-stats-list');
          var fields = [
            { label: 'Previous School', value: player.prev_school || 'N/A' },
            { label: 'Conference', value: player.prev_conference || 'N/A' },
            { label: 'Status', value: player.status || 'N/A' },
            { label: 'Destination', value: player.destination || 'TBD' },
            { label: 'Portal Entry', value: formatDate(player.portal_entry_date) },
            { label: 'Stats', value: player.stats || 'N/A' }
          ];
          fields.forEach(function(field) {
            var row = createElement('div', 'comparison-stat-row');
            row.appendChild(createElement('span', 'comparison-stat-label', field.label));
            row.appendChild(createElement('span', 'comparison-stat-value', field.value));
            statsList.appendChild(row);
          });
          container.appendChild(statsList);

          var removeBtn = createElement('button', 'remove-player', 'Remove');
          (function(idx) {
            removeBtn.addEventListener('click', function() { removePlayer(idx); });
          })(i);
          container.appendChild(removeBtn);
        } else {
          container = createElement('div', 'comparison-empty', 'Search and select Player ' + (i + 1) + ' above');
          container.id = 'player' + (i + 1) + 'Slot';
        }

        grid.appendChild(container);
        if (i === 0) grid.appendChild(createElement('div', 'comparison-vs', 'VS'));
      }
    }

    // Historical Trends
    function setupTrends() {
      document.querySelectorAll('.season-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.season-btn').forEach(function(b) { b.classList.remove('active'); });
          this.classList.add('active');
          renderTrends(this.getAttribute('data-season'));
        });
      });
    }

    function renderTrends(season) {
      var data = historicalData[season];
      if (season === '2025') {
        // Use current data for 2025
        data = { total: allPlayers.length, committed: filteredPlayers.filter(function(p) { return p.status === 'Committed'; }).length, byMonth: [0,0,0,0,0,0,0,0,0,0,0,0] };
        allPlayers.forEach(function(p) {
          if (p.portal_entry_date) {
            var month = new Date(p.portal_entry_date).getMonth();
            data.byMonth[month]++;
          }
        });
      }

      var barsContainer = document.getElementById('trendBars');
      barsContainer.textContent = '';
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      var maxVal = Math.max.apply(null, data.byMonth) || 1;

      data.byMonth.forEach(function(val, idx) {
        var wrapper = createElement('div', 'trend-bar-wrapper');
        var bar = createElement('div', 'trend-bar');
        bar.style.height = ((val / maxVal) * 180) + 'px';
        wrapper.appendChild(bar);
        wrapper.appendChild(createElement('div', 'trend-label', months[idx]));
        wrapper.appendChild(createElement('div', 'trend-value', val.toString()));
        barsContainer.appendChild(wrapper);
      });

      var summaryContainer = document.getElementById('trendSummary');
      summaryContainer.textContent = '';

      var prevSeason = parseInt(season) - 1;
      var prevData = historicalData[prevSeason] || { total: 0, committed: 0 };
      var totalChange = data.total - prevData.total;
      var commitChange = data.committed - prevData.committed;

      var summaryStats = [
        { label: 'Total Entries', value: data.total, change: totalChange, hasPrev: !!historicalData[prevSeason] },
        { label: 'Commitments', value: data.committed, change: commitChange, hasPrev: !!historicalData[prevSeason] },
        { label: 'Commit Rate', value: (data.total > 0 ? ((data.committed / data.total) * 100).toFixed(1) : 0) + '%', change: null },
        { label: 'Peak Month', value: months[data.byMonth.indexOf(Math.max.apply(null, data.byMonth))], change: null }
      ];

      summaryStats.forEach(function(stat) {
        var card = createElement('div', 'trend-stat');
        card.appendChild(createElement('div', 'trend-stat-label', stat.label));
        card.appendChild(createElement('div', 'trend-stat-value', stat.value.toString()));
        if (stat.change !== null && stat.hasPrev) {
          var changeClass = 'trend-stat-change' + (stat.change > 0 ? ' up' : stat.change < 0 ? ' down' : '');
          var changeText = (stat.change > 0 ? '+' : '') + stat.change + ' vs last season';
          card.appendChild(createElement('div', changeClass, changeText));
        }
        summaryContainer.appendChild(card);
      });
    }

    // Export Functions
    function exportToCSV() {
      if (allPlayers.length === 0) return;

      var headers = ['Name', 'Position', 'Previous School', 'Conference', 'Status', 'New School', 'Year'];
      var rows = allPlayers.map(function(p) {
        return [
          '"' + (p.name || '').replace(/"/g, '""') + '"',
          p.position || '',
          '"' + (p.previousSchool || p.school || '').replace(/"/g, '""') + '"',
          p.conference || '',
          p.status || 'In Portal',
          '"' + (p.newSchool || '').replace(/"/g, '""') + '"',
          p.year || ''
        ].join(',');
      });

      var csv = headers.join(',') + '\n' + rows.join('\n');
      var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      var link = document.createElement('a');
      var url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'transfer-portal-' + new Date().toISOString().split('T')[0] + '.csv');
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    async function exportToPDF() {
      var btn = document.getElementById('exportPdf');
      var originalText = btn.innerHTML;
      btn.innerHTML = '<svg class="spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/></svg> Generating...';
      btn.disabled = true;

      try {
        var content = document.getElementById('content');
        var canvas = await html2canvas(content, {
          backgroundColor: '#0D0D0D',
          scale: 2,
          useCORS: true,
          logging: false
        });

        var jsPDF = window.jspdf.jsPDF;
        var imgWidth = 210;
        var pageHeight = 297;
        var imgHeight = (canvas.height * imgWidth) / canvas.width;
        var pdf = new jsPDF('p', 'mm', 'a4');

        var heightLeft = imgHeight;
        var position = 0;

        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }

        pdf.save('transfer-portal-analytics-' + new Date().toISOString().split('T')[0] + '.pdf');
      } catch (error) {
        console.error('PDF export failed:', error);
        alert('Failed to generate PDF. Please try again.');
      } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    }

    function setupExports() {
      var csvBtn = document.getElementById('exportCsv');
      var pdfBtn = document.getElementById('exportPdf');

      csvBtn.disabled = false;
      pdfBtn.disabled = false;

      csvBtn.addEventListener('click', exportToCSV);
      pdfBtn.addEventListener('click', exportToPDF);
    }

    function showError(message) {
      var loadingState = document.getElementById('loadingState');
      loadingState.textContent = '';
      loadingState.appendChild(createElement('p', 'error-text', message));
    }

    async function init() {
      try {
        var response = await fetch('https://blaze-sports-api.wshobson.workers.dev/api/transfer-portal');
        if (!response.ok) throw new Error('Failed to fetch');
        var data = await response.json();
        allPlayers = data.players || [];
        filteredPlayers = allPlayers;

        setupPositionFilters();
        var analytics = computeAnalytics(allPlayers);
        renderStats(analytics);
        renderConferenceChart(analytics);
        renderPositions(analytics);
        renderDestinations(analytics);
        renderActivity(analytics);
        setupComparison();
        await loadHistoricalData();
        setupTrends();
        renderTrends('2025');

        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        setupExports();
      } catch (error) {
        console.error('Error loading analytics:', error);
        showError('Failed to load analytics. Please refresh the page.');
      }
    }

    init();
  </script>
</body>
</html>
