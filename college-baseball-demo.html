<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>College Baseball - Blaze Sports Intel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
      background: #f3f4f6;
      padding: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .header {
      background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
      color: white;
      padding: 1rem 1rem 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      max-width: 640px;
      margin: 0 auto;
    }

    .header h1 {
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }

    .header-subtitle {
      font-size: 0.875rem;
      opacity: 0.9;
      margin-bottom: 1rem;
    }

    .last-update {
      font-size: 0.75rem;
      opacity: 0.8;
      text-align: center;
      padding: 0.5rem;
      background: rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    .container {
      max-width: 640px;
      margin: 0 auto;
      padding: 1rem;
    }

    .filter-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 0.5rem;
    }

    .filter-tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 0.625rem 1.25rem;
      border: 2px solid #e5e7eb;
      border-radius: 9999px;
      background: white;
      color: #6b7280;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      min-height: 44px;
      display: flex;
      align-items: center;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .tab.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .tab:active {
      transform: scale(0.95);
    }

    .game-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .game-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      -webkit-tap-highlight-color: transparent;
    }

    .game-card.live {
      border-color: #dc2626;
      background: linear-gradient(to bottom, #fef2f2 0%, white 100%);
    }

    .game-card:active {
      transform: scale(0.98);
    }

    .live-indicator {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.75rem;
      font-weight: 700;
      color: #dc2626;
      background: white;
      padding: 0.25rem 0.5rem;
      border-radius: 9999px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #dc2626;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .game-info {
      margin-bottom: 1rem;
      font-size: 0.875rem;
      color: #6b7280;
    }

    .time-venue {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }

    .conference-badge {
      display: inline-block;
      background: #eff6ff;
      color: #1e40af;
      padding: 0.125rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .teams {
      display: flex;
      flex-direction: column;
      gap: 0.875rem;
    }

    .team {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .team-name {
      font-size: 1.125rem;
      font-weight: 600;
      color: #111827;
      flex: 1;
    }

    .team-record {
      font-size: 0.875rem;
      color: #6b7280;
    }

    .score {
      font-size: 1.75rem;
      font-weight: 700;
      color: #111827;
      min-width: 2.5rem;
      text-align: right;
    }

    .inning-info {
      text-align: center;
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
    }

    .box-score-link {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e7eb;
      text-align: center;
    }

    .box-score-btn {
      width: 100%;
      padding: 0.75rem;
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .box-score-btn:hover {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e40af 100%);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }

    .box-score-btn:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(37, 99, 235, 0.2);
    }

    .refresh-button {
      width: 100%;
      margin-top: 1.5rem;
      padding: 1rem;
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
      -webkit-tap-highlight-color: transparent;
    }

    .refresh-button:active {
      transform: scale(0.98);
      box-shadow: 0 1px 4px rgba(37, 99, 235, 0.3);
    }

    .refresh-button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }

    .loading {
      text-align: center;
      padding: 3rem 1rem;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 1rem;
      border: 3px solid #e5e7eb;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .feature-banner {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
    }

    .feature-banner h3 {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }

    .feature-list {
      font-size: 0.875rem;
      line-height: 1.6;
      opacity: 0.95;
    }

    .feature-list li {
      margin-bottom: 0.25rem;
      padding-left: 1rem;
      position: relative;
    }

    .feature-list li::before {
      content: '✓';
      position: absolute;
      left: 0;
      font-weight: bold;
    }

    @media (min-width: 640px) {
      .container {
        padding: 1.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>⚾ College Baseball</h1>
      <div class="header-subtitle">Mobile-First Game Center</div>
      <div class="last-update" id="lastUpdate">
        Loading...
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Feature Banner -->
    <div class="feature-banner">
      <h3>✅ Live Features Activated</h3>
      <ul class="feature-list">
        <li>Real NCAA data via Cloudflare API</li>
        <li>Live game updates every 30 seconds</li>
        <li>Full box scores with detailed stats</li>
        <li>Offline caching with fallback support</li>
        <li>Mobile-first responsive design</li>
        <li>Conference filtering & game status tabs</li>
      </ul>
    </div>

    <!-- Filter tabs -->
    <div class="filter-tabs">
      <button class="tab active" data-filter="all">All Games</button>
      <button class="tab" data-filter="live">Live</button>
      <button class="tab" data-filter="scheduled">Upcoming</button>
      <button class="tab" data-filter="final">Final</button>
    </div>

    <!-- Loading state -->
    <div class="loading" id="loading">
      <div class="spinner"></div>
      <p>Loading games...</p>
    </div>

    <!-- Game list -->
    <div class="game-list" id="gameList" style="display: none;"></div>

    <!-- Empty state -->
    <div class="empty-state" id="emptyState" style="display: none;">
      <div class="empty-state-icon">⚾</div>
      <p>No games available</p>
    </div>

    <!-- Refresh button -->
    <button class="refresh-button" id="refreshBtn">
      Refresh Games
    </button>
  </div>

  <script>
    /**
     * College Baseball Demo - Real API Integration
     * Connects to Cloudflare Functions API for live NCAA data
     */

    const API_BASE = '/api/college-baseball';
    const REFRESH_INTERVAL = 30000; // 30 seconds for live games

    let currentFilter = 'all';
    let games = [];
    let refreshTimer = null;

    // Initialize
    async function init() {
      setupEventListeners();
      await loadGames();
      startAutoRefresh();

      console.log('[College Baseball Demo] Initialized with real NCAA API');
    }

    function setupEventListeners() {
      // Filter tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          renderGames();
        });
      });

      // Refresh button
      document.getElementById('refreshBtn').addEventListener('click', () => {
        loadGames();
      });
    }

    async function loadGames(showLoading = true) {
      if (showLoading) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('gameList').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
      }

      try {
        // Fetch from real API
        const response = await fetch(`${API_BASE}/games`);
        const result = await response.json();

        if (result.success && result.data) {
          games = result.data;
          console.log(`[API] Loaded ${games.length} games`, result.cached ? '(from cache)' : '(live)');
        } else {
          throw new Error(result.error || 'Failed to fetch games');
        }

        renderGames();
        updateLastUpdateTime();

      } catch (error) {
        console.error('[API] Error loading games:', error);

        // Try to load from cache
        const cachedGames = await loadFromCache();
        if (cachedGames) {
          games = cachedGames;
          renderGames();
          showNotice('Showing cached data - Unable to reach server');
        } else {
          showError('Unable to load games. Please check your connection and try again.');
        }
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    function renderGames() {
      const gameList = document.getElementById('gameList');
      const emptyState = document.getElementById('emptyState');

      // Filter games
      const filteredGames = games.filter(game => {
        if (currentFilter === 'all') return true;
        return game.status === currentFilter;
      });

      if (filteredGames.length === 0) {
        gameList.style.display = 'none';
        emptyState.style.display = 'block';
        emptyState.querySelector('p').textContent = games.length === 0
          ? 'No games available. This is currently college baseball off-season (October 2025). Games will return in February 2026!'
          : `No ${currentFilter} games right now`;
        return;
      }

      gameList.style.display = 'flex';
      emptyState.style.display = 'none';

      gameList.innerHTML = filteredGames.map(game => createGameCard(game)).join('');

      // Add click handlers for box scores
      attachBoxScoreHandlers();
    }

    function createGameCard(game) {
      const isLive = game.status === 'live';
      const isFinal = game.status === 'final';
      const hasScore = isLive || isFinal;

      return `
        <div class="game-card ${isLive ? 'live' : ''}" data-game-id="${game.id}">
          ${isLive ? `
            <div class="live-indicator">
              <span class="live-dot"></span>
              LIVE
            </div>
          ` : ''}

          <div class="game-info">
            <div class="time-venue">
              ${isFinal ? 'Final' : game.time || 'TBD'} • ${game.venue || 'TBD'}
            </div>
            ${game.tv ? `<div>📺 ${game.tv}</div>` : ''}
            ${game.homeTeam?.conference ? `<span class="conference-badge">${game.homeTeam.conference}</span>` : ''}
          </div>

          <div class="teams">
            <div class="team">
              <div class="team-name">${game.awayTeam?.shortName || game.awayTeam?.name || 'Away'}</div>
              ${game.awayTeam?.record ? `<div class="team-record">(${game.awayTeam.record.wins}-${game.awayTeam.record.losses})</div>` : ''}
              ${hasScore ? `<div class="score">${game.awayTeam?.score ?? '-'}</div>` : ''}
            </div>
            <div class="team">
              <div class="team-name">${game.homeTeam?.shortName || game.homeTeam?.name || 'Home'}</div>
              ${game.homeTeam?.record ? `<div class="team-record">(${game.homeTeam.record.wins}-${game.homeTeam.record.losses})</div>` : ''}
              ${hasScore ? `<div class="score">${game.homeTeam?.score ?? '-'}</div>` : ''}
            </div>
          </div>

          ${isLive && game.inning ? `
            <div class="inning-info">
              ${formatInning(game.inningHalf, game.inning)}
            </div>
          ` : ''}

          ${hasScore ? `
            <div class="box-score-link" onclick="viewGame('${game.id}', event)">
              <button class="box-score-btn">View Box Score →</button>
            </div>
          ` : ''}
        </div>
      `;
    }

    function attachBoxScoreHandlers() {
      // Handlers are inline in the HTML for simplicity
    }

    function formatInning(half, inning) {
      const halfText = half === 'top' ? 'Top' : half === 'bottom' ? 'Bottom' : 'End';
      const inningText = getOrdinal(inning);
      return `${halfText} ${inningText}`;
    }

    function getOrdinal(n) {
      const suffixes = ['th', 'st', 'nd', 'rd'];
      const v = n % 100;
      return n + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
    }

    function updateLastUpdateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', {
        hour: 'numeric',
        minute: '2-digit',
        timeZone: 'America/Chicago'
      });
      document.getElementById('lastUpdate').textContent = `Updated ${timeStr} CT`;
    }

    async function viewGame(gameId, event) {
      if (event) event.stopPropagation();

      console.log('[Box Score] Loading for game:', gameId);

      try {
        const response = await fetch(`${API_BASE}/boxscore?gameId=${gameId}`);
        const result = await response.json();

        if (result.success && result.data) {
          // For now, navigate to the full games page which has box score support
          // In a future update, we can render box scores inline
          window.location.href = `/college-baseball/games/#game-${gameId}`;
        } else {
          alert('Box score temporarily unavailable. The full games page has complete box scores!');
        }
      } catch (error) {
        console.error('[Box Score] Error:', error);
        alert('Unable to load box score. Try the full games page at /college-baseball/games/');
      }
    }

    function startAutoRefresh() {
      if (refreshTimer) clearInterval(refreshTimer);

      refreshTimer = setInterval(() => {
        const hasLiveGames = games.some(g => g.status === 'live');
        if (hasLiveGames) {
          console.log('[Auto-refresh] Updating live games...');
          loadGames(false);
        }
      }, REFRESH_INTERVAL);
    }

    async function loadFromCache() {
      if ('caches' in window) {
        try {
          const cache = await caches.open('college-baseball-v1');
          const cached = await cache.match(`${API_BASE}/games`);
          if (cached) {
            const result = await cached.json();
            return result.data || null;
          }
        } catch (err) {
          console.warn('[Cache] Failed to load:', err);
        }
      }
      return null;
    }

    function showNotice(message) {
      const banner = document.createElement('div');
      banner.className = 'notice-banner';
      banner.textContent = message;
      banner.style.cssText = `
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: #f59e0b;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      `;
      document.body.appendChild(banner);
      setTimeout(() => banner.remove(), 5000);
    }

    function showError(message) {
      const emptyState = document.getElementById('emptyState');
      emptyState.style.display = 'block';
      emptyState.innerHTML = `
        <div class="empty-state-icon">⚠️</div>
        <p>${message}</p>
        <button onclick="location.reload()" style="
          margin-top: 1rem;
          padding: 0.75rem 1.5rem;
          background: #2563eb;
          color: white;
          border: none;
          border-radius: 8px;
          font-weight: 600;
          cursor: pointer;
        ">Retry</button>
      `;
    }

    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/college-baseball-sw.js')
          .then((registration) => {
            console.log('[Service Worker] Registered successfully:', registration.scope);
          })
          .catch((error) => {
            console.log('[Service Worker] Registration failed:', error);
          });
      });
    }

    // Start the app
    init();
  </script>
</body>
</html>
