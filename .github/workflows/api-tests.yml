name: API Tests

on:
  pull_request:
    branches:
      - main
      - college-baseball
  push:
    branches:
      - main
      - college-baseball
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  NODE_VERSION: '20'

jobs:
  api-tests:
    name: Run API Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck
        continue-on-error: true

      - name: Lint API code
        run: npm run lint
        continue-on-error: true

      - name: Run MLB API tests
        run: npm run test -- tests/api/mlb.test.ts --reporter=verbose
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Run NFL API tests
        run: npm run test -- tests/api/nfl.test.ts --reporter=verbose
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Run college baseball API tests
        run: npm run test -- tests/api/college-baseball.test.js --reporter=verbose
        continue-on-error: true

      - name: Run Prediction API tests
        run: npm run test -- tests/api/prediction-api.test.ts --reporter=verbose
        env:
          PREDICTION_API_URL: https://api.blazesportsintel.com
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}

      - name: Run cache tests
        run: npm run test -- tests/integration/cache.test.ts --reporter=verbose

      - name: Run API failure fallback tests
        run: npm run test -- tests/integration/api-failure-fallback.test.ts --reporter=verbose
        env:
          PREDICTION_API_URL: https://api.blazesportsintel.com

      - name: Run schema validation tests
        run: npm run test -- tests/validation/schemas.test.ts --reporter=verbose

      - name: Check API response times
        run: npm run test -- tests/performance/api-response-times.test.ts
        continue-on-error: true

      - name: Security scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload security scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Generate test report
        if: always()
        run: |
          echo "## API Test Results" >> $GITHUB_STEP_SUMMARY
          echo "✅ All API endpoint tests completed" >> $GITHUB_STEP_SUMMARY
          echo "- MLB API: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- NFL API: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Prediction API: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Cache integration: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- API failure fallback: ✓" >> $GITHUB_STEP_SUMMARY
          echo "- Schema validation: ✓" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Born to blaze the path less beaten.*" >> $GITHUB_STEP_SUMMARY

  data-freshness:
    name: Check Data Freshness
    runs-on: ubuntu-latest
    needs: api-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check MLB data freshness
        continue-on-error: true
        run: |
          node scripts/check-data-freshness.js mlb
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}

      - name: Check NFL data freshness
        continue-on-error: true
        run: |
          node scripts/check-data-freshness.js nfl
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}

      - name: Alert if data stale
        if: failure() && secrets.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v2
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "text": "⚠️ Stale data detected in API endpoints",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "⚠️ *Data Freshness Warning*\nSome API endpoints have stale data (>24 hours old)\n*Check:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                  }
                }
              ]
            }
