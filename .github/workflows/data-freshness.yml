name: Data Freshness Check

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '20'

jobs:
  check-data-freshness:
    name: Check API Data Freshness
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check MLB API freshness
        id: mlb_check
        run: |
          result=$(node scripts/check-data-freshness.js mlb)
          echo "result=$result" >> $GITHUB_OUTPUT
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true

      - name: Check NFL API freshness
        id: nfl_check
        run: |
          result=$(node scripts/check-data-freshness.js nfl)
          echo "result=$result" >> $GITHUB_OUTPUT
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true

      - name: Check NBA API freshness
        id: nba_check
        run: |
          result=$(node scripts/check-data-freshness.js nba)
          echo "result=$result" >> $GITHUB_OUTPUT
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true

      - name: Check College Baseball API freshness
        id: cbb_check
        run: |
          result=$(node scripts/check-data-freshness.js college-baseball)
          echo "result=$result" >> $GITHUB_OUTPUT
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        continue-on-error: true

      - name: Verify KV cache is working
        id: cache_check
        run: |
          npm run test -- tests/integration/cache-health.test.ts
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        continue-on-error: true

      - name: Generate report
        run: |
          echo "## Data Freshness Report" >> $GITHUB_STEP_SUMMARY
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### API Endpoints" >> $GITHUB_STEP_SUMMARY
          echo "- MLB: ${{ steps.mlb_check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- NFL: ${{ steps.nfl_check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- NBA: ${{ steps.nba_check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "- College Baseball: ${{ steps.cbb_check.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cache Health" >> $GITHUB_STEP_SUMMARY
          echo "- KV Cache: ${{ steps.cache_check.outcome }}" >> $GITHUB_STEP_SUMMARY

      - name: Alert on stale data
        if: |
          steps.mlb_check.outcome == 'failure' ||
          steps.nfl_check.outcome == 'failure' ||
          steps.nba_check.outcome == 'failure' ||
          steps.cbb_check.outcome == 'failure' ||
          steps.cache_check.outcome == 'failure'
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "⚠️ Data Freshness Alert - Blaze Sports Intel",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "⚠️ Data Freshness Alert"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*MLB API:*\n${{ steps.mlb_check.outcome }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*NFL API:*\n${{ steps.nfl_check.outcome }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*NBA API:*\n${{ steps.nba_check.outcome }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*College Baseball:*\n${{ steps.cbb_check.outcome }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Cache Status:* ${{ steps.cache_check.outcome }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Full Report>"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Create GitHub Issue on failure
        if: |
          steps.mlb_check.outcome == 'failure' ||
          steps.nfl_check.outcome == 'failure' ||
          steps.cache_check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '⚠️ Stale Data Detected in API Endpoints',
              body: `## Data Freshness Check Failed

              **Date:** ${new Date().toISOString()}

              ### Status
              - MLB API: ${{ steps.mlb_check.outcome }}
              - NFL API: ${{ steps.nfl_check.outcome }}
              - NBA API: ${{ steps.nba_check.outcome }}
              - College Baseball: ${{ steps.cbb_check.outcome }}
              - KV Cache: ${{ steps.cache_check.outcome }}

              **Action Required:** Investigate why data is stale and refresh caches.

              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
              labels: ['bug', 'data-freshness', 'automated']
            })

  cache-warming:
    name: Warm Cache for Popular Teams
    runs-on: ubuntu-latest
    needs: check-data-freshness
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Warm MLB cache
        run: node scripts/warm-cache.js mlb
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Warm NFL cache
        run: node scripts/warm-cache.js nfl
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Warm college baseball cache
        run: node scripts/warm-cache.js college-baseball
        env:
          SPORTSDATAIO_API_KEY: ${{ secrets.SPORTSDATAIO_API_KEY }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
