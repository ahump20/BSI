name: College Baseball D1 Ingestion

on:
  schedule:
    # Run daily at 6 AM CT (11 AM UTC) during season
    - cron: '0 11 * * *'
  workflow_dispatch:
    inputs:
      force_refresh:
        description: 'Force full data refresh'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'

jobs:
  ingest-college-baseball:
    name: Ingest College Baseball Data to D1
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Run ingestion script
        run: node scripts/ingest-college-baseball.js
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Execute SQL on D1
        if: success()
        run: |
          if [ -f "d1-college-baseball.sql" ]; then
            wrangler d1 execute bsi-historical-db --remote --file=d1-college-baseball.sql
            echo "D1 ingestion complete"
          else
            echo "No SQL file generated"
            exit 1
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Verify ingestion
        run: |
          wrangler d1 execute bsi-historical-db --remote --command "SELECT COUNT(*) as teams FROM college_baseball_teams"
          wrangler d1 execute bsi-historical-db --remote --command "SELECT COUNT(*) as players FROM college_baseball_players"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Log sync status
        run: |
          echo "## D1 Ingestion Report" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Sources" >> $GITHUB_STEP_SUMMARY
          echo "- ESPN College Baseball API" >> $GITHUB_STEP_SUMMARY
          echo "- Power 5 Conferences: SEC, Big Ten, Big 12, ACC" >> $GITHUB_STEP_SUMMARY

      - name: Alert on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ùå College Baseball D1 Ingestion Failed',
              body: `## D1 Ingestion Failed

              **Date:** ${new Date().toISOString()}

              The scheduled college baseball data ingestion to D1 has failed.

              **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

              **Action Required:** Check ingestion script and ESPN API availability.`,
              labels: ['bug', 'data-ingestion', 'automated']
            })
