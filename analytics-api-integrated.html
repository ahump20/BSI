<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlazeS Analytics - Live Sports Data with Monte Carlo Projections</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        :root {
            --color-burnt-orange: #cc5500;
            --color-bright-orange: #ff6b00;
            --color-deep-red: #8b0000;
            --color-crimson: #dc143c;
            --color-powder-blue: #b0e0e6;
            --color-steel-blue: #4682b4;
            --color-charcoal: #1a1a1a;
            --color-dark-grey: #2a2a2a;
            --color-medium-grey: #3a3a3a;
            --color-light-grey: #666666;
            --font-headings: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            --font-body: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: var(--font-body);
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0f0a 25%, #0f0a0a 50%, #0a0a0f 75%, #0a0a0a 100%);
            color: #ffffff;
            min-height: 100vh;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 30%, rgba(204, 85, 0, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(139, 0, 0, 0.06) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(176, 224, 230, 0.03) 0%, transparent 60%);
            pointer-events: none;
            z-index: 0;
        }

        .back-nav {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(204, 85, 0, 0.3), rgba(139, 0, 0, 0.2));
            border: 2px solid var(--color-burnt-orange);
            border-radius: 8px;
            color: var(--color-bright-orange);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(204, 85, 0, 0.2);
        }

        .back-btn:hover {
            background: linear-gradient(135deg, rgba(204, 85, 0, 0.5), rgba(139, 0, 0, 0.3));
            transform: translateX(-5px);
            box-shadow: 0 6px 16px rgba(204, 85, 0, 0.4);
        }

        #root {
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .error-message {
            background: linear-gradient(135deg, rgba(220, 20, 60, 0.2), rgba(139, 0, 0, 0.15));
            border: 2px solid var(--color-deep-red);
            border-radius: 8px;
            padding: 16px;
            margin: 20px;
            color: var(--color-crimson);
            text-align: center;
        }

        .loading-data {
            text-align: center;
            padding: 40px;
            color: var(--color-powder-blue);
        }

        .api-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .api-status.live {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(46, 125, 50, 0.2));
            border: 1px solid #4CAF50;
            color: #8BC34A;
        }

        .api-status.cached {
            background: linear-gradient(135deg, rgba(255, 152, 0, 0.3), rgba(245, 124, 0, 0.2));
            border: 1px solid #FF9800;
            color: #FFB74D;
        }
    </style>
</head>
<body>
    <nav class="back-nav">
        <a href="/" class="back-btn">
            ‚Üê Back to Home
        </a>
    </nav>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // API Data Fetching Functions
        const fetchNFLData = async () => {
            const response = await fetch('/api/nfl/standings?season=2025');
            const json = await response.json();

            if (!json.data) {
                throw new Error(json.error || 'Failed to fetch NFL data');
            }

            // Transform SportsDataIO response to our format
            return {
                teams: json.data.map(team => ({
                    name: team.Name,
                    div: `${team.Conference} ${team.Division}`,
                    currentWins: team.Wins,
                    games: 17,
                    baseWinProb: team.Wins / (team.Wins + team.Losses || 1),
                    gamesLeft: 17 - (team.Wins + team.Losses + (team.Ties || 0))
                })),
                meta: json.meta
            };
        };

        const fetchMLBData = async () => {
            const response = await fetch('/api/mlb/standings?season=2025');
            const json = await response.json();

            if (!json.data) {
                throw new Error(json.error || 'Failed to fetch MLB data');
            }

            // Transform SportsDataIO response to our format
            return {
                teams: json.data.map(team => ({
                    name: team.Name,
                    div: `${team.League} ${team.Division}`,
                    currentWins: team.Wins,
                    games: 162,
                    baseWinProb: team.Wins / (team.Wins + team.Losses || 1),
                    gamesLeft: 162 - (team.Wins + team.Losses)
                })),
                meta: json.meta
            };
        };

        const fetchSECData = async () => {
            const response = await fetch('/api/cfb/standings?season=2025&conference=SEC');
            const json = await response.json();

            if (!json.data) {
                throw new Error(json.error || 'Failed to fetch SEC data');
            }

            // Transform SportsDataIO response to our format
            return {
                teams: json.data.map(team => ({
                    name: team.School || team.Name,
                    div: team.Division || 'SEC',
                    currentWins: team.Wins,
                    games: 12,
                    baseWinProb: team.Wins / (team.Wins + team.Losses || 1),
                    gamesLeft: 12 - (team.Wins + team.Losses)
                })),
                meta: json.meta
            };
        };

        // Monte Carlo Simulation Engine
        const normalRandom = (mean, stdDev) => {
            let u1 = Math.random();
            let u2 = Math.random();
            let z0 = Math.sqrt(-2.0 * Math.log(u1)) * Math.cos(2.0 * Math.PI * u2);
            return z0 * stdDev + mean;
        };

        const monteCarloSeasonSimulation = (team, gamesRemaining, iterations) => {
            const results = [];
            const baseProb = team.baseWinProb;
            const momentum = team.currentWins > (team.games - team.gamesLeft) * baseProb ? 0.05 : -0.03;
            const variance = 0.15 + (1 - baseProb) * 0.1;

            for (let i = 0; i < iterations; i++) {
                let wins = team.currentWins;
                for (let game = 0; game < gamesRemaining; game++) {
                    const adjustedProb = Math.max(0.1, Math.min(0.9,
                        baseProb + momentum + normalRandom(0, variance)
                    ));
                    if (Math.random() < adjustedProb) {
                        wins++;
                    }
                }
                results.push(wins);
            }
            return results;
        };

        const calculateStats = (results) => {
            const mean = results.reduce((a, b) => a + b, 0) / results.length;
            const sorted = [...results].sort((a, b) => a - b);
            const median = sorted[Math.floor(sorted.length / 2)];
            const stdDev = Math.sqrt(results.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / results.length);
            const mode = results.reduce((acc, val) => {
                acc[val] = (acc[val] || 0) + 1;
                return acc;
            }, {});
            const mostFrequent = Object.keys(mode).reduce((a, b) => mode[a] > mode[b] ? a : b);

            return {
                mean: mean.toFixed(1),
                median: median,
                stdDev: stdDev.toFixed(2),
                mode: mostFrequent,
                min: Math.min(...results),
                max: Math.max(...results),
                confidence90: {
                    lower: sorted[Math.floor(results.length * 0.05)],
                    upper: sorted[Math.floor(results.length * 0.95)]
                }
            };
        };

        function App() {
            const [activeLeague, setActiveLeague] = useState('NFL');
            const [simulations, setSimulations] = useState({});
            const [loading, setLoading] = useState(true);
            const [dataLoading, setDataLoading] = useState(true);
            const [error, setError] = useState(null);
            const [leagueData, setLeagueData] = useState({});
            const [apiMeta, setApiMeta] = useState({});

            // Fetch live data from backend API
            useEffect(() => {
                const loadAllData = async () => {
                    setDataLoading(true);
                    setError(null);
                    try {
                        const [nflData, mlbData, secData] = await Promise.all([
                            fetchNFLData(),
                            fetchMLBData(),
                            fetchSECData()
                        ]);

                        setLeagueData({
                            'NFL': nflData.teams,
                            'MLB': mlbData.teams,
                            'SEC': secData.teams
                        });

                        setApiMeta({
                            'NFL': nflData.meta,
                            'MLB': mlbData.meta,
                            'SEC': secData.meta
                        });

                        setDataLoading(false);
                    } catch (err) {
                        console.error('Failed to load data:', err);
                        setError(err.message);
                        setDataLoading(false);
                    }
                };

                loadAllData();
            }, []);

            useEffect(() => {
                if (!dataLoading && leagueData[activeLeague]) {
                    runSimulations(activeLeague);
                }
            }, [activeLeague, dataLoading, leagueData]);

            const runSimulations = (league) => {
                setLoading(true);
                setTimeout(() => {
                    const teams = leagueData[league];
                    if (!teams) {
                        setLoading(false);
                        return;
                    }

                    const results = {};

                    teams.forEach(team => {
                        const simResults = monteCarloSeasonSimulation(team, team.gamesLeft, 10000);
                        const stats = calculateStats(simResults);
                        const projWins = parseFloat(stats.mean);

                        let playoffProb, championshipProb;

                        if (league === 'NFL') {
                            playoffProb = projWins >= 12 ? 85 + Math.random() * 12 :
                                        projWins >= 11 ? 70 + Math.random() * 15 :
                                        projWins >= 10 ? 55 + Math.random() * 20 :
                                        projWins >= 9 ? 35 + Math.random() * 20 :
                                        projWins >= 8 ? 15 + Math.random() * 20 : Math.random() * 10;
                            championshipProb = projWins >= 13 ? 12 + Math.random() * 8 :
                                            projWins >= 12 ? 6 + Math.random() * 6 :
                                            projWins >= 11 ? 3 + Math.random() * 4 :
                                            projWins >= 10 ? 1 + Math.random() * 2 : Math.random() * 1;
                        } else if (league === 'SEC') {
                            playoffProb = projWins >= 11 ? 85 + Math.random() * 10 :
                                        projWins >= 10 ? 65 + Math.random() * 15 :
                                        projWins >= 9 ? 40 + Math.random() * 20 :
                                        projWins >= 8 ? 20 + Math.random() * 15 : Math.random() * 10;
                            championshipProb = projWins >= 12 ? 25 + Math.random() * 15 :
                                            projWins >= 11 ? 12 + Math.random() * 10 :
                                            projWins >= 10 ? 5 + Math.random() * 5 :
                                            projWins >= 9 ? 2 + Math.random() * 3 : Math.random() * 1;
                        } else { // MLB
                            playoffProb = projWins >= 95 ? 85 + Math.random() * 12 :
                                        projWins >= 90 ? 70 + Math.random() * 15 :
                                        projWins >= 85 ? 50 + Math.random() * 20 :
                                        projWins >= 82 ? 30 + Math.random() * 20 :
                                        projWins >= 80 ? 15 + Math.random() * 15 : Math.random() * 10;
                            championshipProb = projWins >= 100 ? 12 + Math.random() * 8 :
                                            projWins >= 95 ? 6 + Math.random() * 6 :
                                            projWins >= 90 ? 3 + Math.random() * 3 :
                                            projWins >= 85 ? 1 + Math.random() * 2 : Math.random() * 1;
                        }

                        results[team.name] = {
                            ...team,
                            ...stats,
                            playoffProb: playoffProb.toFixed(0),
                            championshipProb: championshipProb.toFixed(1),
                            projectedWins: stats.mean
                        };
                    });

                    setSimulations(results);
                    setLoading(false);
                }, 1500);
            };

            if (dataLoading) {
                return (
                    <div className="loading-data">
                        <h2>Loading Live Sports Data...</h2>
                        <p>Fetching data from SportsDataIO API</p>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="error-message">
                        <h2>‚ùå Failed to Load Data</h2>
                        <p>{error}</p>
                        <button onClick={() => window.location.reload()}>Retry</button>
                    </div>
                );
            }

            const sortedTeams = Object.values(simulations).sort((a, b) =>
                parseFloat(b.projectedWins) - parseFloat(a.projectedWins)
            );

            const leagueStats = {
                'NFL': { teams: leagueData['NFL']?.length || 32, label: 'Super Bowl' },
                'SEC': { teams: leagueData['SEC']?.length || 16, label: 'Championship' },
                'MLB': { teams: leagueData['MLB']?.length || 30, label: 'World Series' }
            };

            const currentMeta = apiMeta[activeLeague] || {};

            return (
                <div style={{ padding: '100px 20px 40px', maxWidth: '1400px', margin: '0 auto' }}>
                    {/* Header */}
                    <div style={{ textAlign: 'center', marginBottom: '40px' }}>
                        <h1 style={{
                            fontSize: '48px',
                            background: 'linear-gradient(135deg, var(--color-bright-orange), var(--color-crimson))',
                            WebkitBackgroundClip: 'text',
                            WebkitTextFillColor: 'transparent',
                            marginBottom: '12px'
                        }}>
                            üî• BlazeS Sports Analytics
                        </h1>
                        <p style={{ color: var(--color-powder-blue), fontSize: '18px', marginBottom: '16px' }}>
                            Live Data ‚Ä¢ Monte Carlo Simulations ‚Ä¢ 10,000 Iterations Per Team
                            <span className={`api-status ${currentMeta.cached ? 'cached' : 'live'}`}>
                                {currentMeta.cached ? 'üì¶ CACHED' : 'üî¥ LIVE'}
                            </span>
                        </p>
                        <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                            <span style={{
                                padding: '6px 16px',
                                background: 'rgba(204, 85, 0, 0.2)',
                                border: '1px solid var(--color-burnt-orange)',
                                borderRadius: '6px',
                                fontSize: '14px'
                            }}>
                                üìä SportsDataIO API
                            </span>
                            <span style={{
                                padding: '6px 16px',
                                background: 'rgba(204, 85, 0, 0.2)',
                                border: '1px solid var(--color-burnt-orange)',
                                borderRadius: '6px',
                                fontSize: '14px'
                            }}>
                                ‚ö° Workers KV Cache
                            </span>
                            <span style={{
                                padding: '6px 16px',
                                background: 'rgba(204, 85, 0, 0.2)',
                                border: '1px solid var(--color-burnt-orange)',
                                borderRadius: '6px',
                                fontSize: '14px'
                            }}>
                                üóÑÔ∏è D1 Database
                            </span>
                        </div>
                        {currentMeta.timestamp && (
                            <p style={{ marginTop: '12px', fontSize: '14px', color: var(--color-light-grey) }}>
                                Last Updated: {new Date(currentMeta.timestamp).toLocaleString('en-US', {
                                    timeZone: 'America/Chicago',
                                    dateStyle: 'medium',
                                    timeStyle: 'short'
                                })} CDT
                            </p>
                        )}
                    </div>

                    {/* League Tabs */}
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', marginBottom: '40px' }}>
                        {['NFL', 'SEC', 'MLB'].map(league => (
                            <button
                                key={league}
                                onClick={() => setActiveLeague(league)}
                                style={{
                                    padding: '12px 24px',
                                    background: activeLeague === league
                                        ? 'linear-gradient(135deg, var(--color-burnt-orange), var(--color-deep-red))'
                                        : 'rgba(42, 42, 42, 0.5)',
                                    border: `2px solid ${activeLeague === league ? 'var(--color-bright-orange)' : 'var(--color-medium-grey)'}`,
                                    borderRadius: '8px',
                                    color: 'white',
                                    fontSize: '16px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease'
                                }}
                            >
                                {league === 'NFL' && 'üèà NFL'}
                                {league === 'SEC' && 'üèà SEC'}
                                {league === 'MLB' && '‚öæ MLB'}
                                {' '}({leagueStats[league].teams} Teams)
                            </button>
                        ))}
                    </div>

                    {/* Main Content */}
                    <div>
                        <h2 style={{ fontSize: '32px', marginBottom: '24px', color: 'var(--color-bright-orange)' }}>
                            {activeLeague} Season Projections
                        </h2>

                        {loading ? (
                            <div style={{ textAlign: 'center', padding: '60px', color: 'var(--color-powder-blue)' }}>
                                <div style={{
                                    width: '60px',
                                    height: '60px',
                                    border: '4px solid rgba(204, 85, 0, 0.2)',
                                    borderTop: '4px solid var(--color-burnt-orange)',
                                    borderRadius: '50%',
                                    animation: 'spin 1s linear infinite',
                                    margin: '0 auto 20px'
                                }}></div>
                                <p>Running {leagueStats[activeLeague].teams * 10000} simulations...</p>
                            </div>
                        ) : (
                            <div style={{
                                background: 'linear-gradient(135deg, rgba(26, 26, 26, 0.8), rgba(42, 42, 42, 0.6))',
                                border: '1px solid rgba(204, 85, 0, 0.3)',
                                borderRadius: '12px',
                                padding: '24px',
                                overflowX: 'auto'
                            }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr style={{ borderBottom: '2px solid var(--color-burnt-orange)' }}>
                                            <th style={{ padding: '12px', textAlign: 'left', color: 'var(--color-bright-orange)' }}>Rank</th>
                                            <th style={{ padding: '12px', textAlign: 'left', color: 'var(--color-bright-orange)' }}>Team</th>
                                            <th style={{ padding: '12px', textAlign: 'left', color: 'var(--color-bright-orange)' }}>Division</th>
                                            <th style={{ padding: '12px', textAlign: 'right', color: 'var(--color-bright-orange)' }}>Current</th>
                                            <th style={{ padding: '12px', textAlign: 'right', color: 'var(--color-bright-orange)' }}>Projected Wins</th>
                                            <th style={{ padding: '12px', textAlign: 'right', color: 'var(--color-bright-orange)' }}>Playoff %</th>
                                            <th style={{ padding: '12px', textAlign: 'right', color: 'var(--color-bright-orange)' }}>{leagueStats[activeLeague].label} %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedTeams.map((team, index) => (
                                            <tr key={team.name} style={{
                                                borderBottom: '1px solid rgba(102, 102, 102, 0.2)',
                                                transition: 'all 0.2s ease'
                                            }}>
                                                <td style={{ padding: '12px' }}>
                                                    <span style={{
                                                        background: index < 6 ? 'linear-gradient(135deg, rgba(204, 85, 0, 0.3), rgba(139, 0, 0, 0.2))' : 'transparent',
                                                        border: index < 6 ? '1px solid var(--color-burnt-orange)' : 'none',
                                                        borderRadius: '6px',
                                                        padding: '4px 12px',
                                                        fontWeight: '600'
                                                    }}>
                                                        {index + 1}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '12px', fontWeight: '600' }}>{team.name}</td>
                                                <td style={{ padding: '12px', color: 'var(--color-light-grey)' }}>{team.div}</td>
                                                <td style={{ padding: '12px', textAlign: 'right' }}>{team.currentWins}-{team.games - team.currentWins - team.gamesLeft}</td>
                                                <td style={{ padding: '12px', textAlign: 'right', color: 'var(--color-powder-blue)', fontWeight: '600' }}>
                                                    {team.projectedWins}
                                                </td>
                                                <td style={{ padding: '12px', textAlign: 'right' }}>{team.playoffProb}%</td>
                                                <td style={{ padding: '12px', textAlign: 'right', color: 'var(--color-bright-orange)', fontWeight: '600' }}>
                                                    {team.championshipProb}%
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>

                    <style>{`
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `}</style>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
