<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Prediction Stream | Blaze Sports Intel</title>
    <meta name="description" content="Real-time game prediction streaming with AI-powered win probability analysis, key moment detection, and comprehensive performance metrics.">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Bebas+Neue&display=swap" rel="stylesheet">

    <!-- Chart.js for Prediction Trends -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

      <link rel="stylesheet" href="/css/bsi-tokens.css">
  <style>
        :root {
            /* Burnt Orange Brand Colors */
            --blaze-orange: #BF5700;
            --blaze-ember: #CC6600;
            --blaze-copper: #D97B38;
            --blaze-sunset: #E69551;
            --blaze-dark: #8B3A00;

            /* Dark Theme Base */
            --bg-primary: #0D0D12;
            --bg-secondary: #1A1A24;
            --bg-tertiary: #252532;
            --bg-elevated: #2D2D3D;

            /* Text Colors */
            --text-primary: #F5F5F7;
            --text-secondary: #C0C0C8;
            --text-tertiary: #8E8E93;

            /* Glass Morphism */
            --glass-bg: rgba(26, 26, 36, 0.75);
            --glass-border: rgba(255, 255, 255, 0.1);

            /* Status Colors */
            --status-active: #28a745;
            --status-paused: #ffc107;
            --status-error: #dc3545;
            --status-inactive: #6c757d;

            /* Effects */
            --glow-orange: 0 0 30px rgba(191, 87, 0, 0.3);
            --glow-ember: 0 0 40px rgba(204, 102, 0, 0.4);
            --glow-green: 0 0 30px rgba(40, 167, 69, 0.3);

            /* Transitions */
            --transition-fast: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);

            /* Borders & Radius */
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --dark-border: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.75rem;
            color: var(--blaze-orange);
            text-decoration: none;
            letter-spacing: 1px;
        }

        .nav-links {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .nav-link {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: color var(--transition-fast);
        }

        .nav-link:hover {
            color: var(--blaze-orange);
        }

        /* Main Content */
        main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 3rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            letter-spacing: 2px;
        }

        .page-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .tech-badges {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .badge {
            padding: 0.5rem 1rem;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Control Panel */
        .control-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--blaze-orange);
            box-shadow: 0 0 0 3px rgba(191, 87, 0, 0.1);
        }

        .control-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, var(--blaze-orange), var(--blaze-ember));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all var(--transition-base);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--glow-orange);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            border: 1px solid var(--dark-border);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #218838);
        }

        /* Stream Status */
        .stream-status {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--status-inactive);
            animation: pulse 2s ease-in-out infinite;
        }

        .status-indicator.active {
            background: var(--status-active);
        }

        .status-indicator.paused {
            background: var(--status-paused);
        }

        .status-indicator.error {
            background: var(--status-error);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-meta {
            margin-left: auto;
            display: flex;
            gap: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Main Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Card Container */
        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-xl);
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--dark-border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-icon {
            color: var(--blaze-orange);
            font-size: 1.5rem;
        }

        /* Current Prediction Display */
        .prediction-display {
            text-align: center;
            padding: 2rem;
        }

        .probability-meter {
            position: relative;
            height: 200px;
            margin-bottom: 2rem;
        }

        .probability-value {
            font-size: 4rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--blaze-orange), var(--blaze-sunset));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
        }

        .probability-label {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .team-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-top: 1.5rem;
        }

        .team-info {
            text-align: center;
        }

        .team-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 0.25rem;
        }

        .team-prob {
            font-size: 2rem;
            font-weight: 800;
            color: var(--blaze-orange);
        }

        .vs-divider {
            color: var(--text-tertiary);
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* Prediction History */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
            margin-bottom: 1rem;
            transition: all var(--transition-fast);
        }

        .history-item:hover {
            border-color: var(--blaze-orange);
            transform: translateX(4px);
        }

        .history-item.key-moment {
            border-color: var(--blaze-ember);
            background: rgba(191, 87, 0, 0.05);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .history-time {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .history-prob {
            font-weight: 700;
            color: var(--blaze-orange);
        }

        .history-description {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .key-moment-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            background: var(--blaze-orange);
            color: white;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }

        /* Performance Metrics */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .metric-item {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius-md);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: var(--blaze-orange);
            margin-bottom: 0.25rem;
        }

        .metric-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        /* Loading State */
        .loading-container {
            display: none;
            justify-content: center;
            align-items: center;
            padding: 3rem;
        }

        .loading-container.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--glass-border);
            border-top-color: var(--blaze-orange);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-left: 1rem;
            color: var(--text-secondary);
            font-weight: 600;
        }

        /* Error State */
        .error-container {
            display: none;
            padding: 1.5rem;
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: var(--radius-lg);
            margin-bottom: 2rem;
        }

        .error-container.active {
            display: flex;
        }

        .error-icon {
            color: #dc3545;
            font-size: 1.5rem;
            margin-right: 1rem;
        }

        .error-message {
            color: var(--text-secondary);
        }

        /* Empty State */
        .empty-state {
            display: none;
            text-align: center;
            padding: 3rem;
        }

        .empty-state.active {
            display: block;
        }

        .empty-icon {
            font-size: 4rem;
            color: var(--text-tertiary);
            margin-bottom: 1rem;
        }

        .empty-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .empty-description {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }

            .page-title {
                font-size: 2rem;
            }

            .control-grid {
                grid-template-columns: 1fr;
            }

            .probability-value {
                font-size: 3rem;
            }

            .team-prob {
                font-size: 1.5rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="/" class="logo">BLAZE SPORTS INTEL</a>
            <nav class="nav-links">
                <a href="/analytics" class="nav-link">Analytics</a>
                <a href="/copilot" class="nav-link">AI Copilot</a>
                <a href="/dashboards/manager" class="nav-link">Dashboards</a>
                <a href="/" class="nav-link">Home</a>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">Live Prediction Stream</h1>
            <p class="page-subtitle">Real-time AI-powered game predictions with win probability analysis and key moment detection</p>
            <div class="tech-badges">
                <span class="badge">Real-Time Updates</span>
                <span class="badge">Win Probability</span>
                <span class="badge">Key Moments</span>
                <span class="badge">Performance Metrics</span>
                <span class="badge">SSE Streaming</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-grid">
                <div class="form-group">
                    <label class="form-label" for="sportSelect">
                        <i class="fas fa-football"></i> Sport
                    </label>
                    <select id="sportSelect" class="form-select">
                        <option value="NFL">NFL</option>
                        <option value="MLB">MLB</option>
                        <option value="NBA">NBA</option>
                        <option value="CFB">College Football</option>
                        <option value="CBB">College Basketball</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="gameIdInput">
                        <i class="fas fa-hashtag"></i> Game ID
                    </label>
                    <input
                        type="text"
                        id="gameIdInput"
                        class="form-input"
                        placeholder="Enter game ID..."
                    />
                </div>
            </div>

            <div class="control-actions">
                <button class="btn btn-success" onclick="initializeStream()">
                    <i class="fas fa-play"></i>
                    Start Stream
                </button>
                <button class="btn btn-danger" onclick="stopStream()" disabled id="stopBtn">
                    <i class="fas fa-stop"></i>
                    Stop Stream
                </button>
                <button class="btn btn-secondary" onclick="loadStreamStatus()">
                    <i class="fas fa-info-circle"></i>
                    Check Status
                </button>
            </div>
        </div>

        <!-- Stream Status -->
        <div id="streamStatus" class="stream-status" style="display: none;">
            <div id="statusIndicator" class="status-indicator"></div>
            <span id="statusText" class="status-text">Stream Inactive</span>
            <div class="status-meta">
                <span id="updateCount">0 updates</span>
                <span id="lastUpdate">Never</span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingContainer" class="loading-container">
            <div class="spinner"></div>
            <span class="loading-text">Loading stream data...</span>
        </div>

        <!-- Error State -->
        <div id="errorContainer" class="error-container">
            <i class="fas fa-exclamation-triangle error-icon"></i>
            <div>
                <strong>Error:</strong>
                <span id="errorMessage" class="error-message"></span>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state active">
            <div class="empty-icon">
                <i class="fas fa-satellite-dish"></i>
            </div>
            <h3 class="empty-title">No Active Stream</h3>
            <p class="empty-description">
                Select a sport and enter a game ID to start streaming real-time predictions
            </p>
        </div>

        <!-- Main Content Grid -->
        <div id="mainContent" class="main-grid" style="display: none;">
            <!-- Current Prediction -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Current Prediction</h2>
                    <i class="fas fa-chart-line card-icon"></i>
                </div>
                <div class="prediction-display">
                    <div class="probability-meter">
                        <div class="probability-value" id="currentProbability">--</div>
                        <div class="probability-label">Win Probability</div>
                    </div>
                    <div class="team-comparison">
                        <div class="team-info">
                            <div class="team-name" id="homeTeam">Home Team</div>
                            <div class="team-prob" id="homeProb">--</div>
                        </div>
                        <div class="vs-divider">VS</div>
                        <div class="team-info">
                            <div class="team-name" id="awayTeam">Away Team</div>
                            <div class="team-prob" id="awayProb">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Performance Metrics</h2>
                    <i class="fas fa-tachometer-alt card-icon"></i>
                </div>
                <div class="metrics-grid">
                    <div class="metric-item">
                        <div class="metric-value" id="accuracyMetric">--</div>
                        <div class="metric-label">Accuracy</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="confidenceMetric">--</div>
                        <div class="metric-label">Confidence</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="updatesMetric">--</div>
                        <div class="metric-label">Total Updates</div>
                    </div>
                    <div class="metric-item">
                        <div class="metric-value" id="keyMomentsMetric">--</div>
                        <div class="metric-label">Key Moments</div>
                    </div>
                </div>
            </div>

            <!-- Prediction History -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Prediction History</h2>
                    <i class="fas fa-history card-icon"></i>
                </div>
                <div id="historyList" class="history-list">
                    <!-- History items will be added here -->
                </div>
            </div>

            <!-- Prediction Trend Chart -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Probability Trend</h2>
                    <i class="fas fa-chart-area card-icon"></i>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Global state
        let currentGameId = null;
        let currentSport = null;
        let streamActive = false;
        let pollInterval = null;
        let updateCount = 0;
        let predictionHistory = [];
        let trendChart = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initializeChart();
        });

        // Initialize stream
        async function initializeStream() {
            const gameId = document.getElementById('gameIdInput').value.trim();
            const sport = document.getElementById('sportSelect').value;

            if (!gameId) {
                alert('Please enter a game ID');
                return;
            }

            currentGameId = gameId;
            currentSport = sport;

            const loadingContainer = document.getElementById('loadingContainer');
            const errorContainer = document.getElementById('errorContainer');
            const emptyState = document.getElementById('emptyState');

            loadingContainer.classList.add('active');
            errorContainer.classList.remove('active');
            emptyState.classList.remove('active');

            try {
                const response = await fetch(`/api/v1/predictions/stream/init?gameId=${gameId}&sport=${sport}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to initialize stream');
                }

                streamActive = true;
                updateCount = 0;
                predictionHistory = [];

                // Update UI
                document.getElementById('streamStatus').style.display = 'flex';
                document.getElementById('statusIndicator').className = 'status-indicator active';
                document.getElementById('statusText').textContent = 'Stream Active';
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('mainContent').style.display = 'grid';

                // Start polling for updates
                startPolling();

            } catch (error) {
                console.error('Error initializing stream:', error);
                document.getElementById('errorMessage').textContent = error.message;
                errorContainer.classList.add('active');
            } finally {
                loadingContainer.classList.remove('active');
            }
        }

        // Start SSE polling
        function startPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            // Poll every 5 seconds
            pollInterval = setInterval(async () => {
                if (!streamActive || !currentGameId) {
                    stopPolling();
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/predictions/stream/live?gameId=${currentGameId}`);
                    const data = await response.json();

                    if (response.ok && data) {
                        updatePrediction(data);
                    }

                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);

            // Load initial data
            loadLivePrediction();
            loadPredictionHistory();
            loadMetrics();
        }

        // Stop polling
        function stopPolling() {
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Stop stream
        async function stopStream() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`/api/v1/predictions/stream/stop?gameId=${currentGameId}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (response.ok) {
                    streamActive = false;
                    stopPolling();

                    document.getElementById('statusIndicator').className = 'status-indicator';
                    document.getElementById('statusText').textContent = 'Stream Stopped';
                    document.getElementById('stopBtn').disabled = true;
                }

            } catch (error) {
                console.error('Error stopping stream:', error);
            }
        }

        // Load live prediction
        async function loadLivePrediction() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`/api/v1/predictions/stream/live?gameId=${currentGameId}`);
                const data = await response.json();

                if (response.ok && data) {
                    updatePrediction(data);
                }

            } catch (error) {
                console.error('Error loading live prediction:', error);
            }
        }

        // Load prediction history
        async function loadPredictionHistory() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`/api/v1/predictions/stream/history?gameId=${currentGameId}`);
                const data = await response.json();

                if (response.ok && data.history) {
                    predictionHistory = data.history;
                    renderHistory(data.history, data.keyMoments || []);
                    updateChart();
                }

            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        // Load metrics
        async function loadMetrics() {
            if (!currentGameId) return;

            try {
                const response = await fetch(`/api/v1/predictions/stream/metrics?gameId=${currentGameId}`);
                const data = await response.json();

                if (response.ok && data) {
                    document.getElementById('accuracyMetric').textContent =
                        data.accuracy ? `${(data.accuracy * 100).toFixed(1)}%` : '--';
                    document.getElementById('confidenceMetric').textContent =
                        data.avgConfidence ? `${(data.avgConfidence * 100).toFixed(1)}%` : '--';
                    document.getElementById('updatesMetric').textContent =
                        data.totalUpdates || '--';
                    document.getElementById('keyMomentsMetric').textContent =
                        data.keyMoments || '--';
                }

            } catch (error) {
                console.error('Error loading metrics:', error);
            }
        }

        // Load stream status
        async function loadStreamStatus() {
            const gameId = document.getElementById('gameIdInput').value.trim();
            if (!gameId) return;

            try {
                const response = await fetch(`/api/v1/predictions/stream/status?gameId=${gameId}`);
                const data = await response.json();

                if (response.ok && data) {
                    alert(`Stream Status: ${data.status}\nUpdates: ${data.updateCount || 0}\nLast Update: ${data.lastUpdate || 'Never'}`);
                }

            } catch (error) {
                console.error('Error loading status:', error);
                alert('Error loading stream status');
            }
        }

        // Update prediction display
        function updatePrediction(data) {
            updateCount++;

            // Update status
            document.getElementById('updateCount').textContent = `${updateCount} updates`;
            document.getElementById('lastUpdate').textContent = formatTime(new Date());

            // Update current prediction
            if (data.winProbability) {
                document.getElementById('currentProbability').textContent =
                    `${(data.winProbability * 100).toFixed(1)}%`;
            }

            if (data.homeTeam && data.awayTeam) {
                document.getElementById('homeTeam').textContent = data.homeTeam.name || 'Home';
                document.getElementById('awayTeam').textContent = data.awayTeam.name || 'Away';
                document.getElementById('homeProb').textContent =
                    `${(data.homeTeam.winProbability * 100).toFixed(1)}%`;
                document.getElementById('awayProb').textContent =
                    `${(data.awayTeam.winProbability * 100).toFixed(1)}%`;
            }

            // Reload history and metrics
            loadPredictionHistory();
            loadMetrics();
        }

        // Render prediction history
        function renderHistory(history, keyMoments) {
            const container = document.getElementById('historyList');
            const keyMomentIds = new Set(keyMoments.map(m => m.predictionId));

            container.innerHTML = history.slice(0, 20).reverse().map(item => {
                const isKeyMoment = keyMomentIds.has(item.id);
                return `
                    <div class="history-item ${isKeyMoment ? 'key-moment' : ''}">
                        <div class="history-header">
                            <span class="history-time">${formatTime(new Date(item.timestamp))}</span>
                            <span class="history-prob">${(item.winProbability * 100).toFixed(1)}%</span>
                        </div>
                        <div class="history-description">
                            ${escapeHtml(item.description || 'Prediction updated')}
                            ${isKeyMoment ? '<span class="key-moment-badge">KEY MOMENT</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Initialize Chart.js
        function initializeChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Win Probability',
                        data: [],
                        borderColor: '#BF5700',
                        backgroundColor: 'rgba(191, 87, 0, 0.1)',
                        borderWidth: 3,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 0,
                            max: 100,
                            ticks: {
                                color: '#8E8E93',
                                callback: value => `${value}%`
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#8E8E93'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Update chart with history data
        function updateChart() {
            if (!trendChart || !predictionHistory.length) return;

            const labels = predictionHistory.map(item =>
                new Date(item.timestamp).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                })
            );
            const data = predictionHistory.map(item => (item.winProbability * 100).toFixed(1));

            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = data;
            trendChart.update();
        }

        // Helper: Format time
        function formatTime(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'Just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
