<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Manage your Blaze Sports Intel subscription, billing, and API keys.">
  <title>Account Portal | Blaze Sports Intel</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=IBM+Plex+Sans:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400&family=Source+Serif+4:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="/css/bsi-tokens.css">
  <style>
    :root {
      --bsi-burnt-orange: #BF5700;
      --bsi-texas-soil: #8B4513;
      --bsi-charcoal: #1A1A1A;
      --bsi-midnight: #0D0D0D;
      --bsi-cream: #FAF8F5;
      --bsi-warm-white: #FAFAFA;
      --bsi-ember: #FF6B35;
      --bsi-success: #22C55E;
      --bsi-warning: #F59E0B;
      --bsi-error: #DC2626;
      --font-display: 'Playfair Display', Georgia, serif;
      --font-body: 'Source Serif 4', Georgia, serif;
      --font-ui: 'IBM Plex Sans', 'Helvetica Neue', sans-serif;
      --font-mono: 'IBM Plex Mono', monospace;
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-body);
      font-size: 1rem;
      line-height: 1.6;
      color: var(--bsi-warm-white);
      background: var(--bsi-midnight);
      -webkit-font-smoothing: antialiased;
      min-height: 100vh;
    }
    img { max-width: 100%; height: auto; display: block; }
    a { color: inherit; text-decoration: none; }

    /* Navigation */
    .nav {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 100;
      background: rgba(26, 26, 26, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(191, 87, 0, 0.2);
    }
    .nav-inner {
      max-width: 1280px;
      margin: 0 auto;
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .nav-logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-family: var(--font-ui);
      font-weight: 600;
      font-size: 1.125rem;
      transition: color 0.15s ease;
    }
    .nav-logo:hover { color: var(--bsi-burnt-orange); }
    .nav-logo img { height: 36px; width: auto; }
    .nav-actions {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .nav-link {
      font-family: var(--font-ui);
      font-size: 0.9375rem;
      font-weight: 500;
      color: rgba(250, 250, 250, 0.8);
      transition: color 0.15s ease;
    }
    .nav-link:hover { color: var(--bsi-burnt-orange); }

    /* Main Layout */
    .main {
      padding-top: 80px;
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 2.5rem 1.5rem 4rem;
    }

    /* Page Header */
    .page-header {
      margin-bottom: 2.5rem;
    }
    .page-title {
      font-family: var(--font-display);
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }
    .page-subtitle {
      font-size: 1.0625rem;
      color: rgba(250, 250, 250, 0.7);
    }

    /* Section Cards */
    .section-card {
      background: var(--bsi-charcoal);
      border: 1px solid rgba(191, 87, 0, 0.15);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 1.5rem;
    }
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(191, 87, 0, 0.15);
    }
    .section-title {
      font-family: var(--font-ui);
      font-size: 1.125rem;
      font-weight: 600;
    }

    /* Subscription Status */
    .subscription-status {
      display: flex;
      align-items: center;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    .status-item {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .status-label {
      font-family: var(--font-ui);
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(250, 250, 250, 0.5);
    }
    .status-value {
      font-family: var(--font-ui);
      font-size: 1rem;
      font-weight: 600;
    }

    /* Tier Badge */
    .tier-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.375rem 0.75rem;
      border-radius: 6px;
      font-family: var(--font-mono);
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .tier-badge--free {
      background: rgba(250, 250, 250, 0.1);
      color: rgba(250, 250, 250, 0.8);
    }
    .tier-badge--pro {
      background: rgba(191, 87, 0, 0.15);
      color: var(--bsi-burnt-orange);
    }
    .tier-badge--enterprise {
      background: rgba(34, 197, 94, 0.15);
      color: var(--bsi-success);
    }

    /* Status Indicator */
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .status-dot--active { background: var(--bsi-success); }
    .status-dot--canceled { background: var(--bsi-warning); }
    .status-dot--past_due { background: var(--bsi-error); }
    .status-dot--none { background: rgba(250, 250, 250, 0.4); }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.75rem 1.25rem;
      font-family: var(--font-ui);
      font-weight: 600;
      font-size: 0.875rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
    }
    .btn--primary {
      background: var(--bsi-burnt-orange);
      color: white;
    }
    .btn--primary:hover {
      background: var(--bsi-ember);
      transform: translateY(-1px);
    }
    .btn--secondary {
      background: rgba(250, 250, 250, 0.1);
      color: var(--bsi-warm-white);
      border: 1px solid rgba(250, 250, 250, 0.2);
    }
    .btn--secondary:hover {
      background: rgba(250, 250, 250, 0.15);
      border-color: rgba(250, 250, 250, 0.3);
    }
    .btn--danger {
      background: rgba(220, 38, 38, 0.1);
      color: var(--bsi-error);
      border: 1px solid rgba(220, 38, 38, 0.3);
    }
    .btn--danger:hover {
      background: rgba(220, 38, 38, 0.2);
    }
    .btn--sm {
      padding: 0.5rem 0.875rem;
      font-size: 0.8125rem;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* API Keys */
    .api-keys-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    .api-key-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      background: rgba(13, 13, 13, 0.5);
      border: 1px solid rgba(250, 250, 250, 0.1);
      border-radius: 8px;
    }
    .api-key-info {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .api-key-name {
      font-family: var(--font-ui);
      font-weight: 500;
    }
    .api-key-meta {
      font-family: var(--font-mono);
      font-size: 0.8125rem;
      color: rgba(250, 250, 250, 0.5);
    }
    .api-key-prefix {
      font-family: var(--font-mono);
      font-size: 0.875rem;
      color: var(--bsi-burnt-orange);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 2rem;
      color: rgba(250, 250, 250, 0.6);
    }
    .empty-state p {
      font-family: var(--font-ui);
      font-size: 0.9375rem;
      margin-bottom: 1rem;
    }

    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }
    .form-label {
      display: block;
      font-family: var(--font-ui);
      font-size: 0.875rem;
      font-weight: 500;
      color: rgba(250, 250, 250, 0.9);
      margin-bottom: 0.5rem;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem 1rem;
      font-family: var(--font-ui);
      font-size: 0.9375rem;
      color: var(--bsi-warm-white);
      background: rgba(13, 13, 13, 0.5);
      border: 1px solid rgba(191, 87, 0, 0.2);
      border-radius: 8px;
      outline: none;
      transition: border-color 0.2s ease;
    }
    .form-input:focus {
      border-color: var(--bsi-burnt-orange);
    }

    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--bsi-charcoal);
      border: 1px solid rgba(191, 87, 0, 0.3);
      border-radius: 12px;
      padding: 2rem;
      width: 100%;
      max-width: 450px;
    }
    .modal-title {
      font-family: var(--font-display);
      font-size: 1.375rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
    }
    .modal-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 1.5rem;
    }

    /* Feature List */
    .feature-list {
      display: grid;
      gap: 0.75rem;
    }
    .feature-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-family: var(--font-ui);
      font-size: 0.9375rem;
    }
    .feature-icon {
      width: 20px;
      height: 20px;
      color: var(--bsi-success);
    }
    .feature-item--locked .feature-icon {
      color: rgba(250, 250, 250, 0.3);
    }
    .feature-item--locked {
      color: rgba(250, 250, 250, 0.5);
    }

    /* Alert */
    .alert {
      padding: 1rem 1.25rem;
      border-radius: 8px;
      font-family: var(--font-ui);
      font-size: 0.9375rem;
      margin-bottom: 1.5rem;
    }
    .alert--warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--bsi-warning);
    }
    .alert--success {
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      color: var(--bsi-success);
    }

    /* Loading */
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(250, 250, 250, 0.2);
      border-top-color: var(--bsi-burnt-orange);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
      .subscription-status {
        flex-direction: column;
        align-items: flex-start;
      }
      .api-key-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }
    }
  </style>
</head>
<body>
  <nav class="nav">
    <div class="nav-inner">
      <a href="/" class="nav-logo">
        <img src="/images/bsi-logo.png" alt="Blaze Sports Intel">
        <span>Blaze Sports Intel</span>
      </a>
      <div class="nav-actions">
        <a href="/dashboard" class="nav-link">Dashboard</a>
        <a href="#" class="nav-link" id="logout-btn">Sign Out</a>
      </div>
    </div>
  </nav>

  <main class="main">
    <div class="container">
      <header class="page-header">
        <h1 class="page-title">Account Portal</h1>
        <p class="page-subtitle">Manage your subscription, billing, and API access</p>
      </header>

      <!-- Auth Check -->
      <div id="auth-required" style="display: none;">
        <div class="section-card" style="text-align: center;">
          <h2 style="font-family: var(--font-display); margin-bottom: 1rem;">Sign in Required</h2>
          <p style="color: rgba(250, 250, 250, 0.7); margin-bottom: 1.5rem;">Please sign in to access your account portal.</p>
          <a href="/login" class="btn btn--primary">Sign In</a>
        </div>
      </div>

      <div id="portal-content" style="display: none;">
        <!-- Subscription Section -->
        <section class="section-card">
          <div class="section-header">
            <h2 class="section-title">Subscription</h2>
            <button class="btn btn--secondary btn--sm" id="manage-billing-btn">
              Manage Billing
            </button>
          </div>

          <div class="subscription-status">
            <div class="status-item">
              <span class="status-label">Plan</span>
              <span class="status-value" id="subscription-tier">
                <span class="tier-badge tier-badge--free">Free</span>
              </span>
            </div>
            <div class="status-item">
              <span class="status-label">Status</span>
              <span class="status-value">
                <span class="status-indicator" id="subscription-status">
                  <span class="status-dot status-dot--none"></span>
                  <span>No subscription</span>
                </span>
              </span>
            </div>
            <div class="status-item" id="period-end-item" style="display: none;">
              <span class="status-label">Renews</span>
              <span class="status-value" id="subscription-period-end">—</span>
            </div>
          </div>

          <div id="upgrade-prompt" style="margin-top: 1.5rem;">
            <p style="font-family: var(--font-ui); color: rgba(250, 250, 250, 0.7); margin-bottom: 1rem;">
              Upgrade to unlock advanced analytics, predictions, and API access.
            </p>
            <a href="/pricing" class="btn btn--primary">View Plans</a>
          </div>
        </section>

        <!-- Features Section -->
        <section class="section-card">
          <div class="section-header">
            <h2 class="section-title">Your Features</h2>
          </div>

          <div class="feature-list" id="features-list">
            <!-- Populated by JS -->
          </div>
        </section>

        <!-- API Keys Section -->
        <section class="section-card" id="api-keys-section">
          <div class="section-header">
            <h2 class="section-title">API Keys</h2>
            <button class="btn btn--primary btn--sm" id="create-key-btn">
              Create Key
            </button>
          </div>

          <div id="api-keys-container">
            <div class="api-keys-list" id="api-keys-list">
              <!-- Populated by JS -->
            </div>
            <div class="empty-state" id="no-keys" style="display: none;">
              <p>You haven't created any API keys yet.</p>
              <button class="btn btn--secondary" id="create-first-key-btn">Create Your First Key</button>
            </div>
          </div>

          <div id="api-keys-upgrade" style="display: none; margin-top: 1rem;">
            <div class="alert alert--warning">
              API keys are available on Pro and Enterprise plans. <a href="/pricing" style="color: var(--bsi-burnt-orange); text-decoration: underline;">Upgrade now</a>
            </div>
          </div>
        </section>

        <!-- Account Section -->
        <section class="section-card">
          <div class="section-header">
            <h2 class="section-title">Account</h2>
          </div>

          <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="status-item">
              <span class="status-label">Email</span>
              <span class="status-value" id="account-email">—</span>
            </div>
            <div class="status-item">
              <span class="status-label">Member Since</span>
              <span class="status-value" id="account-member-since">—</span>
            </div>
          </div>
        </section>
      </div>
    </div>
  </main>

  <!-- Create API Key Modal -->
  <div class="modal-overlay" id="create-key-modal">
    <div class="modal">
      <h3 class="modal-title">Create API Key</h3>
      <form id="create-key-form">
        <div class="form-group">
          <label class="form-label" for="key-name">Key Name</label>
          <input type="text" id="key-name" class="form-input" placeholder="e.g., Production App" required>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn--secondary" id="cancel-create-key">Cancel</button>
          <button type="submit" class="btn btn--primary" id="submit-create-key">Create Key</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Show API Key Modal -->
  <div class="modal-overlay" id="show-key-modal">
    <div class="modal">
      <h3 class="modal-title">API Key Created</h3>
      <p style="color: rgba(250, 250, 250, 0.7); margin-bottom: 1rem;">
        Copy this key now—you won't be able to see it again.
      </p>
      <div style="background: rgba(13, 13, 13, 0.5); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
        <code id="new-key-value" style="font-family: var(--font-mono); font-size: 0.875rem; color: var(--bsi-ember); word-break: break-all;"></code>
      </div>
      <button class="btn btn--primary" id="copy-key-btn" style="width: 100%;">Copy to Clipboard</button>
      <button class="btn btn--secondary" id="close-key-modal" style="width: 100%; margin-top: 0.75rem;">Done</button>
    </div>
  </div>

  <script>
    // Auth state
    let authToken = null;
    let currentUser = null;

    // Feature definitions by tier
    const FEATURES = {
      free: [
        { name: 'Live Scores', unlocked: true },
        { name: 'Basic Standings', unlocked: true },
        { name: 'Game Schedules', unlocked: true },
        { name: 'Advanced Analytics', unlocked: false },
        { name: 'Predictions', unlocked: false },
        { name: 'API Access', unlocked: false },
      ],
      pro: [
        { name: 'Live Scores', unlocked: true },
        { name: 'Basic Standings', unlocked: true },
        { name: 'Game Schedules', unlocked: true },
        { name: 'Advanced Analytics', unlocked: true },
        { name: 'Predictions', unlocked: true },
        { name: 'API Access (10K/day)', unlocked: true },
      ],
      enterprise: [
        { name: 'Live Scores', unlocked: true },
        { name: 'Basic Standings', unlocked: true },
        { name: 'Game Schedules', unlocked: true },
        { name: 'Advanced Analytics', unlocked: true },
        { name: 'Predictions', unlocked: true },
        { name: 'API Access (Unlimited)', unlocked: true },
        { name: 'Bulk Export', unlocked: true },
        { name: 'Priority Support', unlocked: true },
      ],
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      authToken = getCookie('bsi_token') || localStorage.getItem('bsi_token');

      if (!authToken) {
        document.getElementById('auth-required').style.display = 'block';
        return;
      }

      document.getElementById('portal-content').style.display = 'block';
      await loadSubscriptionStatus();
      await loadApiKeys();
    });

    // Load subscription status
    async function loadSubscriptionStatus() {
      try {
        const res = await fetch('/api/stripe/subscription-status', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (data.error) {
          console.error('Subscription status error:', data.error);
          return;
        }

        currentUser = data;
        renderSubscriptionStatus(data);
        renderFeatures(data.tier || 'free');

        // Show/hide API keys section based on tier
        const tier = data.tier || 'free';
        if (tier === 'free') {
          document.getElementById('api-keys-upgrade').style.display = 'block';
          document.getElementById('create-key-btn').style.display = 'none';
        }

        // Account info
        document.getElementById('account-email').textContent = data.email || '—';
        if (data.memberSince) {
          document.getElementById('account-member-since').textContent =
            new Date(data.memberSince).toLocaleDateString('en-US', {
              month: 'long', day: 'numeric', year: 'numeric',
              timeZone: 'America/Chicago'
            });
        }
      } catch (err) {
        console.error('Failed to load subscription:', err);
      }
    }

    // Render subscription status
    function renderSubscriptionStatus(data) {
      const tier = data.tier || 'free';
      const status = data.subscriptionStatus || 'none';

      // Tier badge
      const tierEl = document.getElementById('subscription-tier');
      tierEl.innerHTML = `<span class="tier-badge tier-badge--${tier}">${tier.charAt(0).toUpperCase() + tier.slice(1)}</span>`;

      // Status indicator
      const statusEl = document.getElementById('subscription-status');
      const statusLabels = {
        active: 'Active',
        canceled: 'Canceled',
        past_due: 'Past Due',
        trialing: 'Trial',
        none: 'No subscription'
      };
      statusEl.innerHTML = `
        <span class="status-dot status-dot--${status}"></span>
        <span>${statusLabels[status] || status}</span>
      `;

      // Period end
      if (data.periodEnd && status === 'active') {
        document.getElementById('period-end-item').style.display = 'block';
        document.getElementById('subscription-period-end').textContent =
          new Date(data.periodEnd * 1000).toLocaleDateString('en-US', {
            month: 'long', day: 'numeric', year: 'numeric',
            timeZone: 'America/Chicago'
          });
      }

      // Hide upgrade prompt if pro/enterprise
      if (tier !== 'free') {
        document.getElementById('upgrade-prompt').style.display = 'none';
      }
    }

    // Render features list
    function renderFeatures(tier) {
      const features = FEATURES[tier] || FEATURES.free;
      const listEl = document.getElementById('features-list');

      listEl.innerHTML = features.map(f => `
        <div class="feature-item ${f.unlocked ? '' : 'feature-item--locked'}">
          <svg class="feature-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            ${f.unlocked
              ? '<path d="M20 6L9 17l-5-5"/>'
              : '<circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/>'}
          </svg>
          <span>${f.name}</span>
        </div>
      `).join('');
    }

    // Load API keys
    async function loadApiKeys() {
      try {
        const res = await fetch('/api/keys', {
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (data.error) {
          console.error('API keys error:', data.error);
          return;
        }

        renderApiKeys(data.keys || []);
      } catch (err) {
        console.error('Failed to load API keys:', err);
      }
    }

    // Render API keys
    function renderApiKeys(keys) {
      const listEl = document.getElementById('api-keys-list');
      const noKeysEl = document.getElementById('no-keys');

      if (!keys.length) {
        listEl.style.display = 'none';
        noKeysEl.style.display = 'block';
        return;
      }

      listEl.style.display = 'flex';
      noKeysEl.style.display = 'none';

      listEl.innerHTML = keys.map(key => `
        <div class="api-key-item" data-key-id="${key.id}">
          <div class="api-key-info">
            <span class="api-key-name">${escapeHtml(key.name)}</span>
            <span class="api-key-prefix">${key.prefix}...</span>
            <span class="api-key-meta">Created ${formatDate(key.createdAt)} · ${key.rateLimit === -1 ? 'Unlimited' : key.rateLimit + '/day'}</span>
          </div>
          <button class="btn btn--danger btn--sm" onclick="revokeKey('${key.id}', '${escapeHtml(key.name)}')">
            Revoke
          </button>
        </div>
      `).join('');
    }

    // Create API key
    document.getElementById('create-key-btn').addEventListener('click', () => {
      document.getElementById('create-key-modal').classList.add('active');
    });
    document.getElementById('create-first-key-btn')?.addEventListener('click', () => {
      document.getElementById('create-key-modal').classList.add('active');
    });
    document.getElementById('cancel-create-key').addEventListener('click', () => {
      document.getElementById('create-key-modal').classList.remove('active');
    });

    document.getElementById('create-key-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('key-name').value.trim();
      if (!name) return;

      const btn = document.getElementById('submit-create-key');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span>';

      try {
        const res = await fetch('/api/keys/create', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ name })
        });
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        // Show key
        document.getElementById('create-key-modal').classList.remove('active');
        document.getElementById('new-key-value').textContent = data.key;
        document.getElementById('show-key-modal').classList.add('active');
        document.getElementById('key-name').value = '';

        // Reload keys
        await loadApiKeys();
      } catch (err) {
        console.error('Failed to create key:', err);
        alert('Failed to create API key');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Create Key';
      }
    });

    // Copy key
    document.getElementById('copy-key-btn').addEventListener('click', () => {
      const key = document.getElementById('new-key-value').textContent;
      navigator.clipboard.writeText(key);
      document.getElementById('copy-key-btn').textContent = 'Copied!';
      setTimeout(() => {
        document.getElementById('copy-key-btn').textContent = 'Copy to Clipboard';
      }, 2000);
    });

    document.getElementById('close-key-modal').addEventListener('click', () => {
      document.getElementById('show-key-modal').classList.remove('active');
    });

    // Revoke key
    async function revokeKey(keyId, keyName) {
      if (!confirm(`Revoke API key "${keyName}"? This cannot be undone.`)) return;

      try {
        const res = await fetch(`/api/keys/${keyId}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (data.error) {
          alert(data.error);
          return;
        }

        await loadApiKeys();
      } catch (err) {
        console.error('Failed to revoke key:', err);
        alert('Failed to revoke API key');
      }
    }

    // Manage billing
    document.getElementById('manage-billing-btn').addEventListener('click', async () => {
      const btn = document.getElementById('manage-billing-btn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading-spinner"></span> Loading...';

      try {
        const res = await fetch('/api/stripe/portal-session', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${authToken}` }
        });
        const data = await res.json();

        if (data.error) {
          alert(data.message || data.error);
          return;
        }

        window.location.href = data.url;
      } catch (err) {
        console.error('Failed to open billing portal:', err);
        alert('Failed to open billing portal');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Manage Billing';
      }
    });

    // Logout
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      document.cookie = 'bsi_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT';
      localStorage.removeItem('bsi_token');
      window.location.href = '/login';
    });

    // Helpers
    function getCookie(name) {
      const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function formatDate(timestamp) {
      return new Date(timestamp * 1000).toLocaleDateString('en-US', {
        month: 'short', day: 'numeric', year: 'numeric',
        timeZone: 'America/Chicago'
      });
    }
  </script>
  <script src="/js/bsi-components.js"></script>
</body>
</html>
