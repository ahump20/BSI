var We=Object.defineProperty;var Ne=(r,e,t)=>e in r?We(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var l=(r,e,t)=>Ne(r,typeof e!="symbol"?e+"":e,t);import{M as v,P as I,C as y,D as N,S as x,a as Ze,V as h,T as Ve,b as C,c as F,d as P,E as qe,e as oe,F as He,f as ne,g as Xe,H as ae,h as $e,G as je,i as Ue}from"./babylon-D8S0YZ6G.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const n of o.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();const m={length:100,width:53.33,endZoneDepth:10,hashWidth:18.5,yardLineInterval:5},re={grass:"#2E7D32",grassDark:"#1B5E20"};class ce{constructor(e,t,i){l(this,"scene");l(this,"homeTeam");l(this,"awayTeam");l(this,"fieldMeshes",[]);l(this,"_jumbotronTexture",null);this.scene=e,this.homeTeam=t,this.awayTeam=i}build(){this.createGround(),this.createEndZones(),this.createYardLines(),this.createHashMarks(),this.createFieldNumbers(),this.createSidelines(),this.createStadiumShell()}createGround(){const e=m.length+m.endZoneDepth*2,t=v.CreateGround("field",{width:m.width,height:e,subdivisions:20},this.scene),i=new I("grassMat",this.scene);i.albedoColor=y.FromHexString(re.grass),i.roughness=.95,i.metallic=0,t.material=i,t.receiveShadows=!0,t.position.z=m.length/2,this.fieldMeshes.push(t);for(let s=0;s<20;s++){if(s%2===0)continue;const o=v.CreateGround(`grassStripe_${s}`,{width:m.width,height:5},this.scene),n=new I(`stripeMat_${s}`,this.scene);n.albedoColor=y.FromHexString(re.grassDark),n.roughness=.95,n.metallic=0,o.material=n,o.position.y=.001,o.position.z=s*5+2.5,o.receiveShadows=!0,this.fieldMeshes.push(o)}}createEndZones(){const e=v.CreateGround("homeEndZone",{width:m.width,height:m.endZoneDepth},this.scene),t=new I("homeEndZoneMat",this.scene);t.albedoColor=y.FromHexString(this.homeTeam.primaryColor),t.roughness=.9,t.metallic=0,e.material=t,e.position.y=.002,e.position.z=-10/2,e.receiveShadows=!0,this.fieldMeshes.push(e);const i=v.CreateGround("awayEndZone",{width:m.width,height:m.endZoneDepth},this.scene),s=new I("awayEndZoneMat",this.scene);s.albedoColor=y.FromHexString(this.awayTeam.primaryColor),s.roughness=.9,s.metallic=0,i.material=s,i.position.y=.002,i.position.z=m.length+m.endZoneDepth/2,i.receiveShadows=!0,this.fieldMeshes.push(i),this.createEndZoneText(this.homeTeam,-10/2,!1),this.createEndZoneText(this.awayTeam,m.length+m.endZoneDepth/2,!0)}createEndZoneText(e,t,i){const s=v.CreatePlane(`endZoneText_${e.id}`,{width:40,height:8},this.scene),o=1024,n=new N(`endZoneTexture_${e.id}`,{width:o,height:o/5},this.scene,!0),a=n.getContext();a.fillStyle="transparent",a.clearRect(0,0,o,o/5),a.font="bold 120px Arial",a.fillStyle=e.secondaryColor,a.textAlign="center",a.textBaseline="middle",a.fillText(e.shortName,o/2,o/10),n.update();const c=new x(`endZoneTextMat_${e.id}`,this.scene);c.diffuseTexture=n,c.diffuseTexture.hasAlpha=!0,c.useAlphaFromDiffuseTexture=!0,c.backFaceCulling=!1,c.emissiveColor=y.White(),s.material=c,s.rotation.x=Math.PI/2,s.position.y=.003,s.position.z=t,i&&(s.rotation.y=Math.PI),this.fieldMeshes.push(s)}createYardLines(){const e=new x("yardLineMat",this.scene);e.diffuseColor=y.White(),e.emissiveColor=new y(.2,.2,.2);for(let i=0;i<=m.length;i+=m.yardLineInterval){const s=i%10===0?.3:.15,o=v.CreateBox(`yardLine_${i}`,{width:m.width,height:.01,depth:s},this.scene);o.material=e,o.position.y=.005,o.position.z=i,this.fieldMeshes.push(o)}const t=new x("goalLineMat",this.scene);t.diffuseColor=y.White(),t.emissiveColor=new y(.5,.5,.5),[0,m.length].forEach((i,s)=>{const o=v.CreateBox(`goalLine_${s}`,{width:m.width,height:.01,depth:.5},this.scene);o.material=t,o.position.y=.006,o.position.z=i,this.fieldMeshes.push(o)})}createHashMarks(){const e=new x("hashMat",this.scene);e.diffuseColor=y.White();const t=.75,i=.1;for(let s=1;s<m.length;s++){if(s%m.yardLineInterval===0)continue;const o=v.CreateBox(`hashLeft_${s}`,{width:t,height:.01,depth:i},this.scene);o.material=e,o.position.x=-18.5/2,o.position.y=.004,o.position.z=s,this.fieldMeshes.push(o);const n=v.CreateBox(`hashRight_${s}`,{width:t,height:.01,depth:i},this.scene);n.material=e,n.position.x=m.hashWidth/2,n.position.y=.004,n.position.z=s,this.fieldMeshes.push(n)}}createFieldNumbers(){[10,20,30,40,50,40,30,20,10].forEach((t,i)=>{const s=(i+1)*10;this.createFieldNumber(t,-53.33/2+6,s,!1),this.createFieldNumber(t,m.width/2-6,s,!0)})}createFieldNumber(e,t,i,s){const o=v.CreatePlane(`fieldNumber_${e}_${t>0?"R":"L"}_${i}`,{width:4,height:6},this.scene),n=new N(`numberTexture_${e}_${t}_${i}`,{width:256,height:384},this.scene,!0),a=n.getContext();a.clearRect(0,0,256,384),a.font="bold 280px Arial",a.fillStyle="#FFFFFF",a.strokeStyle="#000000",a.lineWidth=8,a.textAlign="center",a.textBaseline="middle",a.strokeText(e.toString(),128,192),a.fillText(e.toString(),128,192),n.update();const c=new x(`numberMat_${e}_${t}_${i}`,this.scene);c.diffuseTexture=n,c.diffuseTexture.hasAlpha=!0,c.useAlphaFromDiffuseTexture=!0,c.backFaceCulling=!1,c.emissiveColor=new y(.3,.3,.3),o.material=c,o.rotation.x=Math.PI/2,o.position.x=t,o.position.y=.007,o.position.z=i,s&&(o.rotation.y=Math.PI),this.fieldMeshes.push(o)}createSidelines(){const e=new x("sidelineMat",this.scene);e.diffuseColor=y.White(),e.emissiveColor=new y(.3,.3,.3);const t=m.length+m.endZoneDepth*2,i=v.CreateBox("leftSideline",{width:.3,height:.01,depth:t},this.scene);i.material=e,i.position.x=-53.33/2,i.position.y=.005,i.position.z=m.length/2,this.fieldMeshes.push(i);const s=v.CreateBox("rightSideline",{width:.3,height:.01,depth:t},this.scene);s.material=e,s.position.x=m.width/2,s.position.y=.005,s.position.z=m.length/2,this.fieldMeshes.push(s);const o=new I("oobMat",this.scene);o.albedoColor=new y(.15,.15,.15),o.roughness=1,o.metallic=0,[-1,1].forEach(n=>{const a=v.CreateGround(`oob_${n>0?"right":"left"}`,{width:10,height:t},this.scene);a.material=o,a.position.x=n*(m.width/2+5),a.position.y=-.01,a.position.z=m.length/2,this.fieldMeshes.push(a)})}static worldZToYardLine(e){return Math.max(0,Math.min(100,e))}static yardLineToWorldZ(e){return e}static isInBounds(e,t){const i=m.width/2;return e>=-i&&e<=i&&t>=-10&&t<=m.length+m.endZoneDepth}static isInEndZone(e){return e<=0?"home":e>=m.length?"away":null}createStadiumShell(){const e=m.width/2,t=new I("standMat",this.scene);t.albedoColor=new y(.3,.3,.32),t.roughness=.85,t.metallic=.1,[{w:200,h:15,d:8,pos:[-38.665,7.5,m.length/2]},{w:200,h:15,d:8,pos:[e+12,7.5,m.length/2]},{w:8,h:15,d:m.width+24,pos:[0,7.5,-18]},{w:8,h:15,d:m.width+24,pos:[0,7.5,m.length+m.endZoneDepth+8]}].forEach((d,p)=>{const f=v.CreateBox(`grandstand_${p}`,{width:d.d,height:d.h,depth:d.w},this.scene);f.material=t,f.position.set(d.pos[0],d.pos[1],d.pos[2]),f.receiveShadows=!0,this.fieldMeshes.push(f)});const s=new I("towerMat",this.scene);s.albedoColor=new y(.4,.4,.4),s.roughness=.6,s.metallic=.5,[[-34.665,-10],[e+8,-10],[-34.665,m.length+m.endZoneDepth],[e+8,m.length+m.endZoneDepth]].forEach(([d,p],f)=>{const g=v.CreateCylinder(`lightTower_${f}`,{diameter:2,height:40},this.scene);g.material=s,g.position.set(d,20,p),this.fieldMeshes.push(g);const b=new Ze(`towerLight_${f}`,new h(d,40,p),this.scene);b.intensity=.6,b.range=80,b.diffuse=y.White()});const n=v.CreatePlane("jumbotron",{width:20,height:8},this.scene);n.position.set(0,18,m.length+m.endZoneDepth+3);const a=new N("jumbotronTex",{width:512,height:256},this.scene,!1),c=new x("jumbotronMat",this.scene);c.diffuseTexture=a,c.emissiveColor=new y(.8,.8,.8),c.backFaceCulling=!1,n.material=c,this.updateJumbotron(a,0,0),this.fieldMeshes.push(n),this._jumbotronTexture=a}updateJumbotron(e=null,t=0,i=0){const s=e||this._jumbotronTexture;if(!s)return;const o=s.getContext();o.fillStyle="#111111",o.fillRect(0,0,512,256),o.font="bold 60px Arial",o.fillStyle="#FFFFFF",o.textAlign="center",o.textBaseline="middle",o.fillText(`SCORE: ${t} - ${i}`,256,128),s.update()}dispose(){this.fieldMeshes.forEach(e=>e.dispose()),this.fieldMeshes=[]}}const Ye={catchRadius:2.5,fumbleChance:.15,bulletVelocity:45,touchVelocity:35,lobVelocity:25,gravity:15};class Je{constructor(e,t={}){l(this,"scene");l(this,"config");l(this,"ball",null);l(this,"ballTrail",null);l(this,"catchParticles",null);l(this,"state","dead");l(this,"holder",null);l(this,"velocity",h.Zero());l(this,"targetPosition",null);l(this,"passType","touch");l(this,"flightTime",0);l(this,"maxFlightTime",0);this.scene=e,this.config={...Ye,...t}}initialize(){this.createBall(),this.createVisualEffects()}createBall(){this.ball=v.CreateSphere("football",{diameterX:.6,diameterY:.35,diameterZ:.35,segments:16},this.scene);const e=new x("footballMat",this.scene);e.diffuseColor=new y(.55,.27,.07),e.specularColor=new y(.3,.2,.1),this.ball.material=e,this.ball.position.y=1,this.ball.rotation.x=Math.PI/2,this.ball.isVisible=!1}createVisualEffects(){if(!this.ball)return;this.ballTrail=new Ve("ballTrail",this.ball,this.scene,.15,30,!0);const e=new x("trailMat",this.scene);e.emissiveColor=new y(1,1,1),e.alpha=.3,this.ballTrail.material=e,this.ballTrail.isVisible=!1,this.catchParticles=new C("catchParticles",50,this.scene),this.catchParticles.particleTexture=new F("https://raw.githubusercontent.com/BabylonJS/Assets/master/textures/flare.png",this.scene),this.catchParticles.emitter=h.Zero(),this.catchParticles.minSize=.2,this.catchParticles.maxSize=.5,this.catchParticles.minLifeTime=.2,this.catchParticles.maxLifeTime=.4,this.catchParticles.emitRate=100,this.catchParticles.blendMode=C.BLENDMODE_ADD,this.catchParticles.gravity=new h(0,-5,0),this.catchParticles.direction1=new h(-1,1,-1),this.catchParticles.direction2=new h(1,2,1),this.catchParticles.color1=new P(1,.8,0,1),this.catchParticles.color2=new P(1,.5,0,1),this.catchParticles.colorDead=new P(1,.3,0,0)}giveTo(e,t){this.state="held",this.holder=e,this.velocity=h.Zero(),this.targetPosition=null,this.ball&&(this.ball.isVisible=!0,this.ball.position=t.clone(),this.ball.position.y=1.2),this.ballTrail&&(this.ballTrail.isVisible=!1)}throwTo(e,t="touch",i=0){if(!this.ball||this.state!=="held")return;this.state="thrown",this.holder=null,this.passType=t,this.targetPosition=e.clone(),this.flightTime=0;let s,o;switch(t){case"bullet":s=this.config.bulletVelocity*(1+i*.2),o=.1;break;case"lob":s=this.config.lobVelocity,o=.6;break;default:s=this.config.touchVelocity,o=.3}const n=this.ball.position.clone(),a=h.Distance(n,e);this.maxFlightTime=a/s;const c=e.subtract(n).normalize(),d=c.scale(s),f=(a*o+.5*this.config.gravity*Math.pow(this.maxFlightTime/2,2))/(this.maxFlightTime/2);this.velocity=new h(d.x,f,d.z),this.ballTrail&&(this.ballTrail.isVisible=!0);const g=Math.atan2(c.x,c.z);this.ball.rotation.y=g}update(e){!this.ball||this.state!=="thrown"||(this.flightTime+=e,this.velocity.y-=this.config.gravity*e,this.ball.position.addInPlace(this.velocity.scale(e)),this.ball.rotation.x+=e*10,this.ball.position.y<=.3&&(this.ball.position.y=.3,this.state="loose",this.velocity=h.Zero(),this.ballTrail&&(this.ballTrail.isVisible=!1)))}isInCatchRadius(e){return!this.ball||this.state!=="thrown"?!1:h.Distance(this.ball.position,e)<=this.config.catchRadius}attemptCatch(e,t,i=5){if(!this.ball||this.state!=="thrown")return!1;const s=h.Distance(this.ball.position,t);if(s>this.config.catchRadius)return!1;const o=.7+i/10*.25,n=s/this.config.catchRadius*.2,a=o-n;return Math.random()<a?(this.giveTo(e,t),this.catchParticles&&(this.catchParticles.emitter=t.clone(),this.catchParticles.start(),setTimeout(()=>this.catchParticles?.stop(),200)),!0):(this.state="loose",!1)}fumble(e=5){if(this.state!=="held")return!1;const t=this.config.fumbleChance*(e/5);if(Math.random()<t){if(this.state="loose",this.holder=null,this.ball){const s=Math.random()*Math.PI*2;this.velocity=new h(Math.cos(s)*5,3,Math.sin(s)*5)}return!0}return!1}pickUp(e,t){return!this.ball||this.state!=="loose"?!1:h.Distance(this.ball.position,t)<=1.5?(this.giveTo(e,t),!0):!1}updateHeldPosition(e,t){if(!this.ball||this.state!=="held")return;const i=Math.sin(t)*.3,s=Math.cos(t)*.3;this.ball.position.x=e.x+i,this.ball.position.y=e.y+.8,this.ball.position.z=e.z+s,this.ball.rotation.y=t}markDead(){this.state="dead",this.holder=null,this.velocity=h.Zero(),this.ballTrail&&(this.ballTrail.isVisible=!1)}getState(){return this.state}getHolder(){return this.holder}getPosition(){return this.ball?.position.clone()||null}getMesh(){return this.ball}isCatchable(){return this.state==="thrown"}hide(){this.ball&&(this.ball.isVisible=!1),this.ballTrail&&(this.ballTrail.isVisible=!1)}show(){this.ball&&(this.ball.isVisible=!0)}dispose(){this.ball?.dispose(),this.ballTrail?.dispose(),this.catchParticles?.dispose()}}const Ke={baseSpeed:15,turboMultiplier:1.5,accelerationTime:.2,maxStamina:100,staminaDrainRate:25,staminaRegenRate:15,fatigueSpeedFloor:.84,cutbackPenalty:.28,tackleRadius:1.5,tackleImpulse:8,lateHitWindow:1.5};class Qe{constructor(e,t={}){l(this,"config");l(this,"inputState");l(this,"velocity",h.Zero());l(this,"position");l(this,"rotation",0);l(this,"stamina");l(this,"isTurboActive",!1);l(this,"isActionPressed",!1);l(this,"actionPressTime",0);l(this,"canAct",!0);l(this,"isTackling",!1);l(this,"tackleTimer",0);l(this,"whistleBlown",!1);l(this,"whistleTime",0);l(this,"keysDown",new Set);this.config={...Ke,...t},this.position=e.clone(),this.stamina=this.config.maxStamina,this.inputState={moveX:0,moveZ:0,turbo:!1,action:!1,actionHoldTime:0,selectReceiver:null,mouseX:0,mouseZ:0},this.setupInputHandlers()}setupInputHandlers(){window.addEventListener("keydown",e=>{this.keysDown.add(e.code),e.code==="Space"&&!this.isActionPressed&&(this.isActionPressed=!0,this.actionPressTime=performance.now()),e.code>="Digit1"&&e.code<="Digit5"&&(this.inputState.selectReceiver=parseInt(e.code.slice(-1))-1),this.updateInputState()}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.code),e.code==="Space"&&(this.isActionPressed=!1,this.inputState.actionHoldTime=(performance.now()-this.actionPressTime)/1e3),this.updateInputState()}),window.addEventListener("mousemove",e=>{this.inputState.mouseX=(e.clientX/window.innerWidth-.5)*2,this.inputState.mouseZ=(e.clientY/window.innerHeight-.5)*2}),window.addEventListener("click",e=>{this.inputState.action=!0})}updateInputState(){this.inputState.moveX=0,this.inputState.moveZ=0,(this.keysDown.has("KeyA")||this.keysDown.has("ArrowLeft"))&&(this.inputState.moveX-=1),(this.keysDown.has("KeyD")||this.keysDown.has("ArrowRight"))&&(this.inputState.moveX+=1),(this.keysDown.has("KeyW")||this.keysDown.has("ArrowUp"))&&(this.inputState.moveZ+=1),(this.keysDown.has("KeyS")||this.keysDown.has("ArrowDown"))&&(this.inputState.moveZ-=1),this.inputState.turbo=this.keysDown.has("ShiftLeft")||this.keysDown.has("ShiftRight"),this.inputState.action=this.keysDown.has("Space")}update(e){this.updateStamina(e),this.updateMovement(e),this.isTackling&&(this.tackleTimer-=e,this.tackleTimer<=0&&(this.isTackling=!1)),this.inputState.selectReceiver=null}updateStamina(e){this.inputState.turbo&&this.stamina>0?(this.stamina-=this.config.staminaDrainRate*e,this.stamina=Math.max(0,this.stamina),this.isTurboActive=this.stamina>0):(this.stamina+=this.config.staminaRegenRate*e,this.stamina=Math.min(this.config.maxStamina,this.stamina),this.isTurboActive=!1)}updateMovement(e){const t=new h(this.inputState.moveX,0,this.inputState.moveZ);t.length()>0&&t.normalize();let i=this.config.baseSpeed;this.isTurboActive&&(i*=this.config.turboMultiplier);const s=this.config.maxStamina>0?Math.max(0,Math.min(1,this.stamina/this.config.maxStamina)):1,o=this.config.fatigueSpeedFloor+(1-this.config.fatigueSpeedFloor)*s;if(i*=o,t.length()>0&&this.velocity.length()>.5){const c=this.velocity.clone().normalize(),d=Math.max(-1,Math.min(1,h.Dot(c,t))),p=Math.min(1,(1-d)/2);i*=1-p*this.config.cutbackPenalty}const n=t.scale(i),a=1-Math.pow(.01,e/this.config.accelerationTime);this.velocity=h.Lerp(this.velocity,n,a),this.position.addInPlace(this.velocity.scale(e)),this.velocity.length()>.5&&(this.rotation=Math.atan2(this.velocity.x,this.velocity.z))}attemptTackle(){return this.isTackling?!1:(this.isTackling=!0,this.tackleTimer=.3,!0)}canTackle(e){return this.whistleBlown&&(performance.now()-this.whistleTime)/1e3>this.config.lateHitWindow?!1:h.Distance(this.position,e)<=this.config.tackleRadius}getTackleImpulse(e){return e.subtract(this.position).normalize().scale(this.config.tackleImpulse)}blowWhistle(){this.whistleBlown=!0,this.whistleTime=performance.now()}resetForNewPlay(){this.velocity=h.Zero(),this.isTackling=!1,this.tackleTimer=0,this.whistleBlown=!1,this.canAct=!0,this.isActionPressed=!1,this.inputState.actionHoldTime=0}getPosition(){return this.position.clone()}setPosition(e){this.position=e.clone()}getVelocity(){return this.velocity.clone()}getRotation(){return this.rotation}getStamina(){return this.stamina}isTurboOn(){return this.isTurboActive}getInputState(){return{...this.inputState}}isActionDown(){return this.inputState.action}getActionHoldTime(){return this.inputState.actionHoldTime}getSelectedReceiver(){return this.inputState.selectReceiver}isTacklingNow(){return this.isTackling}updateConfig(e){this.config={...this.config,...e}}dispose(){this.keysDown.clear()}}class et{constructor(e){l(this,"canvas");l(this,"virtualJoystickCenter",null);l(this,"virtualJoystickCurrent",null);l(this,"virtualJoystickActive",!1);l(this,"touchStartTime",0);l(this,"actionTouchId",null);l(this,"joystickTouchId",null);l(this,"joystickOuter",null);l(this,"joystickInner",null);l(this,"actionButton",null);l(this,"turboButton",null);l(this,"moveX",0);l(this,"moveZ",0);l(this,"turbo",!1);l(this,"action",!1);l(this,"selectedReceiver",null);l(this,"JOYSTICK_SIZE",120);l(this,"JOYSTICK_INNER_SIZE",50);l(this,"BUTTON_SIZE",80);l(this,"HAPTIC_TAP",[10]);l(this,"HAPTIC_HEAVY",[30]);l(this,"HAPTIC_DOUBLE",[10,50,10]);this.canvas=e,this.createVisualControls(),this.setupTouchHandlers()}createVisualControls(){const e=document.createElement("div");e.id="touchControls",e.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 50;
      display: none;
    `,document.body.appendChild(e),this.joystickOuter=document.createElement("div"),this.joystickOuter.style.cssText=`
      position: absolute;
      bottom: 100px;
      left: 40px;
      width: ${this.JOYSTICK_SIZE}px;
      height: ${this.JOYSTICK_SIZE}px;
      border-radius: 50%;
      border: 3px solid rgba(57, 255, 20, 0.5);
      background: rgba(0, 0, 0, 0.3);
      pointer-events: auto;
      touch-action: none;
    `,e.appendChild(this.joystickOuter),this.joystickInner=document.createElement("div"),this.joystickInner.style.cssText=`
      position: absolute;
      top: 50%;
      left: 50%;
      width: ${this.JOYSTICK_INNER_SIZE}px;
      height: ${this.JOYSTICK_INNER_SIZE}px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(57, 255, 20, 0.8) 0%, rgba(57, 255, 20, 0.4) 100%);
      transform: translate(-50%, -50%);
      box-shadow: 0 0 15px rgba(57, 255, 20, 0.6);
      transition: transform 0.05s ease-out;
    `,this.joystickOuter.appendChild(this.joystickInner),this.actionButton=document.createElement("div"),this.actionButton.style.cssText=`
      position: absolute;
      bottom: 100px;
      right: 40px;
      width: ${this.BUTTON_SIZE}px;
      height: ${this.BUTTON_SIZE}px;
      border-radius: 50%;
      border: 3px solid rgba(255, 110, 199, 0.6);
      background: rgba(255, 110, 199, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Russo One', sans-serif;
      font-size: 12px;
      color: white;
      text-transform: uppercase;
      pointer-events: auto;
      touch-action: none;
      user-select: none;
    `,this.actionButton.textContent="THROW",e.appendChild(this.actionButton),this.turboButton=document.createElement("div"),this.turboButton.style.cssText=`
      position: absolute;
      bottom: 200px;
      right: 40px;
      width: ${this.BUTTON_SIZE*.8}px;
      height: ${this.BUTTON_SIZE*.8}px;
      border-radius: 50%;
      border: 3px solid rgba(255, 215, 0, 0.6);
      background: rgba(255, 215, 0, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Russo One', sans-serif;
      font-size: 10px;
      color: white;
      text-transform: uppercase;
      pointer-events: auto;
      touch-action: none;
      user-select: none;
    `,this.turboButton.textContent="TURBO",e.appendChild(this.turboButton),"ontouchstart"in window&&(e.style.display="block")}haptic(e){"vibrate"in navigator&&navigator.vibrate(e)}setupTouchHandlers(){this.joystickOuter?.addEventListener("touchstart",this.handleJoystickStart.bind(this),{passive:!1}),this.joystickOuter?.addEventListener("touchmove",this.handleJoystickMove.bind(this),{passive:!1}),this.joystickOuter?.addEventListener("touchend",this.handleJoystickEnd.bind(this),{passive:!1}),this.joystickOuter?.addEventListener("touchcancel",this.handleJoystickEnd.bind(this),{passive:!1}),this.actionButton?.addEventListener("touchstart",this.handleActionStart.bind(this),{passive:!1}),this.actionButton?.addEventListener("touchend",this.handleActionEnd.bind(this),{passive:!1}),this.actionButton?.addEventListener("touchcancel",this.handleActionEnd.bind(this),{passive:!1}),this.turboButton?.addEventListener("touchstart",this.handleTurboStart.bind(this),{passive:!1}),this.turboButton?.addEventListener("touchend",this.handleTurboEnd.bind(this),{passive:!1}),this.turboButton?.addEventListener("touchcancel",this.handleTurboEnd.bind(this),{passive:!1}),this.canvas.addEventListener("touchstart",this.handleCanvasTouch.bind(this),{passive:!1})}handleJoystickStart(e){e.preventDefault(),e.stopPropagation();const t=e.changedTouches[0];this.joystickTouchId=t.identifier,this.virtualJoystickActive=!0;const i=this.joystickOuter.getBoundingClientRect();this.virtualJoystickCenter={x:i.left+i.width/2,y:i.top+i.height/2},this.virtualJoystickCurrent={x:t.clientX,y:t.clientY},this.haptic(this.HAPTIC_TAP),this.updateJoystickVisual()}handleJoystickMove(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++){const i=e.changedTouches[t];if(i.identifier===this.joystickTouchId&&this.virtualJoystickCenter){this.virtualJoystickCurrent={x:i.clientX,y:i.clientY};const s=i.clientX-this.virtualJoystickCenter.x,o=i.clientY-this.virtualJoystickCenter.y,n=this.JOYSTICK_SIZE/2-this.JOYSTICK_INNER_SIZE/2,a=Math.sqrt(s*s+o*o);if(a>8){const c=Math.min(a,n);this.moveX=s/n*Math.min(1,c/n),this.moveZ=-o/n*Math.min(1,c/n)}else this.moveX=0,this.moveZ=0;this.updateJoystickVisual();break}}}handleJoystickEnd(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)if(e.changedTouches[t].identifier===this.joystickTouchId){this.joystickTouchId=null,this.virtualJoystickActive=!1,this.moveX=0,this.moveZ=0,this.resetJoystickVisual();break}}handleActionStart(e){e.preventDefault(),e.stopPropagation(),this.action=!0,this.touchStartTime=performance.now(),this.actionTouchId=e.changedTouches[0].identifier,this.actionButton&&(this.actionButton.style.background="rgba(255, 110, 199, 0.7)",this.actionButton.style.boxShadow="0 0 30px rgba(255, 110, 199, 0.8)",this.actionButton.style.transform="scale(0.95)"),this.haptic(this.HAPTIC_HEAVY)}handleActionEnd(e){e.preventDefault();for(let t=0;t<e.changedTouches.length;t++)if(e.changedTouches[t].identifier===this.actionTouchId){this.action=!1,this.actionTouchId=null,this.actionButton&&(this.actionButton.style.background="rgba(255, 110, 199, 0.3)",this.actionButton.style.boxShadow="none",this.actionButton.style.transform="scale(1)");break}}handleTurboStart(e){e.preventDefault(),e.stopPropagation(),this.turbo=!0,this.turboButton&&(this.turboButton.style.background="rgba(255, 215, 0, 0.6)",this.turboButton.style.boxShadow="0 0 30px rgba(255, 215, 0, 0.8)",this.turboButton.style.transform="scale(0.95)"),this.haptic(this.HAPTIC_DOUBLE)}handleTurboEnd(e){e.preventDefault(),this.turbo=!1,this.turboButton&&(this.turboButton.style.background="rgba(255, 215, 0, 0.2)",this.turboButton.style.boxShadow="none",this.turboButton.style.transform="scale(1)")}handleCanvasTouch(e){const t=e.touches[0];if(!t)return;const i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left;if(t.clientY<150){const o=Math.floor(s/i.width*5);this.selectedReceiver=Math.min(4,Math.max(0,o)),this.haptic(this.HAPTIC_TAP)}}updateJoystickVisual(){if(!this.joystickInner||!this.virtualJoystickCenter||!this.virtualJoystickCurrent)return;const e=(this.JOYSTICK_SIZE-this.JOYSTICK_INNER_SIZE)/2,t=this.virtualJoystickCurrent.x-this.virtualJoystickCenter.x,i=this.virtualJoystickCurrent.y-this.virtualJoystickCenter.y,s=Math.sqrt(t*t+i*i),o=Math.min(s,e),n=Math.atan2(i,t),a=Math.cos(n)*o,c=Math.sin(n)*o;this.joystickInner.style.transform=`translate(calc(-50% + ${a}px), calc(-50% + ${c}px))`;const d=o/e;this.joystickInner.style.boxShadow=`0 0 ${15+d*20}px rgba(57, 255, 20, ${.6+d*.4})`}resetJoystickVisual(){this.joystickInner&&(this.joystickInner.style.transform="translate(-50%, -50%)",this.joystickInner.style.boxShadow="0 0 15px rgba(57, 255, 20, 0.6)")}getActionHoldTime(){return this.action?(performance.now()-this.touchStartTime)/1e3:0}getSelectedReceiver(){const e=this.selectedReceiver;return this.selectedReceiver=null,e}setVisible(e){const t=document.getElementById("touchControls");t&&(t.style.display=e?"block":"none")}triggerHaptic(e){switch(e){case"light":this.haptic([10]);break;case"heavy":this.haptic([50]);break;case"success":this.haptic([20,50,30,50,40]);break;case"error":this.haptic([100,50,100]);break}}dispose(){const e=document.getElementById("touchControls");e&&e.remove()}}const tt={pursuit:1,interpose:.8,seek:1,flee:1,separation:.5,arrival:.6},it={pursuitLookAhead:.5,interposeRatio:.6,separationRadius:3,arrivalRadius:5,reactionTime:.15,coverageAggressiveness:.7};class De{constructor(e={},t={}){l(this,"config");l(this,"weights");this.config={...it,...e},this.weights={...tt,...t}}seek(e,t){const s=t.subtract(e.position).normalize().scale(e.maxSpeed).subtract(e.velocity);return this.truncate(s,e.maxForce)}flee(e,t){const s=e.position.subtract(t).normalize().scale(e.maxSpeed).subtract(e.velocity);return this.truncate(s,e.maxForce)}pursuit(e,t){const s=t.position.subtract(e.position).length(),o=e.velocity.length(),n=o>0?Math.min(s/o,this.config.pursuitLookAhead*2):this.config.pursuitLookAhead,a=t.position.clone();return t.velocity&&a.addInPlace(t.velocity.scale(n)),this.seek(e,a)}interpose(e,t,i){const s=t.position.scale(1-this.config.interposeRatio).add(i.position.scale(this.config.interposeRatio));return this.seek(e,s)}separation(e,t){const i=h.Zero();for(const s of t){if(s.id===e.id)continue;const o=e.position.subtract(s.position),n=o.length();if(n>0&&n<this.config.separationRadius){const a=o.normalize().scale(this.config.separationRadius/n);i.addInPlace(a)}}return i.length()>0?(i.normalize().scaleInPlace(e.maxSpeed),i.subtractInPlace(e.velocity),this.truncate(i,e.maxForce)):h.Zero()}arrival(e,t){const i=t.subtract(e.position),s=i.length();if(s<.1)return h.Zero();let o;s<=this.config.arrivalRadius?o=e.maxSpeed*(s/this.config.arrivalRadius):o=e.maxSpeed;const a=i.normalize().scale(o).subtract(e.velocity);return this.truncate(a,e.maxForce)}calculateDefenderSteering(e,t,i,s,o){const n=h.Zero();if(t){const c=this.pursuit(e,t);n.addInPlace(c.scale(this.weights.pursuit))}else if(i&&o){const c=this.interpose(e,{position:o},i);n.addInPlace(c.scale(this.weights.interpose))}else if(i){const c=this.arrival(e,i.position);n.addInPlace(c.scale(this.weights.seek))}const a=this.separation(e,s);return n.addInPlace(a.scale(this.weights.separation)),this.truncate(n,e.maxForce)}applySteeringForce(e,t,i){const s=t.scale(1/e.mass);e.velocity.addInPlace(s.scale(i)),e.velocity.length()>e.maxSpeed&&e.velocity.normalize().scaleInPlace(e.maxSpeed),e.position.addInPlace(e.velocity.scale(i)),e.velocity.length()>.1&&(e.rotation=Math.atan2(e.velocity.x,e.velocity.z))}truncate(e,t){return e.length()>t?e.normalize().scale(t):e}updateConfig(e){this.config={...this.config,...e}}updateWeights(e){this.weights={...this.weights,...e}}}class st{constructor(e,t){l(this,"steering");l(this,"agent");l(this,"reactionTimer",0);l(this,"coverageType","zone");l(this,"zonePosition",null);l(this,"manAssignment",null);this.agent=e,this.steering=new De(t)}setZoneCoverage(e){this.coverageType="zone",this.zonePosition=e.clone(),this.manAssignment=null}setManCoverage(e){this.coverageType="man",this.manAssignment=e,this.zonePosition=null}update(e,t,i,s,o,n){if(this.reactionTimer-=e,this.reactionTimer>0)return;let a=null;if(this.coverageType==="man"&&this.manAssignment){const p=s.get(this.manAssignment);p&&(a={position:p})}else this.coverageType==="zone"&&this.zonePosition&&(a={position:this.zonePosition});let c=null;t&&(c={position:t,velocity:i||void 0});const d=this.steering.calculateDefenderSteering(this.agent,c,a,n,o);this.steering.applySteeringForce(this.agent,d,e)}triggerReaction(e=.15){this.reactionTimer=e}getAgent(){return this.agent}setPosition(e){this.agent.position=e.clone()}canTackle(e,t=1.5){return h.Distance(this.agent.position,e)<=t}}var Pe=(r=>(r.Cover0="cover0",r.Cover1="cover1",r.Cover2="cover2",r.Cover3="cover3",r.Cover4="cover4",r.Cover6="cover6",r.ManPress="man_press",r.ManOff="man_off",r))(Pe||{});const A=26.67,G=A/1.5;function ot(r){return{deep_third_left:{name:"deep_third_left",xMin:-A,xMax:-G/2,zMin:r+15,zMax:r+40},deep_third_mid:{name:"deep_third_mid",xMin:-G/2,xMax:G/2,zMin:r+15,zMax:r+40},deep_third_right:{name:"deep_third_right",xMin:G/2,xMax:A,zMin:r+15,zMax:r+40},deep_half_left:{name:"deep_half_left",xMin:-A,xMax:0,zMin:r+15,zMax:r+40},deep_half_right:{name:"deep_half_right",xMin:0,xMax:A,zMin:r+15,zMax:r+40},flat_left:{name:"flat_left",xMin:-A,xMax:-10,zMin:r,zMax:r+8},flat_right:{name:"flat_right",xMin:10,xMax:A,zMin:r,zMax:r+8},hook_curl_left:{name:"hook_curl_left",xMin:-15,xMax:-2,zMin:r+5,zMax:r+15},hook_curl_right:{name:"hook_curl_right",xMin:2,xMax:15,zMin:r+5,zMax:r+15},seam_left:{name:"seam_left",xMin:-10,xMax:-2,zMin:r+10,zMax:r+20},seam_right:{name:"seam_right",xMin:2,xMax:10,zMin:r+10,zMax:r+20}}}function nt(r){return new h((r.xMin+r.xMax)*.5,0,(r.zMin+r.zMax)*.5)}function at(r,e){return r.x>=e.xMin&&r.x<=e.xMax&&r.z>=e.zMin&&r.z<=e.zMax}function le(r){switch(r){case"deep_third_left":case"deep_third_mid":case"deep_third_right":case"deep_half_left":case"deep_half_right":return{coverageRating:.8,baseReactionTime:.2,closingSpeedMultiplier:1.1,contestProbability:.6};case"man_coverage":return{coverageRating:.75,baseReactionTime:.18,closingSpeedMultiplier:1.05,contestProbability:.55};case"flat_left":case"flat_right":case"hook_curl_left":case"hook_curl_right":return{coverageRating:.65,baseReactionTime:.22,closingSpeedMultiplier:1,contestProbability:.45};case"seam_left":case"seam_right":return{coverageRating:.7,baseReactionTime:.2,closingSpeedMultiplier:1,contestProbability:.5};case"blitzer":return{coverageRating:.4,baseReactionTime:.12,closingSpeedMultiplier:1.15,contestProbability:.25};case"spy":return{coverageRating:.6,baseReactionTime:.15,closingSpeedMultiplier:1.1,contestProbability:.35};case"contain_left":case"contain_right":return{coverageRating:.5,baseReactionTime:.18,closingSpeedMultiplier:1.05,contestProbability:.3};default:return{coverageRating:.5,baseReactionTime:.2,closingSpeedMultiplier:1,contestProbability:.4}}}function rt(r,e,t,i){const o=e.subtract(r).length();if(o<.5)return e.clone();const n=t.length();if(n<.1)return e.clone();const a=i+n,c=o/a;return e.add(t.scale(c))}function he(r,e,t){const i=t==="left"?-4:4;return new h(e.x+i,0,e.z+2)}function Ce(r,e){switch(r){case"cover3":return _(["deep_third_left","deep_third_mid","deep_third_right","flat_left","flat_right","hook_curl_left","hook_curl_right"],e);case"cover2":return _(["deep_half_left","deep_half_right","flat_left","flat_right","hook_curl_left","hook_curl_right","seam_left"],e);case"cover4":return _(["deep_third_left","deep_third_right","deep_half_left","deep_half_right","hook_curl_left","hook_curl_right","seam_right"],e);case"cover1":return _(["deep_third_mid","man_coverage","man_coverage","man_coverage","man_coverage","hook_curl_left","hook_curl_right"],e);case"cover0":return _(["man_coverage","man_coverage","man_coverage","man_coverage","man_coverage","blitzer","blitzer"],e);case"man_press":return _(["deep_third_mid","man_coverage","man_coverage","man_coverage","man_coverage","man_coverage","spy"],e);case"man_off":return _(["deep_third_mid","man_coverage","man_coverage","man_coverage","man_coverage","hook_curl_left","hook_curl_right"],e);case"cover6":return _(["deep_half_left","deep_third_right","deep_half_right","flat_left","flat_right","hook_curl_left","seam_right"],e);default:return Ce("cover3",e)}}function _(r,e){if(e==="none")return r;const t=[...r];if(e==="zone_blitz"){const i=t.findIndex(s=>s==="hook_curl_left"||s==="hook_curl_right"||s==="flat_left"||s==="flat_right");if(i!==-1){const s=t[i];t[i]="blitzer";const o=t.findIndex(n=>n==="man_coverage"||n==="spy");o!==-1&&(t[o]=s)}return t}if(e==="delayed"){for(let i=t.length-1;i>=0;i--)if(t[i]!=="blitzer"){t[i]="blitzer";break}return t}for(let i=t.length-1;i>=0;i--)if(t[i]!=="blitzer"&&t[i]!=="deep_third_mid"){t[i]="blitzer";break}return t}function ct(r,e){switch(r){case"a_gap_left":return new h(-1.5,0,e-2);case"a_gap_right":return new h(1.5,0,e-2);case"b_gap_left":return new h(-4,0,e-2);case"b_gap_right":return new h(4,0,e-2);case"edge_left":return new h(-8,0,e-1);case"edge_right":return new h(8,0,e-1);case"delayed":return new h(0,0,e-2);case"zone_blitz":return new h(0,0,e-2);default:return new h(0,0,e)}}const U=class U{constructor(){l(this,"steering");l(this,"defenders",new Map);l(this,"scheme","cover3");l(this,"blitzPackage","none");l(this,"lineOfScrimmage",0);l(this,"zones",{});l(this,"qbEyeDirection",h.Forward());l(this,"isPlayAction",!1);l(this,"playElapsed",0);this.steering=new De({pursuitLookAhead:.6,separationRadius:2.5,arrivalRadius:4,coverageAggressiveness:.8},{pursuit:1.2,interpose:.9,seek:1,separation:.4,arrival:.7,flee:0})}addDefender(e,t="hook_curl_left",i){const s=le(t),o={agent:e,role:t,attributes:{...s,...i},manAssignmentId:null,zone:null,reactionTimer:0,routeRecognitionTimer:0,hasRecognizedRoute:!1,blitzPackage:"none",blitzDelayTimer:0,isBlitzing:!1,pursuitAngle:null,containSide:null};this.defenders.set(e.id,o)}removeDefender(e){this.defenders.delete(e)}setLineOfScrimmage(e){this.lineOfScrimmage=e,this.zones=ot(e)}setScheme(e,t="none"){this.scheme=e,this.blitzPackage=t;const i=Ce(e,t),s=Array.from(this.defenders.keys());for(let o=0;o<s.length;o++){const n=this.defenders.get(s[o]),a=i[o%i.length];n.role=a,n.attributes={...le(a),...n.attributes},n.isBlitzing=a==="blitzer",n.blitzPackage=a==="blitzer"?t:"none",n.blitzDelayTimer=t==="delayed"&&a==="blitzer"?.8+Math.random()*.4:0,this.zones[a]?n.zone=this.zones[a]:n.zone=null,a==="contain_left"?n.containSide="left":a==="contain_right"?n.containSide="right":n.containSide=null}}assignManCoverage(e,t){const i=this.defenders.get(e);i&&(i.role="man_coverage",i.manAssignmentId=t,i.zone=null)}setQBEyeDirection(e){this.qbEyeDirection=e.normalize()}setPlayAction(e){this.isPlayAction=e}update(e,t,i,s,o,n){this.playElapsed+=e;const a=this.getAllAgents();for(const[,c]of this.defenders)if(c.reactionTimer=Math.max(0,c.reactionTimer-e),!(c.reactionTimer>0)){if(c.hasRecognizedRoute||(c.routeRecognitionTimer+=e,c.routeRecognitionTimer>=U.ROUTE_BREAK_DELAY&&(c.hasRecognizedRoute=!0)),c.blitzDelayTimer>0){c.blitzDelayTimer-=e,this.updateZoneCoverage(c,e,o,s,a);continue}c.isBlitzing?this.updateBlitzer(c,e,t,i,a):t?this.updatePursuit(c,e,t,i,a):c.role==="man_coverage"?this.updateManCoverage(c,e,o,n,s,a):c.role==="spy"?this.updateSpy(c,e,t,i,s,a):c.containSide?this.updateContain(c,e,t,s,a):this.updateZoneCoverage(c,e,o,s,a)}}updateZoneCoverage(e,t,i,s,o){if(!e.zone){this.steering.applySteeringForce(e.agent,h.Zero(),t);return}let n=null;for(const[d,p]of i)if(at(p,e.zone)){const f=h.Distance(e.agent.position,p);(!n||f<n.dist)&&(n={id:d,pos:p,dist:f})}let a;if(n&&e.hasRecognizedRoute){s?a=this.steering.interpose(e.agent,{position:s},{position:n.pos}):a=this.steering.seek(e.agent,n.pos);const d=n.pos.subtract(e.agent.position).normalize();h.Dot(this.qbEyeDirection,d)>.6&&a.scaleInPlace(1+e.attributes.coverageRating*.3)}else{const d=nt(e.zone);a=this.steering.arrival(e.agent,d)}const c=this.steering.separation(e.agent,o);a.addInPlace(c.scale(.4)),this.applyWithRating(e,a,t)}updateManCoverage(e,t,i,s,o,n){if(!e.manAssignmentId){this.steering.applySteeringForce(e.agent,h.Zero(),t);return}const a=i.get(e.manAssignmentId);if(!a)return;const c=s.get(e.manAssignmentId)||h.Zero(),p=this.scheme==="man_press"||this.scheme==="cover0"?1:5,f=a.subtract(e.agent.position),g=f.length();let b;if(g>p&&!e.hasRecognizedRoute){const S=a.subtract(f.normalize().scale(p));b=this.steering.arrival(e.agent,S)}else{const S={position:a,velocity:c};o&&e.hasRecognizedRoute?(b=this.steering.interpose(e.agent,{position:o},S),b.scaleInPlace(1+e.attributes.coverageRating*.2)):b=this.steering.pursuit(e.agent,S)}const T=this.steering.separation(e.agent,n);b.addInPlace(T.scale(.3)),this.applyWithRating(e,b,t)}updateBlitzer(e,t,i,s,o){const n=i||ct(e.blitzPackage,this.lineOfScrimmage),a=s||h.Zero(),c={position:n,velocity:a};let d=this.steering.pursuit(e.agent,c);d.scaleInPlace(1.15);const p=this.steering.separation(e.agent,o);d.addInPlace(p.scale(.2)),this.steering.applySteeringForce(e.agent,d,t)}updatePursuit(e,t,i,s,o){const n=s||h.Zero();if(e.containSide){const p=he(e.agent.position,i,e.containSide),f=this.steering.seek(e.agent,p),g=this.steering.separation(e.agent,o);f.addInPlace(g.scale(.3)),this.applyWithRating(e,f,t);return}const a=rt(e.agent.position,i,n,e.agent.maxSpeed*e.attributes.closingSpeedMultiplier);e.pursuitAngle=a.clone();const c=this.steering.seek(e.agent,a);this.isPlayAction&&this.playElapsed<1&&c.scaleInPlace(.5);const d=this.steering.separation(e.agent,o);c.addInPlace(d.scale(.3)),this.applyWithRating(e,c,t)}updateSpy(e,t,i,s,o,n){const a=o?o.x:0,c=new h(a,0,this.lineOfScrimmage+3);let d;if(i){const f={position:i,velocity:s||void 0};d=this.steering.pursuit(e.agent,f)}else d=this.steering.arrival(e.agent,c);const p=this.steering.separation(e.agent,n);d.addInPlace(p.scale(.3)),this.applyWithRating(e,d,t)}updateContain(e,t,i,s,o){const n=i||s||new h(0,0,this.lineOfScrimmage),a=he(e.agent.position,n,e.containSide),c=this.steering.seek(e.agent,a),d=this.steering.separation(e.agent,o);c.addInPlace(d.scale(.3)),this.applyWithRating(e,c,t)}applyWithRating(e,t,i){const s=.85+e.attributes.coverageRating*.3,o=t.scale(s);this.steering.applySteeringForce(e.agent,o,i)}triggerReaction(e){for(const[,t]of this.defenders){const i=e??t.attributes.baseReactionTime;t.reactionTimer=i*(1.3-t.attributes.coverageRating*.5)}this.playElapsed=0;for(const[,t]of this.defenders)t.routeRecognitionTimer=0,t.hasRecognizedRoute=!1}canTackle(e,t,i=1.5){const s=this.defenders.get(e);return s?h.Distance(s.agent.position,t)<=i:!1}getAgent(e){return this.defenders.get(e)?.agent??null}getAllAgents(){const e=[];for(const[,t]of this.defenders)e.push(t.agent);return e}get defenderCount(){return this.defenders.size}get currentScheme(){return this.scheme}contestCatchProbability(e,t){const i=this.defenders.get(e);if(!i)return 0;const s=h.Distance(i.agent.position,t);if(s>3)return 0;const o=1-s/3;return i.attributes.contestProbability*o*i.attributes.coverageRating}reset(){this.playElapsed=0,this.isPlayAction=!1,this.qbEyeDirection=h.Forward();for(const[,e]of this.defenders)e.reactionTimer=0,e.routeRecognitionTimer=0,e.hasRecognizedRoute=!1,e.pursuitAngle=null,e.blitzDelayTimer=0}};l(U,"ROUTE_BREAK_DELAY",.5);let K=U;const de={quarterLengthSec:120,playClockSec:25,overtimeSuddenDeath:!0,twoMinuteWarningEnabled:!0},lt=[{id:"first_td",name:"First Blood",description:"Score your first touchdown"},{id:"100yd_passer",name:"Arm Cannon",description:"Pass for 100+ yards in a game"},{id:"pick_six",name:"Pick Six",description:"Return an interception for a touchdown"},{id:"shutout",name:"Lockdown",description:"Win without allowing a score"},{id:"comeback",name:"Never Say Die",description:"Win after trailing by 14+"},{id:"perfect_drive",name:"Surgeon",description:"Complete a drive with a perfect passer rating"},{id:"hat_trick",name:"Hat Trick",description:"Score 3 touchdowns"}];class z{constructor(e={}){l(this,"config");l(this,"clock");l(this,"scores");l(this,"stats");l(this,"drives");l(this,"achievements");l(this,"maxTrailingDeficit");l(this,"currentDrivePassing");this.config={...de,...e},this.clock=this.createClock(),this.scores={home:this.createTeamScore("home"),away:this.createTeamScore("away")},this.stats={home:this.createGameStats(),away:this.createGameStats()},this.drives=[],this.achievements=new Map,this.maxTrailingDeficit=0,this.currentDrivePassing=null;for(const t of lt)this.achievements.set(t.id,{...t,unlockedAt:null})}createClock(){return{quarter:1,timeRemainingSec:this.config.quarterLengthSec,playClockSec:this.config.playClockSec,isRunning:!1,isHalftime:!1,isTwoMinuteWarning:!1,isOvertime:!1,isGameOver:!1}}createTeamScore(e){return{team:e,total:0,touchdowns:0,extraPoints:0,twoPointConversions:0,fieldGoals:0,safeties:0,quarterScores:[0,0,0,0]}}createGameStats(){return{passing:{attempts:0,completions:0,yards:0,touchdowns:0,interceptions:0,passerRating:0},rushing:{attempts:0,yards:0,touchdowns:0,longestRun:0},receiving:{receptions:0,yards:0,touchdowns:0,byReceiver:new Map},defense:{sacks:0,interceptions:0,fumbleRecoveries:0},bigPlays:0,explosivePlays:0,timeOfPossessionSec:0,thirdDownAttempts:0,thirdDownConversions:0,fourthDownAttempts:0,fourthDownConversions:0}}getClock(){return this.clock}startClock(){!this.clock.isGameOver&&!this.clock.isHalftime&&(this.clock.isRunning=!0)}stopClock(){this.clock.isRunning=!1}resetPlayClock(){this.clock.playClockSec=this.config.playClockSec}tick(e){if(!this.clock.isRunning||this.clock.isGameOver)return!1;this.clock.playClockSec=Math.max(0,this.clock.playClockSec-e);const t=this.clock.timeRemainingSec;return this.clock.timeRemainingSec=Math.max(0,this.clock.timeRemainingSec-e),this.config.twoMinuteWarningEnabled&&!this.clock.isTwoMinuteWarning&&(this.clock.quarter===2||this.clock.quarter===4)&&t>120&&this.clock.timeRemainingSec<=120?(this.clock.isTwoMinuteWarning=!0,this.clock.isRunning=!1,!1):this.clock.timeRemainingSec<=0?this.endQuarter():!1}clearTwoMinuteWarning(){this.clock.isTwoMinuteWarning=!1}endQuarter(){return this.clock.isRunning=!1,this.clock.quarter===2?(this.clock.isHalftime=!0,!0):this.clock.quarter===4?this.scores.home.total===this.scores.away.total&&this.config.overtimeSuddenDeath?(this.clock.quarter=5,this.clock.isOvertime=!0,this.clock.timeRemainingSec=this.config.quarterLengthSec,!0):(this.clock.isGameOver=!0,this.evaluateEndGameAchievements(),!0):this.clock.isOvertime?this.scores.home.total===this.scores.away.total?(this.clock.quarter+=1,this.clock.timeRemainingSec=this.config.quarterLengthSec,!0):(this.clock.isGameOver=!0,this.evaluateEndGameAchievements(),!0):(this.clock.quarter+=1,this.clock.timeRemainingSec=this.config.quarterLengthSec,this.clock.isTwoMinuteWarning=!1,!0)}endHalftime(){this.clock.isHalftime&&(this.clock.isHalftime=!1,this.clock.quarter=3,this.clock.timeRemainingSec=this.config.quarterLengthSec,this.clock.isTwoMinuteWarning=!1)}getElapsedSec(){return(this.clock.quarter-1)*this.config.quarterLengthSec+(this.config.quarterLengthSec-this.clock.timeRemainingSec)}getScore(e){return this.scores[e]}scoreTouchdown(e){this.addPoints(e,6),this.scores[e].touchdowns+=1,this.checkScoringAchievements(e)}scoreExtraPoint(e){this.addPoints(e,1),this.scores[e].extraPoints+=1}scoreTwoPointConversion(e){this.addPoints(e,2),this.scores[e].twoPointConversions+=1}scoreFieldGoal(e){this.addPoints(e,3),this.scores[e].fieldGoals+=1,this.checkOvertimeEnd()}scoreSafety(e){this.addPoints(e,2),this.scores[e].safeties+=1,this.checkOvertimeEnd()}addPoints(e,t){this.scores[e].total+=t;const i=Math.min(this.clock.quarter-1,this.scores[e].quarterScores.length-1);if(i>=0){for(;this.scores[e].quarterScores.length<=i;)this.scores[e].quarterScores.push(0);this.scores[e].quarterScores[i]+=t}this.trackDeficit()}checkOvertimeEnd(){this.clock.isOvertime&&this.scores.home.total!==this.scores.away.total&&(this.clock.isGameOver=!0,this.evaluateEndGameAchievements())}trackDeficit(){const e=this.scores.away.total-this.scores.home.total;e>this.maxTrailingDeficit&&(this.maxTrailingDeficit=e)}getStats(e){return this.stats[e]}recordPassAttempt(e,t,i,s,o){const n=this.stats[e].passing;n.attempts+=1,t&&(n.completions+=1,n.yards+=i,s&&(n.touchdowns+=1)),o&&(n.interceptions+=1),n.passerRating=z.computePasserRating(n),t&&(i>=40?this.stats[e].explosivePlays+=1:i>=20&&(this.stats[e].bigPlays+=1)),this.currentDrivePassing&&(this.currentDrivePassing.attempts+=1,t&&(this.currentDrivePassing.completions+=1,this.currentDrivePassing.yards+=i,s&&(this.currentDrivePassing.touchdowns+=1)),o&&(this.currentDrivePassing.interceptions+=1),this.currentDrivePassing.passerRating=z.computePasserRating(this.currentDrivePassing)),this.checkStatAchievements(e)}recordReception(e,t,i,s){const o=this.stats[e].receiving;o.receptions+=1,o.yards+=i,s&&(o.touchdowns+=1);const n=o.byReceiver.get(t);n?(n.receptions+=1,n.yards+=i,s&&(n.touchdowns+=1)):o.byReceiver.set(t,{receptions:1,yards:i,touchdowns:s?1:0})}recordRush(e,t,i){const s=this.stats[e].rushing;s.attempts+=1,s.yards+=t,i&&(s.touchdowns+=1),t>s.longestRun&&(s.longestRun=t),t>=40?this.stats[e].explosivePlays+=1:t>=20&&(this.stats[e].bigPlays+=1)}recordSack(e){this.stats[e].defense.sacks+=1}recordInterception(e){this.stats[e].defense.interceptions+=1}recordFumbleRecovery(e){this.stats[e].defense.fumbleRecoveries+=1}recordPickSix(e){this.recordInterception(e),this.unlock("pick_six")}recordThirdDown(e,t){this.stats[e].thirdDownAttempts+=1,t&&(this.stats[e].thirdDownConversions+=1)}recordFourthDown(e,t){this.stats[e].fourthDownAttempts+=1,t&&(this.stats[e].fourthDownConversions+=1)}addTimeOfPossession(e,t){this.stats[e].timeOfPossessionSec+=t}static computePasserRating(e){if(e.attempts===0)return 0;const t=Math.min(Math.max((e.completions/e.attempts-.3)*5,0),2.375),i=Math.min(Math.max((e.yards/e.attempts-3)*.25,0),2.375),s=Math.min(Math.max(e.touchdowns/e.attempts*20,0),2.375),o=Math.min(Math.max(2.375-e.interceptions/e.attempts*25,0),2.375);return Math.round((t+i+s+o)/6*100*10)/10}getDrives(){return this.drives}startDrive(e){this.currentDrivePassing={attempts:0,completions:0,yards:0,touchdowns:0,interceptions:0,passerRating:0}}endDrive(e,t,i,s,o){const n={driveIndex:this.drives.length,team:e,plays:t,yards:i,result:s,elapsedSec:o,startQuarter:this.clock.quarter,startTimeRemaining:this.clock.timeRemainingSec+o};this.drives.push(n),this.currentDrivePassing&&this.currentDrivePassing.attempts>0&&s==="touchdown"&&this.currentDrivePassing.passerRating>=158.3&&this.unlock("perfect_drive"),this.currentDrivePassing=null}getAchievements(){return Array.from(this.achievements.values())}getUnlockedAchievements(){return this.getAchievements().filter(e=>e.unlockedAt!==null)}isUnlocked(e){return(this.achievements.get(e)?.unlockedAt??null)!==null}unlock(e){const t=this.achievements.get(e);t&&t.unlockedAt===null&&(t.unlockedAt=this.getElapsedSec())}checkScoringAchievements(e){const t=this.scores[e];t.touchdowns>=1&&this.unlock("first_td"),t.touchdowns>=3&&this.unlock("hat_trick"),this.clock.isOvertime&&this.scores.home.total!==this.scores.away.total&&(this.clock.isGameOver=!0,this.evaluateEndGameAchievements())}checkStatAchievements(e){this.stats[e].passing.yards>=100&&this.unlock("100yd_passer")}evaluateEndGameAchievements(){const e=this.scores.home.total>this.scores.away.total?"home":"away",t=e==="home"?"away":"home";this.scores[t].total===0&&this.unlock("shutout"),e==="home"&&this.maxTrailingDeficit>=14&&this.unlock("comeback")}reset(e){e&&(this.config={...de,...e}),this.clock=this.createClock(),this.scores={home:this.createTeamScore("home"),away:this.createTeamScore("away")},this.stats={home:this.createGameStats(),away:this.createGameStats()},this.drives=[],this.maxTrailingDeficit=0,this.currentDrivePassing=null;for(const[t,i]of this.achievements)i.unlockedAt=null}}const ht={masterVolume:.7,musicVolume:.4,sfxVolume:.8,ambientVolume:.3};class dt{constructor(e,t={}){l(this,"scene");l(this,"config");l(this,"isUnlocked",!1);l(this,"audioContext",null);l(this,"_ambientNoise",null);l(this,"_ambientLfo",null);l(this,"_crowdSources",null);l(this,"_crowdGain",null);l(this,"_convolver",null);this.scene=e,this.config={...ht,...t},this.initAudioContext()}initAudioContext(){try{this.audioContext=new(window.AudioContext||window.webkitAudioContext)}catch{console.warn("Web Audio API not supported")}this.audioContext&&this.createReverbConvolver()}async unlock(){if(!this.isUnlocked){if(this.audioContext?.state==="suspended"&&await this.audioContext.resume(),this.audioContext){const e=this.audioContext.createBuffer(1,1,22050),t=this.audioContext.createBufferSource();t.buffer=e,t.connect(this.audioContext.destination),t.start(0)}this.isUnlocked=!0}}get unlocked(){return this.isUnlocked}playSFX(e){if(!this.audioContext||!this.isUnlocked)return;const t=this.config.masterVolume*this.config.sfxVolume;switch(e){case"snap":this.playSnap(t);break;case"tackle":this.playTackle(t);break;case"tackle_big":this.playBigTackle(t);break;case"catch":this.playCatch(t);break;case"incomplete":this.playIncomplete(t);break;case"whistle":this.playWhistle(t);break;case"crowd_cheer":this.playCrowdCheer(t);break;case"crowd_gasp":this.playCrowdGasp(t);break;case"touchdown":this.playTouchdown(t);break;case"first_down":this.playFirstDown(t);break;case"turbo_boost":this.playTurboBoost(t);break;case"game_start":this.playGameStart(t);break;case"game_over":this.playGameOver(t);break;case"pass_throw":this.playPassThrow(t);break;case"hit_impact":this.playHitImpact(t);break;case"fumble":this.playFumble(t);break;case"stiff_arm":this.playStiffArm(t);break;case"juke":this.playJuke(t);break}}playSnap(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.05),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.value=1500,n.Q.value=2;const a=t.createGain();a.gain.setValueAtTime(e*.5,i),a.gain.exponentialDecayTo(.001,i+.05),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playTackle(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.12),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="lowpass",n.frequency.value=800;const a=t.createGain();a.gain.setValueAtTime(e*.7,i),a.gain.exponentialDecayTo(.001,i+.12),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i);const c=t.createOscillator();c.type="sine",c.frequency.setValueAtTime(100,i),c.frequency.exponentialRampToValueAtTime(40,i+.08);const d=t.createGain();d.gain.setValueAtTime(e*.5,i),d.gain.exponentialDecayTo(.001,i+.08),c.connect(d),d.connect(t.destination),c.detune.value=Math.random()*400-200,c.start(i),c.stop(i+.1)}playBigTackle(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.2),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="lowpass",n.frequency.value=600;const a=t.createGain();a.gain.setValueAtTime(e*.9,i),a.gain.exponentialDecayTo(.001,i+.2),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i);const c=t.createOscillator();c.type="sine",c.frequency.setValueAtTime(80,i),c.frequency.exponentialRampToValueAtTime(30,i+.15);const d=t.createGain();d.gain.setValueAtTime(e*.7,i),d.gain.exponentialDecayTo(.001,i+.15),c.connect(d),d.connect(t.destination),c.detune.value=Math.random()*400-200,c.start(i),c.stop(i+.2),setTimeout(()=>this.playCrowdGasp(e*.5),100)}playCatch(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.06),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.value=1200,n.Q.value=1;const a=t.createGain();a.gain.setValueAtTime(e*.4,i),a.gain.exponentialDecayTo(.001,i+.06),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playIncomplete(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.08),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="lowpass",n.frequency.value=500;const a=t.createGain();a.gain.setValueAtTime(e*.3,i),a.gain.exponentialDecayTo(.001,i+.08),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i),setTimeout(()=>this.playCrowdGasp(e*.3),50)}playWhistle(e){const t=this.audioContext,i=t.currentTime,s=t.createOscillator();s.type="sine",s.frequency.setValueAtTime(3e3,i),s.frequency.setValueAtTime(2800,i+.1),s.frequency.setValueAtTime(3e3,i+.2);const o=t.createGain();if(o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(e*.3,i+.02),o.gain.setValueAtTime(e*.3,i+.25),o.gain.linearRampToValueAtTime(0,i+.3),s.connect(o),o.connect(t.destination),this._convolver){const n=t.createGain();n.gain.value=.3,o.connect(this._convolver),this._convolver.connect(n),n.connect(t.destination)}s.detune.value=Math.random()*400-200,s.start(i),s.stop(i+.35)}playCrowdCheer(e){const t=this.audioContext,i=t.currentTime,s=1.5,o=this.createNoiseBuffer(s),n=t.createBufferSource();n.buffer=o;const a=t.createBiquadFilter();a.type="bandpass",a.frequency.value=1200,a.Q.value=.5;const c=t.createOscillator();c.frequency.value=3;const d=t.createGain();d.gain.value=200,c.connect(d),d.connect(a.frequency),c.detune.value=Math.random()*400-200,c.start(i),c.stop(i+s);const p=t.createGain();p.gain.setValueAtTime(0,i),p.gain.linearRampToValueAtTime(e*.5,i+.2),p.gain.setValueAtTime(e*.5,i+.8),p.gain.linearRampToValueAtTime(0,i+s),n.connect(a),a.connect(p),p.connect(t.destination),n.start(i)}playCrowdGasp(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.4),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.setValueAtTime(2e3,i),n.frequency.linearRampToValueAtTime(800,i+.4),n.Q.value=1;const a=t.createGain();a.gain.setValueAtTime(e*.4,i),a.gain.linearRampToValueAtTime(0,i+.4),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playTouchdown(e){const t=this.audioContext,i=t.currentTime,s=[261.63,329.63,392,523.25,659.26],o=[0,.05,.1,.15,.2];s.forEach((n,a)=>{const c=t.createOscillator();c.type="triangle",c.frequency.value=n;const d=t.createGain();d.gain.setValueAtTime(0,i+o[a]),d.gain.linearRampToValueAtTime(e*.4,i+o[a]+.05),d.gain.exponentialDecayTo(.001,i+o[a]+1),c.connect(d),d.connect(t.destination),c.detune.value=Math.random()*400-200,c.start(i+o[a]),c.stop(i+o[a]+1.2)}),setTimeout(()=>this.playCrowdCheer(e*1.5),150)}playFirstDown(e){const t=this.audioContext,i=t.currentTime;[392,493.88,587.33].forEach((o,n)=>{const a=t.createOscillator();a.type="square",a.frequency.value=o;const c=t.createGain(),d=i+n*.08;c.gain.setValueAtTime(e*.2,d),c.gain.exponentialDecayTo(.001,d+.2),a.connect(c),c.connect(t.destination),a.detune.value=Math.random()*400-200,a.start(d),a.stop(d+.25)})}playTurboBoost(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.15),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.setValueAtTime(500,i),n.frequency.linearRampToValueAtTime(2e3,i+.15),n.Q.value=1;const a=t.createGain();a.gain.setValueAtTime(e*.3,i),a.gain.linearRampToValueAtTime(0,i+.15),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playGameStart(e){const t=this.audioContext,i=t.currentTime,s=t.createOscillator();s.type="sawtooth",s.frequency.value=220;const o=t.createBiquadFilter();o.type="lowpass",o.frequency.value=800;const n=t.createGain();n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(e*.4,i+.1),n.gain.setValueAtTime(e*.4,i+.4),n.gain.linearRampToValueAtTime(0,i+.6),s.connect(o),o.connect(n),n.connect(t.destination),s.detune.value=Math.random()*400-200,s.start(i),s.stop(i+.7),setTimeout(()=>this.playCrowdCheer(e*.5),200)}playGameOver(e){const t=this.audioContext,i=t.currentTime,s=t.createOscillator();s.type="sawtooth",s.frequency.setValueAtTime(220,i),s.frequency.linearRampToValueAtTime(110,i+1);const o=t.createBiquadFilter();o.type="lowpass",o.frequency.value=600;const n=t.createGain();n.gain.setValueAtTime(e*.4,i),n.gain.linearRampToValueAtTime(0,i+1),s.connect(o),o.connect(n),n.connect(t.destination),s.detune.value=Math.random()*400-200,s.start(i),s.stop(i+1.1)}playPassThrow(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.2),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.setValueAtTime(600,i),n.frequency.linearRampToValueAtTime(1500,i+.2),n.Q.value=2;const a=t.createGain();a.gain.setValueAtTime(0,i),a.gain.linearRampToValueAtTime(e*.2,i+.05),a.gain.linearRampToValueAtTime(0,i+.2),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playHitImpact(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.08),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="lowpass",n.frequency.value=1e3;const a=t.createGain();a.gain.setValueAtTime(e*.5,i),a.gain.exponentialDecayTo(.001,i+.08),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playFumble(e){const t=this.audioContext,i=t.currentTime,s=t.createOscillator();s.type="sawtooth",s.frequency.setValueAtTime(500,i),s.frequency.exponentialRampToValueAtTime(150,i+.3);const o=t.createBiquadFilter();o.type="lowpass",o.frequency.value=1e3;const n=t.createGain();n.gain.setValueAtTime(e*.25,i),n.gain.linearRampToValueAtTime(0,i+.3),s.connect(o),o.connect(n),n.connect(t.destination),s.detune.value=Math.random()*400-200,s.start(i),s.stop(i+.35),this.playCrowdGasp(e*.6)}playStiffArm(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.06),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.value=1e3,n.Q.value=1;const a=t.createGain();a.gain.setValueAtTime(e*.4,i),a.gain.exponentialDecayTo(.001,i+.06),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}playJuke(e){const t=this.audioContext,i=t.currentTime,s=this.createNoiseBuffer(.1),o=t.createBufferSource();o.buffer=s;const n=t.createBiquadFilter();n.type="bandpass",n.frequency.setValueAtTime(800,i),n.frequency.linearRampToValueAtTime(1500,i+.1),n.Q.value=2;const a=t.createGain();a.gain.setValueAtTime(e*.25,i),a.gain.linearRampToValueAtTime(0,i+.1),o.connect(n),n.connect(a),a.connect(t.destination),o.start(i)}createReverbConvolver(){const e=this.audioContext,t=e.sampleRate,i=t*1.5,s=e.createBuffer(2,i,t);for(let o=0;o<2;o++){const n=s.getChannelData(o);for(let a=0;a<i;a++)n[a]=(Math.random()*2-1)*Math.exp(-a/(t*.4))}this._convolver=e.createConvolver(),this._convolver.buffer=s}createNoiseBuffer(e){const t=this.audioContext,i=t.sampleRate,s=i*e,o=t.createBuffer(1,s,i),n=o.getChannelData(0);for(let a=0;a<s;a++)n[a]=Math.random()*2-1;return o}startAmbientCrowd(){if(!this.audioContext||!this.isUnlocked)return;this.stopAmbientCrowd();const e=this.audioContext,t=this.config.masterVolume*this.config.ambientVolume;this._crowdGain=e.createGain(),this._crowdGain.gain.value=t*.25,this._crowdGain.connect(e.destination);const i=[[-1,0,-1],[1,0,-1],[-1,0,1],[1,0,1]];this._crowdSources=i.map((s,o)=>{const n=e.sampleRate*2,a=e.createBuffer(1,n,e.sampleRate),c=a.getChannelData(0);for(let T=0;T<n;T++)c[T]=(Math.random()*2-1)*.5;const d=e.createBufferSource();d.buffer=a,d.loop=!0;const p=e.createBiquadFilter();p.type="bandpass",p.frequency.value=600+o*150,p.Q.value=.4;const f=e.createPanner();f.positionX.value=s[0],f.positionY.value=s[1],f.positionZ.value=s[2],f.panningModel="HRTF",f.distanceModel="inverse",f.refDistance=1,f.maxDistance=10;const g=e.createOscillator();g.frequency.value=.15+Math.random()*.2;const b=e.createGain();return b.gain.value=80,g.connect(b),b.connect(p.frequency),g.start(),d.connect(p),p.connect(f),f.connect(this._crowdGain),d.start(),{noise:d,lfo:g,panner:f}})}stopAmbientCrowd(){this._crowdSources&&(this._crowdSources.forEach(e=>{e.noise.stop(),e.lfo.stop()}),this._crowdSources=null),this._crowdGain&&(this._crowdGain.disconnect(),this._crowdGain=null),this._ambientNoise&&(this._ambientNoise.stop(),this._ambientNoise=null),this._ambientLfo&&(this._ambientLfo.stop(),this._ambientLfo=null)}setCrowdIntensity(e){if(!this._crowdGain||!this.audioContext)return;const t=this.audioContext,i=this.config.masterVolume*this.config.ambientVolume*.25;this._crowdGain.gain.cancelScheduledValues(t.currentTime),this._crowdGain.gain.setValueAtTime(this._crowdGain.gain.value,t.currentTime),this._crowdGain.gain.linearRampToValueAtTime(i*e,t.currentTime+.5)}setMasterVolume(e){this.config.masterVolume=Math.max(0,Math.min(1,e))}setSFXVolume(e){this.config.sfxVolume=Math.max(0,Math.min(1,e))}dispose(){this.stopAmbientCrowd(),this.audioContext?.state!=="closed"&&this.audioContext?.close()}}AudioParam.prototype.exponentialDecayTo||(AudioParam.prototype.exponentialDecayTo=function(r,e){this.exponentialRampToValueAtTime(Math.max(r,1e-4),e)});const ut={startingYardLine:25,enableTurnovers:!0,maxDowns:4,firstDownDistance:10,fieldLength:100};class pt{constructor(e={}){l(this,"config");l(this,"state");l(this,"playHistory",[]);this.config={...ut,...e},this.state=this.createInitialState()}createInitialState(){const e=this.config.startingYardLine;return{down:1,yardsToGo:this.config.firstDownDistance,lineOfScrimmage:e,firstDownMarker:Math.min(e+this.config.firstDownDistance,this.config.fieldLength),playCount:0,driveYards:0,driveResult:"in_progress",isRedZone:e>=80,fieldPosition:e<40?"own":e<60?"midfield":"opponent",lastPlayResult:null}}reset(e){e!==void 0&&(this.config.startingYardLine=e),this.state=this.createInitialState(),this.playHistory=[]}processPlay(e,t={}){const i=t.isPenalty?t.penaltyYards??0:e,s={yardsGained:i,isComplete:t.isComplete??i>0,isTouchdown:!1,isTurnover:!1,isFirstDown:!1,isSack:t.isSack??!1,isFumble:t.isFumble??!1,isInterception:t.isInterception??!1,isPenalty:t.isPenalty??!1,penaltyYards:t.penaltyYards??0,bigPlay:i>=20,explosivePlay:i>=40},o=this.state.lineOfScrimmage+i;if(o>=this.config.fieldLength)return s.isTouchdown=!0,this.state.driveResult="touchdown",this.state.lineOfScrimmage=this.config.fieldLength,this.finalizPlay(s),s;if(o<=0)return s.isTurnover=!0,this.state.driveResult="safety",this.state.lineOfScrimmage=0,this.finalizPlay(s),s;if(this.config.enableTurnovers){if(s.isInterception)return s.isTurnover=!0,this.state.driveResult="interception",this.finalizPlay(s),s;if(s.isFumble)return s.isTurnover=!0,this.state.driveResult="fumble_lost",this.finalizPlay(s),s}return this.state.lineOfScrimmage=o,this.state.driveYards+=Math.max(0,i),o>=this.state.firstDownMarker?(s.isFirstDown=!0,this.state.down=1,this.state.yardsToGo=this.config.firstDownDistance,this.state.firstDownMarker=Math.min(o+this.config.firstDownDistance,this.config.fieldLength)):(this.state.down++,this.state.yardsToGo=Math.max(1,this.state.firstDownMarker-o),this.state.down>this.config.maxDowns&&(s.isTurnover=!0,this.state.driveResult="turnover_on_downs")),this.finalizPlay(s),s}finalizPlay(e){this.state.playCount++,this.state.lastPlayResult=e,this.state.isRedZone=this.state.lineOfScrimmage>=80,this.state.fieldPosition=this.state.lineOfScrimmage<40?"own":this.state.lineOfScrimmage<60?"midfield":"opponent",this.playHistory.push(e)}getState(){return{...this.state}}isOver(){return this.state.driveResult!=="in_progress"}getDown(){return this.state.down}getYardsToGo(){return this.state.yardsToGo}getLineOfScrimmage(){return this.state.lineOfScrimmage}getFirstDownMarker(){return this.state.firstDownMarker}isRedZone(){return this.state.isRedZone}getPlayHistory(){return[...this.playHistory]}getDownAndDistance(){const e=["1st","2nd","3rd","4th"][this.state.down-1]??`${this.state.down}th`,t=this.state.lineOfScrimmage,i=t<=50?`OWN ${t}`:`OPP ${100-t}`;return this.state.yardsToGo>=this.config.fieldLength-t?`${e} & Goal at ${i}`:`${e} & ${this.state.yardsToGo} at ${i}`}getAvgYardsPerPlay(){return this.state.playCount===0?0:this.state.driveYards/this.state.playCount}}const ue=[{positionId:"qb",offsetX:-2,offsetZ:0},{positionId:"rb",offsetX:0,offsetZ:-3}],pe=[{positionId:"qb",offsetX:1,offsetZ:0},{positionId:"rb",offsetX:-4,offsetZ:0},{positionId:"te",offsetX:0,offsetZ:-4}],fe=[{positionId:"qb",offsetX:-2,offsetZ:0},{positionId:"wr1",offsetX:0,offsetZ:18},{positionId:"wr2",offsetX:-1,offsetZ:12},{positionId:"wr3",offsetX:0,offsetZ:15},{positionId:"te",offsetX:0,offsetZ:-6}],me=[{positionId:"qb",offsetX:-3,offsetZ:0},{positionId:"wr1",offsetX:0,offsetZ:25},{positionId:"wr2",offsetX:0,offsetZ:-25},{positionId:"wr3",offsetX:-1,offsetZ:12},{positionId:"te",offsetX:-1,offsetZ:-12},{positionId:"rb",offsetX:-1,offsetZ:-4}],ye=[{positionId:"qb",offsetX:0,offsetZ:0},{positionId:"rb",offsetX:-4,offsetZ:0},{positionId:"te",offsetX:0,offsetZ:-6}];function L(r){const e={qb:{x:-5,z:0},rb:{x:-7,z:0},wr1:{x:0,z:20},wr2:{x:0,z:-20},wr3:{x:-1,z:8},te:{x:-1,z:-8},c:{x:0,z:0}},t={...e};for(const i of r)t[i.positionId]&&(t[i.positionId]={x:e[i.positionId].x+i.offsetX,z:e[i.positionId].z+i.offsetZ});return Object.values(t).map(i=>new h(i.x,0,i.z))}const Q={shotgun:{id:"shotgun",name:"Shotgun",description:"QB lined up 7 yards back, RB beside him",offsets:ue,preview:L(ue)},iform:{id:"iform",name:"I-Formation",description:"QB under center, RB directly behind",offsets:pe,preview:L(pe)},trips:{id:"trips",name:"Trips",description:"Three receivers stacked to one side",offsets:fe,preview:L(fe)},spread:{id:"spread",name:"Spread",description:"Receivers split wide, 5-wide look",offsets:me,preview:L(me)},singleback:{id:"singleback",name:"Singleback",description:"Balanced with one back behind QB",offsets:ye,preview:L(ye)}},xe=[{id:"pb_quick_slants",name:"Quick Slants",category:"short",formation:"spread",tempo:"hurry",description:"Two slants off the snap for a fast 5-8 yard gain",difficulty:1,tags:["quick","safe","short_yardage"],routes:[{positionId:"wr1",routeType:"slant",routeDepth:7,routeWidth:-5,breakDelay:.15,isPrimary:!0},{positionId:"wr2",routeType:"slant",routeDepth:7,routeWidth:5,breakDelay:.2,isPrimary:!1},{positionId:"wr3",routeType:"flat",routeDepth:2,routeWidth:10,breakDelay:.1,isPrimary:!1},{positionId:"te",routeType:"drag",routeDepth:5,routeWidth:12,breakDelay:.25,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:3,routeWidth:-5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_rb_screen",name:"RB Screen",category:"short",formation:"shotgun",tempo:"normal",description:"Dump to the back and let blockers lead",difficulty:2,tags:["screen","run_after_catch","blitz_beater"],routes:[{positionId:"rb",routeType:"flat",routeDepth:-1,routeWidth:14,breakDelay:.4,isPrimary:!0},{positionId:"wr1",routeType:"streak",routeDepth:20,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr2",routeType:"streak",routeDepth:20,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"block",routeDepth:4,routeWidth:10,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"block",routeDepth:4,routeWidth:6,breakDelay:.5,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:3,routeWidth:12,breakDelay:.3,isPrimary:!1}]},{id:"pb_flat_out",name:"Flat & Out",category:"short",formation:"singleback",tempo:"hurry",description:"Quick flat to the TE with a WR out route underneath",difficulty:1,tags:["quick","safe","sideline"],routes:[{positionId:"te",routeType:"flat",routeDepth:3,routeWidth:-10,breakDelay:.15,isPrimary:!0},{positionId:"wr1",routeType:"out",routeDepth:6,routeWidth:8,breakDelay:.4,isPrimary:!1},{positionId:"wr2",routeType:"slant",routeDepth:8,routeWidth:5,breakDelay:.2,isPrimary:!1},{positionId:"wr3",routeType:"drag",routeDepth:5,routeWidth:15,breakDelay:.3,isPrimary:!1},{positionId:"rb",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_curl_flat",name:"Curl-Flat Combo",category:"medium",formation:"singleback",tempo:"normal",description:"High-low read: curl at 12 yards with a flat underneath",difficulty:1,tags:["read","safe","zone_beater"],routes:[{positionId:"wr1",routeType:"curl",routeDepth:12,routeWidth:0,breakDelay:.7,isPrimary:!0},{positionId:"wr3",routeType:"flat",routeDepth:3,routeWidth:10,breakDelay:.15,isPrimary:!1},{positionId:"wr2",routeType:"curl",routeDepth:12,routeWidth:0,breakDelay:.7,isPrimary:!1},{positionId:"te",routeType:"in",routeDepth:10,routeWidth:-10,breakDelay:.55,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:4,routeWidth:5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_mesh_cross",name:"Mesh Crossers",category:"medium",formation:"spread",tempo:"normal",description:"Crossing routes that create pick-style traffic",difficulty:2,tags:["crossing","man_beater","rac"],routes:[{positionId:"wr1",routeType:"drag",routeDepth:6,routeWidth:-25,breakDelay:.25,isPrimary:!0},{positionId:"wr2",routeType:"drag",routeDepth:5,routeWidth:25,breakDelay:.2,isPrimary:!1},{positionId:"wr3",routeType:"in",routeDepth:14,routeWidth:-12,breakDelay:.55,isPrimary:!1},{positionId:"te",routeType:"out",routeDepth:10,routeWidth:-10,breakDelay:.5,isPrimary:!1},{positionId:"rb",routeType:"wheel",routeDepth:12,routeWidth:14,breakDelay:.4,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_smash",name:"Smash Concept",category:"medium",formation:"trips",tempo:"normal",description:"Corner-hitch combo to beat Cover 2",difficulty:2,tags:["cover2_beater","read","sideline"],routes:[{positionId:"wr1",routeType:"corner",routeDepth:14,routeWidth:10,breakDelay:.55,isPrimary:!0},{positionId:"wr3",routeType:"curl",routeDepth:6,routeWidth:0,breakDelay:.5,isPrimary:!1},{positionId:"wr2",routeType:"post",routeDepth:16,routeWidth:-8,breakDelay:.55,isPrimary:!1},{positionId:"te",routeType:"drag",routeDepth:5,routeWidth:-15,breakDelay:.3,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:3,routeWidth:-5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_four_verts",name:"Four Verticals",category:"deep",formation:"spread",tempo:"normal",description:"Four receivers streak deep to stress the safeties",difficulty:3,tags:["vertical","aggressive","cover3_beater"],routes:[{positionId:"wr1",routeType:"streak",routeDepth:30,routeWidth:0,breakDelay:0,isPrimary:!0},{positionId:"wr2",routeType:"streak",routeDepth:30,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"streak",routeDepth:25,routeWidth:3,breakDelay:0,isPrimary:!1},{positionId:"te",routeType:"streak",routeDepth:22,routeWidth:-3,breakDelay:0,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_post_wheel",name:"Post-Wheel",category:"deep",formation:"shotgun",tempo:"normal",description:"Deep post with a wheel route to hold the safety",difficulty:2,tags:["deep","cover1_beater","big_play"],routes:[{positionId:"wr1",routeType:"post",routeDepth:22,routeWidth:-10,breakDelay:.55,isPrimary:!0},{positionId:"rb",routeType:"wheel",routeDepth:18,routeWidth:16,breakDelay:.35,isPrimary:!1},{positionId:"wr2",routeType:"curl",routeDepth:12,routeWidth:0,breakDelay:.65,isPrimary:!1},{positionId:"wr3",routeType:"slant",routeDepth:8,routeWidth:-5,breakDelay:.2,isPrimary:!1},{positionId:"te",routeType:"drag",routeDepth:6,routeWidth:15,breakDelay:.3,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_corner_post",name:"Corner-Post",category:"deep",formation:"trips",tempo:"slow",description:"Corner route with a deep post to split the coverage",difficulty:3,tags:["deep","cover2_beater","aggressive"],routes:[{positionId:"wr1",routeType:"corner",routeDepth:25,routeWidth:15,breakDelay:.5,isPrimary:!1},{positionId:"wr2",routeType:"post",routeDepth:28,routeWidth:-10,breakDelay:.55,isPrimary:!0},{positionId:"wr3",routeType:"in",routeDepth:12,routeWidth:-8,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"flat",routeDepth:3,routeWidth:-10,breakDelay:.15,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:4,routeWidth:4,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_hb_dive",name:"HB Dive",category:"run",formation:"iform",tempo:"hurry",description:"Quick handoff up the middle",difficulty:1,tags:["run","short_yardage","safe"],routes:[{positionId:"rb",routeType:"streak",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!0},{positionId:"wr1",routeType:"block",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr2",routeType:"block",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"block",routeDepth:3,routeWidth:5,breakDelay:0,isPrimary:!1},{positionId:"te",routeType:"block",routeDepth:3,routeWidth:-5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:2,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"pb_stretch",name:"Outside Stretch",category:"run",formation:"singleback",tempo:"normal",description:"RB bounces it to the outside",difficulty:2,tags:["run","outside","rac"],routes:[{positionId:"rb",routeType:"flat",routeDepth:2,routeWidth:18,breakDelay:.1,isPrimary:!0},{positionId:"wr1",routeType:"block",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr2",routeType:"block",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"block",routeDepth:3,routeWidth:10,breakDelay:0,isPrimary:!1},{positionId:"te",routeType:"block",routeDepth:3,routeWidth:12,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:2,routeWidth:5,breakDelay:0,isPrimary:!1}]},{id:"pb_pa_deep",name:"Play Action Deep",category:"deep",formation:"iform",tempo:"slow",description:"Fake the run, hit the post",difficulty:3,tags:["play_action","deep","big_play"],unlockRequirement:{type:"touchdowns",value:3},routes:[{positionId:"wr1",routeType:"post",routeDepth:30,routeWidth:-10,breakDelay:.6,isPrimary:!0},{positionId:"wr2",routeType:"corner",routeDepth:25,routeWidth:14,breakDelay:.55,isPrimary:!1},{positionId:"wr3",routeType:"drag",routeDepth:8,routeWidth:-20,breakDelay:.3,isPrimary:!1},{positionId:"te",routeType:"streak",routeDepth:18,routeWidth:-4,breakDelay:.1,isPrimary:!1},{positionId:"rb",routeType:"block",routeDepth:1,routeWidth:0,breakDelay:.8,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]}],ft=[{id:"def_cover0",name:"Cover 0",type:"man",description:"Pure man, no deep safety. All-in.",blitzers:["dl1","dl2"],coverageDepths:{dl1:0,dl2:0,lb:0,cb1:0,cb2:0,ss:0,fs:0},strongAgainst:["run","short"],weakAgainst:["deep"],riskLevel:3},{id:"def_cover1",name:"Cover 1",type:"man",description:"Man coverage with a single high safety",blitzers:["dl1","dl2"],coverageDepths:{dl1:0,dl2:0,lb:5,cb1:0,cb2:0,ss:0,fs:25},strongAgainst:["short","run"],weakAgainst:["deep"],riskLevel:2},{id:"def_cover2",name:"Cover 2",type:"zone",description:"Two deep safeties, corners in flats",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:8,cb1:5,cb2:5,ss:20,fs:20},strongAgainst:["short","medium"],weakAgainst:["deep","run"],riskLevel:1},{id:"def_cover3",name:"Cover 3",type:"zone",description:"Three deep zones, four underneath",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:10,cb1:20,cb2:20,ss:8,fs:25},strongAgainst:["deep","medium"],weakAgainst:["short","run"],riskLevel:1},{id:"def_cover4",name:"Cover 4",type:"zone",description:"Four deep zones, prevent the big play",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:12,cb1:22,cb2:22,ss:22,fs:28},strongAgainst:["deep"],weakAgainst:["short","run"],riskLevel:1},{id:"def_tampa2",name:"Tampa 2",type:"zone",description:"Cover 2 shell with the LB dropping deep middle",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:18,cb1:5,cb2:5,ss:20,fs:20},strongAgainst:["medium","deep"],weakAgainst:["run","short"],riskLevel:1},{id:"def_zone_blitz",name:"Zone Blitz",type:"blitz",description:"Blitz from unexpected spots, drop a lineman into coverage",blitzers:["dl1","lb","ss"],coverageDepths:{dl1:0,dl2:8,lb:0,cb1:12,cb2:12,ss:0,fs:22},strongAgainst:["medium","short"],weakAgainst:["deep"],riskLevel:2},{id:"def_man_blitz",name:"Man Blitz",type:"blitz",description:"Man coverage with an extra rusher",blitzers:["dl1","dl2","lb","ss"],coverageDepths:{dl1:0,dl2:0,lb:0,cb1:0,cb2:0,ss:0,fs:18},strongAgainst:["short","run"],weakAgainst:["deep"],riskLevel:3},{id:"def_nickel",name:"Nickel",type:"zone",description:"Extra DB for passing downs, balanced coverage",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:7,cb1:10,cb2:10,ss:15,fs:22},strongAgainst:["medium","short"],weakAgainst:["run"],riskLevel:1},{id:"def_dime",name:"Dime",type:"zone",description:"Maximum pass coverage for obvious passing downs",blitzers:[],coverageDepths:{dl1:2,dl2:2,lb:12,cb1:14,cb2:14,ss:18,fs:25},strongAgainst:["deep","medium"],weakAgainst:["run","short"],riskLevel:1}];function mt(){return["shotgun","iform","trips","spread","singleback"].map(e=>{const t=xe.filter(o=>o.formation===e),i=[...new Set(t.map(o=>o.category))],s=t.length>0?t.reduce((o,n)=>o+n.difficulty,0)/t.length:0;return{formation:e,label:Q[e].name,playCount:t.length,categories:i,avgDifficulty:Math.round(s*10)/10,preview:Q[e].preview}})}mt();class _e{constructor(e=xe,t=ft){l(this,"offensivePlays");l(this,"defensivePlays");this.offensivePlays=e,this.defensivePlays=t}getFormation(e){return Q[e]}getPlaysForFormation(e){return this.offensivePlays.filter(t=>t.formation===e)}selectDefensivePlay(e){const t=this.defensivePlays.map(a=>({play:a,score:this.scoreDefensivePlay(a,e)}));t.sort((a,c)=>c.score-a.score);const i=t.slice(0,2),s=i.reduce((a,c)=>a+c.score,0);if(s<=0)return t[0].play;const o=Math.random()*s;let n=0;for(const a of i)if(n+=a.score,o<=n)return a.play;return t[0].play}getPlayRecommendations(e,t=4){const i=this.offensivePlays.map(s=>({play:s,score:this.scoreOffensivePlay(s,e)}));return i.sort((s,o)=>o.score-s.score),i.slice(0,t).map(s=>s.play)}scoreDefensivePlay(e,t){let i=10;const s=this.predictOffensiveCategory(t);return e.strongAgainst.includes(s)&&(i+=8),e.weakAgainst.includes(s)&&(i-=6),t.yardsToGo<=3&&(e.type==="blitz"&&(i+=5),e.type==="man"&&(i+=3)),t.yardsToGo>=15&&((e.id==="def_cover4"||e.id==="def_cover3")&&(i+=5),e.type==="blitz"&&(i-=3)),t.down===4&&e.type==="blitz"&&(i+=4),t.scoreDiff<0&&t.timeRemaining<120&&(i+=e.riskLevel*2),t.scoreDiff>0&&t.timeRemaining<120&&(e.id==="def_cover4"&&(i+=6),e.type==="blitz"&&(i-=4)),t.yardLine<=20&&e.type==="zone"&&(i+=2),Math.max(i,0)}scoreOffensivePlay(e,t){let i=10;const s=this.predictOffensiveCategory(t);return e.category===s&&(i+=10),t.yardsToGo<=3&&((e.category==="short"||e.category==="run")&&(i+=5),e.tags.includes("safe")&&(i+=3)),t.yardsToGo>=15&&(e.category==="deep"&&(i+=6),e.category==="medium"&&(i+=3),e.category==="run"&&(i-=4)),t.down===4&&t.yardsToGo<=3&&(e.tags.includes("safe")&&(i+=5),e.difficulty===1&&(i+=3)),t.scoreDiff<-7&&t.timeRemaining<180&&(e.category==="deep"&&(i+=6),e.tempo==="hurry"&&(i+=3)),t.scoreDiff>7&&t.timeRemaining<180&&(e.category==="run"&&(i+=8),e.tempo==="slow"&&(i+=3)),t.yardLine<=10&&((e.category==="short"||e.category==="run")&&(i+=4),e.category==="deep"&&(i-=4)),t.down<=2&&e.difficulty===3&&(i-=2),Math.max(i,0)}predictOffensiveCategory(e){return e.yardsToGo<=3?"run":e.yardsToGo>=15?"deep":e.yardsToGo>=7?"medium":"short"}}const Ie={id:"team_firebirds",name:"Blaze Firebirds",shortName:"FIRE",mascot:"Phoenix",description:"Rising from the flames with explosive offense and fiery determination.",primaryColor:"#BF5700",secondaryColor:"#FF6B35",accentColor:"#C9A227",helmetColor:"#BF5700",offense:8,defense:6,speed:8,power:7,specialAbility:{name:"Phoenix Rising",description:"Turbo regenerates 50% faster when behind",effect:"turbo_regen"}},yt={id:"team_wolves",name:"Shadow Wolves",shortName:"WOLF",mascot:"Wolf",description:"A relentless pack that hunts quarterbacks and terrorizes offenses.",primaryColor:"#1A1A1A",secondaryColor:"#4169E1",accentColor:"#C0C0C0",helmetColor:"#1A1A1A",offense:6,defense:9,speed:7,power:8,specialAbility:{name:"Pack Hunter",description:"Defenders converge 25% faster on ball carrier",effect:"pack_hunt"}},gt=[{id:"team_thunder",name:"Storm Thunder",shortName:"THDR",mascot:"Lightning Bolt",description:"Electrifying speed that strikes before you can react.",primaryColor:"#FFD700",secondaryColor:"#000080",accentColor:"#FFFFFF",helmetColor:"#FFD700",offense:9,defense:5,speed:10,power:5,specialAbility:{name:"Lightning Strike",description:"Big plays (20+ yards) give 2x bonus points",effect:"big_play_bonus"}},{id:"team_ironclad",name:"Iron Titans",shortName:"IRON",mascot:"Titan",description:"An unstoppable ground game built on raw power.",primaryColor:"#4A4A4A",secondaryColor:"#8B0000",accentColor:"#C0C0C0",helmetColor:"#4A4A4A",offense:7,defense:7,speed:5,power:10,specialAbility:{name:"Iron Will",description:"Cannot be tackled for loss on first contact",effect:"no_tfl"}},{id:"team_vipers",name:"Venom Vipers",shortName:"VIPE",mascot:"Viper",description:"Quick-strike offense that leaves opponents paralyzed.",primaryColor:"#228B22",secondaryColor:"#000000",accentColor:"#FFD700",helmetColor:"#228B22",offense:8,defense:8,speed:9,power:6,specialAbility:{name:"Venom Strike",description:"Stiff-arms have 100% success rate",effect:"super_stiff_arm"}}];function bt(){return[Ie,...gt]}const ge=[{id:"qb",name:"Quarterback",shortName:"QB",role:"offense",defaultX:-5,defaultZ:0},{id:"rb",name:"Running Back",shortName:"RB",role:"offense",defaultX:-7,defaultZ:0},{id:"wr1",name:"Wide Receiver 1",shortName:"WR",role:"offense",defaultX:0,defaultZ:20},{id:"wr2",name:"Wide Receiver 2",shortName:"WR",role:"offense",defaultX:0,defaultZ:-20},{id:"wr3",name:"Slot Receiver",shortName:"SL",role:"offense",defaultX:-1,defaultZ:8},{id:"te",name:"Tight End",shortName:"TE",role:"offense",defaultX:-1,defaultZ:-8},{id:"c",name:"Center",shortName:"C",role:"offense",defaultX:0,defaultZ:0}],Y=[{id:"dl1",name:"Defensive Line 1",shortName:"DL",role:"defense",defaultX:1,defaultZ:-3},{id:"dl2",name:"Defensive Line 2",shortName:"DL",role:"defense",defaultX:1,defaultZ:3},{id:"lb",name:"Linebacker",shortName:"LB",role:"defense",defaultX:4,defaultZ:0},{id:"cb1",name:"Cornerback 1",shortName:"CB",role:"defense",defaultX:2,defaultZ:18},{id:"cb2",name:"Cornerback 2",shortName:"CB",role:"defense",defaultX:2,defaultZ:-18},{id:"ss",name:"Strong Safety",shortName:"SS",role:"defense",defaultX:8,defaultZ:6},{id:"fs",name:"Free Safety",shortName:"FS",role:"defense",defaultX:12,defaultZ:0}],wt=[{id:"play_slants",name:"Quick Slants",category:"short",description:"Fast-breaking slant routes for quick gains",difficulty:1,routes:[{positionId:"wr1",routeType:"slant",routeDepth:8,routeWidth:-5,breakDelay:.2,isPrimary:!0},{positionId:"wr2",routeType:"slant",routeDepth:8,routeWidth:5,breakDelay:.2,isPrimary:!1},{positionId:"wr3",routeType:"flat",routeDepth:2,routeWidth:10,breakDelay:.1,isPrimary:!1},{positionId:"te",routeType:"drag",routeDepth:5,routeWidth:12,breakDelay:.3,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:3,routeWidth:-5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"play_screen",name:"Screen Pass",category:"short",description:"Dump it to the RB and let blockers lead the way",difficulty:2,routes:[{positionId:"rb",routeType:"flat",routeDepth:-2,routeWidth:12,breakDelay:.4,isPrimary:!0},{positionId:"wr1",routeType:"streak",routeDepth:20,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr2",routeType:"streak",routeDepth:20,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"block",routeDepth:5,routeWidth:8,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"block",routeDepth:5,routeWidth:5,breakDelay:.5,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:3,routeWidth:10,breakDelay:.3,isPrimary:!1}]},{id:"play_curls",name:"Curl Routes",category:"medium",description:"Receivers run and turn back for the ball",difficulty:1,routes:[{positionId:"wr1",routeType:"curl",routeDepth:12,routeWidth:0,breakDelay:.7,isPrimary:!0},{positionId:"wr2",routeType:"curl",routeDepth:12,routeWidth:0,breakDelay:.7,isPrimary:!1},{positionId:"wr3",routeType:"out",routeDepth:8,routeWidth:8,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"in",routeDepth:10,routeWidth:-10,breakDelay:.6,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:5,routeWidth:5,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"play_cross",name:"Crossers",category:"medium",description:"Crossing routes to create traffic for defenders",difficulty:2,routes:[{positionId:"wr1",routeType:"drag",routeDepth:8,routeWidth:-25,breakDelay:.3,isPrimary:!0},{positionId:"wr2",routeType:"drag",routeDepth:6,routeWidth:25,breakDelay:.2,isPrimary:!1},{positionId:"wr3",routeType:"post",routeDepth:15,routeWidth:-8,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"corner",routeDepth:12,routeWidth:12,breakDelay:.5,isPrimary:!1},{positionId:"rb",routeType:"wheel",routeDepth:10,routeWidth:15,breakDelay:.4,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"play_four_verts",name:"Four Verticals",category:"deep",description:"Stretch the defense deep with four go routes",difficulty:3,routes:[{positionId:"wr1",routeType:"streak",routeDepth:30,routeWidth:0,breakDelay:0,isPrimary:!0},{positionId:"wr2",routeType:"streak",routeDepth:30,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"wr3",routeType:"streak",routeDepth:25,routeWidth:5,breakDelay:0,isPrimary:!1},{positionId:"te",routeType:"streak",routeDepth:20,routeWidth:-5,breakDelay:0,isPrimary:!1},{positionId:"rb",routeType:"checkdown",routeDepth:5,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}]},{id:"play_bomb",name:"Hail Mary",category:"deep",description:"All receivers go deep - throw it up and pray",difficulty:3,routes:[{positionId:"wr1",routeType:"post",routeDepth:35,routeWidth:-10,breakDelay:.6,isPrimary:!0},{positionId:"wr2",routeType:"corner",routeDepth:30,routeWidth:15,breakDelay:.5,isPrimary:!1},{positionId:"wr3",routeType:"streak",routeDepth:35,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"te",routeType:"post",routeDepth:25,routeWidth:-5,breakDelay:.4,isPrimary:!1},{positionId:"rb",routeType:"streak",routeDepth:20,routeWidth:8,breakDelay:.3,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}],unlockRequirement:{type:"touchdowns",value:5}},{id:"play_trick",name:"Flea Flicker",category:"deep",description:"Hand off then get the ball back - big play potential",difficulty:3,routes:[{positionId:"wr1",routeType:"streak",routeDepth:35,routeWidth:0,breakDelay:0,isPrimary:!0},{positionId:"wr2",routeType:"post",routeDepth:30,routeWidth:-12,breakDelay:.6,isPrimary:!1},{positionId:"wr3",routeType:"corner",routeDepth:25,routeWidth:15,breakDelay:.5,isPrimary:!1},{positionId:"te",routeType:"streak",routeDepth:20,routeWidth:0,breakDelay:0,isPrimary:!1},{positionId:"rb",routeType:"block",routeDepth:2,routeWidth:0,breakDelay:.8,isPrimary:!1},{positionId:"c",routeType:"block",routeDepth:0,routeWidth:0,breakDelay:0,isPrimary:!1}],unlockRequirement:{type:"score",value:2e3}}];function be(){return wt}const we=16,vt=8,ve={1:"#39FF14",2:"#FF6EC7",3:"#00BFFF",4:"#FFD700",5:"#FF6B35"};class kt{constructor(e,t=null){l(this,"scene");l(this,"glowLayer");l(this,"ghostPool",[]);l(this,"trailPool",[]);l(this,"activeGhosts",0);l(this,"activeTrails",0);this.scene=e,this.glowLayer=t,this._initPool()}_initPool(){for(let e=0;e<we;e++){const t=v.CreateCapsule(`ghost_receiver_${e}`,{radius:.4,height:1.8},this.scene);t.isVisible=!1;const i=new x(`ghostMat_${e}`,this.scene);i.alpha=0,i.disableLighting=!0,t.material=i,this.glowLayer&&this.glowLayer.addIncludedOnlyMesh(t),this.ghostPool.push(t)}}placeGhost(e,t,i=1){if(this.activeGhosts>=we)return;const s=this.ghostPool[this.activeGhosts];s.position=e.clone(),s.position.y=1,s.isVisible=!0;const o=s.material,n=ve[i]??"#39FF14";o.diffuseColor=y.FromHexString(n),o.emissiveColor=y.FromHexString(n).scale(.4),o.alpha=Math.min(.5,t*.6),this.activeGhosts++}renderRoutePrediction(e,t,i,s=1){if(this.activeTrails>=vt)return;const o=12,n=[];for(let g=0;g<=o;g++){const b=g/o,T=Math.sin(b*Math.PI)*1.5,S=h.Lerp(e,t,b);S.y=1+T,(g%2===0||g===o)&&n.push(S)}if(n.length<2)return;const a=ve[s]??"#39FF14",c=y.FromHexString(a),d=Math.min(.6,i*.7),p=n.map(()=>new P(c.r,c.g,c.b,d)),f=v.CreateLines(`ghostRoute_${this.activeTrails}`,{points:n,colors:p,updatable:!1},this.scene);this.trailPool.push(f),this.activeTrails++}clear(){for(let e=0;e<this.activeGhosts;e++)this.ghostPool[e].isVisible=!1;this.activeGhosts=0;for(const e of this.trailPool)e.dispose();this.trailPool=[],this.activeTrails=0}dispose(){this.clear();for(const e of this.ghostPool)e.dispose();this.ghostPool=[]}}var Z=(r=>(r[r.QB=0]="QB",r[r.WR1=1]="WR1",r[r.WR2=2]="WR2",r[r.WR3=3]="WR3",r[r.TE=4]="TE",r[r.RB=5]="RB",r[r.DEFENDER=6]="DEFENDER",r[r.BALL=7]="BALL",r))(Z||{}),V=(r=>(r[r.HUDDLE=0]="HUDDLE",r[r.SET=1]="SET",r[r.SNAP=2]="SNAP",r[r.THROW=3]="THROW",r[r.RUN_ROUTE=4]="RUN_ROUTE",r[r.CATCH=5]="CATCH",r[r.TACKLE=6]="TACKLE",r[r.SCORE=7]="SCORE",r))(V||{});function St(r,e,t,i){return r&7|(e&7)<<3|(t&3)<<6|(i&15)<<8}function Tt(r){return{type:r&7,action:r>>3&7,stamina:r>>6&3,region:r>>8&15}}const Me=100;function Dt(r,e=Me){const t=Math.max(0,Math.min(e,r.z)),i=Math.min(7,Math.floor(t/e*8)),s=r.x>=0?1:0;return i*2+s}function Pt(r,e=Me){const t=Math.floor(r/2),i=r%2,s=(t+.5)/8*e,o=i===1?8:-8;return new h(o,1,s)}function Ct(r){return r>=75?3:r>=50?2:r>=25?1:0}function xt(r,e){const t=Dt(r.position,e),i=Ct(r.stamina??100);return St(r.type,r.action,i,t)}const _t={qb:0,wr1:1,wr2:2,wr3:3,te:4,rb:5};function ke(r){return _t[r]??6}class X{constructor(){l(this,"transitions",new Map);l(this,"totalObservations",0)}observe(e,t){if(e===null||t===null){this.totalObservations++;return}const i=this._inferAction(e,t);this.transitions.has(e)||this.transitions.set(e,new Map);const s=this.transitions.get(e);s.has(i)||s.set(i,new Map);const o=s.get(i);o.set(t,(o.get(t)??0)+1),this.totalObservations++}predict(e){const t=this.transitions.get(e);if(!t)return[{token:e,probability:.6,observations:0}];const i=new Map;let s=0;for(const n of t.values())for(const[a,c]of n)i.set(a,(i.get(a)??0)+c),s+=c;if(s===0)return[{token:e,probability:.6,observations:0}];const o=[];for(const[n,a]of i)o.push({token:n,probability:a/s,observations:a});return o.sort((n,a)=>a.probability-n.probability),o.slice(0,5)}anomalyScore(e,t){const s=this.predict(e).find(o=>o.token===t);return s?1-s.probability:1}serialize(){const e={};for(const[t,i]of this.transitions){e[t]={};for(const[s,o]of i)e[t][s]=Object.fromEntries(o)}return JSON.stringify({version:1,totalObservations:this.totalObservations,transitions:e})}static deserialize(e){const t=JSON.parse(e),i=new X;i.totalObservations=t.totalObservations??0;for(const[s,o]of Object.entries(t.transitions??{})){const n=parseInt(s,10),a=new Map;for(const[c,d]of Object.entries(o)){const p=parseInt(c,10),f=new Map(Object.entries(d).map(([g,b])=>[parseInt(g,10),b]));a.set(p,f)}i.transitions.set(n,a)}return i}_inferAction(e,t){if(e===t)return 0;const i=e>>8&15,s=t>>8&15;if(i!==s)return 1;const o=e>>6&3,n=t>>6&3;return n<o?3:n>o?4:2}}const Se=3,It=.65;class Mt{constructor(e,t=null){l(this,"scene");l(this,"ghostRenderer");l(this,"predictor");l(this,"playCount",0);l(this,"prevTokens",new Map);l(this,"onAnomaly",null);this.scene=e,this.ghostRenderer=new kt(e,t),this.predictor=new X}observeEntity(e){const t=xt(e),i=this.prevTokens.get(e.id)??null;if(i!==null){this.predictor.observe(i,t);const s=this.predictor.anomalyScore(i,t);s>It&&this.playCount>=Se&&this.onAnomaly?.(e.id,s)}else this.predictor.observe(null,t);this.prevTokens.set(e.id,t)}onPlayStart(){this.playCount++}onPlayEnd(){for(const[e,t]of this.prevTokens)this.predictor.observe(t,null);this.prevTokens.clear()}renderGhosts(e){if(this.ghostRenderer.clear(),!(this.playCount<Se))for(const[t,i]of this.prevTokens){const s=e.get(t);if(!s)continue;const o=s.type;if(o===Z.QB||o===Z.DEFENDER||o===Z.BALL)continue;const n=this.predictor.predict(i);let a=0;for(const c of n){if(c.probability<.1||a>=2)break;if(c.observations===0)continue;const d=Tt(c.token),p=Pt(d.region);this.ghostRenderer.placeGhost(p,c.probability,o),this.ghostRenderer.renderRoutePrediction(s.position,p,c.probability,o),a++}}}serialize(){return this.predictor.serialize()}restore(e){this.predictor=X.deserialize(e),this.playCount=Math.floor(this.predictor.totalObservations/10)}getStats(){return{playCount:this.playCount,totalObservations:this.predictor.totalObservations}}dispose(){this.ghostRenderer.dispose()}}const R={yardsGained:10,firstDown:100,bigPlay:200,touchdown:700,stiffArm:50,juke:75},W={blaze:{burntOrange:"#BF5700",gold:"#C9A227"},arcade:{neonGreen:"#39FF14",constructionYellow:"#FFD700"}};class te{constructor(e){l(this,"engine");l(this,"scene");l(this,"camera");l(this,"shadowGenerator",null);l(this,"glowLayer",null);l(this,"field",null);l(this,"ball",null);l(this,"playerController",null);l(this,"touchController",null);l(this,"defenderAIs",[]);l(this,"aiSystem");l(this,"scoreSystem");l(this,"offensivePlayers",new Map);l(this,"defensivePlayers",new Map);l(this,"qbMesh",null);l(this,"tackleParticles",null);l(this,"touchdownParticles",null);l(this,"turfSpray",null);l(this,"speedLines",null);l(this,"pipeline",null);l(this,"skyDome",null);l(this,"cameraShakeDuration",0);l(this,"cameraShakeTimeRemaining",0);l(this,"cameraShakeIntensity",0);l(this,"cameraBaseRotationOffset",180);l(this,"resizeHandler",null);l(this,"pendingTimeouts",new Set);l(this,"pendingIntervals",new Set);l(this,"audioManager",null);l(this,"genieSystem",null);l(this,"driveSystem");l(this,"playbookSystem");l(this,"gameState");l(this,"config");l(this,"gameStartTime",0);l(this,"isGameOver",!1);l(this,"GAME_DURATION_MS",9e4);l(this,"selectedPlay",null);l(this,"defensivePlay",null);l(this,"ballCarrierId",null);l(this,"playStartYardLine",0);this.config=e,this.engine=new qe(e.canvas,!0,{adaptToDeviceRatio:!0,powerPreference:"high-performance",antialias:!0,stencil:!0}),this.scene=new oe(this.engine),this.driveSystem=new pt({startingYardLine:20}),this.playbookSystem=new _e,this.aiSystem=new K,this.scoreSystem=new z({quarterLengthSec:90}),this.gameState={score:0,yardsGained:0,touchdowns:0,firstDowns:0,bigPlays:0,turnovers:0,turboYards:0,stiffArms:0,jukes:0,tacklesMade:0,down:1,yardsToGo:10,lineOfScrimmage:20,timeRemaining:this.GAME_DURATION_MS,phase:"pre_snap",currentPlay:null,longestPlay:0}}static async create(e){const t=new te(e);return await t.initialize(),t}async initialize(){this.setupCamera(),this.setupLighting(),this.createSkyDome(),this.setupPostProcessing(),this.createField(),this.createPlayers(),this.setupBall(),this.setupControls(),this.createVisualEffects(),this.setupAudio(),this.genieSystem=new Mt(this.scene,this.glowLayer),this.engine.runRenderLoop(()=>{this.update(),this.scene.render()}),this.resizeHandler=()=>this.engine.resize(),window.addEventListener("resize",this.resizeHandler)}setupAudio(){this.audioManager=new dt(this.scene,{masterVolume:.7,musicVolume:.4,sfxVolume:.8,ambientVolume:.3})}async unlockAudio(){await this.audioManager?.unlock(),this.audioManager?.startAmbientCrowd()}setupCamera(){this.camera=new He("camera",new h(0,20,-15),this.scene),this.camera.heightOffset=25,this.camera.radius=35,this.camera.rotationOffset=180,this.camera.cameraAcceleration=.1,this.camera.maxCameraSpeed=20,this.cameraBaseRotationOffset=this.camera.rotationOffset;const e=v.CreateBox("cameraTarget",{size:.1},this.scene);e.isVisible=!1,e.position=new h(0,0,20),this.camera.lockedTarget=e}setupLighting(){const e=new ne("mainLight",new h(-.5,-1,.5),this.scene);e.intensity=1.2,e.diffuse=y.White(),e.position=new h(50,80,-50),this.shadowGenerator=new Xe(2048,e),this.shadowGenerator.useBlurExponentialShadowMap=!0,this.shadowGenerator.blurScale=2;const t=new ae("ambient",new h(0,1,0),this.scene);t.intensity=.5,t.diffuse=new y(.9,.9,1),t.groundColor=new y(.2,.4,.2),this.scene.clearColor=new P(.05,.05,.1,1);const i=new ne("rimLight",new h(-30,40,60).normalize(),this.scene);i.intensity=.4,i.diffuse=y.FromHexString("#FFF5E0");const s=new ae("fieldGlow",new h(0,1,1),this.scene);s.intensity=.2,s.diffuse=y.FromHexString("#FFB870"),s.groundColor=new y(.1,.1,.12),this.scene.fogMode=oe.FOGMODE_EXP2,this.scene.fogDensity=8e-4,this.scene.fogColor=new y(.05,.05,.1)}createSkyDome(){const e=v.CreateSphere("skyDome",{diameter:500,segments:32},this.scene),t=new x("skyMat",this.scene);t.backFaceCulling=!1,t.disableLighting=!0;const i=new N("skyTexture",{width:512,height:512},this.scene,!0),s=i.getContext(),o=s.createLinearGradient(0,0,0,512);o.addColorStop(0,"#0B1020"),o.addColorStop(.5,"#141B2D"),o.addColorStop(1,"#1B2235"),s.fillStyle=o,s.fillRect(0,0,512,512);for(let n=0;n<120;n++){const a=Math.random()*512,c=Math.random()*256,d=Math.random()*1.5+.5;s.fillStyle=`rgba(255, 255, 255, ${Math.random()*.8})`,s.beginPath(),s.arc(a,c,d,0,Math.PI*2),s.fill()}i.update(),t.diffuseTexture=i,t.emissiveColor=new y(.4,.45,.6),e.material=t,e.isPickable=!1,this.skyDome=e}setupPostProcessing(){const e=new $e("pipeline",!0,this.scene,[this.camera]);e.bloomEnabled=!0,e.bloomThreshold=.8,e.bloomWeight=.3,e.bloomKernel=64,this.glowLayer=new je("glow",this.scene),this.glowLayer.intensity=.6,e.fxaaEnabled=!0,e.samples=4,e.chromaticAberrationEnabled=!0,e.chromaticAberration.aberrationAmount=.15,e.grainEnabled=!0,e.grain.intensity=3,e.grain.animated=!0,this.pipeline=e}createField(){this.field=new ce(this.scene,this.config.homeTeam,this.config.awayTeam),this.field.build()}createPlayers(){const e=this.config.homeTeam,t=this.config.awayTeam;ge.forEach(i=>{const s=this.createPlayerMesh(i.id,e,!0);this.offensivePlayers.set(i.id,s),i.id==="qb"&&(this.qbMesh=s)}),Y.forEach(i=>{const s=this.createPlayerMesh(i.id,t,!1);this.defensivePlayers.set(i.id,s);const o={id:i.id,position:s.position.clone(),velocity:h.Zero(),maxSpeed:12+t.speed/10*5,maxForce:20,mass:1,rotation:0},n=new st(o,{pursuitLookAhead:.4,coverageAggressiveness:t.defense/10});this.defenderAIs.push(n),this.aiSystem.addDefender(o)})}createPlayerMesh(e,t,i){const s=v.CreateCapsule(`player_${e}`,{radius:.5,height:2},this.scene),o=new x(`playerMat_${e}`,this.scene);o.diffuseColor=y.FromHexString(t.primaryColor),o.specularColor=y.FromHexString(t.secondaryColor),o.emissiveColor=y.FromHexString(t.primaryColor).scale(.3),s.material=o;const n=v.CreateSphere(`helmet_${e}`,{diameter:.6},this.scene);n.position.y=1.1,n.parent=s;const a=new I(`helmetMat_${e}`,this.scene);return a.albedoColor=y.FromHexString(t.helmetColor),a.metallic=.7,a.roughness=.25,n.material=a,this.shadowGenerator&&this.shadowGenerator.addShadowCaster(s),this.glowLayer&&(this.glowLayer.addExcludedMesh(s),this.glowLayer.addExcludedMesh(n)),s.position.y=1,s.position.x=i?-30:30,s}setupBall(){this.ball=new Je(this.scene,{catchRadius:2.5,bulletVelocity:50,touchVelocity:38}),this.ball.initialize()}setupControls(){this.playerController=new Qe(new h(0,0,this.gameState.lineOfScrimmage-5),{baseSpeed:15,turboMultiplier:1.5,accelerationTime:.2}),"ontouchstart"in window&&(this.touchController=new et(this.config.canvas))}createVisualEffects(){this.tackleParticles=new C("tackleParticles",100,this.scene),this.tackleParticles.particleTexture=new F("https://raw.githubusercontent.com/BabylonJS/Assets/master/textures/flare.png",this.scene),this.tackleParticles.emitter=h.Zero(),this.tackleParticles.minSize=.3,this.tackleParticles.maxSize=.8,this.tackleParticles.minLifeTime=.2,this.tackleParticles.maxLifeTime=.5,this.tackleParticles.emitRate=150,this.tackleParticles.blendMode=C.BLENDMODE_ADD,this.tackleParticles.gravity=new h(0,-10,0),this.tackleParticles.direction1=new h(-3,2,-3),this.tackleParticles.direction2=new h(3,5,3),this.tackleParticles.color1=y.FromHexString(W.arcade.neonGreen).toColor4(1),this.tackleParticles.color2=y.FromHexString(W.arcade.constructionYellow).toColor4(1),this.tackleParticles.colorDead=new P(0,1,0,0),this.touchdownParticles=new C("tdParticles",500,this.scene),this.touchdownParticles.particleTexture=new F("https://raw.githubusercontent.com/BabylonJS/Assets/master/textures/flare.png",this.scene),this.touchdownParticles.emitter=h.Zero(),this.touchdownParticles.minSize=.5,this.touchdownParticles.maxSize=1.5,this.touchdownParticles.minLifeTime=1,this.touchdownParticles.maxLifeTime=2,this.touchdownParticles.emitRate=200,this.touchdownParticles.blendMode=C.BLENDMODE_ADD,this.touchdownParticles.gravity=new h(0,-5,0),this.touchdownParticles.direction1=new h(-5,10,-5),this.touchdownParticles.direction2=new h(5,20,5),this.touchdownParticles.color1=y.FromHexString(W.blaze.burntOrange).toColor4(1),this.touchdownParticles.color2=y.FromHexString(W.blaze.gold).toColor4(1),this.touchdownParticles.colorDead=new P(1,.5,0,0),this.turfSpray=new C("turfSpray",30,this.scene),this.turfSpray.particleTexture=new F("https://raw.githubusercontent.com/BabylonJS/Assets/master/textures/flare.png",this.scene),this.turfSpray.emitter=h.Zero(),this.turfSpray.minSize=.03,this.turfSpray.maxSize=.07,this.turfSpray.minLifeTime=.1,this.turfSpray.maxLifeTime=.3,this.turfSpray.emitRate=80,this.turfSpray.blendMode=C.BLENDMODE_STANDARD,this.turfSpray.gravity=new h(0,-5,0),this.turfSpray.direction1=new h(-1,1,-1),this.turfSpray.direction2=new h(1,2,1),this.turfSpray.color1=new P(.4,.25,.1,.8),this.turfSpray.color2=new P(.3,.2,.08,.6),this.turfSpray.colorDead=new P(.2,.15,.05,0),this.speedLines=new C("speedLines",20,this.scene),this.speedLines.particleTexture=new F("https://raw.githubusercontent.com/BabylonJS/Assets/master/textures/flare.png",this.scene),this.speedLines.emitter=h.Zero(),this.speedLines.minSize=.05,this.speedLines.maxSize=.15,this.speedLines.minLifeTime=.05,this.speedLines.maxLifeTime=.15,this.speedLines.emitRate=60,this.speedLines.blendMode=C.BLENDMODE_ADD,this.speedLines.gravity=h.Zero(),this.speedLines.color1=new P(1,1,1,.6),this.speedLines.color2=new P(.9,.9,1,.4),this.speedLines.colorDead=new P(1,1,1,0)}startGame(){this.gameStartTime=performance.now(),this.isGameOver=!1,this.resetGameState(),this.setupNewPlay(),this.config.onGameStateChange(this.gameState),this.audioManager?.playSFX("game_start")}resetGameState(){this.driveSystem.reset(20),this.aiSystem.reset(),this.gameState={score:0,yardsGained:0,touchdowns:0,firstDowns:0,bigPlays:0,turnovers:0,turboYards:0,stiffArms:0,jukes:0,tacklesMade:0,down:1,yardsToGo:10,lineOfScrimmage:20,timeRemaining:this.GAME_DURATION_MS,phase:"pre_snap",currentPlay:null,longestPlay:0}}setupNewPlay(){this.gameState.phase="pre_snap";const e=this.driveSystem.getState();this.gameState.down=e.down,this.gameState.yardsToGo=e.yardsToGo,this.gameState.lineOfScrimmage=e.lineOfScrimmage,this.playStartYardLine=e.lineOfScrimmage;const t={down:e.down,yardsToGo:e.yardsToGo,yardLine:e.lineOfScrimmage,scoreDiff:0,timeRemaining:this.gameState.timeRemaining/1e3,quarter:1},i=this.playbookSystem.getPlayRecommendations(t,1);this.selectedPlay=i[0]??be()[0],this.gameState.currentPlay=this.selectedPlay,this.defensivePlay=this.playbookSystem.selectDefensivePlay(t),this.aiSystem.setLineOfScrimmage(e.lineOfScrimmage),this.aiSystem.setScheme(Pe.Cover3),this.positionPlayersForPlay();const s=this.qbMesh?.position||new h(0,0,this.gameState.lineOfScrimmage-5);this.ball?.giveTo("qb",s),this.ballCarrierId="qb",this.camera.lockedTarget&&this.qbMesh&&(this.camera.lockedTarget.position=this.qbMesh.position.clone());const o=setTimeout(()=>{this.pendingTimeouts.delete(o),this.gameState.phase==="pre_snap"&&!this.isGameOver&&this.snapBall()},1500);this.pendingTimeouts.add(o)}positionPlayersForPlay(){const e=this.gameState.lineOfScrimmage;ge.forEach(t=>{const i=this.offensivePlayers.get(t.id);i&&(i.position.x=t.defaultZ,i.position.z=e+t.defaultX,i.position.y=1)}),Y.forEach((t,i)=>{const s=this.defensivePlayers.get(t.id);s&&(s.position.x=t.defaultZ,s.position.z=e+t.defaultX,s.position.y=1,this.defenderAIs[i]&&this.defenderAIs[i].setPosition(s.position))}),this.playerController?.setPosition(new h(0,0,e-5))}snapBall(){this.gameState.phase="play_active",this.genieSystem?.onPlayStart(),this.audioManager?.playSFX("snap"),this.scoreSystem.startClock(),this.aiSystem.triggerReaction(.2),this.selectedPlay&&this.runRoutes(),this.config.onGameStateChange(this.gameState)}runRoutes(){this.selectedPlay&&this.selectedPlay.routes.forEach(e=>{const t=this.offensivePlayers.get(e.positionId);if(!t||e.routeType==="block"||e.positionId==="qb")return;const i=t.position.clone(),s=new h(i.x+e.routeWidth,1,i.z+e.routeDepth);this.animatePlayerToPosition(t,s,2e3)})}animatePlayerToPosition(e,t,i){const s=e.position.clone(),o=performance.now(),n=()=>{if(this.gameState.phase!=="play_active")return;const a=performance.now()-o,c=Math.min(1,a/i);e.position=h.Lerp(s,t,c);const d=t.subtract(s);e.rotation.y=Math.atan2(d.x,d.z),c<1&&requestAnimationFrame(n)};n()}update(){if(this.isGameOver)return;const e=this.engine.getDeltaTime()/1e3,t=Math.min(e,.1);if(this.gameState.phase==="play_active"&&(this.scoreSystem.tick(t),this.scoreSystem.getClock().timeRemainingSec<=0)){this.endGame("timeout");return}this.gameState.timeRemaining=this.scoreSystem.getClock().timeRemainingSec*1e3,this.gameState.phase==="play_active"&&this.updatePlayActive(t),this.config.onGameStateChange(this.gameState)}updatePlayActive(e){if(this.playerController?.update(e),this.ball?.update(e),this.ballCarrierId==="qb"&&this.qbMesh&&this.playerController){const c=this.playerController.getPosition();this.qbMesh.position=c,this.qbMesh.rotation.y=this.playerController.getRotation(),this.ball?.updateHeldPosition(c,this.playerController.getRotation()),this.camera.lockedTarget&&(this.camera.lockedTarget.position=c);const d=this.playerController.getVelocity().length(),p=34+Math.min(10,d*.6),f=24+Math.min(8,d*.4);let g=p,b=f;if(this.cameraShakeTimeRemaining>0){this.cameraShakeTimeRemaining=Math.max(0,this.cameraShakeTimeRemaining-e);const T=this.cameraShakeDuration>0?this.cameraShakeTimeRemaining/this.cameraShakeDuration:0,S=(Math.random()*2-1)*this.cameraShakeIntensity*T;g+=S*.6,b+=S*.4,this.camera.rotationOffset=this.cameraBaseRotationOffset+S}else this.camera.rotationOffset=this.cameraBaseRotationOffset;if(this.camera.radius=g,this.camera.heightOffset=b,this.playerController.isTurboOn()){const T=this.playerController.getVelocity(),S=T.length()*e;if(T.z>0&&(this.gameState.turboYards+=S),this.speedLines&&this.playerController){const se=this.playerController.getVelocity();this.speedLines.emitter=this.playerController.getPosition().clone(),this.speedLines.direction1=se.normalize().scale(-2),this.speedLines.direction2=se.normalize().scale(-3),this.speedLines.isStarted||this.speedLines.start()}}else this.speedLines?.stop()}const t=this.ballCarrierId?this.getBallCarrierPosition():null,i=this.playerController?.getVelocity()||null,s=this.ball?.getPosition()||null,o=new Map,n=new Map;if(this.offensivePlayers.forEach((c,d)=>{d!=="qb"&&d!=="c"&&(o.set(d,c.position.clone()),n.set(d,h.Zero()))}),this.playerController){const c=this.playerController.getRotation();this.aiSystem.setQBEyeDirection(new h(Math.sin(c),0,Math.cos(c)))}if(this.aiSystem.update(e,t,i,s,o,n),Y.forEach(c=>{const d=this.defensivePlayers.get(c.id),p=this.aiSystem.getAgent(c.id);d&&p&&(d.position.x=p.position.x,d.position.z=p.position.z,d.rotation.y=p.rotation,t&&h.Distance(p.position,t)<1.5&&this.handleTackle(p.position))}),this.glowLayer&&this.ballCarrierId){const c=this.ballCarrierId==="qb"?this.qbMesh:this.offensivePlayers.get(this.ballCarrierId);c&&this.glowLayer.addIncludedOnlyMesh(c)}if(this.genieSystem){this.offensivePlayers.forEach((d,p)=>{if(p==="c")return;const f=ke(p),g=p===this.ballCarrierId?V.CATCH:p==="qb"?V.SNAP:V.RUN_ROUTE;this.genieSystem.observeEntity({id:p,type:f,position:d.position.clone(),action:g,stamina:100})});const c=new Map;this.offensivePlayers.forEach((d,p)=>{c.set(p,{position:d.position.clone(),type:ke(p)})}),this.genieSystem.renderGhosts(c)}if(this.ballCarrierId==="qb"&&this.playerController?.isActionDown()){const c=this.playerController.getSelectedReceiver();c!==null&&this.attemptThrow(c)}(t?.z||0)>=m.length&&this.scoreTouchdown(),t&&!ce.isInBounds(t.x,t.z)&&this.endPlay(!1)}getBallCarrierPosition(){return this.ballCarrierId?this.ballCarrierId==="qb"?this.playerController?.getPosition()||null:this.offensivePlayers.get(this.ballCarrierId)?.position.clone()||null:null}attemptThrow(e){const i=["wr1","wr2","wr3","te","rb"][e];if(!i)return;const s=this.offensivePlayers.get(i);if(!s)return;const o=this.playerController?.getActionHoldTime()||0;let n="touch";o>.3?n="bullet":o<.1&&(n="lob");const a=5,c=s.position.clone();c.z+=a,this.ball?.throwTo(c,n,o),this.ballCarrierId=null,this.audioManager?.playSFX("pass_throw");const d=setTimeout(()=>{this.pendingTimeouts.delete(d),!(this.isGameOver||!this.ball)&&this.ball.isCatchable()&&(this.ball.attemptCatch(i,s.position,7)?(this.ballCarrierId=i,this.audioManager?.playSFX("catch"),this.camera.lockedTarget&&(this.camera.lockedTarget.position=s.position)):(this.audioManager?.playSFX("incomplete"),this.endPlay(!0)))},800);this.pendingTimeouts.add(d)}handleTackle(e){if(this.gameState.phase!=="play_active")return;if((this.playerController?.getVelocity()?.length()||0)>10?this.audioManager?.playSFX("tackle_big"):this.audioManager?.playSFX("tackle"),this.tackleParticles&&this.ballCarrierId){const i=this.getBallCarrierPosition();i&&(this.tackleParticles.emitter=i,this.tackleParticles.start(),setTimeout(()=>this.tackleParticles?.stop(),300))}this.gameState.tacklesMade++,this.triggerCameraShake(1.2,350),this.endPlay(!1)}scoreTouchdown(){this.gameState.touchdowns++,this.gameState.score+=R.touchdown,this.scoreSystem.scoreTouchdown("home"),this.field?.updateJumbotron(null,this.gameState.score,0),this.audioManager?.playSFX("touchdown"),this.audioManager?.setCrowdIntensity(3),this.triggerCameraShake(1.6,600);const e=this.getBallCarrierPosition()||new h(0,0,100);if(this.touchdownParticles){this.touchdownParticles.emitter=e,this.touchdownParticles.start();const n=setTimeout(()=>{this.pendingTimeouts.delete(n),this.touchdownParticles?.stop()},2e3);this.pendingTimeouts.add(n)}this.gameState.touchdowns>=3&&this.spawnMascot();const t=this.scene.lights,i=t.map(n=>n.intensity);let s=performance.now();const o=setInterval(()=>{const n=(performance.now()-s)/1e3;if(n>2){t.forEach((c,d)=>c.intensity=i[d]),clearInterval(o),this.pendingIntervals.delete(o);return}const a=1+.3*Math.sin(n*Math.PI*6);t.forEach((c,d)=>c.intensity=i[d]*a)},33);this.pendingIntervals.add(o),this.endGame("touchdown")}triggerCameraShake(e,t){this.cameraShakeIntensity=e,this.cameraShakeDuration=t/1e3,this.cameraShakeTimeRemaining=this.cameraShakeDuration}endPlay(e){this.gameState.phase="post_play",this.scoreSystem.stopClock(),this.genieSystem?.onPlayEnd(),this.playerController?.blowWhistle(),this.ball?.markDead(),this.audioManager?.playSFX("whistle"),this.audioManager?.setCrowdIntensity(.3);const t=this.getBallCarrierPosition()?.z||this.gameState.lineOfScrimmage,i=e?0:Math.max(0,t-this.playStartYardLine);this.scoreSystem.recordPassAttempt("home",!e,i,!1,!1);const s=this.driveSystem.processPlay(i,{isComplete:!e});i>0&&!e&&(this.gameState.yardsGained+=i,this.gameState.score+=Math.floor(i*R.yardsGained),s.bigPlay&&(this.gameState.bigPlays++,this.gameState.score+=R.bigPlay),i>this.gameState.longestPlay&&(this.gameState.longestPlay=i));const o=this.driveSystem.getState();if(this.gameState.lineOfScrimmage=o.lineOfScrimmage,this.gameState.down=o.down,this.gameState.yardsToGo=o.yardsToGo,s.isFirstDown&&(this.gameState.firstDowns++,this.gameState.score+=R.firstDown,this.audioManager?.playSFX("first_down")),s.isTurnover||this.driveSystem.isOver()){this.endGame("turnover");return}this.config.onGameStateChange(this.gameState),setTimeout(()=>{this.isGameOver||this.setupNewPlay()},1500)}endGame(e){if(this.isGameOver)return;this.isGameOver=!0,this.gameState.phase="game_over",this.audioManager?.stopAmbientCrowd(),e!=="touchdown"&&this.audioManager?.playSFX("game_over");const t={finalScore:this.gameState.score,yardsGained:this.gameState.yardsGained,touchdowns:this.gameState.touchdowns,firstDowns:this.gameState.firstDowns,bigPlays:this.gameState.bigPlays,turnovers:this.gameState.turnovers,tacklesMade:this.gameState.tacklesMade,stiffArms:this.gameState.stiffArms,jukes:this.gameState.jukes,turboYards:Math.floor(this.gameState.turboYards),longestPlay:this.gameState.longestPlay,result:e,durationSeconds:Math.floor((performance.now()-this.gameStartTime)/1e3),teamId:this.config.homeTeam.id};this.config.onGameOver(t),this.submitToLeaderboard(t)}async submitToLeaderboard(e){try{const t=this.config.homeTeam?.name||"Anonymous",i=await fetch("/api/mini-games/leaderboard/submit",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({gameId:"blitz",playerName:t,score:e.finalScore,metadata:{touchdowns:e.touchdowns,yardsGained:e.yardsGained,result:e.result}})});i.ok||console.warn("[Blitz] Leaderboard submit failed:",i.status)}catch{}}selectPlay(e){const i=be().find(s=>s.id===e);i&&(this.selectedPlay=i,this.gameState.currentPlay=i)}setSelectedPlay(e){this.selectedPlay=e,this.gameState.currentPlay=e}triggerSnap(){this.gameState.phase==="pre_snap"&&!this.isGameOver&&this.snapBall()}getGameState(){return{...this.gameState}}getScoreSystem(){return this.scoreSystem}performJuke(e){if(this.gameState.phase!=="play_active"||!this.ballCarrierId||!this.playerController)return;const t=8,i=this.playerController.getPosition(),s=e.normalize().scale(t*.15);this.playerController.setPosition(i.add(s)),this.gameState.jukes++,this.gameState.score+=R.juke,this.audioManager?.playSFX("juke"),this.turfSpray&&(this.turfSpray.emitter=this.playerController.getPosition().clone(),this.turfSpray.start(),setTimeout(()=>this.turfSpray?.stop(),200))}performSpin(){if(this.gameState.phase!=="play_active"||!this.ballCarrierId||!this.playerController)return;const e=this.playerController.getPosition(),t=this.playerController.getRotation(),i=new h(Math.sin(t),0,Math.cos(t));this.playerController.setPosition(e.add(i.scale(1.5))),this.gameState.score+=R.juke,this.audioManager?.playSFX("juke"),this.turfSpray&&(this.turfSpray.emitter=this.playerController.getPosition().clone(),this.turfSpray.start(),setTimeout(()=>this.turfSpray?.stop(),200))}performTruck(){this.gameState.phase!=="play_active"||!this.ballCarrierId||this.playerController&&(this.gameState.stiffArms++,this.gameState.score+=R.stiffArm,this.audioManager?.playSFX("stiff_arm"))}performDive(e){if(this.gameState.phase!=="play_active"||!this.ballCarrierId||!this.playerController)return;const t=this.playerController.getPosition(),i=e.length()>0?e.normalize():new h(0,0,1);this.playerController.setPosition(t.add(i.scale(3))),this.endPlay(!1)}callAudible(){if(this.gameState.phase!=="pre_snap")return;const e=this.driveSystem.getState(),t={down:e.down,yardsToGo:e.yardsToGo,yardLine:e.lineOfScrimmage,scoreDiff:0,timeRemaining:this.gameState.timeRemaining/1e3,quarter:1},i=this.playbookSystem.getPlayRecommendations(t,4),s=i.find(o=>o.name!==this.selectedPlay?.name)??i[0];s&&(this.setSelectedPlay(s),this.config.onPlayFeedback?.("AUDIBLE!","firstdown"))}setHotRoute(e,t){if(this.gameState.phase!=="pre_snap"||!this.selectedPlay)return;const s=["wr1","wr2","wr3","te","rb"][e];if(!s)return;const o=this.selectedPlay.routes.find(n=>n.positionId===s);o&&(o.routeType=t)}pumpFake(){this.gameState.phase!=="play_active"||this.ballCarrierId!=="qb"||(this.aiSystem.triggerReaction(.4),this.config.onPlayFeedback?.("PUMP FAKE","firstdown"))}throwAway(){if(this.gameState.phase!=="play_active"||this.ballCarrierId!=="qb")return;const e=this.playerController?.getPosition();if(e&&this.ball){const t=new h(e.x>0?m.width/2+5:-31.665,5,e.z+10);this.ball.throwTo(t,"bullet",0)}this.ballCarrierId=null,this.scoreSystem.stopClock(),this.scoreSystem.recordPassAttempt("home",!1,0,!1,!1),setTimeout(()=>this.endPlay(!0),600)}spawnMascot(){Ue.ImportMeshAsync("","/assets/","blaze_mascot.glb",this.scene).then(e=>{const t=e.meshes[0];t.scaling=new h(2,2,2);const i=(m.length+m.endZoneDepth*2)/2+5;t.position=new h(0,0,i);const s=-15,o=15;t.position.x=s;const n=performance.now(),a=3e3,c=setInterval(()=>{const d=performance.now()-n,p=Math.min(d/a,1);if(t.position.x=s+(o-s)*p,t.position.y=Math.abs(Math.sin(p*Math.PI*6))*1.5,p>=1){clearInterval(c),this.pendingIntervals.delete(c);const f=new C("mascotFireworks",500,this.scene);f.emitter=t.position.clone(),f.minSize=.1,f.maxSize=.4,f.minLifeTime=.5,f.maxLifeTime=2,f.emitRate=500,f.blendMode=C.BLENDMODE_ADD,f.direction1=new h(-5,8,-5),f.direction2=new h(5,15,5),f.gravity=new h(0,-9.8,0),f.color1=new P(1,.5,0,1),f.color2=new P(1,.84,0,1),f.colorDead=new P(1,.2,0,0),f.createPointEmitter(new h(-1,0,-1),new h(1,1,1)),f.targetStopDuration=2,f.disposeOnStop=!0,f.start();const g=setTimeout(()=>{this.pendingTimeouts.delete(g),t.dispose()},2500);this.pendingTimeouts.add(g)}},16);this.pendingIntervals.add(c)}).catch(e=>{console.warn("Failed to load mascot:",e)})}dispose(){this.isGameOver=!0;for(const e of this.pendingTimeouts)clearTimeout(e);this.pendingTimeouts.clear();for(const e of this.pendingIntervals)clearInterval(e);this.pendingIntervals.clear(),this.resizeHandler&&(window.removeEventListener("resize",this.resizeHandler),this.resizeHandler=null),this.camera?.lockedTarget&&this.camera.lockedTarget.dispose(),this.genieSystem?.dispose(),this.audioManager?.dispose(),this.field?.dispose(),this.ball?.dispose(),this.playerController?.dispose(),this.tackleParticles?.dispose(),this.touchdownParticles?.dispose(),this.turfSpray?.dispose(),this.speedLines?.dispose(),this.scene.dispose(),this.engine.dispose()}}const Re={moveUp:"KeyW",moveDown:"KeyS",moveLeft:"KeyA",moveRight:"KeyD",selectReceiver1:"Digit1",selectReceiver2:"Digit2",selectReceiver3:"Digit3",selectReceiver4:"Digit4",audible:"KeyA",pumpFake:"KeyR",throwAway:"Space",juke:"KeyJ",spin:"KeyK",truck:"KeyL",dive:"Space"},Ae={juke:.8,spin:1.2,truck:1.5},Rt={bindings:Re,cooldowns:Ae,swipeThreshold:40,touchEnabled:!0};class At{constructor(e,t){l(this,"phase","pre_snap");l(this,"config");l(this,"keysDown",new Set);l(this,"cooldowns",{juke:0,spin:0,truck:0});l(this,"moveDirection",h.Zero());l(this,"listeners",{});l(this,"globalListeners",[]);l(this,"touchStartX",0);l(this,"touchStartY",0);l(this,"touchStartTime",0);l(this,"handleKeyDown");l(this,"handleKeyUp");l(this,"handlePointerDown");l(this,"handlePointerUp");l(this,"handleContextMenu");this.canvas=e,this.config={...Rt,...t,bindings:{...Re,...t?.bindings},cooldowns:{...Ae,...t?.cooldowns}},this.handleKeyDown=this.onKeyDown.bind(this),this.handleKeyUp=this.onKeyUp.bind(this),this.handlePointerDown=this.onPointerDown.bind(this),this.handlePointerUp=this.onPointerUp.bind(this),this.handleContextMenu=i=>i.preventDefault(),this.attach()}setPhase(e){this.phase=e,this.keysDown.clear(),this.moveDirection.setAll(0)}getPhase(){return this.phase}on(e,t){const i=this.listeners[e]??(this.listeners[e]=[]);return i.push(t),()=>{const s=i.indexOf(t);s!==-1&&i.splice(s,1)}}onAny(e){return this.globalListeners.push(e),()=>{const t=this.globalListeners.indexOf(e);t!==-1&&this.globalListeners.splice(t,1)}}update(e){for(const t of["juke","spin","truck"])this.cooldowns[t]>0&&(this.cooldowns[t]=Math.max(0,this.cooldowns[t]-e));this.rebuildMoveDirection(),this.moveDirection.lengthSquared()>.001&&this.phase!=="pre_snap"&&this.emit("move",this.moveDirection.clone())}getMoveDirection(){return this.moveDirection.clone()}isOnCooldown(e){return this.cooldowns[e]>0}getCooldown(e){return this.cooldowns[e]}setBindings(e){Object.assign(this.config.bindings,e)}dispose(){this.detach(),this.listeners={},this.globalListeners=[]}attach(){window.addEventListener("keydown",this.handleKeyDown),window.addEventListener("keyup",this.handleKeyUp),this.canvas.addEventListener("pointerdown",this.handlePointerDown),this.canvas.addEventListener("pointerup",this.handlePointerUp),this.canvas.addEventListener("contextmenu",this.handleContextMenu)}detach(){window.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("keyup",this.handleKeyUp),this.canvas.removeEventListener("pointerdown",this.handlePointerDown),this.canvas.removeEventListener("pointerup",this.handlePointerUp),this.canvas.removeEventListener("contextmenu",this.handleContextMenu)}onKeyDown(e){if(e.repeat)return;this.keysDown.add(e.code);const t=this.config.bindings;switch(this.phase){case"pre_snap":this.handlePreSnapKey(e.code,t);break;case"pocket":this.handlePocketKey(e.code,t);break;case"scramble":this.handleScrambleKey(e.code,t);break;case"ball_carrier":this.handleBallCarrierKey(e.code,t);break}}onKeyUp(e){this.keysDown.delete(e.code)}handlePreSnapKey(e,t){if(e===t.selectReceiver1)return this.emit("select_receiver",h.Zero(),1);if(e===t.selectReceiver2)return this.emit("select_receiver",h.Zero(),2);if(e===t.selectReceiver3)return this.emit("select_receiver",h.Zero(),3);if(e===t.selectReceiver4)return this.emit("select_receiver",h.Zero(),4);if(e==="ArrowLeft")return this.emit("hot_route_out",h.Left());if(e==="ArrowRight")return this.emit("hot_route_in",h.Right());if(e==="ArrowUp")return this.emit("hot_route_streak",h.Forward());if(e==="ArrowDown")return this.emit("hot_route_curl",h.Backward());if(e===t.moveLeft&&e===t.audible)return this.emit("audible",h.Zero());if(e===t.audible)return this.emit("audible",h.Zero());if(e===t.moveLeft)return this.emit("hot_route_out",h.Left());if(e===t.moveRight)return this.emit("hot_route_in",h.Right());if(e===t.moveUp)return this.emit("hot_route_streak",h.Forward());if(e===t.moveDown)return this.emit("hot_route_curl",h.Backward())}handlePocketKey(e,t){if(e===t.pumpFake)return this.emit("pump_fake",h.Zero());if(e===t.throwAway)return this.emit("throw_away",h.Zero());if(e===t.selectReceiver1)return this.emit("select_receiver",h.Zero(),1);if(e===t.selectReceiver2)return this.emit("select_receiver",h.Zero(),2);if(e===t.selectReceiver3)return this.emit("select_receiver",h.Zero(),3);if(e===t.selectReceiver4)return this.emit("select_receiver",h.Zero(),4)}handleScrambleKey(e,t){if(e===t.pumpFake)return this.emit("pump_fake",h.Zero());if(e===t.throwAway)return this.emit("throw_away",h.Zero());if(e===t.selectReceiver1)return this.emit("select_receiver",h.Zero(),1);if(e===t.selectReceiver2)return this.emit("select_receiver",h.Zero(),2);if(e===t.selectReceiver3)return this.emit("select_receiver",h.Zero(),3);if(e===t.selectReceiver4)return this.emit("select_receiver",h.Zero(),4)}handleBallCarrierKey(e,t){if(e===t.juke)return this.trySpecialMove("juke");if(e===t.spin||e==="ShiftLeft"||e==="ShiftRight")return this.trySpecialMove("spin");if(e===t.truck||e==="ControlLeft"||e==="ControlRight")return this.trySpecialMove("truck");if(e===t.dive)return this.emit("dive",this.moveDirection.clone())}onPointerDown(e){if(this.touchStartX=e.clientX,this.touchStartY=e.clientY,this.touchStartTime=performance.now(),e.button===2){(this.phase==="pocket"||this.phase==="scramble")&&this.emit("pump_fake",h.Zero());return}e.button===0&&this.phase==="ball_carrier"&&this.trySpecialMove("juke")}onPointerUp(e){if(e.button!==0)return;const t=e.clientX-this.touchStartX,i=e.clientY-this.touchStartY,s=Math.sqrt(t*t+i*i),o=performance.now()-this.touchStartTime;if(this.config.touchEnabled&&s>this.config.swipeThreshold){this.handleSwipe(t,i);return}o<300&&s<10&&(this.phase==="pocket"||this.phase==="scramble")&&this.emit("throw",h.Zero())}handleSwipe(e,t){const i=Math.abs(e),s=Math.abs(t);let o;switch(i>s?o=e>0?h.Right():h.Left():o=t>0?h.Backward():h.Forward(),this.phase){case"pre_snap":i>s?this.emit(e>0?"hot_route_in":"hot_route_out",o):this.emit(t<0?"hot_route_streak":"hot_route_curl",o);break;case"ball_carrier":this.trySpecialMove("juke",o);break}}rebuildMoveDirection(){const e=this.config.bindings;let t=0,i=0;(this.keysDown.has(e.moveLeft)||this.keysDown.has("ArrowLeft"))&&(t-=1),(this.keysDown.has(e.moveRight)||this.keysDown.has("ArrowRight"))&&(t+=1),(this.keysDown.has(e.moveUp)||this.keysDown.has("ArrowUp"))&&(i+=1),(this.keysDown.has(e.moveDown)||this.keysDown.has("ArrowDown"))&&(i-=1),this.moveDirection.set(t,0,i),this.moveDirection.lengthSquared()>1&&this.moveDirection.normalize()}trySpecialMove(e,t){if(this.cooldowns[e]>0)return;this.cooldowns[e]=this.config.cooldowns[e];const i=t??this.moveDirection.clone();this.emit(e,i)}emit(e,t,i){const s={action:e,phase:this.phase,direction:t,receiverIndex:i,timestamp:performance.now()},o=this.listeners[e];if(o)for(let n=0;n<o.length;n++)o[n](s);for(let n=0;n<this.globalListeners.length;n++)this.globalListeners[n](s)}}function Ee(){let r=localStorage.getItem("blitz_player_id");return r||(r=`player_${Date.now()}_${Math.random().toString(36).substring(2,9)}`,localStorage.setItem("blitz_player_id",r)),r}function ie(){return parseInt(localStorage.getItem("blitz_high_score")||"0",10)}function Et(r){const e=ie();r>e&&localStorage.setItem("blitz_high_score",r.toString())}function Le(){return localStorage.getItem("blitz_player_name")||""}function Lt(r){localStorage.setItem("blitz_player_name",r)}let D=null;const u={loadingScreen:document.getElementById("loadingScreen"),menuScreen:document.getElementById("menuScreen"),renderCanvas:document.getElementById("renderCanvas"),gameUI:document.getElementById("gameUI"),driveInfo:document.getElementById("driveInfo"),staminaBar:document.getElementById("staminaBar"),gameOverScreen:document.getElementById("gameOverScreen"),highScore:document.getElementById("highScore"),teamSelect:document.getElementById("teamSelect"),playButton:document.getElementById("playButton"),score:document.getElementById("score"),timer:document.getElementById("timer"),down:document.getElementById("down"),yards:document.getElementById("yards"),driveText:document.getElementById("driveText"),staminaFill:document.getElementById("staminaFill"),playFeedback:document.getElementById("playFeedback"),gameOverResult:document.getElementById("gameOverResult"),finalScore:document.getElementById("finalScore"),gameStats:document.getElementById("gameStats"),leaderboard:document.getElementById("leaderboard"),playAgainButton:document.getElementById("playAgainButton"),menuButton:document.getElementById("menuButton"),playerNameInput:document.getElementById("playerNameInput"),saveNameBtn:document.getElementById("saveNameBtn"),shareXBtn:document.getElementById("shareXBtn"),copyLinkBtn:document.getElementById("copyLinkBtn"),playClock:document.getElementById("playClock"),playClockText:document.getElementById("playClockText"),scoreTicker:document.getElementById("scoreTicker"),homeTeamName:document.getElementById("homeTeamName"),homeTeamScore:document.getElementById("homeTeamScore"),awayTeamScore:document.getElementById("awayTeamScore"),awayTeamName:document.getElementById("awayTeamName"),quarterDisplay:document.getElementById("quarterDisplay"),playCallOverlay:document.getElementById("playCallOverlay"),formationPicker:document.getElementById("formationPicker"),playPicker:document.getElementById("playPicker"),moveIndicators:document.getElementById("moveIndicators"),jukeReady:document.getElementById("jukeReady"),spinReady:document.getElementById("spinReady"),truckReady:document.getElementById("truckReady")};let k=null,$=Ie,E="",J=null;const Be=new _e;let w=null,ee=null,M=null,O="shotgun",q=null,B=25;function Fe(){const r=u.formationPicker;for(;r.firstChild;)r.removeChild(r.firstChild);const e=[{id:"shotgun",label:"Shotgun"},{id:"iform",label:"I-Form"},{id:"trips",label:"Trips"},{id:"spread",label:"Spread"},{id:"singleback",label:"Singleback"}];for(const t of e){const i=document.createElement("button");i.textContent=t.label,i.style.cssText=`font-family:'Russo One',sans-serif;font-size:0.75rem;padding:0.375rem 0.75rem;border:2px solid ${t.id===O?"var(--arcade-neon-green)":"rgba(255,255,255,0.2)"};background:${t.id===O?"rgba(57,255,20,0.15)":"rgba(255,255,255,0.05)"};color:${t.id===O?"var(--arcade-neon-green)":"rgba(255,255,255,0.6)"};cursor:pointer;text-transform:uppercase;letter-spacing:0.05em;transition:all 0.15s;`,i.addEventListener("click",()=>{O=t.id,Fe(),Oe()}),r.appendChild(i)}}function Oe(){const r=u.playPicker;for(;r.firstChild;)r.removeChild(r.firstChild);const e=Be.getPlaysForFormation(O);for(const t of e){const i=document.createElement("button");i.style.cssText="display:flex;flex-direction:column;align-items:center;padding:0.5rem 0.75rem;border:2px solid rgba(255,255,255,0.15);background:rgba(255,255,255,0.05);cursor:pointer;transition:all 0.15s;min-width:90px;";const s=document.createElement("span");s.textContent=t.name,s.style.cssText="font-family:'Russo One',sans-serif;font-size:0.6875rem;color:var(--arcade-yellow);text-transform:uppercase;";const o=document.createElement("span");o.textContent=t.description??"",o.style.cssText="font-size:0.5rem;color:rgba(255,255,255,0.35);margin-top:2px;",i.appendChild(s),i.appendChild(o),i.addEventListener("mouseenter",()=>{i.style.borderColor="var(--arcade-yellow)",i.style.background="rgba(255,215,0,0.1)"}),i.addEventListener("mouseleave",()=>{i.style.borderColor="rgba(255,255,255,0.15)",i.style.background="rgba(255,255,255,0.05)"}),i.addEventListener("click",()=>{ze(t)}),r.appendChild(i)}}function ze(r){u.playCallOverlay.style.display="none",k&&(k.setSelectedPlay(r),k.triggerSnap()),j()}function Bt(){Fe(),Oe(),u.playCallOverlay.style.display="flex",Ft()}function Ge(){u.playCallOverlay.style.display="none",j()}function Ft(){B=25,u.playClockText.textContent="25",u.playClock.style.display="block",j(),q=window.setInterval(()=>{if(B--,u.playClockText.textContent=String(B),B<=5&&(u.playClockText.style.color="var(--arcade-hot-pink)"),B<=0){j();const r={down:1,yardsToGo:10,yardLine:75,scoreDiff:0,timeRemaining:120,quarter:1},e=Be.getPlayRecommendations(r,1);e.length>0&&ze(e[0])}},1e3)}function j(){q!==null&&(clearInterval(q),q=null),u.playClockText.style.color="var(--arcade-yellow)"}async function Ot(){u.highScore.textContent=ie().toLocaleString(),zt(),Gt(),u.loadingScreen.style.display="none",u.menuScreen.style.display="flex";const r=document.createElement("a");r.href="/mini-games",r.textContent=" Back to Arcade",r.style.cssText="position:fixed;top:8px;left:12px;color:#888;font-size:12px;text-decoration:none;z-index:9999;font-family:sans-serif;",r.addEventListener("mouseenter",()=>{r.style.color="#bf5700"}),r.addEventListener("mouseleave",()=>{r.style.color="#888"}),document.body.appendChild(r)}function zt(){bt().forEach((e,t)=>{const i=document.createElement("div");i.className="team-card"+(t===0?" selected":""),i.dataset.teamId=e.id,i.innerHTML=`
      <div class="team-logo" style="background-color: ${e.primaryColor}; box-shadow: 0 0 15px ${e.primaryColor};">
        ${e.shortName.charAt(0)}
      </div>
      <div class="team-name" style="color: ${e.primaryColor};">${e.name}</div>
      <div class="team-stats">
        <span>OFF ${e.offense}</span>
        <span>DEF ${e.defense}</span>
        <span>SPD ${e.speed}</span>
      </div>
    `,i.addEventListener("click",()=>{document.querySelectorAll(".team-card").forEach(s=>s.classList.remove("selected")),i.classList.add("selected"),$=e}),u.teamSelect.appendChild(i)})}function Gt(){u.playButton.addEventListener("click",Te),u.playAgainButton.addEventListener("click",Te),u.menuButton.addEventListener("click",Ht),u.saveNameBtn.addEventListener("click",Wt),u.copyLinkBtn.addEventListener("click",Nt);const r=Le();r&&(u.playerNameInput.value=r)}async function Wt(){const r=u.playerNameInput.value.trim();if(r){Lt(r);try{u.saveNameBtn.textContent="Saving...",u.saveNameBtn.setAttribute("disabled","true"),await fetch("/api/blitz/submit-score",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerId:Ee(),playerName:r,score:D?.finalScore||0,teamId:D?.teamId||$.id,stats:{yardsGained:D?.yardsGained||0,touchdowns:D?.touchdowns||0,firstDowns:D?.firstDowns||0,bigPlays:D?.bigPlays||0,turnovers:D?.turnovers||0,tacklesMade:D?.tacklesMade||0,stiffArms:D?.stiffArms||0,jukes:D?.jukes||0,turboYards:D?.turboYards||0,longestPlay:D?.longestPlay||0,durationSeconds:D?.durationSeconds||0,result:D?.result||"incomplete"}})}),u.saveNameBtn.textContent="Saved!";const e=await fetch("/api/blitz/leaderboard?limit=5");if(e.ok){const t=await e.json();if(t.success&&t.entries){const i=u.leaderboard;i.textContent="";const s=document.createElement("div");s.className="leaderboard-title",s.textContent="Top Scores",i.appendChild(s);for(const o of t.entries){const n=document.createElement("div");n.className="leaderboard-entry";const a=document.createElement("span");a.className="rank",a.textContent=`#${o.rank}`;const c=document.createElement("span");c.className="player",c.textContent=o.playerName||"Anonymous";const d=document.createElement("span");d.className="lb-score",d.textContent=o.score.toLocaleString(),n.appendChild(a),n.appendChild(c),n.appendChild(d),i.appendChild(n)}}}}catch(e){console.error("Failed to save name:",e),u.saveNameBtn.textContent="Error"}finally{setTimeout(()=>{u.saveNameBtn.textContent="Save Name",u.saveNameBtn.removeAttribute("disabled")},2e3)}}}function Nt(){const e=`https://blaze-blitz-football.pages.dev?ref=share&score=${D?.finalScore||0}`;navigator.clipboard.writeText(e).then(()=>{u.copyLinkBtn.classList.add("copied"),u.copyLinkBtn.innerHTML="<span></span> Copied!",setTimeout(()=>{u.copyLinkBtn.classList.remove("copied"),u.copyLinkBtn.innerHTML="<span></span> Copy Link"},2e3)}).catch(()=>{const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t),u.copyLinkBtn.classList.add("copied"),u.copyLinkBtn.innerHTML="<span></span> Copied!",setTimeout(()=>{u.copyLinkBtn.classList.remove("copied"),u.copyLinkBtn.innerHTML="<span></span> Copy Link"},2e3)})}async function Te(){u.menuScreen.style.display="none",u.gameOverScreen.style.display="none",u.renderCanvas.style.display="block",u.gameUI.style.display="flex",u.driveInfo.style.display="block",u.staminaBar.style.display="block",u.scoreTicker.style.display="block",u.moveIndicators.style.display="flex",u.homeTeamName.textContent=$.shortName,u.awayTeamName.textContent="WOLVES",u.homeTeamScore.textContent="0",u.awayTeamScore.textContent="0",u.quarterDisplay.textContent="Q1",w&&(w.dispose(),w=null),M!==null&&(cancelAnimationFrame(M),M=null),ee=new z({quarterLengthSec:90,playClockSec:25}),k&&k.dispose(),k=await te.create({canvas:u.renderCanvas,homeTeam:$,awayTeam:yt,onGameStateChange:Zt,onGameOver:Vt,onPlayFeedback:(t,i)=>H(t,`feedback-${i}`)}),await k.unlockAudio(),k.startGame(),w=new At(u.renderCanvas),w.setPhase("pre_snap"),w.on("juke",t=>k?.performJuke(t.direction)),w.on("spin",()=>k?.performSpin()),w.on("truck",()=>k?.performTruck()),w.on("dive",t=>k?.performDive(t.direction)),w.on("audible",()=>k?.callAudible()),w.on("pump_fake",()=>k?.pumpFake()),w.on("throw_away",()=>k?.throwAway()),w.on("hot_route_out",t=>k?.setHotRoute(t.receiverIndex??0,"out")),w.on("hot_route_in",t=>k?.setHotRoute(t.receiverIndex??0,"in")),w.on("hot_route_streak",t=>k?.setHotRoute(t.receiverIndex??0,"streak")),w.on("hot_route_curl",t=>k?.setHotRoute(t.receiverIndex??0,"curl"));let r=performance.now();const e=()=>{const t=performance.now(),i=(t-r)/1e3;r=t,w&&(w.update(i),u.jukeReady.style.opacity=w.isOnCooldown("juke")?"0.3":"1",u.spinReady.style.opacity=w.isOnCooldown("spin")?"0.3":"1",u.truckReady.style.opacity=w.isOnCooldown("truck")?"0.3":"1"),M=requestAnimationFrame(e)};M=requestAnimationFrame(e)}function Zt(r){u.score.textContent=r.score.toLocaleString();const e=Math.ceil(r.timeRemaining/1e3);u.timer.textContent=e.toString(),u.timer.classList.toggle("timer-warning",e<=10);const t=["1st","2nd","3rd","4th"][r.down-1]||"4th";u.down.textContent=t,u.yards.textContent=r.yardsGained.toString();const i=r.lineOfScrimmage,s=i<=50?"OWN":"OPP",o=i<=50?i:100-i;if(u.driveText.textContent=`${t} & ${r.yardsToGo} at ${s} ${o}`,u.homeTeamScore.textContent=r.score.toString(),ee){const n=ee.getClock();u.quarterDisplay.textContent=n.isOvertime?"OT":`Q${n.quarter}`}w&&(r.phase==="pre_snap"?w.setPhase("pre_snap"):r.phase==="play_active"&&w.setPhase("pocket")),r.phase==="pre_snap"?Bt():Ge(),r.phase==="play_active"?u.moveIndicators.style.display="flex":u.moveIndicators.style.display="none",r.touchdowns>0&&E!=="touchdown"?(H("TOUCHDOWN!","feedback-touchdown"),E="touchdown"):r.firstDowns>0&&r.down===1&&E!=="firstdown"?(H("FIRST DOWN!","feedback-firstdown"),E="firstdown"):r.bigPlays>0&&E!=="bigplay"&&(H("BIG PLAY!","feedback-bigplay"),E="bigplay")}function H(r,e){J&&clearTimeout(J),u.playFeedback.textContent=r,u.playFeedback.className=`show ${e}`,J=window.setTimeout(()=>{u.playFeedback.classList.remove("show")},1500)}async function Vt(r){D=r,u.gameUI.style.display="none",u.driveInfo.style.display="none",u.staminaBar.style.display="none",u.renderCanvas.style.display="none",u.scoreTicker.style.display="none",u.playClock.style.display="none",u.moveIndicators.style.display="none",Ge(),w&&(w.dispose(),w=null),M!==null&&(cancelAnimationFrame(M),M=null),Et(r.finalScore),u.highScore.textContent=ie().toLocaleString();const e={touchdown:"TOUCHDOWN!",turnover:"TURNOVER ON DOWNS",timeout:"TIME EXPIRED",incomplete:"DRIVE ENDED"}[r.result];u.gameOverResult.textContent=e,u.finalScore.textContent=r.finalScore.toLocaleString();const i=k?.getScoreSystem()?.getStats("home"),s=i?.passing.passerRating??0,o=i&&i.passing.attempts>0?Math.round(i.passing.completions/i.passing.attempts*100):0,n=u.gameStats;n.textContent="";const a=[["Total Yards",String(r.yardsGained)],["Touchdowns",String(r.touchdowns)],["First Downs",String(r.firstDowns)],["Completion %",`${o}%`],["Passer Rating",s.toFixed(1)],["Big Plays (20+ yds)",String(r.bigPlays)],["Longest Play",`${r.longestPlay} yds`],["Turbo Yards",String(r.turboYards)],["Duration",`${r.durationSeconds}s`]];for(const[f,g]of a){const b=document.createElement("div");b.className="stat-row";const T=document.createElement("span");T.className="label",T.textContent=f;const S=document.createElement("span");S.className="value",S.textContent=g,b.appendChild(T),b.appendChild(S),n.appendChild(b)}const c=`Just scored ${r.finalScore.toLocaleString()} points in Blaze Blitz!  ${r.touchdowns} TDs, ${r.yardsGained} yards. Can you beat my score?`,d="https://blazesportsintel.com/games/blitz/";u.shareXBtn.href=`https://twitter.com/intent/tweet?text=${encodeURIComponent(c)}&url=${encodeURIComponent(d)}`;const p=Le();p&&(u.playerNameInput.value=p),u.gameOverScreen.style.display="flex",E="",qt(r).catch(()=>{})}async function qt(r){try{const e=await fetch("/api/blitz/submit-score",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({playerId:Ee(),score:r.finalScore,teamId:r.teamId,stats:{yardsGained:r.yardsGained,touchdowns:r.touchdowns,firstDowns:r.firstDowns,bigPlays:r.bigPlays,turnovers:r.turnovers,tacklesMade:r.tacklesMade,stiffArms:r.stiffArms,jukes:r.jukes,turboYards:r.turboYards,longestPlay:r.longestPlay,durationSeconds:r.durationSeconds,result:r.result}})});if(e.ok){const t=await e.json();t.success&&t.data?.isHighScore&&(u.gameOverResult.textContent+=" NEW HIGH SCORE!")}}catch{}try{const e=await fetch("/api/blitz/leaderboard?limit=5");if(!e.ok)return;const t=await e.json();if(t.success&&t.entries){const i=u.leaderboard;i.textContent="";const s=document.createElement("div");s.className="leaderboard-title",s.textContent="Top Scores",i.appendChild(s);for(const o of t.entries){const n=document.createElement("div");n.className="leaderboard-entry";const a=document.createElement("span");a.className="rank",a.textContent=`#${o.rank}`;const c=document.createElement("span");c.className="player",c.textContent=o.playerName||"Anonymous";const d=document.createElement("span");d.className="lb-score",d.textContent=o.score.toLocaleString(),n.appendChild(a),n.appendChild(c),n.appendChild(d),i.appendChild(n)}}}catch{}}function Ht(){k&&(k.dispose(),k=null),u.gameOverScreen.style.display="none",u.menuScreen.style.display="flex"}Ot().catch(console.error);
//# sourceMappingURL=index-CyDSLlA9.js.map
