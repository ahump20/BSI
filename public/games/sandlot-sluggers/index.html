<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>Sandlot Sluggers | BSI Arcade</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0D0D12;overflow:hidden;touch-action:none;font-family:'Inter',system-ui,sans-serif}
canvas{display:block;margin:0 auto}
#menu{position:absolute;top:0;left:0;width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(13,13,18,0.95);z-index:10}
#menu h1{font-size:clamp(28px,6vw,48px);color:#BF5700;text-transform:uppercase;letter-spacing:3px;margin-bottom:8px}
#menu p{color:rgba(255,255,255,0.5);font-size:14px;margin-bottom:24px}
#menu .controls{color:rgba(255,255,255,0.35);font-size:12px;margin-bottom:20px;text-align:center;line-height:1.8}
.btn{background:#BF5700;color:#fff;border:none;padding:14px 40px;font-size:16px;font-weight:800;text-transform:uppercase;letter-spacing:2px;border-radius:10px;cursor:pointer}
.btn:hover{background:#d46300}
#gameover{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;align-items:center;justify-content:center;background:rgba(13,13,18,0.95);z-index:10}
#gameover h2{font-size:36px;color:#BF5700;margin-bottom:8px;text-transform:uppercase}
#gameover .final{font-size:64px;font-weight:900;color:#fff;margin-bottom:4px}
#gameover .sub{color:rgba(255,255,255,0.4);font-size:14px;margin-bottom:24px}
#hit-flash{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;opacity:0;z-index:5;transition:opacity 0.15s}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hit-flash"></div>
<div id="menu">
  <h1>Sandlot Sluggers</h1>
  <p>Timing-Based Baseball</p>
  <div class="controls">SPACE / Tap = Swing<br>Time it perfectly for home runs. Build streaks for multipliers.<br>Watch for pitch type indicators!</div>
  <button class="btn" onclick="startGame()">Play Ball</button>
</div>
<div id="gameover">
  <h2>Game Over</h2>
  <div class="final" id="finalScore">0</div>
  <div class="sub" id="finalHits">0 Hits</div>
  <button class="btn" onclick="startGame()">Play Again</button>
</div>
<script>
const canvas=document.getElementById('c'),ctx=canvas.getContext('2d');
let W,H;
function resize(){W=canvas.width=Math.min(window.innerWidth,800);H=canvas.height=Math.min(window.innerHeight,600);}
window.addEventListener('resize',resize);resize();

let state='menu',score=0,timeLeft=60,streak=0,hits=0,totalSwings=0,homeRuns=0;
let pitch={active:false,x:0,y:0,speed:0,type:'fastball',shadow:0};
let swinging=false,swingFrame=0,result='',resultTimer=0,resultColor='';
let particles=[],floatingTexts=[],ballFlight=null,crowdNoise=0;
let outfielders=[],screenShake=0;

const PLATE_X=()=>W/2,PLATE_Y=()=>H*0.78,MOUND_Y=()=>H*0.32;
const PITCH_TYPES=[
  {name:'fastball',speed:340,color:'#ff4444',curve:0,label:'FB'},
  {name:'curve',speed:240,color:'#60a5fa',curve:80,label:'CB'},
  {name:'slider',speed:280,color:'#a78bfa',curve:50,label:'SL'},
  {name:'change',speed:200,color:'#4ade80',curve:0,label:'CH'}
];

function startGame(){
  score=0;timeLeft=60;streak=0;hits=0;totalSwings=0;homeRuns=0;
  state='play';result='';resultTimer=0;particles=[];floatingTexts=[];ballFlight=null;screenShake=0;crowdNoise=0;
  outfielders=[{x:W*0.2,y:H*0.2},{x:W*0.4,y:H*0.15},{x:W*0.6,y:H*0.15},{x:W*0.8,y:H*0.2}];
  document.getElementById('menu').style.display='none';
  document.getElementById('gameover').style.display='none';
  throwPitch();
  if(!window._loop){window._loop=true;requestAnimationFrame(loop);}
}

function throwPitch(){
  const type=PITCH_TYPES[Math.floor(Math.random()*PITCH_TYPES.length)];
  const wobble=(Math.random()-0.5)*30;
  pitch={active:true,x:W/2+wobble,y:MOUND_Y(),speed:type.speed,type:type.name,
    curve:(Math.random()>0.5?1:-1)*type.curve,color:type.color,label:type.label,shadow:0};
  swinging=false;swingFrame=0;ballFlight=null;
}

let lastT=0,timerAcc=0;
function loop(ts){
  const dt=Math.min((ts-lastT)/1000,0.05);lastT=ts;
  if(state==='play'){timerAcc+=dt;if(timerAcc>=1){timerAcc-=1;timeLeft--;if(timeLeft<=0)endGame();}}
  update(dt);draw();
  requestAnimationFrame(loop);
}

function update(dt){
  if(screenShake>0)screenShake-=dt*6;
  crowdNoise=Math.max(0,crowdNoise-dt*0.5);
  if(pitch.active){
    pitch.y+=pitch.speed*dt;
    pitch.x+=pitch.curve*dt*0.8;
    pitch.shadow=Math.min(1,(pitch.y-MOUND_Y())/(PLATE_Y()-MOUND_Y()));
    if(pitch.y>PLATE_Y()+80&&!swinging){
      result='BALL';resultTimer=0.8;resultColor='#64748b';streak=0;pitch.active=false;
      setTimeout(throwPitch,700);
    }
  }
  if(swinging){swingFrame+=dt*14;if(swingFrame>5)swinging=false;}
  if(ballFlight){
    ballFlight.t+=dt;
    ballFlight.x+=ballFlight.vx*dt;
    ballFlight.y+=ballFlight.vy*dt;
    ballFlight.vy+=100*dt;
    ballFlight.scale=Math.max(0.2,1-ballFlight.t*0.4);
    // outfielders react
    outfielders.forEach(o=>{
      const dx=ballFlight.x-o.x,dy=ballFlight.y-o.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if(dist>5){o.x+=dx/dist*80*dt;o.y+=dy/dist*60*dt;}
    });
    if(ballFlight.t>2.5)ballFlight=null;
  }
  if(resultTimer>0)resultTimer-=dt;
  particles=particles.filter(p=>{p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=400*dt;p.life-=dt;return p.life>0;});
  floatingTexts=floatingTexts.filter(f=>{f.y-=45*dt;f.life-=dt;return f.life>0;});
}

function swing(){
  if(!pitch.active||swinging||state!=='play')return;
  swinging=true;swingFrame=0;totalSwings++;
  const dist=Math.abs(pitch.y-PLATE_Y());
  const norm=dist/(H*0.5);
  let res,pts,color,flightAngle;
  if(norm<0.05){res='HOME RUN';pts=500;color='#FDB913';flightAngle=-1.2;homeRuns++;screenShake=0.8;crowdNoise=1;
    spawnParticles(PLATE_X(),PLATE_Y(),30,'#FDB913');spawnParticles(PLATE_X(),PLATE_Y(),15,'#FF6B35');
    document.getElementById('hit-flash').style.background='rgba(253,185,19,0.2)';document.getElementById('hit-flash').style.opacity='1';setTimeout(()=>document.getElementById('hit-flash').style.opacity='0',150);
  }else if(norm<0.12){res='TRIPLE';pts=350;color='#FF6B35';flightAngle=-0.9;spawnParticles(PLATE_X(),PLATE_Y(),15,'#FF6B35');}
  else if(norm<0.22){res=Math.random()>0.4?'DOUBLE':'SINGLE';pts=res==='DOUBLE'?200:100;color='#BF5700';flightAngle=-0.6;spawnParticles(PLATE_X(),PLATE_Y(),8,'#BF5700');}
  else if(norm<0.38){res='FOUL';pts=10;color='#666';streak=0;flightAngle=Math.random()>0.5?-0.3:0.3;}
  else{res='STRIKE';pts=0;color='#ef4444';streak=0;flightAngle=0;}
  if(pts>=100){streak++;hits++;
    ballFlight={x:PLATE_X(),y:PLATE_Y(),vx:Math.cos(flightAngle)*200+(Math.random()-0.5)*60,vy:Math.sin(flightAngle)*250-100,t:0,scale:1,type:res};
  }else if(res==='FOUL'){
    ballFlight={x:PLATE_X(),y:PLATE_Y(),vx:flightAngle*200,vy:-150,t:0,scale:0.8,type:'FOUL'};
  }
  const mult=Math.min(1+streak*0.25,4);
  const total=Math.round(pts*mult);
  score+=total;
  result=res;resultTimer=1.3;resultColor=color;
  if(total>0)floatingTexts.push({x:PLATE_X(),y:PLATE_Y()-40,text:'+'+total+(mult>1?' (x'+mult.toFixed(1)+')':''),color,life:1.5});
  pitch.active=false;
  setTimeout(throwPitch,1000);
}

function spawnParticles(x,y,n,color){
  for(let i=0;i<n;i++)particles.push({x,y,vx:(Math.random()-0.5)*350,vy:-200-Math.random()*250,color,life:1+Math.random()});
}

function draw(){
  ctx.save();
  if(screenShake>0)ctx.translate((Math.random()-0.5)*screenShake*8,(Math.random()-0.5)*screenShake*8);
  ctx.fillStyle='#0D0D12';ctx.fillRect(0,0,W,H);
  // sky
  const sky=ctx.createLinearGradient(0,0,0,H*0.35);
  sky.addColorStop(0,'#0f1729');sky.addColorStop(1,'#162040');
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H*0.35);
  // stars
  ctx.fillStyle='rgba(255,255,255,0.3)';
  for(let i=0;i<20;i++){const sx=(i*137.5)%W,sy=(i*97.3)%H*0.3;ctx.fillRect(sx,sy,1.5,1.5);}
  // stadium lights
  ctx.fillStyle='rgba(253,185,19,0.06)';ctx.beginPath();ctx.arc(W*0.15,H*0.08,80,0,Math.PI*2);ctx.fill();
  ctx.beginPath();ctx.arc(W*0.85,H*0.08,80,0,Math.PI*2);ctx.fill();
  // crowd (rows of dots)
  for(let row=0;row<3;row++){
    for(let i=0;i<Math.floor(W/8);i++){
      const cx=i*8+4,cy=H*0.08+row*10+Math.sin(i*0.5+crowdNoise*10+row)*2;
      const bright=crowdNoise>0.3?0.3+Math.random()*0.2:0.1+Math.random()*0.05;
      ctx.fillStyle=`rgba(255,255,255,${bright})`;
      ctx.fillRect(cx,cy,4,5);
    }
  }
  // outfield grass
  ctx.fillStyle='#1a5c2a';ctx.beginPath();ctx.moveTo(0,H*0.35);ctx.quadraticCurveTo(W/2,H*0.2,W,H*0.35);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.fill();
  // infield dirt
  ctx.fillStyle='#8B6914';ctx.beginPath();ctx.ellipse(W/2,H*0.62,W*0.38,H*0.28,0,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='#1a5c2a';ctx.beginPath();ctx.ellipse(W/2,H*0.55,W*0.2,H*0.13,0,0,Math.PI*2);ctx.fill();
  // base paths
  ctx.strokeStyle='rgba(255,255,255,0.12)';ctx.lineWidth=2;
  ctx.beginPath();ctx.moveTo(PLATE_X(),PLATE_Y());ctx.lineTo(W*0.7,H*0.55);ctx.lineTo(W/2,H*0.38);ctx.lineTo(W*0.3,H*0.55);ctx.closePath();ctx.stroke();
  // bases
  ctx.fillStyle='#fff';
  [[W*0.7,H*0.55],[W/2,H*0.38],[W*0.3,H*0.55]].forEach(([bx,by])=>{ctx.save();ctx.translate(bx,by);ctx.rotate(Math.PI/4);ctx.fillRect(-5,-5,10,10);ctx.restore();});
  // outfielders
  outfielders.forEach(o=>{ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(o.x,o.y,5,0,Math.PI*2);ctx.fill();});
  // mound
  ctx.fillStyle='#8B6914';ctx.beginPath();ctx.ellipse(W/2,MOUND_Y(),22,12,0,0,Math.PI*2);ctx.fill();
  // plate
  ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(PLATE_X(),PLATE_Y()+6);ctx.lineTo(PLATE_X()-10,PLATE_Y());ctx.lineTo(PLATE_X()-8,PLATE_Y()-6);ctx.lineTo(PLATE_X()+8,PLATE_Y()-6);ctx.lineTo(PLATE_X()+10,PLATE_Y());ctx.closePath();ctx.fill();
  // strike zone
  ctx.strokeStyle='rgba(255,255,255,0.08)';ctx.lineWidth=1;ctx.strokeRect(PLATE_X()-28,PLATE_Y()-48,56,56);
  // pitcher
  ctx.fillStyle='#334155';ctx.beginPath();ctx.arc(W/2,MOUND_Y()-16,9,0,Math.PI*2);ctx.fill();
  ctx.fillRect(W/2-4,MOUND_Y()-7,8,18);
  ctx.fillStyle='#fff';ctx.fillRect(W/2-3,MOUND_Y()-7,6,3); // cap
  // batter
  const bx=PLATE_X()+38,by=PLATE_Y()-8;
  ctx.fillStyle='#BF5700';ctx.beginPath();ctx.arc(bx,by-18,9,0,Math.PI*2);ctx.fill();
  ctx.fillRect(bx-4,by-9,8,22);
  ctx.fillStyle='#FF6B35';ctx.fillRect(bx-3,by-18,6,3); // helmet
  // bat
  if(swinging&&swingFrame<3.5){
    ctx.save();ctx.translate(bx-12,by-3);ctx.rotate(-1.8+swingFrame*1.4);
    ctx.fillStyle='#DEB887';ctx.fillRect(0,-2.5,42,5);ctx.fillStyle='#8B6914';ctx.fillRect(36,-3,8,6);ctx.restore();
  }else{
    ctx.save();ctx.translate(bx-10,by-14);ctx.rotate(-0.9);
    ctx.fillStyle='#DEB887';ctx.fillRect(0,-2,38,4);ctx.restore();
  }
  // pitch ball with shadow
  if(pitch.active){
    const sz=4+pitch.shadow*3;
    // shadow on ground
    ctx.fillStyle='rgba(0,0,0,0.2)';ctx.beginPath();ctx.ellipse(pitch.x,PLATE_Y()+2,sz*1.2,sz*0.4,0,0,Math.PI*2);ctx.fill();
    // ball
    ctx.fillStyle='#fff';ctx.beginPath();ctx.arc(pitch.x,pitch.y,sz,0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#cc0000';ctx.lineWidth=1;ctx.beginPath();ctx.arc(pitch.x,pitch.y,sz,0.5,1.8);ctx.stroke();ctx.beginPath();ctx.arc(pitch.x,pitch.y,sz,3.6,5);ctx.stroke();
    // pitch type indicator
    ctx.fillStyle=pitch.color;ctx.font='bold 10px sans-serif';ctx.textAlign='center';
    ctx.fillText(pitch.label,pitch.x,pitch.y-sz-6);
    // speed lines
    if(pitch.type==='fastball'){
      ctx.strokeStyle='rgba(255,68,68,0.2)';ctx.lineWidth=1;
      for(let i=1;i<=3;i++){ctx.beginPath();ctx.moveTo(pitch.x-8+i*4,pitch.y-15);ctx.lineTo(pitch.x-8+i*4,pitch.y-30);ctx.stroke();}
    }
  }
  // ball flight
  if(ballFlight){
    const s=ballFlight.scale;
    ctx.fillStyle=ballFlight.type==='HOME RUN'?'#FDB913':'#fff';
    ctx.beginPath();ctx.arc(ballFlight.x,ballFlight.y,5*s,0,Math.PI*2);ctx.fill();
    if(ballFlight.type==='HOME RUN'){ctx.strokeStyle='rgba(253,185,19,0.3)';ctx.lineWidth=2;ctx.beginPath();ctx.arc(ballFlight.x,ballFlight.y,10*s,0,Math.PI*2);ctx.stroke();}
  }
  // particles
  particles.forEach(p=>{ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,3,0,Math.PI*2);ctx.fill();});
  ctx.globalAlpha=1;
  // floating texts
  floatingTexts.forEach(f=>{ctx.globalAlpha=Math.min(1,f.life);ctx.fillStyle=f.color;ctx.font='bold 20px sans-serif';ctx.textAlign='center';
    ctx.strokeStyle='rgba(0,0,0,0.5)';ctx.lineWidth=3;ctx.strokeText(f.text,f.x,f.y);ctx.fillText(f.text,f.x,f.y);});
  ctx.globalAlpha=1;
  // result
  if(resultTimer>0){
    ctx.fillStyle=resultColor;ctx.font='bold 32px sans-serif';ctx.textAlign='center';
    ctx.strokeStyle='rgba(0,0,0,0.6)';ctx.lineWidth=4;
    ctx.strokeText(result,W/2,H*0.18);ctx.fillText(result,W/2,H*0.18);
  }
  // HUD
  ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(0,0,W,34);
  ctx.fillStyle='#fff';ctx.font='bold 13px sans-serif';
  ctx.textAlign='left';ctx.fillText('Score: '+score,12,22);
  ctx.textAlign='center';
  const mult=Math.min(1+streak*0.25,4);
  ctx.fillStyle=streak>=3?'#FDB913':'#fff';
  ctx.fillText(timeLeft+'s  |  Streak: '+streak+(mult>1?' (x'+mult.toFixed(1)+')':''),W/2,22);
  ctx.textAlign='right';ctx.fillStyle='#BF5700';ctx.fillText('HR: '+homeRuns,W-12,22);
  ctx.restore();
}

function endGame(){
  state='over';
  document.getElementById('gameover').style.display='flex';
  document.getElementById('finalScore').textContent=score;
  document.getElementById('finalHits').textContent=hits+' Hit'+(hits!==1?'s':'')+' ('+homeRuns+' HR) / '+totalSwings+' Swings';
  submitScore();
}

function submitScore(){
  const name=localStorage.getItem('bsi_player_name')||'Player';
  const avatar=localStorage.getItem('bsi_player_avatar')||'\u26BE';
  fetch('/api/multiplayer/leaderboard',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({game:'sandlot-sluggers',name,avatar,score})}).catch(()=>{});
}

document.addEventListener('keydown',e=>{if(e.code==='Space'){e.preventDefault();swing();}});
canvas.addEventListener('touchstart',e=>{e.preventDefault();swing();},{passive:false});
</script>
</body>
</html>
