<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>49ers Advanced Analytics | Blaze Sports Intel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --team-primary: #AA0000;
            --team-secondary: #B3995D;
            --bg-dark: #0d0d0d;
            --bg-card: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --accent: #FF6B35;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 1rem;
        }
        .header {
            text-align: center;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, var(--team-primary) 0%, var(--team-secondary) 100%);
            border-radius: 1rem;
            margin-bottom: 1.5rem;
        }
        .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header p { color: rgba(255,255,255,0.8); }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.25rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--team-primary);
        }
        .record-display {
            font-size: 3rem;
            font-weight: 700;
            text-align: center;
            color: var(--team-primary);
        }
        .record-label { text-align: center; color: var(--text-secondary); margin-top: 0.5rem; }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-secondary); }
        .stat-value { font-weight: 600; }
        .stat-value.positive { color: var(--success); }
        .stat-value.negative { color: var(--danger); }
        .standings-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .standings-table th {
            text-align: left;
            padding: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .standings-table td { padding: 0.5rem; }
        .standings-table tr.current-team { background: rgba(170,0,0,0.2); }
        .schedule-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255,255,255,0.03);
            border-radius: 0.5rem;
        }
        .schedule-item.win { border-left: 3px solid var(--success); }
        .schedule-item.loss { border-left: 3px solid var(--danger); }
        .schedule-item.tie { border-left: 3px solid var(--warning); }
        .schedule-item.upcoming { border-left: 3px solid var(--text-secondary); }
        .opponent { font-weight: 500; }
        .game-result { font-weight: 600; }
        .game-result.win { color: var(--success); }
        .game-result.loss { color: var(--danger); }
        .pythagorean {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(170,0,0,0.2), rgba(179,153,93,0.2));
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .pyth-value { font-size: 2rem; font-weight: 700; color: var(--team-primary); }
        .pyth-label { color: var(--text-secondary); font-size: 0.875rem; }
        .loading { text-align: center; padding: 2rem; color: var(--text-secondary); }
        .last-updated { text-align: center; color: var(--text-secondary); font-size: 0.75rem; margin-top: 1rem; }
        @media (max-width: 768px) {
            .header h1 { font-size: 1.5rem; }
            .record-display { font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>⛏️ San Francisco 49ers</h1>
        <p>Advanced Analytics Dashboard</p>
    </div>

    <div class="dashboard-grid">
        <div class="card">
            <div class="card-title">Season Record</div>
            <div id="record-display" class="record-display">--</div>
            <div class="record-label">Win-Loss-Tie</div>
            <div class="pythagorean">
                <div class="pyth-value" id="pyth-wins">--</div>
                <div class="pyth-label">Pythagorean Expected Wins</div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Scoring Analysis</div>
            <div id="scoring-stats">
                <div class="stat-row">
                    <span class="stat-label">Points For</span>
                    <span class="stat-value" id="points-for">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Points Against</span>
                    <span class="stat-value" id="points-against">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Point Differential</span>
                    <span class="stat-value" id="point-diff">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Points/Game</span>
                    <span class="stat-value" id="ppg">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Avg Points Allowed</span>
                    <span class="stat-value" id="papg">--</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">NFC West Standings</div>
            <table class="standings-table" id="standings-table">
                <thead>
                    <tr><th>Team</th><th>W</th><th>L</th><th>T</th><th>PCT</th></tr>
                </thead>
                <tbody id="standings-body">
                    <tr><td colspan="5" class="loading">Loading...</td></tr>
                </tbody>
            </table>
        </div>

        <div class="card">
            <div class="card-title">Offensive Stats</div>
            <div id="offensive-stats">
                <div class="stat-row">
                    <span class="stat-label">Total Yards/Game</span>
                    <span class="stat-value" id="off-ypg">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Passing Yards/Game</span>
                    <span class="stat-value" id="off-pass">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rushing Yards/Game</span>
                    <span class="stat-value" id="off-rush">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">3rd Down %</span>
                    <span class="stat-value" id="off-3rd">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Red Zone %</span>
                    <span class="stat-value" id="off-rz">--</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">Defensive Stats</div>
            <div id="defensive-stats">
                <div class="stat-row">
                    <span class="stat-label">Yards Allowed/Game</span>
                    <span class="stat-value" id="def-ypg">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Pass Yards Allowed</span>
                    <span class="stat-value" id="def-pass">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rush Yards Allowed</span>
                    <span class="stat-value" id="def-rush">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sacks</span>
                    <span class="stat-value" id="def-sacks">--</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Takeaways</span>
                    <span class="stat-value" id="def-to">--</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">2024 Schedule</div>
            <div id="schedule-container">
                <div class="loading">Loading schedule...</div>
            </div>
        </div>
    </div>

    <div class="last-updated" id="last-updated"></div>

    <script>
        const ESPN_BASE = 'https://site.api.espn.com/apis/site/v2/sports/football/nfl';
        const TEAM_ID = '25';
        const TEAM_ABBREV = 'SF';
        const DIVISION = 'NFC West';
        const NFL_PYTHAGOREAN_EXP = 2.53;

        let teamStats = {
            pointsFor: 0,
            pointsAgainst: 0,
            wins: 0,
            losses: 0,
            ties: 0,
            gamesPlayed: 0
        };

        async function fetchTeamData() {
            try {
                const res = await fetch(`${ESPN_BASE}/teams/${TEAM_ID}`);
                const data = await res.json();
                return data.team;
            } catch (e) {
                console.error('Error fetching team data:', e);
                return null;
            }
        }

        async function fetchSchedule() {
            try {
                const res = await fetch(`${ESPN_BASE}/teams/${TEAM_ID}/schedule`);
                const data = await res.json();
                return data.events || [];
            } catch (e) {
                console.error('Error fetching schedule:', e);
                return [];
            }
        }

        async function fetchStandings() {
            try {
                const res = await fetch(`${ESPN_BASE}/standings`);
                const data = await res.json();
                return data.children || [];
            } catch (e) {
                console.error('Error fetching standings:', e);
                return [];
            }
        }

        async function fetchStatistics() {
            try {
                const res = await fetch(`${ESPN_BASE}/teams/${TEAM_ID}/statistics`);
                const data = await res.json();
                return data;
            } catch (e) {
                console.error('Error fetching statistics:', e);
                return null;
            }
        }

        function calculatePythagoreanWins(pf, pa, games) {
            if (pa === 0 || games === 0) return 0;
            const exp = NFL_PYTHAGOREAN_EXP;
            const winPct = Math.pow(pf, exp) / (Math.pow(pf, exp) + Math.pow(pa, exp));
            return (winPct * games).toFixed(1);
        }

        function renderRecord() {
            const recordStr = teamStats.ties > 0
                ? `${teamStats.wins}-${teamStats.losses}-${teamStats.ties}`
                : `${teamStats.wins}-${teamStats.losses}`;
            document.getElementById('record-display').textContent = recordStr;

            const pythWins = calculatePythagoreanWins(
                teamStats.pointsFor,
                teamStats.pointsAgainst,
                teamStats.gamesPlayed
            );
            document.getElementById('pyth-wins').textContent = pythWins;
        }

        function renderScoring() {
            document.getElementById('points-for').textContent = teamStats.pointsFor;
            document.getElementById('points-against').textContent = teamStats.pointsAgainst;

            const diff = teamStats.pointsFor - teamStats.pointsAgainst;
            const diffEl = document.getElementById('point-diff');
            diffEl.textContent = (diff > 0 ? '+' : '') + diff;
            diffEl.className = 'stat-value ' + (diff > 0 ? 'positive' : diff < 0 ? 'negative' : '');

            const ppg = teamStats.gamesPlayed > 0 ? (teamStats.pointsFor / teamStats.gamesPlayed).toFixed(1) : '--';
            const papg = teamStats.gamesPlayed > 0 ? (teamStats.pointsAgainst / teamStats.gamesPlayed).toFixed(1) : '--';
            document.getElementById('ppg').textContent = ppg;
            document.getElementById('papg').textContent = papg;
        }

        function renderStandings(standings) {
            const division = standings.find(c => c.name === DIVISION);
            if (!division) return;

            const tbody = document.getElementById('standings-body');
            tbody.innerHTML = '';

            const teams = division.standings?.entries || [];
            teams.sort((a, b) => {
                const aWins = parseInt(a.stats?.find(s => s.name === 'wins')?.value || 0);
                const bWins = parseInt(b.stats?.find(s => s.name === 'wins')?.value || 0);
                return bWins - aWins;
            });

            teams.forEach(team => {
                const stats = team.stats || [];
                const wins = stats.find(s => s.name === 'wins')?.value || 0;
                const losses = stats.find(s => s.name === 'losses')?.value || 0;
                const ties = stats.find(s => s.name === 'ties')?.value || 0;
                const pct = stats.find(s => s.name === 'winPercent')?.value || 0;

                const isCurrentTeam = team.team?.abbreviation === TEAM_ABBREV;
                const row = document.createElement('tr');
                if (isCurrentTeam) row.className = 'current-team';
                row.innerHTML = `
                    <td>${team.team?.abbreviation || '--'}</td>
                    <td>${wins}</td>
                    <td>${losses}</td>
                    <td>${ties}</td>
                    <td>${(pct * 1).toFixed(3)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSchedule(events) {
            const container = document.getElementById('schedule-container');
            container.innerHTML = '';

            teamStats = { pointsFor: 0, pointsAgainst: 0, wins: 0, losses: 0, ties: 0, gamesPlayed: 0 };

            events.forEach(event => {
                const competition = event.competitions?.[0];
                if (!competition) return;

                const competitors = competition.competitors || [];
                const homeTeam = competitors.find(c => c.homeAway === 'home');
                const awayTeam = competitors.find(c => c.homeAway === 'away');
                const isHome = homeTeam?.team?.id === TEAM_ID;
                const opponent = isHome ? awayTeam : homeTeam;
                const team = isHome ? homeTeam : awayTeam;

                const isCompleted = competition.status?.type?.completed;
                const teamScore = parseInt(team?.score || 0);
                const oppScore = parseInt(opponent?.score || 0);

                let resultClass = 'upcoming';
                let resultText = event.status?.type?.shortDetail || 'Scheduled';

                if (isCompleted) {
                    teamStats.gamesPlayed++;
                    teamStats.pointsFor += teamScore;
                    teamStats.pointsAgainst += oppScore;

                    if (teamScore > oppScore) {
                        teamStats.wins++;
                        resultClass = 'win';
                        resultText = `W ${teamScore}-${oppScore}`;
                    } else if (teamScore < oppScore) {
                        teamStats.losses++;
                        resultClass = 'loss';
                        resultText = `L ${teamScore}-${oppScore}`;
                    } else {
                        teamStats.ties++;
                        resultClass = 'tie';
                        resultText = `T ${teamScore}-${oppScore}`;
                    }
                }

                const weekNum = event.week?.number ? `Week ${event.week.number}` : '';
                const location = isHome ? 'vs' : '@';

                const item = document.createElement('div');
                item.className = `schedule-item ${resultClass}`;
                item.innerHTML = `
                    <div>
                        <div class="opponent">${location} ${opponent?.team?.abbreviation || 'TBD'}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary)">${weekNum}</div>
                    </div>
                    <div class="game-result ${resultClass}">${resultText}</div>
                `;
                container.appendChild(item);
            });

            renderRecord();
            renderScoring();
        }

        function renderStatistics(stats) {
            if (!stats || !stats.splits?.categories) return;

            const categories = stats.splits.categories;

            const getStatValue = (catName, statName) => {
                const cat = categories.find(c => c.name === catName);
                if (!cat) return '--';
                const stat = cat.stats?.find(s => s.name === statName);
                return stat ? stat.displayValue || stat.value : '--';
            };

            document.getElementById('off-ypg').textContent = getStatValue('general', 'totalYards');
            document.getElementById('off-pass').textContent = getStatValue('passing', 'netPassingYards');
            document.getElementById('off-rush').textContent = getStatValue('rushing', 'rushingYards');
            document.getElementById('off-3rd').textContent = getStatValue('general', 'thirdDownConvPct');
            document.getElementById('off-rz').textContent = getStatValue('general', 'redZoneScoringPct');

            document.getElementById('def-ypg').textContent = getStatValue('general', 'yardsAgainst');
            document.getElementById('def-pass').textContent = getStatValue('passing', 'netPassingYardsAgainst');
            document.getElementById('def-rush').textContent = getStatValue('rushing', 'rushingYardsAgainst');
            document.getElementById('def-sacks').textContent = getStatValue('defensive', 'sacks');
            document.getElementById('def-to').textContent = getStatValue('defensive', 'takeaways');
        }

        async function init() {
            const [teamData, schedule, standings, statistics] = await Promise.all([
                fetchTeamData(),
                fetchSchedule(),
                fetchStandings(),
                fetchStatistics()
            ]);

            if (schedule.length) renderSchedule(schedule);
            if (standings.length) renderStandings(standings);
            if (statistics) renderStatistics(statistics);

            document.getElementById('last-updated').textContent =
                `Last updated: ${new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' })} CT`;
        }

        init();
        setInterval(init, 300000);
    </script>
</body>
</html>
