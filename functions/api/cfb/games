/**
 * Blaze Sports Intel - CFB AI Game Previews & Recaps
 * Fetches CFB games and generates AI-powered previews/recaps
 */

import { z } from 'zod';

export interface Env {
  AI: Ai;
  BSI_CACHE?: KVNamespace;
}

// Zod schema for ESPN API response validation
const ESPNCompetitorSchema = z.object({
  team: z.object({
    displayName: z.string(),
    abbreviation: z.string(),
    logo: z.string().optional(),
  }),
  homeAway: z.string(),
  score: z.string().optional(),
  winner: z.boolean().optional(),
  records: z.array(z.object({ summary: z.string() })).optional(),
});

const ESPNCompetitionSchema = z.object({
  competitors: z.array(ESPNCompetitorSchema),
  venue: z.object({ fullName: z.string() }).optional(),
  broadcasts: z.array(z.object({ names: z.array(z.string()) })).optional(),
  headlines: z.array(z.object({ shortLinkText: z.string() })).optional(),
});

const ESPNGameSchema = z.object({
  id: z.string(),
  name: z.string(),
  date: z.string(),
  status: z.object({
    type: z.object({
      name: z.string(),
      completed: z.boolean(),
    }),
  }),
  competitions: z.array(ESPNCompetitionSchema),
});

const ESPNResponseSchema = z.object({
  events: z.array(ESPNGameSchema).default([]),
});

type ESPNGame = z.infer<typeof ESPNGameSchema>;

const ESPN_CFB_API = 'https://site.api.espn.com/apis/site/v2/sports/football/college-football';
const MAX_AI_CALLS_PER_REQUEST = 10;
const DATE_PATTERN = /^\d{8}$/;

function isValidDateParam(date: string): boolean {
  if (!DATE_PATTERN.test(date)) return false;
  const year = parseInt(date.slice(0, 4), 10);
  const month = parseInt(date.slice(4, 6), 10);
  const day = parseInt(date.slice(6, 8), 10);
  return year >= 2000 && year <= 2100 && month >= 1 && month <= 12 && day >= 1 && day <= 31;
}

function getChicagoDate(): string {
  return new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
}

async function generatePreview(env: Env, game: ESPNGame): Promise<string> {
  const competition = game.competitions[0];
  const homeTeam = competition.competitors.find((c) => c.homeAway === 'home');
  const awayTeam = competition.competitors.find((c) => c.homeAway === 'away');

  const homeRecord = homeTeam?.records?.[0]?.summary || 'N/A';
  const awayRecord = awayTeam?.records?.[0]?.summary || 'N/A';
  const venue = competition.venue?.fullName || 'TBD';
  const broadcast = competition.broadcasts?.[0]?.names?.[0] || 'TBD';

  const gameDate = new Date(game.date).toLocaleDateString('en-US', {
    weekday: 'long',
    month: 'long',
    day: 'numeric',
    timeZone: 'America/Chicago',
  });

  const prompt = `You are a college football analyst writing a game preview. Write a 2-paragraph preview.

Game: ${awayTeam?.team.displayName} (${awayRecord}) at ${homeTeam?.team.displayName} (${homeRecord})
Date: ${gameDate}
Venue: ${venue}
TV: ${broadcast}

Write an engaging preview covering:
1. What makes this matchup interesting
2. Key players or storylines to watch

Keep it under 150 words. Be direct, no clich√©s. Write in present tense where appropriate.`;

  try {
    const response = await env.AI.run('@cf/meta/llama-3-8b-instruct', {
      prompt,
      max_tokens: 300,
    });
    return response?.response || 'Preview unavailable.';
  } catch {
    return `${awayTeam?.team.displayName} travels to face ${homeTeam?.team.displayName} in this matchup. Game time details available closer to kickoff.`;
  }
}

async function generateRecap(env: Env, game: ESPNGame): Promise<string> {
  const competition = game.competitions[0];
  const homeTeam = competition.competitors.find((c) => c.homeAway === 'home');
  const awayTeam = competition.competitors.find((c) => c.homeAway === 'away');
  const winner = competition.competitors.find((c) => c.winner);
  const headline = competition.headlines?.[0]?.shortLinkText || '';

  const prompt = `You are a college football analyst writing a game recap. Write a 2-paragraph summary.

Final: ${awayTeam?.team.displayName} ${awayTeam?.score} at ${homeTeam?.team.displayName} ${homeTeam?.score}
Winner: ${winner?.team.displayName}
${headline ? `Headline: ${headline}` : ''}

Write a recap covering:
1. How the game was decided
2. What this means for both teams going forward

Keep it under 150 words. Be analytical and direct.`;

  try {
    const response = await env.AI.run('@cf/meta/llama-3-8b-instruct', {
      prompt,
      max_tokens: 300,
    });
    return response?.response || 'Recap unavailable.';
  } catch {
    return `${winner?.team.displayName} defeated ${winner === homeTeam ? awayTeam?.team.displayName : homeTeam?.team.displayName} by a final score of ${homeTeam?.score}-${awayTeam?.score}.`;
  }
}

export const onRequest: PagesFunction<Env> = async (context) => {
  const { request, env } = context;
  const url = new URL(request.url);

  const headers = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type',
    'Content-Type': 'application/json',
  };

  if (request.method === 'OPTIONS') {
    return new Response(null, { headers });
  }

  if (request.method !== 'GET') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers,
    });
  }

  try {
    const dateParam = url.searchParams.get('date');
    const date = dateParam || getChicagoDate().replace(/-/g, '');
    const limitParam = parseInt(url.searchParams.get('limit') || '10', 10);

    // Validate date format
    if (dateParam && !isValidDateParam(dateParam)) {
      return new Response(
        JSON.stringify({ error: 'Invalid date format. Use YYYYMMDD.' }),
        { status: 400, headers }
      );
    }

    // Rate limit: cap at MAX_AI_CALLS_PER_REQUEST to prevent expensive runaway
    const limit = Math.min(Math.max(1, limitParam), MAX_AI_CALLS_PER_REQUEST);

    // Check cache first
    const cacheKey = `cfb:games:${date}:${limit}`;
    if (env.BSI_CACHE) {
      const cached = await env.BSI_CACHE.get(cacheKey);
      if (cached) {
        return new Response(cached, {
          headers: { ...headers, 'X-Cache': 'HIT' },
        });
      }
    }

    // Fetch games from ESPN
    const response = await fetch(`${ESPN_CFB_API}/scoreboard?dates=${date}`);
    if (!response.ok) {
      throw new Error(`ESPN API error: ${response.status}`);
    }

    const rawData = await response.json();
    const parseResult = ESPNResponseSchema.safeParse(rawData);

    if (!parseResult.success) {
      throw new Error(`Invalid ESPN API response: ${parseResult.error.message}`);
    }

    const games = parseResult.data.events;

    // Process games with AI content
    const processedGames = await Promise.all(
      games.slice(0, limit).map(async (game) => {
        const competition = game.competitions[0];
        const homeTeam = competition.competitors.find((c) => c.homeAway === 'home');
        const awayTeam = competition.competitors.find((c) => c.homeAway === 'away');
        const isCompleted = game.status.type.completed;

        // Check for cached content
        const contentType = isCompleted ? 'recap' : 'preview';
        const contentCacheKey = `cfb:${contentType}:${game.id}`;
        let aiContent: string | null = null;

        if (env.BSI_CACHE) {
          aiContent = await env.BSI_CACHE.get(contentCacheKey);
        }

        if (!aiContent) {
          aiContent = isCompleted
            ? await generateRecap(env, game)
            : await generatePreview(env, game);

          if (env.BSI_CACHE) {
            await env.BSI_CACHE.put(contentCacheKey, aiContent, {
              expirationTtl: isCompleted ? 86400 : 3600,
            });
          }
        }

        return {
          id: game.id,
          name: game.name,
          date: game.date,
          status: game.status.type.name,
          completed: isCompleted,
          homeTeam: {
            name: homeTeam?.team.displayName,
            abbreviation: homeTeam?.team.abbreviation,
            logo: homeTeam?.team.logo,
            score: homeTeam?.score,
            record: homeTeam?.records?.[0]?.summary,
          },
          awayTeam: {
            name: awayTeam?.team.displayName,
            abbreviation: awayTeam?.team.abbreviation,
            logo: awayTeam?.team.logo,
            score: awayTeam?.score,
            record: awayTeam?.records?.[0]?.summary,
          },
          venue: competition.venue?.fullName,
          broadcast: competition.broadcasts?.[0]?.names?.[0],
          contentType,
          aiContent,
        };
      })
    );

    const result = {
      meta: {
        source: 'ESPN college-football',
        fetched_at: getChicagoDate(),
        timezone: 'America/Chicago',
        ai_model: '@cf/meta/llama-3-8b-instruct',
        total: games.length,
        returned: processedGames.length,
      },
      games: processedGames,
    };

    const json = JSON.stringify(result);

    // Cache for 5 minutes
    if (env.BSI_CACHE) {
      await env.BSI_CACHE.put(cacheKey, json, { expirationTtl: 300 });
    }

    return new Response(json, {
      headers: { ...headers, 'X-Cache': 'MISS' },
    });
  } catch (error) {
    const message = error instanceof Error ? error.message : 'Unknown error';
    return new Response(
      JSON.stringify({
        error: 'Failed to fetch games',
        message,
      }),
      {
        status: 500,
        headers,
      }
    );
  }
};
